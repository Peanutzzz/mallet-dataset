sy generator mapper component mapper public interface sy generator mapper extend super mapper list map string object query list page map string object page param p map string object map int query total map string object map map string string query table string table name list map string string query column string table name 
aggregation service fallback factory slf4j component public class aggregation service fallback factory implement fallback factory aggregation service override public aggregation service create throwable throwable return index name route log error index name throwable return map util new hash map 
spring util component public class spring util implement application context aware private static application context application context null public static t t get bean class t cla return application context get bean cla public static t t get bean string name class t cal return application context get bean name cal public static string get property string key return application context get bean environment class get property key override public void set application context application context application context spring util application context application context 
sso logout success handler component public class sso logout success handler implement logout success handler value zlt logout uri private string logout uri private redirect strategy redirect strategy new default redirect strategy override public void on logout success http servlet request request http servlet response response authentication authentication throw i o exception o auth2 authentication oauth2 authentication o auth2 authentication authentication o auth2 authentication detail detail o auth2 authentication detail oauth2 authentication get detail string access token detail get token value redirect strategy send redirect request response logout uri access token 
permission auth manager slf4j component public class permission auth manager extend default permission service impl implement reactive authorization manager authorization context resource private menu service menu service override public mono authorization decision check mono authentication authentication authorization context authorization context return authentication map auth server web exchange exchange authorization context get exchange server http request request exchange get request boolean be permission super have permission auth request get method value request get u r i get path return new authorization decision be permission default if empty new authorization decision false override public list sy menu find menu by role code string role code return menu service find by role code role code 
menu service fallback factory slf4j component public class menu service fallback factory implement fallback factory menu service override public menu service create throwable throwable return role id log error find by role code role id throwable return collection util new array list 
lb isolation filter component conditional on property name config constant config ribbon isolation enable have value true public class lb isolation filter extend load balancer client filter public lb isolation filter load balancer client load balancer load balancer property property super load balancer property override protected service instance choose server web exchange exchange string vresion exchange get request get header get first common constant z l t version if str util be not empty vresion if this load balancer instanceof ribbon load balancer client ribbon load balancer client client ribbon load balancer client this load balancer string service id uri exchange get attribute gateway request url attr get host return client choose service id vresion return super choose exchange 
request statistics filter component public class request statistics filter implement global filter order override public mono void filter server web exchange exchange gateway filter chain chain server http request request exchange get request map string string header request get header to single value map user agent user agent user agent parse user agent string header get user agent point util debug request statistics ip reactive addr util get remote addr request browser get browser user agent get browser name operate system get operate system user agent get operate system name return chain filter exchange override public int get order return private string get browser string browser if str util be not empty browser if browser contain chrome return chrome else if browser contain firefox return firefox else if browser contain safari return safari else if browser contain edge return edge return browser private string get operate system string operate system if str util be not empty operating system if operate system contain mac os x return mac os x else if operate system contain android return android return operate system 
trace filter component public class trace filter implement global filter order autowired private trace property trace property override public mono void filter server web exchange exchange gateway filter chain chain if trace property get enable id string trace id id util fast simple u u i d mdc put common constant log trace id trace id server http request server http request exchange get request mutate header h h add common constant trace id header trace id build server web exchange build exchange mutate request server http request build return chain filter build return chain filter exchange override public int get order return order highest precedence 
swagger provider component enable configuration property swagger agg property class primary public class swagger provider implement swagger resource provider private final route locator route locator private final gateway property gateway property resource private swagger agg property swagger agg property public swagger provider route locator route locator gateway property gateway property this route locator route locator this gateway property gateway property override public list swagger resource get list swagger resource resource new array list set string route new hash set spring cloud gateway route route locator get route subscribe route route add route get id application yml route gateway property get route stream filter route definition route contain route definition get id swagger agg property be show route definition get id for each route definition route definition get predicate stream filter predicate definition path equal ignore case predicate definition get name for each predicate definition resource add swagger resource route definition get id predicate definition get arg get name util generate name prefix replace swagger agg property get api doc path return resource private swagger resource swagger resource string name string location swagger resource swagger resource new swagger resource swagger resource set name name swagger resource set location location swagger resource set swagger version swagger agg property get swagger version return swagger resource 
menu service fallback factory slf4j component public class menu service fallback factory implement fallback factory menu service override public menu service create throwable throwable return role id log error find by role code role id throwable return collection util new array list 
request statistics filter slf4j component public class request statistics filter extend zuul filter override public string filter type return filter constant pre type override public int filter order return override public boolean should filter return true override public object run request context ctx request context get current context http servlet request req ctx get request user agent user agent user agent parse user agent string req get header user agent point util debug request statistics ip addr util get remote addr req browser get browser user agent get browser get name operating system get operate system user agent get operate system get name return null private string get browser string browser if str util be not empty browser if browser contain chrome return chrome else if browser contain firefox return firefox else if browser contain safari return safari else if browser contain edge return edge return browser private string get operate system string operate system if str util be not empty operating system if operate system contain mac os x return mac os x else if operate system contain android return android return operate system 
trace filter component public class trace filter extend zuul filter autowire private trace property trace property override public string filter type return filter constant pre type override public int filter order return form body wrapper filter order override public boolean should filter return trace property get enable override public object run id string trace id id util fast simple u u i d mdc put common constant log trace id trace id request context ctx request context get current context ctx add zuul request header common constant trace id header trace id return null 
user info header filter component public class user info header filter extend zuul filter override public string filter type return filter constant pre type override public int filter order return form body wrapper filter order override public boolean should filter return true override public object run authentication authentication security context holder get context get authentication if authentication null authentication instanceof anonymous authentication token object principal authentication get principal request context ctx request context get current context client id if principal instanceof sy user sy user user sy user authentication get principal ctx add zuul request header security constant user id header string value of user get id ctx add zuul request header security constant user header user get username o auth2 authentication oauth2 authentication o auth2 authentication authentication string client id oauth2 authentication get o auth2 request get client id ctx add zuul request header security constant tenant header client id ctx add zuul request header security constant role header collection util join authentication get authority return null 
cookie interceptor component public class cookie interceptor extend handler interceptor adapter override public void post handle http servlet request request http servlet response response object handler model and view model and view throw exception cookie if model and view null array util be not empty request get cookie hash map string cookie cookie map new hash map string cookie for cookie ck request get cookie cookie map put ck get name ck model and view add object cookie map cookie map static method if model and view null model and view add object i18n util ftl util generate static model i18n util class get name super post handle request response handler model and view 
permission interceptor component public class permission interceptor extend handler interceptor adapter public static final string login identity key xxl job login identity private static string login identity token public static string get login identity token if login identity token null string username xxl job admin config get admin config get login username string password xxl job admin config get admin config get login password login token string token tmp digest util md5 digest as hex string value of username password get byte get byte utf token tmp new big integer token tmp get byte to string login identity token token tmp return login identity token public static boolean login http servlet response response string username string password boolean if remember login token string token tmp digest util md5 digest as hex string value of username password get byte token tmp new big integer token tmp get byte to string if get login identity token equal token tmp return false do login cookie util set response login identity key get login identity token if remember return true public static void logout http servlet request request http servlet response response cookie util remove request response login identity key public static boolean if login http servlet request request string indentity info cookie util get value request login identity key if indentity info null get login identity token equal indentity info trim return false return true override public boolean pre handle http servlet request request http servlet response response object handler throw exception if handler instanceof handler method return super pre handle request response handler if if login request handler method method handler method handler permession limit permission method get method annotation permession limit class if permission null permission limit response send redirect request get context path to login request get request dispatcher to login forward request response return false return super pre handle request response handler 
web exception resolver component public class web exception resolver implement handler exception resolver private static transient logger logger logger factory get logger web exception resolver class override public model and view resolve exception http servlet request request http servlet response response object handler exception ex logger error web exception resolver ex if json boolean be json false handler method method handler method handler response body response body method get method annotation response body class if response body null be json true error result return t string error result new return t string return t fail code ex to string replace all n br response model and view mv new model and view if be json try response set content type application json charset utf response get writer print jackson util write value as string error result catch i o exception e logger error e get message e return mv else mv add object exception msg error result get msg mv set view name common common exception return mv 
command job handler job handler value command job handler component public class command job handler extend i job handler override public return t string execute string param throw exception string command param int exit value buffer reader buffer reader null try command process process process runtime get runtime exec command buffer input stream buffer input stream new buffer input stream process get input stream buffer reader new buffer reader new input stream reader buffer input stream command log string line while line buffer reader read line null xxl job logger log line command exit process wait for exit value process exit value catch exception e xxl job logger log e finally if buffer reader null buffer reader close if exit value return i job handler success else return new return t string i job handler fail get code command exit value exit value be fail 
demo job handler job handler value demo job handler component public class demo job handler extend i job handler override public return t string execute string param throw exception xxl job logger log xxl job hello world for int i i i xxl job logger log beat at i time unit seconds sleep return success 
http job handler job handler value http job handler component public class http job handler extend i job handler override public return t string execute string param throw exception valid if param null param trim length xxl job logger log url empty return fail httpclient http client http client null try http client new http client http client set follow redirect false configure http client for example http client start start http client request request request http client new request param request method http method get request timeout time unit millisecond invoke content response response request send if response get status http status ok xxl job logger log http status code invalid response get status return fail string response msg response get content as string xxl job logger log response msg return success catch exception e xxl job logger log e return fail finally if http client null http client stop 
oauth token aspect slf4j component aspect public class oauth token aspect around execution org springframework security oauth2 provider endpoint token endpoint post access token public object handle controller method proceeding join point join point throw throwable try object arg join point get arg principal principal principal arg if principal instanceof authentication throw new insufficient authentication exception there be no client authentication try add a appropriate authentication filter string client id get client id principal map string string parameter map string string arg string grant type parameter get o auth2 util grant type id tenant context holder set tenant client id object proceed join point proceed if security constant authorization code equal grant type enable o auth2 sso sso demo ss sso enable o auth2 sso token return proceed else response entity o auth2 access token response entity response entity o auth2 access token proceed o auth2 access token body response entity get body return response entity status http status ok body result succeed body catch exception e log error e return response entity status http status bad request body result fail e get message finally tenant context holder clear private string get client id principal principal authentication client authentication principal if client be authenticate throw new insufficient authentication exception the client be not authenticate string client id client get name if client instanceof o auth2 authentication client id o auth2 authentication client get o auth2 request get client id return client id 
mobile authentication security config component public class mobile authentication security config extend security configurer adapter default security filter chain http security autowire private zlt user detail service user detail service autowire private password encoder password encoder override public void configure http security http mobile provider mobile authentication provider provider new mobile authentication provider provider set user detail service user detail service provider set password encoder password encoder http authentication provider provider 
open id authentication security config component public class open id authentication security config extend security configurer adapter default security filter chain http security autowire private social user detail service user detail service override public void configure http security http open id provider open id authentication provider provider new open id authentication provider provider set user detail service user detail service http authentication provider provider 
oauth authorize aspect slf4j component aspect public class oauth authorize aspect autowired private user service user service around execution org springframework security oauth2 provider endpoint authorization endpoint authorize public object do around method proceeding join point join point throw throwable object arg join point get arg map string string parameter map string string arg principal principal principal arg if principal instanceof tenant username password authentication token tenant username password authentication token tenant token tenant username password authentication token principal string client id tenant token get client id string request client id parameter get o auth2 util client id if request client id equal client id try tenant context holder set tenant request client id login app user user user service find by username tenant token get name tenant token new tenant username password authentication token user tenant token get credentials user get authority request client id arg tenant token finally tenant context holder clear return join point proceed arg 
tenant authentication security config component public class tenant authentication security config extend security configurer adapter default security filter chain http security private zlt user detail service user detail service private password encoder password encoder public tenant authentication security config zlt user detail service user detail service password encoder password encoder this user detail service user detail service this password encoder password encoder override public void configure http security http tenant authentication provider provider new tenant authentication provider provider set user detail service user detail service provider set password encoder password encoder http authentication provider provider 
admin service health indicator component public class admin service health indicator implement health indicator private final app service app service public admin service health indicator final app service app service this app service app service override public health health check return health up build private void check page request pageable page request of app service find all pageable 
namespace acquire lock aspect aspect component public class namespace acquire lock aspect private static final logger logger logger factory get logger namespace acquire lock aspect class private final namespace lock service namespace lock service private final namespace service namespace service private final item service item service private final biz config biz config public namespace acquire lock aspect final namespace lock service namespace lock service final namespace service namespace service final item service item service final biz config biz config this namespace lock service namespace lock service this namespace service namespace service this item service item service this biz config biz config create item before annotation pre acquire namespace lock arg app id cluster name namespace name item public void require lock advice string app id string cluster name string namespace name item d t o item acquire lock app id cluster name namespace name item get datum change last modify by update item before annotation pre acquire namespace lock arg app id cluster name namespace name item id item public void require lock advice string app id string cluster name string namespace name long item id item d t o item acquire lock app id cluster name namespace name item get datum change last modify by update by change set before annotation pre acquire namespace lock arg app id cluster name namespace name change set public void require lock advice string app id string cluster name string namespace name item change set change set acquire lock app id cluster name namespace name change set get datum change last modify by delete item before annotation pre acquire namespace lock arg item id operator public void require lock advice long item id string operator item item item service find one item id if item null throw new bad request exception item not exist acquire lock item get namespace id operator void acquire lock string app id string cluster name string namespace name string current user if biz config be namespace lock switch off return namespace namespace namespace service find one app id cluster name namespace name acquire lock namespace current user void acquire lock long namespace id string current user if biz config be namespace lock switch off return namespace namespace namespace service find one namespace id acquire lock namespace current user private void acquire lock namespace namespace string current user if namespace null throw new bad request exception namespace not exist long namespace id namespace get id namespace lock namespace lock namespace lock service find lock namespace id if namespace lock null try try lock namespace id current user lock success catch data integrity violation exception e lock fail namespace lock namespace lock service find lock namespace id check lock namespace namespace lock current user catch exception e logger error try lock error e throw e else check lock owner be current user check lock namespace namespace lock current user private void try lock long namespace id string user namespace lock lock new namespace lock lock set namespace id namespace id lock set datum change create by user lock set datum change last modify by user namespace lock service try lock lock private void check lock namespace namespace namespace lock namespace lock string current user if namespace lock null throw new service exception string format check lock for s fail please retry namespace get namespace name string lock owner namespace lock get datum change create by if lock owner equal current user throw new bad request exception namespace namespace get namespace name be modify by lock owner 
namespace unlock aspect aspect component public class namespace unlock aspect private gson gson new gson private final namespace lock service namespace lock service private final namespace service namespace service private final item service item service private final release service release service private final biz config biz config public namespace unlock aspect final namespace lock service namespace lock service final namespace service namespace service final item service item service final release service release service final biz config biz config this namespace lock service namespace lock service this namespace service namespace service this item service item service this release service release service this biz config biz config create item after annotation pre acquire namespace lock arg app id cluster name namespace name item public void require lock advice string app id string cluster name string namespace name item d t o item try unlock namespace service find one app id cluster name namespace name update item after annotation pre acquire namespace lock arg app id cluster name namespace name item id item public void require lock advice string app id string cluster name string namespace name long item id item d t o item try unlock namespace service find one app id cluster name namespace name update by change set after annotation pre acquire namespace lock arg app id cluster name namespace name change set public void require lock advice string app id string cluster name string namespace name item change set change set try unlock namespace service find one app id cluster name namespace name delete item after annotation pre acquire namespace lock arg item id operator public void require lock advice long item id string operator item item item service find one item id if item null throw new bad request exception item not exist try unlock namespace service find one item get namespace id private void try unlock namespace namespace if biz config be namespace lock switch off return if be modify namespace namespace lock service unlock namespace get id boolean be modify namespace namespace release release release service find latest active release namespace list item item item service find item without order namespace get id if release null return have normal item item map string string release configuration gson from json release get configuration gson type config map string string configuration from item generate configuration from item namespace item map difference string string difference map difference release configuration configuration from item return difference be equal private boolean have normal item list item item for item item item if string util be empty item get key return true return false private map string string generate configuration from item namespace namespace list item namespace item map string string configuration from item map new hash map namespace parent namespace namespace service find parent namespace namespace parent namespace if parent namespace null generate map from item namespace item configuration from item else child namespace release parent release release service find latest active release parent namespace if parent release null configuration from item gson from json parent release get configuration gson type config generate map from item namespace item configuration from item return configuration from item private map string string generate map from item list item item map string string configuration from item for item item item string key item get key if string util be blank key continue configuration from item put key item get value return configuration from item 
biz config component public class biz config extend refreshable config private static final int default item key length private static final int default item value length private static final int default appnamespace cache rebuild interval 60 private static final int default gray release rule scan interval 60 private static final int default appnamespace cache scan interval 1 private static final int default accesskey cache scan interval 1 private static final int default accesskey cache rebuild interval 60 private static final int default release message cache scan interval 1 private static final int default release message scan interval in ms m private static final int default release message notification batch private static final int default release message notification batch interval in milli m private static final int default long polling timeout 60 private gson gson new gson private static final type namespace value length override type reference new type token map long integer get type private final biz d b property source property source public biz config final biz d b property source property source this property source property source override protect list refreshable property source get refreshable property source return collection singleton list property source public list string eureka service url string configuration get value eureka service url if string be null or empty configuration return collection empty list return splitter split to list configuration public int gray release rule scan interval int interval get int property apollo gray release rule scan interval default gray release rule scan interval return check int interval integer max value default gray release rule scan interval public long long polling timeout in milli int timeout get int property long polling timeout default long polling timeout java client s long polling timeout be seconds so server side long polling timeout must be less than return check int timeout default long polling timeout public int item key length limit int limit get int property item key length limit default item key length return check int limit integer max value default item key length public int item value length limit int limit get int property item value length limit default item value length return check int limit integer max value default item value length public map long integer namespace value length limit override string namespace value length override string get value namespace value length limit override map long integer namespace value length override map new hash map if string be null or empty namespace value length override string namespace value length override gson from json namespace value length override string namespace value length override type reference return namespace value length override public boolean be namespace lock switch off return get boolean property namespace lock switch false ctrip config public string clog url return get value clog server url public string clog port return get value clog server port public int app namespace cache scan interval int interval get int property apollo app namespace cache scan interval default appnamespace cache scan interval return check int interval integer max value default appnamespace cache scan interval public time unit app namespace cache scan interval time unit return time unit seconds public int app namespace cache rebuild interval int interval get int property apollo app namespace cache rebuild interval default appnamespace cache rebuild interval return check int interval integer max value default appnamespace cache rebuild interval public time unit app namespace cache rebuild interval time unit return time unit seconds public int access key cache scan interval int interval get int property apollo access key cache scan interval default accesskey cache scan interval return check int interval integer max value default accesskey cache scan interval public time unit access key cache scan interval time unit return time unit seconds public int access key cache rebuild interval int interval get int property apollo access key cache rebuild interval default accesskey cache rebuild interval return check int interval integer max value default accesskey cache rebuild interval public time unit access key cache rebuild interval time unit return time unit seconds public int release message cache scan interval int interval get int property apollo release message cache scan interval default release message cache scan interval return check int interval integer max value default release message cache scan interval public time unit release message cache scan interval time unit return time unit seconds public int release message scan interval in milli int interval get int property apollo message scan interval default release message scan interval in ms return check int interval integer max value default release message scan interval in m public int release message notification batch int batch get int property apollo release message notification batch default release message notification batch return check int batch integer max value default release message notification batch public int release message notification batch interval in milli int interval get int property apollo release message notification batch interval default release message notification batch interval in milli return check int interval integer max value default release message notification batch interval in milli public boolean be config service cache enable return get boolean property config service cache enable false int check int int value int min int max int default value if value min value max return value return default value 
biz log customizer component profile ctrip public class biz log customizer extend log customizer private final biz config biz config public biz log customizer final biz config biz config this biz config biz config override protect string clog url return biz config clog url override protect string clog port return biz config clog port 
apollo eureka client config component primary public class apollo eureka client config extend eureka client config bean private final biz config biz config public apollo eureka client config final biz config biz config this biz config biz config assert only one zone default zone but multiple environment public list string get eureka server service url string my zone list string url biz config eureka service url return collection util be empty url super get eureka server service url my zone url override public boolean equal object o return super equal o 
database message sender component public class database message sender implement message sender private static final logger logger logger factory get logger database message sender class private static final int clean queue max size private blocking queue long to clean queue new link blocking queue clean queue max size private final executor service clean executor service private final atomic boolean clean stop private final release message repository release message repository public database message sender final release message repository release message repository clean executor service executor new single thread executor apollo thread factory create database message sender true clean stop new atomic boolean false this release message repository release message repository override transactional public void send message string message string channel logger info send message to channel message channel if object equal channel topic apollo release topic logger warn channel not support by database message sender return tracer log event apollo admin service release message message transaction transaction tracer new transaction apollo admin service send message try release message new message release message repository save new release message message to clean offer new message get id transaction set status transaction success catch throwable ex logger error send message to database fail ex transaction set status ex throw ex finally transaction complete post construct private void initialize clean executor service submit while clean stop get thread current thread be interrupted try long rm to clean poll time unit seconds if rm null clean message rm else time unit seconds sleep catch throwable ex tracer log error ex private void clean message long id boolean have more true double check in case the release message be roll back release message release message release message repository find by id id or else null if release message null return while have more thread current thread be interrupted list release message message release message repository find first100 by message and id less than order by id asc release message get message release message get id release message repository delete all message have more message size message for each to remove tracer log event string format release message clean s to remove get message string value of to remove get id void stop clean clean stop set true 
biz d b property source component public class biz d b property source extend refreshable property source private static final logger logger logger factory get logger biz d b property source class autowire private server config repository server config repository public biz d b property source string name map string object source super name source public biz d b property source super d b config map new concurrent map string get current datum center return foundation server get datum center override protect void refresh iterable server config db config server config repository find all map string object new config map new hash map default cluster s config for server config config db config if object equal config const cluster name default config get cluster new config put config get key config get value datum center s configs string datum center get current datum center for server config config db config if object equal datum center config get cluster new config put config get key config get value cluster s config if string be null or empty system get property config const apollo cluster key string cluster system get property config const apollo cluster key for server config config db config if object equal cluster config get cluster new config put config get key config get value put to environment for map entry string object config new config entry set string key config get key object value config get value if this source get key null logger info load config from db key value else if object equal this source get key value logger info load config from db old value key value this source get key this source put key value 
entity manager util component public class entity manager util extend entity manager factory accessor private static final logger logger logger factory get logger entity manager util class close the entity manager use it with caution this be only intend for use with async request which spring win t close the entity manager until the async request be finish public void close entity manager entity manager holder em holder entity manager holder transaction synchronization manager get resource get entity manager factory if em holder null return logger debug close jpa entity manager in entity manager util entity manager factory util close entity manager em holder get entity manager 
java config placeholder auto update test component static class test java config bean3 private final int timeout private final int batch autowire public test java config bean3 value timeout int timeout value batch int batch this timeout timeout this batch batch public int get timeout return timeout public int get batch return batch 
java config placeholder test component static class test java config bean value timeout private int timeout private int batch value batch public void set batch int batch this batch batch public int get timeout return timeout public int get batch return batch 
java config placeholder test component static class test java config bean3 private final int timeout private final int batch autowire public test java config bean3 value timeout int timeout value batch int batch this timeout timeout this batch batch public int get timeout return timeout public int get batch return batch 
repository aspect aspect component public class repository aspect pointcut execution public org springframework datum repository repository public void any repository method around any repository method public object invoke with cat transaction proceed join point join point throw throwable string name join point get signature get declare type get simple name join point get signature get name transaction cat transaction tracer new transaction sql name try object result join point proceed cat transaction set status transaction success return result catch throwable ex cat transaction set status ex throw ex finally cat transaction complete 
titan entity manager component conditional titan condition class public class titan entity manager private final titan setting setting public titan entity manager final titan setting setting this setting setting suppress warning rawtype unchecked bean public datum source datasource throw exception class clazz class for name com ctrip datasource configure dal datum source factory object obj clazz new instance method method clazz get method create datum source new class string class string class datum source d datum source method invoke obj new object setting get titan dbname setting get titan url tracer log event apollo datasource titan setting get titan dbname return d 
titan setting component public class titan setting value fat titan url private string fat titan url value uat titan url private string uat titan url value pro titan url private string pro titan url value fat titan dbname private string fat titan dbname value uat titan dbname private string uat titan dbname value pro titan dbname private string pro titan dbname public string get titan url env env env util transform env foundation server get env type switch env case fat case fw return fat titan url case uat return uat titan url case tool case pro return pro titan url default return public string get titan dbname env env env util transform env foundation server get env type switch env case fat case fw return fat titan dbname case uat return uat titan dbname case tool case pro return pro titan dbname default return 
config service health indicator component public class config service health indicator implement health indicator private final app service app service public config service health indicator final app service app service this app service app service override public health health check return health up build private void check page request pageable page request of app service find all pageable 
access key util component public class access key util private static final string url separator private static final string url config prefix config private static final string url configfile json prefix configfile json private static final string url configfile prefix configfile private static final string url notification prefix notification v2 private final access key service with cache access key service with cache public access key util access key service with cache access key service with cache this access key service with cache access key service with cache public list string find available secret string app id return access key service with cache get available secret app id public string extract app id from request http servlet request request string app id null string servlet path request get servlet path if string util start with servlet path url config prefix app id string util substring between servlet path url config prefix url separator else if string util start with servlet path url configfile json prefix app id string util substring between servlet path url configfile json prefix url separator else if string util start with servlet path url configfile prefix app id string util substring between servlet path url configfile prefix url separator else if string util start with servlet path url notification prefix app id request get parameter app id return app id public string build signature string path string query string timestamp string string secret string path with query path if string be null or empty query path with query query return signature signature timestamp string path with query secret 
namespace util component public class namespace util private final app namespace service with cache app namespace service with cache public namespace util final app namespace service with cache app namespace service with cache this app namespace service with cache app namespace service with cache public string filter namespace name string namespace name if namespace name to lower case end with property int dot index namespace name last index of return namespace name substring dot index return namespace name public string normalize namespace string app id string namespace name app namespace app namespace app namespace service with cache find by app id and namespace app id namespace name if app namespace null return app namespace get name app namespace app namespace service with cache find public namespace by name namespace name if app namespace null return app namespace get name return namespace name 
watch key util component public class watch key util private static final joiner string joiner joiner on config const cluster namespace separator private final app namespace service with cache app namespace service public watch key util final app namespace service with cache app namespace service this app namespace service app namespace service assemble watch key for the give app id cluster namespace datum center combination public set string assemble all watch key string app id string cluster name string namespace string datum center multimap string string watch key map assemble all watch key app id cluster name set new hash set namespace datum center return set new hash set watch key map get namespace assemble watch key for the give app id cluster namespace datum center combination return a multimap with namespace as the key and watch key as the value public multimap string string assemble all watch key string app id string cluster name set string namespace string datum center multimap string string watch key map assemble watch key app id cluster name namespace datum center every app have a application namespace if namespace size namespace contain config const namespace application set string namespace belong to app id namespace belong to app id app id namespace set string public namespace set difference namespace namespace belong to app id listen on more namespace if it be a public namespace if public namespace be empty watch key map put all find public config watch key app id cluster name public namespace datum center return watch key map private multimap string string find public config watch key string application id string cluster name set string namespace string datum center multimap string string watch key map hash multimap create list app namespace app namespace app namespace service find public namespace by name namespace for app namespace app namespace app namespace check whether the namespace s app id equal to current one if object equal application id app namespace get app id continue string public config app id app namespace get app id watch key map put all app namespace get name assemble watch key public config app id cluster name app namespace get name datum center return watch key map private string assemble key string app id string cluster string namespace return string joiner join app id cluster namespace private set string assemble watch key string app id string cluster name string namespace string datum center if config const no appid placeholder equal ignore case app id return collection empty set set string watch key set new hash set watch specify cluster config change if object equal config const cluster name default cluster name watch key add assemble key app id cluster name namespace watch datum center config change if string be null or empty datum center object equal datum center cluster name watch key add assemble key app id datum center namespace watch default cluster config change watch key add assemble key app id config const cluster name default namespace return watch key private multimap string string assemble watch key string app id string cluster name set string namespace string datum center multimap string string watch key map hash multimap create for string namespace namespace watch key map put all namespace assemble watch key app id cluster name namespace datum center return watch key map private set string namespace belong to app id string app id set string namespace if config const no appid placeholder equal ignore case app id return collection empty set list app namespace app namespace app namespace service find by app id and namespace app id namespace if app namespace null app namespace be empty return collection empty set return app namespace stream map app namespace get name collect collector to set 
annotate bean component annotate bean public class annotate bean private static final logger logger logger factory get logger annotate bean class private int timeout private int batch private list json bean json bean apollo json value annotate on field example the default value be specify as empty list br json bean property some string hello some int some string world some int apollo json value json bean property private list json bean another json bean value batch public void set batch int batch logger info update batch old value new value this batch batch this batch batch value timeout public void set timeout int timeout logger info update timeout old value new value this timeout timeout this timeout timeout apollo json value annotate on method example the default value be specify as empty list br json bean property some string hello some int some string world some int apollo json value json bean property public void set json bean list json bean json bean logger info update json bean old value new value this json bean json bean this json bean json bean override public string to string return string format annotate bean timeout d batch d json bean s timeout batch json bean private static class json bean private string some string private int some int override public string to string return json bean some string some string some int some int 
sample redis config conditional on property redis cache enable configuration property prefix redis cache component sample redis config refresh scope public class sample redis config private static final logger logger logger factory get logger sample redis config class private int expire seconds private string cluster node private int command timeout private map string string some map map new link hash map private list string some list list new link list post construct private void initialize logger info sample redis config initialize expire seconds cluster node command timeout some map some list expire seconds cluster node command timeout some map some list public void set expire seconds int expire seconds this expire seconds expire seconds public void set cluster node string cluster node this cluster node cluster node public void set command timeout int command timeout this command timeout command timeout public map string string get some map return some map public list string get some list return some list override public string to string return string format sample redis config expire seconds d cluster node s command timeout d some map s some list s expire seconds cluster node command timeout some map some list 
spring boot apollo refresh config conditional on property redis cache enable component public class spring boot apollo refresh config private static final logger logger logger factory get logger spring boot apollo refresh config class private final sample redis config sample redis config private final refresh scope refresh scope public spring boot apollo refresh config final sample redis config sample redis config final refresh scope refresh scope this sample redis config sample redis config this refresh scope refresh scope apollo config change listener value config const namespace application t e s t1 apollo application yaml interested key prefix redi cache public void on change config change event change event logger info before refresh sample redis config to string refresh scope refresh sample redis config logger info after refresh sample redis config to string 
consumer permission validator component public class consumer permission validator private final consumer role permission service permission service private final consumer auth util consumer auth util public consumer permission validator final consumer role permission service permission service final consumer auth util consumer auth util this permission service permission service this consumer auth util consumer auth util public boolean have modify namespace permission http servlet request request string app id string namespace name string env if have create namespace permission request app id return true return permission service consumer have permission consumer auth util retrieve consumer id request permission type modify namespace role util build namespace target id app id namespace name permission service consumer have permission consumer auth util retrieve consumer id request permission type modify namespace role util build namespace target id app id namespace name env public boolean have release namespace permission http servlet request request string app id string namespace name string env if have create namespace permission request app id return true return permission service consumer have permission consumer auth util retrieve consumer id request permission type release namespace role util build namespace target id app id namespace name permission service consumer have permission consumer auth util retrieve consumer id request permission type release namespace role util build namespace target id app id namespace name env public boolean have create namespace permission http servlet request request string app id return permission service consumer have permission consumer auth util retrieve consumer id request permission type create namespace app id public boolean have create cluster permission http servlet request request string app id return permission service consumer have permission consumer auth util retrieve consumer id request permission type create cluster app id 
admin service address locator component public class admin service address locator private static final long normal refresh interval private static final long offline refresh interval private static final int retry time private static final string admin service url path service admin private static final logger logger logger factory get logger admin service address locator class private schedule executor service refresh service address service private rest template rest template private list env all env private map env list service d t o cache new concurrent hash map private final portal setting portal setting private final rest template factory rest template factory private final portal meta domain service portal meta domain service public admin service address locator final http message converter http message converter final portal setting portal setting final rest template factory rest template factory final portal meta domain service portal meta domain service this portal setting portal setting this rest template factory rest template factory this portal meta domain service portal meta domain service post construct public void init all env portal setting get all env init rest template rest template rest template factory get object refresh service address service executor new schedule thread pool apollo thread factory create service locator true refresh service address service schedule new refresh admin server address task time unit millisecond public list service d t o get service list env env list service d t o service cache get env if collection util be empty service return collection empty list list service d t o random config service list new array list service collection shuffle random config service return random config service maintain admin server address private class refresh admin server address task implement runnable override public void run boolean refresh success true refresh fail if get any env address fail for env env all env boolean current env refresh result refresh server address cache env refresh success refresh success current env refresh result if refresh success refresh service address service schedule new refresh admin server address task normal refresh interval time unit millisecond else refresh service address service schedule new refresh admin server address task offline refresh interval time unit millisecond private boolean refresh server address cache env env for int i i retry time i try service d t o service get admin server address env if service null service length continue cache put env array as list service return true catch throwable e logger error string format get admin server address from meta server fail env s meta server address s env portal meta domain service get domain env e tracer log error string format get admin server address from meta server fail env s meta server address s env portal meta domain service get domain env e return false private service d t o get admin server address env env string domain name portal meta domain service get domain env string url domain name admin service url path return rest template get for object url service d t o class 
portal config component public class portal config extend refreshable config private static final logger logger logger factory get logger portal config class private gson gson new gson private static final type organization new type token list organization get type meta server config in portal d b server config private static final type meta server new type token map string string get type private final portal d b property source portal d b property source public portal config final portal d b property source portal d b property source this portal d b property source portal d b property source override public list refreshable property source get refreshable property source return collection singleton list portal d b property source level important public list env portal support env string configuration get array property apollo portal env new string fat uat pro list env envs list new link list for string env configuration env add env add environment env return env return the relationship between environment and its meta server empty if meet exception public map string string get meta server final string key apollo portal meta server string json content get value key if null json content return collection empty map watch out that the format of content may be wrong that will cause exception map string string map collection empty map try try to parse map gson from json json content meta server catch exception e logger error wrong format with key key return map public list string super admin string super admin config get value super admin if string be null or empty super admin config return collection empty list return splitter split to list super admin config public set env email support env string configuration get array property email support envs null set env result set new hash set if configuration null configuration length return result for string env configuration result add env from string env return result public boolean be config view member only string env string config view member only env get array property config view member only env new string for string member only env config view member only env if member only env equal ignore case env return true return false level normal public int connect timeout return get int property api connect timeout public int read timeout return get int property api read timeout public list organization organization string organization get value organization return organization null collection empty list gson from json organization organization public string portal address return get value apollo portal address public boolean be emergency publish allow env env string target env env name string emergency publish support env get array property emergency publish support env new string for string support env emergency publish support env if object equal target env support env to upper case trim return true return false level low public set env publish tip support env string configuration get array property namespace publish tip support env null set env result set new hash set if configuration null configuration length return result for string env configuration result add env from string env return result public string consumer token salt return get value consumer token salt apollo portal public string email sender return get value email sender public string email template framework return get value email template framework public string email release diff module template return get value email template release module diff public string email rollback diff module template return get value email template rollback module diff public string email gray rule module template return get value email template release module rule public string wiki address return get value wiki address http github com ctripcorp apollo wiki public boolean can app admin create private namespace return get boolean property admin create private namespace switch true public boolean be create application permission enable return get boolean property system role manager service create application limit switch key false public boolean be manage app master permission enable return get boolean property system role manager service manage app master limit switch key false the follow configuration be use in ctrip profile public int app id return get int property ctrip appid send code template id apply from ewatch public string send code return get value ctrip email send code public int template id return get int property ctrip email template id email retention time in email server queue time unit hour public int survival duration return get int property ctrip email survival duration public boolean be send email async return get boolean property email send async true public string portal server name return get value server name public string cas server login url return get value ca server login url public string cas server url prefix return get value ca server url prefix public string credis service url return get value credis service url public string user service url return get value user service url public string user service access token return get value user service access token public string soa server address return get value soa server address public string clog url return get value clog server url public string clog port return get value clog server port public string herme server address return get value herme server address 
gray publish email builder component public class gray publish email builder extend config publish email builder private static final string email subject apollo private gson gson new gson private joiner ip joiner joiner on override protect string subject return email subject override public string email content env env release history b o release history string result render email common content env release history return render gray release rule content result release history override protect string get template framework return portal config email template framework override protect string get diff module template return portal config email release diff module template private string render gray release rule content string body template release history b o release history map string object context release history get operation context object rule context get rule list gray release rule item d t o rule item rule null null gson from json rule to string gson type rule item if collection util be empty rule item return body template replace all email content gray rule module br h4 h4 string builder rule html builder new string builder for gray release rule item d t o rule item rule item string client app id rule item get client app id set string ip rule item get client ip list rule html builder append b app id nbsp b append client app id append nbsp nbsp b ip nbsp b ip joiner append to rule html builder ip string gray rule module content portal config email gray rule module template replace all email content gray rule content matcher quote replacement rule html builder to string return body template replace all email content gray rule module matcher quote replacement gray rule module content 
merge email builder component public class merge email builder extend config publish email builder private static final string email subject apollo override protect string subject return email subject override protect string email content env env release history b o release history return render email common content env release history override protect string get template framework return portal config email template framework override protect string get diff module template return portal config email release diff module template 
normal publish email builder component public class normal publish email builder extend config publish email builder private static final string email subject apollo override protect string subject return email subject override protect string email content env env release history b o release history return render email common content env release history override protect string get template framework return portal config email template framework override protect string get diff module template return portal config email release diff module template 
rollback email builder component public class rollback email builder extend config publish email builder private static final string email subject apollo override protect string subject return email subject override protect string email content env env release history b o release history return render email common content env release history override protect string get template framework return portal config email template framework override protect string get diff module template return portal config email rollback diff module template 
item comparator component public class item comparator public item change set compare ignore blank and comment item long base namespace id list item d t o base item list item d t o target item list item d t o filter source item filter blank and comment item base item list item d t o filter target item filter blank and comment item target item map string item d t o source item map bean util map by key key filter source item map string item d t o target item map bean util map by key key filter target item item change set change set new item change set for item d t o item target item string key item get key item d t o source item source item map get key if source item null add item d t o copy item copy item item copy item set namespace id base namespace id change set add create item copy item else if object equal source item get value item get value update only value comment can be update source item set value item get value source item set comment item get comment change set add update item source item for item d t o item base item string key item get key item d t o target item target item map get key if target item null delete change set add delete item item return change set private list item d t o filter blank and comment item list item d t o item list item d t o result new link list if collection util be empty item return result for item d t o item item if string util be empty item get key result add item return result private item d t o copy item item d t o source item item d t o copy item new item d t o copy item set key source item get key copy item set value source item get value copy item set comment source item get comment return copy item 
permission validator component permission validator public class permission validator private final user info holder user info holder private final role permission service role permission service private final portal config portal config private final app namespace service app namespace service private final system role manager service system role manager service autowire public permission validator final user info holder user info holder final role permission service role permission service final portal config portal config final app namespace service app namespace service final system role manager service system role manager service this user info holder user info holder this role permission service role permission service this portal config portal config this app namespace service app namespace service this system role manager service system role manager service public boolean have modify namespace permission string app id string namespace name return role permission service user have permission user info holder get user get user id permission type modify namespace role util build namespace target id app id namespace name public boolean have modify namespace permission string app id string namespace name string env return have modify namespace permission app id namespace name role permission service user have permission user info holder get user get user id permission type modify namespace role util build namespace target id app id namespace name env public boolean have release namespace permission string app id string namespace name return role permission service user have permission user info holder get user get user id permission type release namespace role util build namespace target id app id namespace name public boolean have release namespace permission string app id string namespace name string env return have release namespace permission app id namespace name role permission service user have permission user info holder get user get user id permission type release namespace role util build namespace target id app id namespace name env public boolean have delete namespace permission string app id return have assign role permission app id be super admin public boolean have operate namespace permission string app id string namespace name return have modify namespace permission app id namespace name have release namespace permission app id namespace name public boolean have operate namespace permission string app id string namespace name string env return have operate namespace permission app id namespace name have modify namespace permission app id namespace name env have release namespace permission app id namespace name env public boolean have assign role permission string app id return role permission service user have permission user info holder get user get user id permission type assign role app id public boolean have create namespace permission string app id return role permission service user have permission user info holder get user get user id permission type create namespace app id public boolean have create app namespace permission string app id app namespace app namespace boolean be public app namespace app namespace be public if portal config can app admin create private namespace be public app namespace return have create namespace permission app id return be super admin public boolean have create cluster permission string app id return role permission service user have permission user info holder get user get user id permission type create cluster app id public boolean be app admin string app id return be super admin have assign role permission app id public boolean be super admin return role permission service be super admin user info holder get user get user id public boolean should hide config to current user string app id string env string namespace name check whether the current environment enable member only function if portal config be config view member only env return false public namespace be open to every one app namespace app namespace app namespace service find by app id and name app id namespace name if app namespace null app namespace be public return false check app admin and operate permission return be app admin app id have operate namespace permission app id namespace name env public boolean have create application permission return have create application permission user info holder get user get user id public boolean have create application permission string user id return system role manager service have create application permission user id public boolean have manage app master permission string app id the manage app master permission might not be initialize so we need to check be super admin first return be super admin have assign role permission app id system role manager service have manage app master permission user info holder get user get user id app id 
portal setting component public class portal setting private static final logger logger logger factory get logger portal setting class private static final int health check interval private final application context application context private final portal config portal config private final portal meta domain service portal meta domain service private list env all env new array list mark env up or down private map env boolean env status mark new concurrent hash map public portal setting final application context application context final portal config portal config final portal meta domain service portal meta domain service this application context application context this portal config portal config this portal meta domain service portal meta domain service post construct private void post construct all env portal config portal support env for env env all env env status mark put env true schedule executor service health check service executor new schedule thread pool apollo thread factory create env health checker true health check service schedule with fix delay new health check task application context health check interval time unit millisecond public list env get all env return all envs public list env get active env list env active env new link list for env env all env if env status mark get env active env add env return active env public boolean be env active env env boolean mark env status mark get env return mark null false mark private class health check task implement runnable private static final int env down threshold private map env integer health check fail counter new hash map private admin service a p i health a p i health a p i public health check task application context context health a p i context get bean admin service a p i health a p i class for env env all env health check fail counter put env public void run for env env all env try if be up env revive if env status mark get env env status mark put env true health check fail counter put env logger info env revive because env health check success env env else logger error env health check fail maybe because of admin server down env meta server address env portal meta domain service get domain env handle env down env catch exception e logger error env health check fail maybe because of meta server down or configure wrong meta server address env meta server address env portal meta domain service get domain env e handle env down env private boolean be up env env health health health a p i health env return up equal health get status get code private void handle env down env env int fail time health check fail counter get env health check fail counter put env fail time if env status mark get env logger error env be down env fail time meta server address env fail time portal meta domain service get domain env else if fail time env down threshold env status mark put env false logger error env be down because health check fail for time which equal to down threshold env meta server address env down threshold env portal meta domain service get domain env else logger error env health check fail for time which less than down threshold down threshold env meta server address fail time env down threshold env portal meta domain service get domain env 
rest template factory component public class rest template factory implement factory bean rest template initialize bean autowired private http message converter http message converter autowire private portal config portal config private rest template rest template public rest template get object return rest template public class rest template get object type return rest template class public boolean be singleton return true public void after property set throw unsupported encode exception closeable http client http client http client builder create build rest template new rest template http message converter get converter http component client http request factory request factory new http component client http request factory http client request factory set connect timeout portal config connect timeout request factory set read timeout portal config read timeout rest template set request factory request factory 
retryable rest template component public class retryable rest template private logger logger logger factory get logger retryable rest template class private uri template handler uri template handler new default uri builder factory private rest template rest template private final rest template factory rest template factory private final admin service address locator admin service address locator private final portal meta domain service portal meta domain service public retryable rest template final lazy rest template factory rest template factory final lazy admin service address locator admin service address locator final portal meta domain service portal meta domain service this rest template factory rest template factory this admin service address locator admin service address locator this portal meta domain service portal meta domain service post construct private void post construct rest template rest template factory get object public t t get env env string path class t response type object url variable throw rest client exception return execute http method get env path null response type url variable public t response entity t get env env string path parameterize type reference t reference object uri variable throw rest client exception return exchange get env path reference uri variable public t t post env env string path object request class t response type object uri variable throw rest client exception return execute http method post env path request response type uri variable public void put env env string path object request object url variable throw rest client exception execute http method put env path request null url variable public void delete env env string path object url variable throw rest client exception execute http method delete env path null null url variable private t t execute http method method env env string path object request class t response type object uri variable if path start with path path substring path length string uri uri template handler expand path uri variable get path transaction ct tracer new transaction admin a p i uri ct add datum env env list service d t o service get admin service env ct for service d t o service d t o service try t result do execute method service d t o path request response type uri variable ct set status transaction success ct complete return result catch throwable t logger error http request fail uri method uri method t tracer log error t if can retry t method tracer log event tracer event type api retry uri else biz exception rethrow ct set status t ct complete throw t all admin server down service exception e new service exception string format admin server be unresponsive meta server address s admin server s portal meta domain service get domain env service ct set status e ct complete throw e private t response entity t exchange get env env string path parameterize type reference t reference object uri variable if path start with path path substring path length string uri uri template handler expand path uri variable get path transaction ct tracer new transaction admin a p i uri ct add datum env env list service d t o service get admin service env ct for service d t o service d t o service try response entity t result rest template exchange parse host service d t o path http method get null reference uri variable ct set status transaction success ct complete return result catch throwable t logger error http request fail uri method uri http method get t tracer log error t if can retry t http method get tracer log event tracer event type api retry uri else biz exception rethrow ct set status t ct complete throw t all admin server down service exception e new service exception string format admin server be unresponsive meta server address s admin server s portal meta domain service get domain env service ct set status e ct complete throw e private list service d t o get admin service env env transaction ct list service d t o service admin service address locator get service list env if collection util be empty service service exception e new service exception string format no available admin server maybe because of meta server down or all admin server down meta server address s portal meta domain service get domain env ct set status e ct complete throw e return service private t t do execute http method method service d t o service string path object request class t response type object uri variable t result null switch method case get result rest template get for object parse host service path response type uri variable break case post result rest template post for entity parse host service path request response type uri variable get body break case put rest template put parse host service path request uri variable break case delete rest template delete parse host service path uri variable break default throw new unsupported operation exception string format unsupported http method method s method return result private string parse host service d t o service address return service address get homepage url post delete put admin server private boolean can retry throwable e http method method throwable nest exception e get cause if method http method get return nest exception instanceof socket timeout exception nest exception instanceof http host connect exception nest exception instanceof connect timeout exception return nest exception instanceof http host connect exception nest exception instanceof connect timeout exception 
file text resolver component file text resolver public class file text resolver implement config text resolver override public item change set resolve long namespace id string config text list item d t o base item item change set change set new item change set if collection util be empty base item string util be empty config text return change set if collection util be empty base item change set add create item create item namespace id config text else item d t o before item base item get if config text equal before item get value update change set add update item create item namespace id before item get id config text return change set private item d t o create item long namespace id long item id string value item d t o item new item d t o item set id item id item set namespace id namespace id item set value value item set line num item set key config const config file content key return item 
property resolver component property resolver public class property resolver implement config text resolver private static final string kv separator private static final string item separator n override public item change set resolve long namespace id string config text list item d t o base item map integer item d t o old line num map item bean util map by key line num base item map string item d t o old key map item bean util map by key key base item remove comment and blank item map old key map item remove string new item config text split item separator if be have repeat key new item throw new bad request exception config text have repeat key please check item change set change set new item change set map integer string new line num map item new hash map use for delete blank and comment item int line counter for string new item new item new item new item trim new line num map item put line counter new item item d t o old item by line old line num map item get line counter comment item if be comment item new item handle comment line namespace id old item by line new item line counter change set blank item else if be blank item new item handle blank line namespace id old item by line line counter change set normal item else handle normal line namespace id old key map item new item line counter change set line counter delete comment and blank item old line num map item new line num map item change set delete normal k v item old key map item change set return change set private boolean be have repeat key string new item set string key new hash set int line counter int key count for string item new item if be comment item item be blank item item key count string kv parse key value from item item if kv null key add kv to lower case else throw new bad request exception line line counter key value must separate by line counter return key count key size private string parse key value from item string item int kv separator item index of kv separator if kv separator return null string kv new string kv item substr kv separator trim kv item substr kv separator item length trim return kv private void handle comment line long namespace id item d t o old item by line string new item int line counter item change set change set string old comment old item by line null old item by line get comment create comment implement update comment by delete old comment and create new comment if be comment item old item by line new item equal old comment change set add create item build comment item 0l namespace id new item line counter private void handle blank line long namespace id item d t o old item int line counter item change set change set if be blank item old item change set add create item build blank item 0l namespace id line counter private void handle normal line long namespace id map string item d t o key map old item string new item int line counter item change set change set string kv parse key value from item new item if kv null throw new bad request exception line line counter key value must separate by string new key kv string new value kv replace n n handle user input n item d t o old item key map old item get new key if old item null new item change set add create item build normal item 0l namespace id new key new value line counter else if new value equal old item get value line counter old item get line num update item change set add update item build normal item old item get id namespace id new key new value old item get comment line counter key map old item remove new key private boolean be comment item item d t o item return item null equal item get key item get comment start with item get comment start with private boolean be comment item string line return line null line start with line start with private boolean be blank item item d t o item return item null equal item get key equal item get comment private boolean be blank item string line return string null to empty line trim be empty private void delete normal k v item map string item d t o base key map item item change set change set surplus item be to be delete for map entry string item d t o entry base key map item entry set change set add delete item entry get value private void delete comment and blank item map integer item d t o old line num map item map integer string new line num map item item change set change set for map entry integer item d t o entry old line num map item entry set int line num entry get key item d t o old item entry get value string new item new line num map item get line num old be blank by now be not old be comment by now be not exist or modify if be blank item old item be blank item new item be comment item old item new item null new item equal old item get comment change set add delete item old item private item d t o build comment item long id long namespace id string comment int line num return build normal item id namespace id comment line num private item d t o build blank item long id long namespace id int line num return build normal item id namespace id line num private item d t o build normal item long id long namespace id string key string value string comment int line num item d t o item new item d t o key value comment line num item set id id item set namespace id namespace id return item 
app info change listener component public class app info change listener private static final logger logger logger factory get logger app info change listener class private final admin service a p i app a p i app a p i private final portal setting portal setting public app info change listener final admin service a p i app a p i app a p i final portal setting portal setting this app a p i app a p i this portal setting portal setting event listener public void on app info change app info change event event app d t o app d t o bean util transform app d t o class event get app string app id app d t o get app id list env envs portal setting get active env for env env envs try app a p i update app env app d t o catch throwable e logger error update app s info fail env app id env app id e tracer log error string format update app s info fail env s app id s env app id e 
config publish listener component public class config publish listener private final release history service release history service private final email service email service private final normal publish email builder normal publish email builder private final gray publish email builder gray publish email builder private final rollback email builder rollback email builder private final merge email builder merge email builder private final portal config portal config private final m q service mq service private executor service executor service public config publish listener final release history service release history service final email service email service final normal publish email builder normal publish email builder final gray publish email builder gray publish email builder final rollback email builder rollback email builder final merge email builder merge email builder final portal config portal config final m q service mq service this release history service release history service this email service email service this normal publish email builder normal publish email builder this gray publish email builder gray publish email builder this rollback email builder rollback email builder this merge email builder merge email builder this portal config portal config this mq service mq service post construct public void init executor service executor new single thread executor apollo thread factory create config publish notify true event listener public void on config publish config publish event event executor service submit new config publish notify task event get config publish info private class config publish notify task implement runnable private config publish event config publish info publish info config publish notify task config publish event config publish info publish info this publish info publish info override public void run release history b o release history get release history if release history null tracer log error load release history fail null return send publish email release history send publish msg release history private release history b o get release history env env publish info get env int operation publish info be merge event release operation gray release merge to master publish info be rollback event release operation rollback publish info be normal publish event release operation normal release publish info be gray publish event release operation gray release if operation return null if publish info be rollback event return release history service find latest by previous release id and operation env publish info get previous release id operation return release history service find latest by release id and operation env publish info get release id operation private void send publish email release history b o release history env env publish info get env if portal config email support envs contain env return int real operation release history get operation email email null try email build email env release history real operation catch throwable e tracer log error build email fail e if email null email service send email private void send publish msg release history b o release history mq service send publish msg publish info get env release history private email build email env env release history b o release history int operation switch operation case release operation gray release return gray publish email builder build env release history case release operation normal release return normal publish email builder build env release history case release operation rollback return rollback email builder build env release history case release operation gray release merge to master return merge email builder build env release history default return null 
creation listener component public class creation listener private static logger logger logger factory get logger creation listener class private final portal setting portal setting private final admin service a p i app a p i app a p i private final admin service a p i namespace a p i namespace a p i public creation listener final portal setting portal setting final admin service a p i app a p i app a p i final admin service a p i namespace a p i namespace a p i this portal setting portal setting this app a p i app a p i this namespace a p i namespace a p i event listener public void on app creation event app creation event event app d t o app d t o bean util transform app d t o class event get app list env envs portal setting get active env for env env envs try app a p i create app env app d t o catch throwable e logger error create app fail app id env app d t o get app id env e tracer log error string format create app fail app id s env s app d t o get app id env e event listener public void on app namespace creation event app namespace creation event event app namespace d t o app namespace bean util transform app namespace d t o class event get app namespace list env envs portal setting get active env for env env envs try namespace a p i create app namespace env app namespace catch throwable e logger error create app namespace fail app id env app namespace get app id env e tracer log error string format create app namespace fail app id s env s app namespace get app id env e 
deletion listener component public class deletion listener private static final logger logger logger factory get logger deletion listener class private final portal setting portal setting private final admin service a p i app a p i app a p i private final admin service a p i namespace a p i namespace a p i public deletion listener final portal setting portal setting final admin service a p i app a p i app a p i final admin service a p i namespace a p i namespace a p i this portal setting portal setting this app a p i app a p i this namespace a p i namespace a p i event listener public void on app deletion event app deletion event event app d t o app d t o bean util transform app d t o class event get app string app id app d t o get app id string operator app d t o get datum change last modify by list env envs portal setting get active env for env env envs try app a p i delete app env app id operator catch throwable e logger error delete app fail env app id env app id e tracer log error string format delete app fail env s app id s env app id e event listener public void on app namespace deletion event app namespace deletion event event app namespace d t o app namespace bean util transform app namespace d t o class event get app namespace list env envs portal setting get active env string app id app namespace get app id string namespace name app namespace get name string operator app namespace get datum change last modify by for env env envs try namespace a p i delete app namespace env app id namespace name operator catch throwable e logger error delete app namespace fail app id namespace env app id namespace name env e tracer log error string format delete app namespace fail app id s namespace s env s app id namespace name env e 
portal d b property source component public class portal d b property source extend refreshable property source private static final logger logger logger factory get logger portal d b property source class autowire private server config repository server config repository public portal d b property source string name map string object source super name source public portal d b property source super d b config map new concurrent map override protect void refresh iterable server config db config server config repository find all for server config config db config string key config get key object value config get value if this source be empty logger info load config from db key value else if object equal this source get key value logger info load config from db old value key value this source get key this source put key value 
biz log customizer component profile ctrip public class biz log customizer extend log customizer private final portal config portal config public biz log customizer final portal config portal config this portal config portal config override protect string clog url return portal config clog url override protect string clog port return portal config clog port 
address server generator manager component public class address server generator manager generate product name param name name return product public string generate product name string name if string util be blank name address server constant default product equal name return address server constant aliware naco default product name return string format address server constant aliware naco product dom template name note if the parameter input be empty then will return the empty list param service name service name param cluster name cluster name param ip array array of ips return instance list public list instance generate instance by ip string service name string raw product name string cluster name string ip array if string util be empty service name string util be empty cluster name ip array null ip array length return collection empty list list instance instance list new array list ip array length for string ip ip array string ip and port generate ip and port ip instance instance new instance instance set ip ip and port instance set port integer parse int ip and port instance set cluster name cluster name instance set service name service name instance set tenant constant default namespace id instance set app raw product name instance set ephemeral false instance list add instance return instance list private string generate ip and port string ip int index ip index of address server constant ip port separator if index return new string ip substr index ip substr index return new string ip string value of address server constant default server port generate response ip param instance list a instance set will generate string response to client return the result of response to client public string generate response ip list instance instance list string builder ip new string builder instance list for each instance ip append instance get ip instance get port ip append n return ip to string generate naco service name param raw service name the raw service name will not contain the link constant default group return the naco service name public string generate naco service name string raw service name if raw service name index of constant default group return raw service name return constant default group address server constant group service name sep raw service name 
address server manager component public class address server manager public string get raw product name string name if string util be blank name address server constant default product equal name return address server constant default product return name if the name be empty then return the default link util and common default cluster name or return the source name by input param name name return default cluster name public string get default cluster name if empty string name if string util be empty name address server constant default get cluster equal name return address server constant default get cluster return name public string get raw cluster name string name return get default cluster name if empty name split ip param ip multi ip will separator by the return array of ip public string split ip string ip if string util be blank ips return new string return ip split address server constant multi ip separator 
switch and option component public class switch and option value naco cmdb dump task interval private int dump task interval value naco cmdb event task interval private int event task interval value naco cmdb label task interval private int label task interval value naco cmdb load datum at start false private boolean load datum at start public int get dump task interval return dump task interval public int get event task interval return event task interval public int get label task interval return label task interval public boolean be load datum at start return load datum at start 
cmdb provider component public class cmdb provider implement cmdb reader cmdb writer autowire private switch and option switch private cmdb service cmdb service private final service loader cmdb service service loader service loader load cmdb service class private map string map string entity entity map new concurrent hash map private map string label label map new concurrent hash map private set string entity type set new hash set private long event timestamp system current time millis public cmdb provider throw naco exception private void init cmdb service throw naco exception iterator cmdb service iterator service loader iterator if iterator have next cmdb service iterator next if cmdb service null switch be load datum at start throw new naco exception naco exception server error can not initialize cmdb service load datum public void load if switch be load datum at start return init label map set string label name cmdb service get label name if label name null label name be empty logger main warn load init label name fail else for string label name label name if get null label it be still ok we will try it later when we meet this label label map put label name cmdb service get label label name init entity type set entity type set cmdb service get entity type init entity map entity map cmdb service get all entity init call by spring throw naco exception naco exception post construct public void init throw naco exception init cmdb service load cmdb executor schedule cmdb task new cmdb dump task switch get dump task interval time unit seconds cmdb executor schedule cmdb task new cmdb label task switch get label task interval time unit seconds cmdb executor schedule cmdb task new cmdb event task switch get event task interval time unit seconds override public entity query entity string entity name string entity type if entity map contain key entity type return null return entity map get entity type get entity name override public string query label string entity name string entity type string label name entity entity query entity entity name entity type if entity null return null return entity get label get label name override public list entity query entity by label string label name string label value throw new unsupported operation exception not available now remove cmdb entity param entity name entity name param entity type entity type public void remove entity string entity name string entity type if entity map contain key entity type return entity map get entity type remove entity name update entity param entity entity public void update entity entity entity if entity type set contain entity get type return entity map get entity get type put entity get name entity public class cmdb label task implement runnable override public void run logger main debug label task start dump if cmdb service null return try map string label tmp label map new hash map set string label name cmdb service get label name if label name null label name be empty logger main warn cmdb label task load label name fail else for string label name label name if get null label it be still ok we will try it later when we meet this label tmp label map put label name cmdb service get label label name if logger main be debug enable logger main debug label task get label map jackson util to json tmp label map label map tmp label map catch exception e logger main error cmdb label task dump fail e finally cmdb executor schedule cmdb task this switch get label task interval time unit seconds public class cmdb dump task implement runnable override public void run try logger main debug dump task start dump if cmdb service null return refresh entity map entity map cmdb service get all entity catch exception e logger main error dump task dump fail e finally cmdb executor schedule cmdb task this switch get dump task interval time unit seconds public class cmdb event task implement runnable override public void run try logger main debug event task start dump if cmdb service null return long current system current time millis list entity event event cmdb service get entity event event timestamp event timestamp current if logger main be debug enable logger main debug event task get event size event jackson util to json event if event null event be empty for entity event event event switch event get type case entity remove remove entity event get entity name event get entity type break case entity add or update update entity cmdb service get entity event get entity name event get entity type break default break catch exception e logger main error cmdb event event task fail e finally cmdb executor schedule cmdb task this switch get event task interval time unit seconds 
request log aspect aspect component public class request log aspect publish config private static final string client interface publish single config execution com alibaba naco config server controller config controller publish config arg request response datum id group tenant content get config private static final string client interface get config execution com alibaba naco config server controller config controller get config arg request response datum id group tenant remove config private static final string client interface remove all config execution com alibaba naco config server controller config controller delete config arg request response datum id group tenant publish single around client interface publish single config public object interface publish single proceeding join point pjp http servlet request request http servlet response response string datum id string group string tenant string content throw throwable final string md5 content null null m d5 util md5 hex content constant encode metric monitor get publish monitor increment and get return log client request publish pjp request response datum id group tenant md5 remove all around client interface remove all config public object interface remove all proceeding join point pjp http servlet request request http servlet response response string datum id string group string tenant throw throwable return log client request remove pjp request response datum id group tenant null get config around client interface get config public object interface get config proceeding join point pjp http servlet request request http servlet response response string datum id string group string tenant throw throwable final string group key group key2 get key datum id group tenant final string md5 config cache service get content md5 group key metric monitor get config monitor increment and get return log client request get pjp request response datum id group tenant md5 client api request log rt status request ip op type datum id group datum id md5 private object log client request string request type proceed join point pjp http servlet request request http servlet response response string datum id string group string tenant string md5 throw throwable final string request ip request util get remote ip request string app name request get header request util client appname header final long st system current time millis object ret val pjp proceed final long rt system current time millis st rt status request ip op type datum id group datum id md5 app name log util client log info rt ret val request ip request type datum id group tenant md5 app name return ret val 
embed permission persist service impl conditional value condition on embed storage class component public class embed permission persist service impl implement permission persist service autowired private database operate database operate autowired private embed storage persist service impl persist service public page permission info get permission string role int page no int page size pagination helper permission info helper persist service create pagination helper string sql count row select count from permission where string sql fetch row select role resource action from permission where string where role role if string util be blank role where 1 = 1 page permission info page info helper fetch page sql count row where sql fetch row where new array list string to array page no page size permission row mapper if page info null page info new page page info set total count page info set page item new array list return page info execute ddd user permission operation param role role info string value param resource resource info string value param action action info string value public void add permission string role string resource string action string sql insert into permission role resource action value embed storage context util add sql context sql role resource action database operate block update execute delete user permission operation param role role info string value param resource resource info string value param action action info string value public void delete permission string role string resource string action string sql delete from permission where role and resource and action embed storage context util add sql context sql role resource action database operate block update 
embed role persist service impl conditional value condition on embed storage class component public class embed role persist service impl implement role persist service autowired private database operate database operate autowired private embed storage persist service impl persist service public page role info get role int page no int page size pagination helper role info helper persist service create pagination helper string sql count row select count from select distinct role from role role where string sql fetch row select role username from role where string where 1 = 1 page role info page info helper fetch page sql count row where sql fetch row where new array list string to array page no page size role info row mapper if page info null page info new page page info set total count page info set page item new array list return page info public page role info get role by user name string username int page no int page size pagination helper role info helper persist service create pagination helper string sql count row select count from role where string sql fetch row select role username from role where string where username username if string util be blank username where 1 = 1 return helper fetch page sql count row where sql fetch row where new array list string to array page no page size role info row mapper add user role param role role string value param user name username string value public void add role string role string user name string sql insert into role role username value try embed storage context util add sql context sql role user name database operate update embed storage context util get current sql context finally embed storage context util clean all context delete user role param role role string value public void delete role string role string sql delete from role where role try embed storage context util add sql context sql role database operate update embed storage context util get current sql context finally embed storage context util clean all context execute delete role sql operation param role role string value param username user string value public void delete role string role string username string sql delete from role where role and username try embed storage context util add sql context sql role username database operate update embed storage context util get current sql context finally embed storage context util clean all context 
embed user persist service impl conditional value condition on embed storage class component public class embed user persist service impl implement user persist service autowired private database operate database operate autowired private embed storage persist service impl persist service execute create user operation param username username string value param password password string value public void create user string username string password string sql insert into user username password enable value try embed storage context util add sql context sql username password true database operate block update finally embed storage context util clean all context execute delete user operation param username username string value public void delete user string username string sql delete from user where username try embed storage context util add sql context sql username database operate block update finally embed storage context util clean all context execute update user password operation param username username string value param password password string value public void update user password string username string password try embed storage context util add sql context update user set password where username password username database operate block update finally embed storage context util clean all context public user find user by username string username string sql select username password from user where username return database operate query one sql new object username user row mapper public page user get user int page no int page size pagination helper user helper persist service create pagination helper string sql count row select count from user where string sql fetch row select username password from user where string where 1 = 1 page user page info helper fetch page sql count row where sql fetch row where new array list string to array page no page size user row mapper if page info null page info new page page info set total count page info set page item new array list return page info 
external permission persist service impl conditional value condition on external storage class component public class external permission persist service impl implement permission persist service autowired private external storage persist service impl persist service private jdbc template jt post construct protect void init jt persist service get jdbc template public page permission info get permission string role int page no int page size pagination helper permission info helper persist service create pagination helper string sql count row select count from permission where string sql fetch row select role resource action from permission where string where role role if string util be blank role where 1 = 1 try page permission info page info helper fetch page sql count row where sql fetch row where new array list string to array page no page size permission row mapper if page info null page info new page page info set total count page info set page item new array list return page info catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute add permission operation param role role string value param resource resource string value param action action string value public void add permission string role string resource string action string sql insert into permission role resource action value try jt update sql role resource action catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute delete permission operation param role role string value param resource resource string value param action action string value public void delete permission string role string resource string action string sql delete from permission where role and resource and action try jt update sql role resource action catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e 
external role persist service impl conditional value condition on external storage class component public class external role persist service impl implement role persist service autowired private external storage persist service impl persist service private jdbc template jt post construct protect void init jt persist service get jdbc template public page role info get role int page no int page size pagination helper role info helper persist service create pagination helper string sql count row select count from select distinct role from role role where string sql fetch row select role username from role where string where 1 = 1 try page role info page info helper fetch page sql count row where sql fetch row where new array list string to array page no page size role info row mapper if page info null page info new page page info set total count page info set page item new array list return page info catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e public page role info get role by user name string username int page no int page size pagination helper role info helper persist service create pagination helper string sql count row select count from role where string sql fetch row select role username from role where string where username username if string util be blank username where 1 = 1 try return helper fetch page sql count row where sql fetch row where new array list string to array page no page size role info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute add role operation param role role string value param user name username string value public void add role string role string user name string sql insert into role role username value try jt update sql role user name catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute delete role operation param role role string value public void delete role string role string sql delete from role where role try jt update sql role catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute delete role operation param role role string value param username username string value public void delete role string role string username string sql delete from role where role and username try jt update sql role username catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e private static final class role info row mapper implement row mapper role info override public role info map row result set rs int row num throw s q l exception role info role info new role info role info set role rs get string role role info set username rs get string username return role info 
external user persist service impl conditional value condition on external storage class component public class external user persist service impl implement user persist service autowired private external storage persist service impl persist service private jdbc template jt post construct protect void init jt persist service get jdbc template execute create user operation param username username string value param password password string value public void create user string username string password string sql insert into user username password enable value try jt update sql username password true catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute delete user operation param username username string value public void delete user string username string sql delete from user where username try jt update sql username catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute update user password operation param username username string value param password password string value public void update user password string username string password try jt update update user set password where username password username catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e execute find user by username operation param username username string value return user model public user find user by username string username string sql select username password from user where username try return this jt query for object sql new object username user row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e catch empty result datum access exception e return null catch exception e log util fatal log error db other error e get message e throw new runtime exception e public page user get user int page no int page size pagination helper user helper persist service create pagination helper string sql count row select count from user where string sql fetch row select username password from user where string where 1 = 1 try page user page info helper fetch page sql count row where sql fetch row where new array list string to array page no page size user row mapper if page info null page info new page page info set total count page info set page item new array list return page info catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e 
embed dump service conditional condition on embed storage class component public class embed dump service extend dump service private final protocol manager protocol manager if it be just a normal reading failure it can be resolve by retry final string retry message new string the conformance protocol be temporarily unavailable for read if the read fail due to a internal problem in the raft state machine it can not be remedy by retry final string error message new string f s m caller be overload state error here you inject the dependent object constructively ensure that some of the dependent functionality be initialize ahead of time param persist service link persist service param member manager link server member manager param protocol manager link protocol manager public embed dump service persist service persist service server member manager member manager protocol manager protocol manager super persist service member manager this protocol manager protocol manager post construct override protect void init throw throwable if application util get standalone mode dump operate processor dump all processor dump all beta processor dump all tag processor return c p protocol protocol protocol manager get cp protocol atomic reference throwable error reference new atomic reference null count down latch wait dump finish new count down latch watch path naco config leader have value observer observer new observer override public void update observable o object arg global executor execute by common must make sure that there be a value here to perform the correct operation that follow if object be null arg return identify without a timeout mechanism embed storage context util put extend info constant extend need read until have datum true remove you own listening to avoid task accumulation boolean can end false for try dump operate processor dump all processor dump all beta processor dump all tag processor protocol protocol meta datum un subscribe constant config model raft group metadata key leader meta datum this can end true catch throwable ex if should retry ex error reference set ex can end true if can end thread util count down wait dump finish break thread util sleep l embed storage context util clean all context protocol protocol meta datum subscribe constant config model raft group metadata key leader meta datum observer we must wait for the dump task to complete the callback operation before continue with the initialization thread util latch await wait dump finish if a exception occur during the execution of the dump task the exception need to be throw trigger the node to start the failed process final throwable ex error reference get if object non null ex throw ex private boolean should retry throwable ex final string err msg ex get message for string fail msg error message if string util contain ignore case err msg fail msg return false for final string retry msg retry message if string util contain ignore case err msg retry msg return true return false override protect boolean can execute if application util get standalone mode return true if be derby raft mode only leader can execute c p protocol protocol protocol manager get cp protocol return protocol be leader constant config model raft group 
external dump service conditional condition on external storage class component public class external dump service extend dump service here you inject the dependent object constructively ensure that some of the dependent functionality be initialize ahead of time param persist service link persist service param member manager link server member manager public external dump service persist service persist service server member manager member manager super persist service member manager post construct override protect void init throw throwable dump operate processor dump all processor dump all beta processor dump all tag processor override protect boolean can execute return member manager be first ip 
distribute database operate impl conditional condition distribute embed storage class component suppress warning unchecked public class distribute database operate impl extend log processor4 c p implement base database operate the datum import operation be dedicated key which act as a identifier private static final string datum import key datum import private server member manager member manager private c p protocol protocol private local datum source service impl datum source service private jdbc template jdbc template private transaction template transaction template private serializer serializer serialize factory get default private reentrant read write lock lock new reentrant read write lock private reentrant read write lock read lock read lock lock read lock private reentrant read write lock write lock write lock lock write lock public distribute database operate impl server member manager member manager protocol manager protocol manager throw exception this member manager member manager this protocol protocol manager get cp protocol init protect void init throw exception this data source service local datum source service impl dynamic datum source get instance get datum source because in raft derby mode ensure datum consistency depend on the raft s log playback and snapshot recovery capability and the last datum must be clear this data source service clean and reopen derby this jdbc template datum source service get jdbc template this transaction template datum source service get transaction template register a derby raft state machine failure event for node degradation processing notify center register to share publisher raft db error event class register the snapshot load event notify center register to share publisher derby load event class notify center register subscriber new subscriber raft db error event override public void on event raft db error event event datum source service set health status down override public class extend event subscribe type return raft db error event class notify center register to publisher config dump event class notify center ring buffer size notify center register subscriber new dump config handler this protocol add log processor collection singleton list this log util default log info use distribute transaction service impl just for test public void mock consistency protocol c p protocol protocol this protocol protocol override public r r query one string sql class r cl try logger util print if debug enable log util default log query one info sql sql byte datum serializer serialize select request builder query type query type query one no mapper no arg sql sql class name cl get canonical name build final boolean block read embed storage context util contain extend info constant extend need read until have datum response response inner read get request new builder set group group set datum byte string copy from datum build block read if response get success return serializer deserialize response get datum to byte array cl throw new n jdbc exception response get err msg response get err msg catch exception e log util fatal log error a exception occur during the query operation e to string throw new naco runtime exception naco exception server error e to string override public r r query one string sql object arg class r cl try logger util print if debug enable log util default log query one info sql arg sql arg byte datum serializer serialize select request builder query type query type query one no mapper with arg sql sql arg args class name cl get canonical name build final boolean block read embed storage context util contain extend info constant extend need read until have datum response response inner read get request new builder set group group set datum byte string copy from datum build block read if response get success return serializer deserialize response get datum to byte array cl throw new n jdbc exception response get err msg response get err msg catch exception e log util fatal log error a exception occur during the query operation e to string throw new naco runtime exception naco exception server error e to string override public r r query one string sql object arg row mapper r mapper try logger util print if debug enable log util default log query one info sql arg sql arg byte datum serializer serialize select request builder query type query type query one with mapper with arg sql sql arg args class name mapper get class get canonical name build final boolean block read embed storage context util contain extend info constant extend need read until have datum response response inner read get request new builder set group group set datum byte string copy from datum build block read if response get success return serializer deserialize response get datum to byte array class util resolve generic type by interface mapper get class throw new n jdbc exception response get err msg response get err msg catch exception e log util fatal log error a exception occur during the query operation e to string throw new naco runtime exception naco exception server error e to string override public r list r query many string sql object arg row mapper r mapper try logger util print if debug enable log util default log query many info sql arg sql arg byte datum serializer serialize select request builder query type query type query many with mapper with arg sql sql arg args class name mapper get class get canonical name build final boolean block read embed storage context util contain extend info constant extend need read until have datum response response inner read get request new builder set group group set datum byte string copy from datum build block read if response get success return serializer deserialize response get datum to byte array list class throw new n jdbc exception response get err msg catch exception e log util fatal log error a exception occur during the query operation e to string throw new naco runtime exception naco exception server error e to string override public r list r query many string sql object arg class be r class try logger util print if debug enable log util default log query many info sql arg sql arg byte datum serializer serialize select request builder query type query type query many no mapper with arg sql sql arg args class name r class get canonical name build final boolean block read embed storage context util contain extend info constant extend need read until have datum response response inner read get request new builder set group group set datum byte string copy from datum build block read if response get success return serializer deserialize response get datum to byte array list class throw new n jdbc exception response get err msg catch exception e log util fatal log error a exception occur during the query operation e to string throw new naco runtime exception naco exception server error e to string override public list map string object query many string sql object arg try logger util print if debug enable log util default log query many info sql arg sql arg byte datum serializer serialize select request builder query type query type query many with list with arg sql sql arg arg build final boolean block read embed storage context util contain extend info constant extend need read until have datum response response inner read get request new builder set group group set datum byte string copy from datum build block read if response get success return serializer deserialize response get datum to byte array list class throw new n jdbc exception response get err msg catch exception e log util fatal log error a exception occur during the query operation e to string throw new naco runtime exception naco exception server error e to string in some business situation you need to avoid the timeout issue so block read be use to determine this param request link get request param block read be async read operation return link response throw exception exception private response inner read get request request boolean block read throw exception if block read return response protocol a get datum request join return protocol get datum request override public completable future rest result string datum import file file return completable future supply async try disk util line iterator iterator disk util line iterator file int batch size list string batch update new array list batch size list completable future response future new array list while iterator have next string sql iterator next if string util be not blank sql batch update add sql boolean submit batch update size batch size iterator have next if submit list modify request request batch update stream map modify request new collect collector to list completable future response future protocol submit async log new builder set group group set datum byte string copy from serializer serialize request put extend info datum import key boolean true to string build future add future batch update clear completable future all of future to array new completable future join for completable future response future future response response future get if response get success return rest result util fail response get err msg return rest result util success catch throwable ex log util default log error datum import have error ex return rest result util fail ex get message override public boolean update list modify request sql context bi consumer boolean throwable consumer try since the sql parameter be object in order to ensure that the type of array element be not lose the serialization here be do use the java specific serialization framework rather than continue with the protobuff logger util print if debug enable log util default log modify request info sql context timestamp group ip port signature final string key system current time millis group member manager get self get address m d5 util md5 hex sql context to string constant encode log log log new builder set group group set key key set datum byte string copy from serializer serialize sql context put all extend info embed storage context util get current extend info set type sql context get class get canonical name build if object be null consumer response response this protocol submit log if response get success return true log util default log error execute sql modify operation fail response get err msg return false else this protocol submit async log when complete bi consumer response throwable response ex string err msg object be null ex response get err msg exception util get cause ex get message consumer accept response get success string util be blank err msg null new n jdbc exception err msg return true catch timeout exception e log util fatal log error a timeout exception occur during the update operation throw new naco runtime exception naco exception server error e to string catch throwable e log util fatal log error a exception occur during the update operation e throw new naco runtime exception naco exception server error e to string override public list snapshot operation load snapshot operate return collection singleton list new derby snapshot operation write lock suppress warning all override public response on request final get request request final select request select request serializer deserialize request get datum to byte array select request class logger util print if debug enable log util default log get datum info select request select request final row mapper object mapper row mapper manager get row mapper select request get class name final byte type select request get query type read lock lock object datum try switch type case query type query one with mapper with arg datum query one jdbc template select request get sql select request get arg mapper break case query type query one no mapper no arg datum query one jdbc template select request get sql class util find class by name select request get class name break case query type query one no mapper with arg datum query one jdbc template select request get sql select request get arg class util find class by name select request get class name break case query type query many with mapper with arg datum query many jdbc template select request get sql select request get arg mapper break case query type query many with list with arg datum query many jdbc template select request get sql select request get arg break case query type query many no mapper with arg datum query many jdbc template select request get sql select request get arg class util find class by name select request get class name break default throw new illegal argument exception unsupported datum query category byte string byte datum null byte string empty byte string copy from serializer serialize datum return response new builder set success true set datum byte build catch exception e log util fatal log error there be a error query the datum request error select request e to string return response new builder set success false set err msg class util get simpla name e exception util get cause e get message build finally read lock unlock override public response on apply log log logger util print if debug enable log util default log on apply info log log final byte string byte string log get datum precondition check argument byte string null log get datum must not null list modify request sql context serializer deserialize byte string to byte array list class final lock lock read lock lock lock try boolean be ok false if log contain extend info datum import key be ok do datum import jdbc template sql context else sql context sort comparator compare int modify request get execute no be ok update transaction template jdbc template sql context if there be additional information post processing put into the asynchronous thread pool for processing to avoid block the normal execution of the state machine config executor execute embed dump handle extend info log get extend info map return response new builder set success be ok build we do not believe that a error cause by a problem with a sql error should trigger the stop operation of the raft state machine catch bad sql grammar exception datum integrity violation exception e return response new builder set success false set err msg e to string build catch data access exception e throw new consistency exception e to string catch throwable t throw t finally lock unlock override public void on error throwable throwable trigger reversion strategy notify center publish event new raft db error event throwable override public string group return constant config model raft group private void handle extend info map string string extend info if extend info contain key constant extend info config dump event string json val extend info get constant extend info config dump event if string util be not blank json val notify center publish event jackson util to obj json val config dump event class return if extend info contain key constant extend info config dump event string json val extend info get constant extend info config dump event if string util be not blank json val list config dump event list jackson util to obj json val new generic type list config dump event get type list stream filter object non null for each notify center publish event 
embed storage persist service impl suppress warning pmd method return wrapper type rule checkstyle linelength conditional value condition on embed storage class component public class embed storage persist service impl implement persist service private static final string resource config info id config info id private static final string resource config history id config history id private static final string resource config tag relation id config tag relation id private static final string resource app configdata relation sub app configdata relation sub private static final string resource config beta id config beta id private static final string resource namespace id namespace id private static final string resource user id user id private static final string resource role id role id private static final string resource permission id permission id private datum source service datum source service private final database operate database operate private final id generator manager id generator manager the constructor set the dependency injection order param database operate link embed storage persist service impl param id generator manager link id generator manager public embed storage persist service impl database operate database operate id generator manager id generator manager this database operate database operate this id generator manager id generator manager notify center register to share publisher derby import event class init datum source service and id generator manager post construct public void init datum source service dynamic datum source get instance get datum source id generator manager register resource config info id resource config history id resource config tag relation id resource app configdata relation sub resource config beta id resource namespace id resource user id resource role id resource permission id public boolean check master writable return datum source service check master writable public void set basic datum source service datum source service datum source service this data source service datum source service public synchronize void reload throw i o exception this data source service reload config info table insert update delete for unit test public jdbc template get jdbc template return this data source service get jdbc template public transaction template get transaction template return this data source service get transaction template suppress warning checkstyle abbreviation as word in name public string get current d b url return this data source service get current db url public database operate get database operate return database operate override public e pagination helper e create pagination helper return new embed pagination helper impl e database operate override public void add config info final string src ip final string src user final config info config info final timestamp time final map string object config advance info final boolean notify try final string tenant tmp string util be blank config info get tenant string util empty config info get tenant config info set tenant tenant tmp long config id id generator manager next id resource config info id long he id id generator manager next id resource config history id add config info atomic config id src ip src user config info time config advance info string config tag config advance info null null string config advance info get config tag add config tag relation config id config tag config info get datum id config info get group config info get tenant insert config history atomic he id config info src ip src user time i embed storage context util on modify config info config info src ip time database operate block update finally embed storage context util clean all context override public void add config info4 beta config info config info string beta ip string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant config info set tenant tenant tmp try string md5 m d5 util md5 hex config info get content constant encode final string sql insert into config info beta datum id group id tenant id app name content md5 beta ip src ip src user gmt create gmt modify value final object arg new object config info get datum id config info get group tenant tmp app name tmp config info get content md5 beta ip src ip src user time time embed storage context util on modify config beta info config info beta ip src ip time embed storage context util add sql context sql arg database operate block update finally embed storage context util clean all context override public void add config info4 tag config info config info string tag string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant string tag tmp string util be blank tag string util empty tag trim config info set tenant tenant tmp try string md5 m d5 util md5 hex config info get content constant encode final string sql insert into config info tag datum id group id tenant id tag id app name content md5 src ip src user gmt create gmt modify value final object arg new object config info get datum id config info get group tenant tmp tag tmp app name tmp config info get content md5 src ip src user time time embed storage context util on modify config tag info config info tag tmp src ip time embed storage context util add sql context sql arg database operate block update finally embed storage context util clean all context override public void update config info final config info config info final string src ip final string src user final timestamp time final map string object config advance info final boolean notify try config info old config info find config info config info get datum id config info get group config info get tenant final string tenant tmp string util be blank config info get tenant string util empty config info get tenant old config info set tenant tenant tmp string app name tmp old config info get app name if the app name pass by the user be not empty the app name of the user be persist otherwise the app name of db be use empty string be require to clear app name if config info get app name null config info set app name app name tmp update config info atomic config info src ip src user time config advance info string config tag config advance info null null string config advance info get config tag if config tag null delete all tag and recreate they remove tag by id atomic old config info get id add config tag relation old config info get id config tag config info get datum id config info get group config info get tenant insert config history atomic old config info get id old config info src ip src user time u embed storage context util on modify config info config info src ip time database operate block update finally embed storage context util clean all context override public void update config info4 beta config info config info string beta ip string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant config info set tenant tenant tmp try string md5 m d5 util md5 hex config info get content constant encode final string sql update config info beta set content md5 src ip src user gmt modify app name where datum id and group id and tenant id final object arg new object config info get content md5 src ip src user time app name tmp config info get datum id config info get group tenant tmp embed storage context util on modify config beta info config info beta ip src ip time embed storage context util add sql context sql arg database operate block update finally embed storage context util clean all context override public void update config info4 tag config info config info string tag string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant string tag tmp string util be blank tag string util empty tag trim config info set tenant tenant tmp try string md5 m d5 util md5 hex config info get content constant encode final string sql update config info tag set content md5 src ip src user gmt modify app name where datum id and group id and tenant id and tag id final object arg new object config info get content md5 src ip src user time app name tmp config info get datum id config info get group tenant tmp tag tmp embed storage context util on modify config tag info config info tag tmp src ip time embed storage context util add sql context sql arg database operate block update finally embed storage context util clean all context override public void insert or update beta final config info config info final string beta ip final string src ip final string src user final timestamp time final boolean notify if find config info4 beta config info get datum id config info get group config info get tenant null add config info4 beta config info beta ip src ip null time notify else update config info4 beta config info beta ip src ip null time notify override public void insert or update tag final config info config info final string tag final string src ip final string src user final timestamp time final boolean notify if find config info4 tag config info get datum id config info get group config info get tenant tag null add config info4 tag config info tag src ip null time notify else update config info4 tag config info tag src ip null time notify override public void update md5 string datum id string group string tenant string md5 timestamp last time string tenant tmp string util be blank tenant string util empty tenant try final string sql update config info set md5 where datum id and group id and tenant id and gmt modify final object arg new object md5 datum id group tenant tmp last time embed storage context util add sql context sql arg boolean result database operate update embed storage context util get current sql context if result throw new naco config exception fail to config the m d5 modification finally embed storage context util clean all context override public void insert or update string src ip string src user config info config info timestamp time map string object config advance info insert or update src ip src user config info time config advance info true override public void insert or update string src ip string src user config info config info timestamp time map string object config advance info boolean notify if object be null find config info config info get datum id config info get group config info get tenant add config info src ip src user config info time config advance info notify else update config info config info src ip src user time config advance info notify override public void insert or update sub sub info sub info if be already exist sub info update config sub atomic sub info get datum id sub info get group sub info get app name sub info get date else add config sub atomic sub info get datum id sub info get group sub info get app name sub info get date private boolean be already exist sub info sub info final string sql select from app configdata relation sub where dara id and group id and app name map obj database operate query one sql new object sub info get datum id sub info get group sub info get app name map class return obj null override public void remove config info final string data id final string group final string tenant final string src ip final string src user final timestamp time new timestamp system current time millis config info config info find config info datum id group tenant if object non null config info try string tenant tmp string util be blank tenant string util empty tenant remove config info atomic datum id group tenant tmp src ip src user remove tag by id atomic config info get id insert config history atomic config info get id config info src ip src user time d embed storage context util on delete config info tenant tmp group datum id src ip time boolean result database operate update embed storage context util get current sql context if result throw new naco config exception config deletion fail finally embed storage context util clean all context override public list config info remove config info by id final list long id final string src ip final string src user if collection util be empty id return null id remove all collection singleton null final timestamp time new timestamp system current time millis try string id str joiner on join id list config info config info list find config info by id id str if collection util be not empty config info list remove config info by id atomic id str for config info config info config info list remove tag by id atomic config info get id insert config history atomic config info get id config info src ip src user time d embed storage context util on batch delete config info config info list boolean result database operate update embed storage context util get current sql context if result throw new naco config exception fail to config batch deletion return config info list finally embed storage context util clean all context override public void remove config info4 beta final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant config info config info find config info4 beta datum id group tenant if config info null try final string sql delete from config info beta where datum id and group id and tenant id final object arg new object datum id group tenant tmp embed storage context util on delete config beta info tenant tmp group datum id system current time millis embed storage context util add sql context sql arg boolean result database operate update embed storage context util get current sql context if result throw new naco config exception tag configuration deletion fail finally embed storage context util clean all context override public boolean add aggr config info final string data id final string group string tenant final string datum id string app name final string content string app name tmp string util be blank app name string util empty app name string tenant tmp string util be blank tenant string util empty tenant string content tmp string util be blank content string util empty content final timestamp now new timestamp system current time millis final string select select content from config info aggr where datum id and group id and tenant id and datum id final string insert insert into config info aggr datum id group id tenant id datum id app name content gmt modify value final string update update config info aggr set content gmt modify where datum id and group id and tenant id and datum id string db content database operate query one select new object datum id group tenant tmp datum id string class if object be null db content final object arg new object datum id group tenant tmp datum id app name tmp content tmp now embed storage context util add sql context insert arg else if db content equal content final object arg new object content tmp now data id group tenant tmp datum id embed storage context util add sql context update arg try boolean result database operate update embed storage context util get current sql context if result throw new naco config exception merge configuration release fail return true finally embed storage context util clean all context override public void remove single aggr config info final string data id final string group final string tenant final string datum id final string tenant tmp string util be blank tenant string util empty tenant final string sql delete from config info aggr where datum id and group id and tenant id and datum id final object arg new object datum id group tenant tmp datum id embed storage context util add sql context sql arg try boolean result database operate update embed storage context util get current sql context if result throw new naco config exception aggregation with single configuration deletion fail finally embed storage context util clean all context override public void remove aggr config info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant final string sql delete from config info aggr where datum id and group id and tenant id final object arg new object datum id group tenant tmp embed storage context util add sql context sql arg try boolean result database operate update embed storage context util get current sql context if result throw new naco config exception aggregation with all configuration deletion fail finally embed storage context util clean all context override public boolean batch remove aggr final string data id final string group final string tenant final list string datum list final string tenant tmp string util be blank tenant string util empty tenant final string builder datum string new string builder for string datum datum list datum string append append datum append datum string delete char at datum string length final string sql delete from config info aggr where datum id and group id and tenant id and datum id in datum string to string final object arg new object datum id group tenant tmp embed storage context util add sql context sql arg try boolean result database operate update embed storage context util get current sql context if result throw new naco config exception aggregation fail to configure batch deletion return true finally embed storage context util clean all context override public void remove config history final timestamp start time final int limit size string sql delete from he config info where gmt modify limit pagination helper config info helper create pagination helper helper update limit sql new object start time limit size override public int find config history count by time final timestamp start time string sql select count from he config info where gmt modify integer result database operate query one sql new object start time integer class if result null throw new illegal argument exception config info beta count error return result override public long find config max id string sql select max id from config info return optional of nullable database operate query one sql long class or else 0 l override public boolean batch publish aggr final string data id final string group final string tenant final map string string datum map final string app name try boolean be publish ok false for entry string string entry datum map entry set add aggr config info datum id group tenant entry get key app name entry get value be publish ok database operate update embed storage context util get current sql context if be publish ok null return false return be publish ok finally embed storage context util clean all context override public boolean replace aggr final string data id final string group final string tenant final map string string datum map final string app name boolean be replace ok false string app name tmp app name null app name remove aggr config info datum id group tenant string tenant tmp string util be blank tenant string util empty tenant final string sql insert into config info aggr datum id group id tenant id datum id app name content gmt modify value for entry string string datum entry datum map entry set final object arg new object datum id group tenant tmp datum entry get key app name tmp datum entry get value new timestamp system current time millis embed storage context util add sql context sql arg try be replace ok database operate update embed storage context util get current sql context if be replace ok null return false return be replace ok finally embed storage context util clean all context override public list config info find all datum id and group string sql select distinct datum id group id from config info return database operate query many sql empty array config info row mapper override public config info4 beta find config info4 beta final string data id final string group final string tenant string tenant tmp string util be blank tenant string util empty tenant final string sql select id datum id group id tenant id app name content beta ip from config info beta where datum id and group id and tenant id return database operate query one sql new object datum id group tenant tmp config i n f o4 b e t a row mapper override public config info4 tag find config info4 tag final string data id final string group final string tenant final string tag string tenant tmp string util be blank tenant string util empty tenant string tag tmp string util be blank tag string util empty tag trim final string sql select id datum id group id tenant id tag id app name content from config info tag where datum id and group id and tenant id and tag id return database operate query one sql new object datum id group tenant tmp tag tmp config i n f o4 t a g row mapper override public config info find config info app final string data id final string group final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant final string sql select id datum id group id tenant id app name content from config info where datum id and group id and tenant id and app name return database operate query one sql new object datum id group tenant tmp app name config info row mapper override public config info find config info advance info final string data id final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag list string param list new array list string param list add datum id param list add group param list add tenant tmp string builder sql new string builder select id datum id group id tenant id app name content from config info where datum id and group id and tenant id if string util be not blank config tag sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a data id and a group id and a tenant id sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql append sql append param list add tag arr i sql append if string util be not blank app name sql append and a app name param list add app name else if string util be not blank app name sql append and app name param list add app name return database operate query one sql to string param list to array config info row mapper override public config info base find config info base final string data id final string group final string sql select id datum id group id content from config info where datum id and group id and tenant id return database operate query one sql new object datum id group string util empty config info base row mapper override public config info find config info long id final string sql select id datum id group id tenant id app name content from config info where id return database operate query one sql new object id config info row mapper override public config info find config info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant final string sql select id datum id group id tenant id app name content md5 type from config info where datum id and group id and tenant id final object arg new object datum id group tenant tmp return database operate query one sql arg config info row mapper override public page config info find config info by datum id final int page no final int page size final string data id final string tenant string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper return helper fetch page select count from config info where datum id and tenant id select id datum id group id tenant id app name content from config info where datum id and tenant id new object datum id tenant tmp page no page size config info row mapper override public page config info find config info by datum id and app final int page no final int page size final string data id final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper return helper fetch page select count from config info where datum id and tenant id and app name select id datum id group id tenant id app name content from config info where datum id and tenant id and app name new object datum id tenant tmp app name page no page size config info row mapper override public page config info find config info by datum id and advance final int page no final int page size final string data id final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string builder sql count new string builder select count from config info where datum id and tenant id string builder sql new string builder select id datum id group id tenant id app name content from config info where datum id and tenant id list string param list new array list string param list add datum id param list add tenant tmp if string util be not blank config tag sql count new string builder select count from config info a left join config tag relation b on a id b id where a data id and a tenant id sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a data id and a tenant id sql count append and b tag name in sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql count append sql append sql count append sql append param list add tag arr i sql count append sql append if string util be not blank app name sql count append and a app name sql append and a app name param list add app name else if string util be not blank app name sql count append and app name sql append and app name param list add app name pagination helper config info helper create pagination helper return helper fetch page sql count to string sql to string param list to array page no page size config info row mapper override public page config info find config info4 page final int page no final int page size final string data id final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string sql count select count from config info string sql select id datum id group id tenant id app name content type from config info string builder where new string builder where list string param list new array list string param list add tenant tmp if string util be not blank config tag sql count select count from config info a left join config tag relation b on a id b id sql select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where append a tenant id if string util be not blank datum id where append and a data id param list add datum id if string util be not blank group where append and a group id param list add group if string util be not blank app name where append and a app name param list add app name where append and b tag name in string tag arr config tag split for int i i tag arr length i if i where append where append param list add tag arr i where append else where append tenant id if string util be not blank datum id where append and datum id param list add datum id if string util be not blank group where append and group id param list add group if string util be not blank app name where append and app name param list add app name pagination helper config info helper create pagination helper return helper fetch page sql count where to string sql where to string param list to array page no page size config info row mapper override public page config info base find config info base by datum id final int page no final int page size final string datum id pagination helper config info base helper create pagination helper return helper fetch page select count from config info where datum id and tenant id select id datum id group id content from config info where datum id and tenant id new object datum id string util empty page no page size config info base row mapper override public page config info find config info by group final int page no final int page size final string group final string tenant string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper return helper fetch page select count from config info where group id and tenant id select id datum id group id tenant id app name content from config info where group id and tenant id new object group tenant tmp page no page size config info row mapper override public page config info find config info by group and app final int page no final int page size final string group final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper return helper fetch page select count from config info where group id and tenant id and app name select id datum id group id tenant id app name content from config info where group id and tenant id and app name new object group tenant tmp app name page no page size config info row mapper override public page config info find config info by group and advance final int page no final int page size final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string builder sql count new string builder select count from config info where group id and tenant id string builder sql new string builder select id datum id group id tenant id app name content from config info where group id and tenant id list string param list new array list string param list add group param list add tenant tmp if string util be not blank config tag sql count new string builder select count from config info a left join config tag relation b on a id b id where a group id and a tenant id sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a group id and a tenant id sql count append and b tag name in sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql count append sql append sql count append sql append param list add tag arr i sql count append sql append if string util be not blank app name sql count append and a app name sql append and a app name param list add app name else if string util be not blank app name sql count append and app name sql append and app name param list add app name pagination helper config info helper create pagination helper return helper fetch page sql count to string sql to string param list to array page no page size config info row mapper override public page config info find config info by app final int page no final int page size final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper return helper fetch page select count from config info where tenant id like and app name select id datum id group id tenant id app name content from config info where tenant id like and app name new object generate like argument tenant tmp app name page no page size config info row mapper override public page config info find config info by advance final int page no final int page size final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string builder sql count new string builder select count from config info where tenant id like string builder sql new string builder select id datum id group id tenant id app name content from config info where tenant id like list string param list new array list string param list add tenant tmp if string util be not blank config tag sql count new string builder select count from config info a left join config tag relation b on a id b id where a tenant id sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a tenant id sql count append and b tag name in sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql count append sql append sql count append sql append param list add tag arr i sql count append sql append if string util be not blank app name sql count append and a app name sql append and a app name param list add app name else if string util be not blank app name sql count append and app name sql append and app name param list add app name pagination helper config info helper create pagination helper return helper fetch page sql count to string sql to string param list to array page no page size config info row mapper override public page config info base find config info base by group final int page no final int page size final string group pagination helper config info base helper create pagination helper return helper fetch page select count from config info where group id and tenant id select id datum id group id content from config info where group id and tenant id new object group string util empty page no page size config info base row mapper override public int config info count string sql select count id from config info integer result database operate query one sql integer class if result null throw new illegal argument exception config info count error return result override public int config info count string tenant string sql select count id from config info where tenant id like tenant integer result database operate query one sql integer class if result null throw new illegal argument exception config info count error return result override public int config info beta count string sql select count id from config info beta integer result database operate query one sql integer class if result null throw new illegal argument exception config info beta count error return result override public int config info tag count string sql select count id from config info tag integer result database operate query one sql integer class if result null throw new illegal argument exception config info beta count error return result override public list string get tenant id list int page int page size string sql select tenant id from config info where tenant id group by tenant id limit int from page page size return database operate query many sql new object from page size string class override public list string get group id list int page int page size string sql select group id from config info where tenant id group by group id limit int from page page size return database operate query many sql new object from page size string class override public int aggr config info count string datum id string group string tenant string tenant tmp string util be blank tenant string util empty tenant string sql select count id from config info aggr where datum id and group id and tenant id integer result database operate query one sql new object datum id group tenant tmp integer class if result null throw new illegal argument exception aggr config info count error return result override public int aggr config info count string datum id string group string tenant list string datum id boolean be in if datum id null datum id be empty return final string tenant tmp string util be blank tenant string util empty tenant string builder sql new string builder select count from config info aggr where datum id and group id and tenant id and datum id if be in sql append in else sql append not in for int i size datum id size i size i if i sql append sql append sql append list object object list list object new array list datum id group tenant tmp object list add all datum id integer result database operate query one sql to string object list to array integer class if result null throw new illegal argument exception aggr config info count error return result override public int aggr config info count in string datum id string group string tenant list string datum id return aggr config info count datum id group tenant datum id true override public int aggr config info count not in string datum id string group string tenant list string datum id return aggr config info count datum id group tenant datum id false override public page config info find all config info final int page no final int page size final string tenant string tenant tmp string util be blank tenant string util empty tenant string sql count row select count from config info string sql fetch row select t id datum id group id tenant id app name content md5 from select id from config info where tenant id like order by id limit g config info t where g id t id pagination helper config info helper create pagination helper return helper fetch page limit sql count row sql fetch row new object generate like argument tenant tmp page no page size page size page no page size config info row mapper override public page config key find all config key final int page no final int page size final string tenant final string tenant tmp string util be blank tenant string util empty tenant final string select select datum id group id app name from select id from config info where tenant id like order by id limit g config info t where g id t id final int total count config info count tenant int page count total count page size if total count page size page count page count if page no page count return null final page config key page new page config key page set page number page no page set page available page count page set total count total count list config key result database operate query many select new object generate like argument tenant tmp page no page size page size new object config key row mapper for config key item result page get page item add item return page override public page config info base find all config info base final int page no final int page size string sql count row select count from config info string sql fetch row select t id datum id group id content md5 from select id from config info order by id limit g config info t where g id t id pagination helper config info base helper create pagination helper return helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info base row mapper override public page config info wrapper find all config info for dump all final int page no final int page size string sql count row select count from config info string sql fetch row select t id datum id group id tenant id app name content type md5 gmt modify from select id from config info order by id limit g config info t where g id t id pagination helper config info wrapper helper create pagination helper return helper fetch page limit sql count row sql fetch row empty array page no page size config info wrapper row mapper override public page config info wrapper find all config info fragment final long last max id final int page size string select select id datum id group id tenant id app name content md5 gmt modify type from config info where id order by id asc limit pagination helper config info wrapper helper create pagination helper return helper fetch page limit select new object last max id page size page size config info wrapper row mapper override public page config info beta wrapper find all config info beta for dump all final int page no final int page size string sql count row select count from config info beta string sql fetch row select t id datum id group id tenant id app name content md5 gmt modify beta ip from select id from config info beta order by id limit g config info beta t where g id t id pagination helper config info beta wrapper helper create pagination helper return helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info beta wrapper row mapper override public page config info tag wrapper find all config info tag for dump all final int page no final int page size string sql count row select count from config info tag string sql fetch row select t id datum id group id tenant id tag id app name content md5 gmt modify from select id from config info tag order by id limit g config info tag t where g id t id pagination helper config info tag wrapper helper create pagination helper return helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info tag wrapper row mapper override public list config info find config info by batch final list string data id final string group final string tenant int sub query limit assert dataid group not null string tenant tmp string util be blank tenant string util empty tenant if dataid empty return empty list if collection util be empty datum id return collection empty list volume query upper limit the number of in be within the shorter the sql statement the better if sub query limit query limit size sub query limit list config info result new array list config info datum id size string sql start select datum id group id tenant id app name content from config info where group id and tenant id and data id in string sql end string builder sub query sql new string builder for int i i datum id size i sub query limit dataid list string param new array list string datum id sub list i math min i sub query limit datum id size for int j j param size j sub query sql append if j param size sub query sql append group param add group param add tenant tmp final string sql sql start sub query sql to string sql end list config info r database operate query many sql param to array config info row mapper assert not null if r null r size result add all r return result override public page config info find config info like final int page no final int page size final string data id final string group final string tenant final string app name final string content string tenant tmp string util be blank tenant string util empty tenant if string util be blank datum id string util be blank group if string util be blank app name return this find all config info page no page size tenant tmp else return this find config info by app page no page size tenant tmp app name final string sql count row select count from config info where final string sql fetch row select id datum id group id tenant id app name content from config info where string where 1 = 1 list string param new array list string if string util be blank datum id where and datum id like param add generate like argument datum id if string util be blank group where and group id like param add generate like argument group where and tenant id like param add generate like argument tenant tmp if string util be blank app name where and app name param add app name if string util be blank content where and content like param add generate like argument content pagination helper config info helper create pagination helper return helper fetch page sql count row where sql fetch row where param to array page no page size config info row mapper override public page config info find config info like final int page no final int page size final config key config key final boolean blacklist string sql count row select count from config info where string sql fetch row select id datum id group id tenant id app name content from config info where string builder where new string builder 1 = 1 white list please synchronize the condition be empty there be no qualified configuration if config key length blacklist page config info page new page config info page set total count return page list string param new array list string boolean be first true for config key config info config key string data id config info get datum id string group config info get group string app name config info get app name if string util be blank datum id string util be blank group string util be blank app name break if blacklist if be first be first false where append and else where append and where append boolean be first sub true if string util be blank datum id where append datum id not like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append or where append group id not like param add generate like argument group be first sub false if string util be blank app name if be first sub where append or where append app name param add app name be first sub false where append else if be first be first false where append and else where append or where append boolean be first sub true if string util be blank datum id where append datum id like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append and where append group id like param add generate like argument group be first sub false if string util be blank app name if be first sub where append and where append app name param add app name be first sub false where append pagination helper config info helper create pagination helper return helper fetch page sql count row where to string sql fetch row where to string param to array page no page size config info row mapper override public page config info find config info like4 page final int page no final int page size final string data id final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string content config advance info null null string config advance info get content final string config tag config advance info null null string config advance info get config tag string sql count row select count from config info string sql fetch row select id datum id group id tenant id app name content from config info string builder where new string builder where list string param new array list string param add generate like argument tenant tmp if string util be not blank config tag sql count row select count from config info a left join config tag relation b on a id b id sql fetch row select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where append a tenant id like if string util be blank datum id where append and a data id like param add generate like argument datum id if string util be blank group where append and a group id like param add generate like argument group if string util be blank app name where append and a app name param add app name if string util be blank content where append and a content like param add generate like argument content where append and b tag name in string tag arr config tag split for int i i tag arr length i if i where append where append param add tag arr i where append else where append tenant id like if string util be blank datum id where append and datum id like param add generate like argument datum id if string util be blank group where append and group id like param add generate like argument group if string util be blank app name where append and app name param add app name if string util be blank content where append and content like param add generate like argument content pagination helper config info helper create pagination helper return helper fetch page sql count row where sql fetch row where param to array page no page size config info row mapper override public page config info base find config info base like final int page no final int page size final string data id final string group final string content throw i o exception if string util be blank datum id string util be blank group throw new i o exception invalid param final string sql count row select count from config info where final string sql fetch row select id datum id group id tenant id content from config info where string where 1 = 1 and tenant id list string param new array list string if string util be blank datum id where and datum id like param add generate like argument datum id if string util be blank group where and group id like param add generate like argument group if string util be blank content where and content like param add generate like argument content pagination helper config info base helper create pagination helper return helper fetch page sql count row where sql fetch row where param to array page no page size config info base row mapper override public config info aggr find single config info aggr string datum id string group string tenant string datum id string tenant tmp string util be blank tenant string util empty tenant string sql select id datum id group id tenant id datum id app name content from config info aggr where datum id and group id and tenant id and datum id return database operate query one sql new object datum id group tenant tmp datum id config info aggr row mapper override public list config info aggr find config info aggr string datum id string group string tenant string tenant tmp string util be blank tenant string util empty tenant string sql select datum id group id tenant id datum id app name content from config info aggr where datum id and group id and tenant id order by datum id return database operate query many sql new object datum id group tenant tmp config info aggr row mapper override public page config info aggr find config info aggr by page string datum id string group string tenant final int page no final int page size string tenant tmp string util be blank tenant string util empty tenant string sql count row select count from config info aggr where datum id and group id and tenant id string sql fetch row select datum id group id tenant id datum id app name content from config info aggr where datum id and group id and tenant id order by datum id limit pagination helper config info aggr helper create pagination helper return helper fetch page limit sql count row new object datum id group tenant tmp sql fetch row new object datum id group tenant tmp page no page size page size page no page size config info aggr row mapper override public page config info aggr find config info aggr like final int page no final int page size config key config key boolean blacklist string sql count row select count from config info aggr where string sql fetch row select datum id group id tenant id datum id app name content from config info aggr where string builder where new string builder 1 = 1 white list please synchronize the condition be empty there be no qualified configuration if config key length blacklist false page config info aggr page new page config info aggr page set total count return page list string param new array list string boolean be first true for config key config info aggr config key string data id config info aggr get datum id string group config info aggr get group string app name config info aggr get app name if string util be blank datum id string util be blank group string util be blank app name break if blacklist if be first be first false where append and else where append and where append boolean be first sub true if string util be blank datum id where append datum id not like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append or where append group id not like param add generate like argument group be first sub false if string util be blank app name if be first sub where append or where append app name param add app name be first sub false where append else if be first be first false where append and else where append or where append boolean be first sub true if string util be blank datum id where append datum id like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append and where append group id like param add generate like argument group be first sub false if string util be blank app name if be first sub where append and where append app name param add app name be first sub false where append pagination helper config info aggr helper create pagination helper return helper fetch page sql count row where to string sql fetch row where to string param to array page no page size config info aggr row mapper override public list config info change find all aggr group string sql select distinct datum id group id tenant id from config info aggr return database operate query many sql empty array config info change row mapper override public list string find datum id by content string datum id string group id string content string sql select datum id from config info aggr where datum id and group id and content return database operate query many sql new object datum id group id content string class override public list config info wrapper find change config final timestamp start time final timestamp end time list map string object list database operate query many select datum id group id tenant id app name content gmt modify from config info where gmt modify and gmt modify new object start time end time return convert change config list override public page config info wrapper find change config final string data id final string group final string tenant final string app name final timestamp start time final timestamp end time final int page no final int page size final long last max id string tenant tmp string util be blank tenant string util empty tenant final string sql count row select count from config info where final string sql fetch row select id datum id group id tenant id app name content type md5 gmt modify from config info where string where 1 = 1 list object param new array list object if string util be blank datum id where and datum id like param add generate like argument datum id if string util be blank group where and group id like param add generate like argument group if string util be blank tenant tmp where and tenant id param add tenant tmp if string util be blank app name where and app name param add app name if start time null where and gmt modify param add start time if end time null where and gmt modify param add end time pagination helper config info wrapper helper create pagination helper return helper fetch page sql count row where sql fetch row where param to array page no page size last max id config info wrapper row mapper override public list config info find delete config final timestamp start time final timestamp end time list map string object list database operate query many select distinct datum id group id tenant id from he config info where op type d and gmt modify and gmt modify new object start time end time return convert delete config list override public long add config info atomic final long id final string src ip final string src user final config info config info final timestamp time map string object config advance info final string app name tmp string util be blank config info get app name string util empty config info get app name final string tenant tmp string util be blank config info get tenant string util empty config info get tenant final string desc config advance info null null string config advance info get desc final string use config advance info null null string config advance info get use final string effect config advance info null null string config advance info get effect final string type config advance info null null string config advance info get type final string schema config advance info null null string config advance info get schema final string md5 tmp m d5 util md5 hex config info get content constant encode final string sql insert into config info id datum id group id tenant id app name content md5 src ip src user gmt create gmt modify c desc c use effect type c schema value final object arg new object id config info get datum id config info get group tenant tmp app name tmp config info get content md5 tmp src ip src user time time desc use effect type schema embed storage context util add sql context sql arg return id override public void add config tag relation atomic long config id string tag name string datum id string group string tenant final string sql insert into config tag relation id tag name tag type datum id group id tenant id value final object arg new object config id tag name null datum id group tenant embed storage context util add sql context sql arg override public void add config tag relation long config id string config tag string data id string group string tenant if string util be not blank config tag string tag arr config tag split for int i i tag arr length i add config tag relation atomic config id tag arr i datum id group tenant override public void remove tag by id atomic long id final string sql delete from config tag relation where id final object arg new object id embed storage context util add sql context sql arg override public list string get config tag by tenant string tenant string sql select tag name from config tag relation where tenant id return database operate query many sql new object tenant string class override public list string select tag by config string datum id string group string tenant string sql select tag name from config tag relation where datum id and group id and tenant id return database operate query many sql new object datum id group tenant string class override public void remove config info atomic final string data id final string group final string tenant final string src ip final string src user string tenant tmp string util be blank tenant string util empty tenant final string sql delete from config info where datum id and group id and tenant id final object arg new object datum id group tenant tmp embed storage context util add sql context sql arg override public void remove config info by id atomic final string id if string util be blank id return string builder sql new string builder sql delete config info by id sql append id in list long param list new array list string tag arr id split for int i i tag arr length i if i sql append sql append param list add long parse long tag arr i sql append embed storage context util add sql context sql to string param list to array override public void remove config info tag final string data id final string group final string tenant final string tag final string src ip final string src user string tenant tmp string util be blank tenant string util empty tenant string tag tmp string util be blank tag string util empty tag final string sql delete from config info tag where datum id and group id and tenant id and tag id final object arg new object datum id group tenant tmp tag tmp embed storage context util on delete config tag info tenant tmp group data id tag tmp src ip embed storage context util add sql context sql arg try database operate update embed storage context util get current sql context finally embed storage context util clean all context override public void update config info atomic final config info config info final string src ip final string src user final timestamp time map string object config advance info final string app name tmp string util be blank config info get app name string util empty config info get app name final string tenant tmp string util be blank config info get tenant string util empty config info get tenant final string md5 tmp m d5 util md5 hex config info get content constant encode final string desc config advance info null null string config advance info get desc final string use config advance info null null string config advance info get use final string effect config advance info null null string config advance info get effect final string type config advance info null null string config advance info get type final string schema config advance info null null string config advance info get schema final string sql update config info set content md5 src ip src user gmt modify app name c desc c use effect type c schema where datum id and group id and tenant id final object arg new object config info get content md5 tmp src ip src user time app name tmp desc use effect type schema config info get datum id config info get group tenant tmp embed storage context util add sql context sql arg override public list config info find config info by id final string id if string util be blank id return null string builder sql new string builder sql find config info by id sql append id in list long param list new array list string tag arr id split for int i i tag arr length i if i sql append sql append param list add long parse long tag arr i sql append return database operate query many sql to string param list to array config info row mapper override public config advance info find config advance info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant list string config tag list this select tag by config datum id group tenant config advance info config advance database operate query one select gmt create gmt modify src user src ip c desc c use effect type c schema from config info where datum id and group id and tenant id new object datum id group tenant tmp config advance info row mapper if collection util be not empty config tag list string builder config tag tmp new string builder for string config tag config tag list if config tag tmp length config tag tmp append config tag else config tag tmp append append config tag config advance set config tag config tag tmp to string return config advance override public config all info find config all info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant final string sql select id datum id group id tenant id app name content md5 gmt create gmt modify src user src ip c desc c use effect type c schema from config info where datum id and group id and tenant id list string config tag list select tag by config datum id group tenant config all info config advance database operate query one sql new object datum id group tenant tmp config all info row mapper if config tag list null config tag list be empty string builder config tag tmp new string builder for string config tag config tag list if config tag tmp length config tag tmp append config tag else config tag tmp append append config tag config advance set config tag config tag tmp to string return config advance override public void insert config history atomic long config history id config info config info string src ip string src user final timestamp time string op string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant final string md5 tmp m d5 util md5 hex config info get content constant encode final string sql insert into he config info id datum id group id tenant id app name content md5 src ip src user gmt modify op type value final object arg new object config history id config info get datum id config info get group tenant tmp app name tmp config info get content md5 tmp src ip src user time op embed storage context util add sql context sql arg override public page config history info find config history string datum id string group string tenant int page no int page size string tenant tmp string util be blank tenant string util empty tenant string sql count row select count from he config info where datum id and group id and tenant id string sql fetch row select nid datum id group id tenant id app name src ip op type gmt create gmt modify from he config info where datum id and group id and tenant id order by nid desc pagination helper config history info helper create pagination helper return helper fetch page sql count row sql fetch row new object datum id group tenant tmp page no page size history list row mapper override public void add config sub atomic final string data id final string group final string app name final timestamp date final string app name tmp app name null app name final long id id generator manager next id resource app configdata relation sub final string sql insert into app configdata relation sub id datum id group id app name gmt modify value final object arg new object id datum id group app name tmp date embed storage context util add sql context sql arg try database operate update embed storage context util get current sql context finally embed storage context util clean all context override public void update config sub atomic final string data id final string group final string app name final timestamp time final string app name tmp app name null app name final string sql update app configdata relation sub set gmt modify where datum id and group id and app name final object arg new object time datum id group app name tmp embed storage context util add sql context sql arg try database operate update embed storage context util get current sql context finally embed storage context util clean all context override public config history info detail config history long nid string sql fetch row select nid datum id group id tenant id app name content md5 src user src ip op type gmt create gmt modify from he config info where nid return database operate query one sql fetch row new object nid history detail row mapper override public void insert tenant info atomic string kp string tenant id string tenant name string tenant desc string create resoure final long time final string sql insert into tenant info kp tenant id tenant name tenant desc create source gmt create gmt modify value final object arg new object kp tenant id tenant name tenant desc create resoure time time embed storage context util add sql context sql arg try boolean result database operate update embed storage context util get current sql context if result throw new naco config exception namespace creation fail finally embed storage context util clean all context override public void update tenant name atomic string kp string tenant id string tenant name string tenant desc final string sql update tenant info set tenant name tenant desc gmt modify where kp and tenant id final object arg new object tenant name tenant desc system current time millis kp tenant id embed storage context util add sql context sql arg try boolean result database operate update embed storage context util get current sql context if result throw new naco config exception namespace update fail finally embed storage context util clean all context override public list tenant info find tenant by kp string kp string sql select tenant id tenant name tenant desc from tenant info where kp return database operate query many sql new object kp tenant info row mapper override public tenant info find tenant by kp string kp string tenant id string sql select tenant id tenant name tenant desc from tenant info where kp and tenant id return database operate query one sql new object kp tenant id tenant info row mapper override public void remove tenant info atomic final string kp final string tenant id embed storage context util add sql context delete from tenant info where kp and tenant id kp tenant id try database operate update embed storage context util get current sql context finally embed storage context util clean all context override public list config info convert delete config list map string object list list config info config new array list config info for map string object map list string datum id string map get datum id string group string map get group id string tenant string map get tenant id config info config new config info config set datum id data id config set group group config set tenant tenant config add config return config override public list config info wrapper convert change config list map string object list list config info wrapper config new array list config info wrapper for map string object map list string datum id string map get datum id string group string map get group id string tenant string map get tenant id string content string map get content long m time timestamp map get gmt modify get time config info wrapper config new config info wrapper config set datum id data id config set group group config set tenant tenant config set content content config set last modify m time config add config return config override public list config info wrapper list all group key md5 final int page size int total count config info count int page count int math ceil total count 1.0 page size list config info wrapper all config info new array list config info wrapper for int page no page no page count page no list config info wrapper config info list list group key md5 by page page no page size all config info add all config info list return all config info override public list config info wrapper list group key md5 by page int page no int page size string sql count row select count from config info string sql fetch row select t id datum id group id tenant id app name type md5 gmt modify from select id from config info order by id limit g config info t where g id t id pagination helper config info wrapper helper create pagination helper page config info wrapper page helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info wrapper row mapper return page get page item override public string generate like argument string s string fuzzy search sign string sql like percent sign if s contain pattern str return s replace all fuzzy search sign sql like percent sign else return s override public config info wrapper query config info final string data id final string group final string tenant string tenant tmp string util be blank tenant string util empty tenant final string sql select id datum id group id tenant id app name content type gmt modify md5 from config info where datum id and group id and tenant id return database operate query one sql new object datum id group tenant tmp config info wrapper row mapper override public boolean be exist table string table name string sql string format select from s limit table name try database operate query one sql integer class return true catch throwable e return false override public boolean complete md5 default log info start complete md5 int per page size int row count config info count int page count int math ceil row count 1.0 per page size int actual row count for int page no page no page count page no page config info wrapper page find all config info for dump all page no per page size if page null for config info wrapper cf page get page item string md5 in db cf get md5 final string content cf get content final string tenant cf get tenant final string md5 m d5 util md5 hex content constant encode if string util be blank md5 in db try update md5 cf get datum id cf get group tenant md5 new timestamp cf get last modify catch throwable e log util default log error complete md5 error dat id group last modify cf get datum id cf get group new timestamp cf get last modify else if md5 in db equal md5 try update md5 cf get datum id cf get group tenant md5 new timestamp cf get last modify catch throwable e log util default log error complete md5 error dat id group last modify cf get datum id cf get group new timestamp cf get last modify actual row count page get page item size default log info complete md5 actual row count row count return true override public list config all info find all config info4 export final string data id final string group final string tenant final string app name final list long id string tenant tmp string util be blank tenant string util empty tenant string builder where new string builder where list object param list new array list if collection util be empty id where append id in for int i i id size i if i where append where append param list add id get i where append else where append tenant id param list add tenant tmp if string util be blank datum id where append and datum id like param list add generate like argument datum id if string util be not blank group where append and group id param list add group if string util be not blank app name where append and app name param list add app name return database operate query many sql find all config info where param list to array config all info row mapper override public map string object batch insert or update list config all info config info list string src user string src ip map string object config advance info timestamp time boolean notify same config policy policy throw naco exception int succ count int skip count list map string string fail datum null list map string string skip datum null for int i i config info list size i config all info config info config info list get i try param util check param config info get datum id config info get group datum id config info get content catch throwable e default log error datum verification fail e throw e config info config info2 save new config info config info get datum id config info get group config info get tenant config info get app name config info get content string type config info get type if string util be blank type simple judgment of file type base on suffix if config info get datum id contain spot string ext name config info get datum id substr config info get datum id last index of spot to upper case try type file type enum value of ext name to upper case get file type catch throwable ex type file type enum text get file type if config advance info null config advance info new hash map config advance info put type type try add config info src ip src user config info2 save time config advance info notify succ count catch throwable e if string util contain duplicate key exception e to string throw e uniqueness constraint conflict if same config policy abort equal policy fail datum new array list skip datum new array list map string string faileditem new hash map faileditem put datum id config info2 save get datum id faileditem put group config info2 save get group fail datum add faileditem for int j i j config info list size j config info skip config info config info list get j map string string skipitem new hash map skipitem put datum id skip config info get datum id skipitem put group skip config info get group skip datum add skipitem break else if same config policy skip equal policy skip count if skip datum null skip datum new array list map string string skipitem new hash map skipitem put datum id config info2 save get datum id skipitem put group config info2 save get group skip datum add skipitem else if same config policy overwrite equal policy succ count update config info config info2 save src ip src user time config advance info notify map string object result new hash map result put succ count succ count result put skip count skip count if fail datum null fail datum be empty result put fail datum fail datum if skip datum null skip datum be empty result put skip datum skip datum return result override public int tenant info count by tenant id string tenant id assert have text tenant id tenant id can not be null integer result database operate query one sql tenant info count by tenant id new string tenant id integer class if result null return return result 
standalone database operate impl conditional condition standalone embed storage class component public class standalone database operate impl implement base database operate private jdbc template jdbc template private transaction template transaction template post construct protect void init datum source service datum source service dynamic datum source get instance get datum source jdbc template datum source service get jdbc template transaction template datum source service get transaction template log util default log info use standalone database operate impl override public r r query one string sql class r cl return query one jdbc template sql cl override public r r query one string sql object arg class r cl return query one jdbc template sql args cl override public r r query one string sql object arg row mapper r mapper return query one jdbc template sql arg mapper override public r list r query many string sql object arg row mapper r mapper return query many jdbc template sql arg mapper override public r list r query many string sql object arg class be r class return query many jdbc template sql arg be class override public list map string object query many string sql object arg return query many jdbc template sql arg override public completable future rest result string datum import file file return completable future supply async try disk util line iterator iterator disk util line iterator file int batch size list string batch update new array list batch size list completable future void future new array list list boolean result new copy on write array list while iterator have next string sql iterator next if string util be not blank sql batch update add sql if batch update size batch size iterator have next list modify request sql batch update stream map s modify request request new modify request request set sql s return request collect collector to list future add completable future run async result add do datum import jdbc template sql batch update clear completable future all of future to array new completable future join return rest result string builder with code boolean util and result to array new boolean with datum build catch throwable ex log util default log error a exception occur when external datum be import into derby ex return rest result util fail ex get message override public boolean update list modify request modify request bi consumer boolean throwable consumer return update modify request override public boolean update list modify request request list return update transaction template jdbc template request list 
external storage persist service impl suppress warning value pmd method return wrapper type rule checkstyle linelength conditional value condition on external storage class component public class external storage persist service impl implement persist service private datum source service datum source service private static final string sql find all config info select id datum id group id tenant id app name content type md5 gmt create gmt modify src user src ip c desc c use effect c schema from config info private static final string sql tenant info count by tenant id select count from tenant info where tenant id private static final string sql find config info by id select id datum id group id tenant id app name content md5 from config info where private static final string sql delete config info by id delete from config info where private static final string pattern str private static final int query limit size protect jdbc template jt protect transaction template tjt constant variable public static final string spot init datasource post construct public void init datum source service dynamic datum source get instance get datum source jt get jdbc template tjt get transaction template public boolean check master writable return datum source service check master writable public void set basic datum source service datum source service datum source service this data source service datum source service public synchronize void reload throw i o exception this data source service reload for unit test public jdbc template get jdbc template return this data source service get jdbc template public transaction template get transaction template return this data source service get transaction template suppress warning checkstyle abbreviation as word in name public string get current d b url return this data source service get current db url override public e pagination helper e create pagination helper return new external storage pagination helper impl e jt config info table insert update delete override public void add config info final string src ip final string src user final config info config info final timestamp time final map string object config advance info final boolean notify boolean result tjt execute status try long config id add config info atomic src ip src user config info time config advance info string config tag config advance info null null string config advance info get config tag add config tag relation config id config tag config info get datum id config info get group config info get tenant insert config history atomic config info src ip src user time i catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e return boolean true override public void add config info4 beta config info config info string beta ip string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant string md5 m d5 util md5 hex config info get content constant encode try jt update insert into config info beta datum id group id tenant id app name content md5 beta ip src ip src user gmt create gmt modify value config info get datum id config info get group tenant tmp app name tmp config info get content md5 beta ip src ip src user time time catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void add config info4 tag config info config info string tag string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant string tag tmp string util be blank tag string util empty tag trim string md5 m d5 util md5 hex config info get content constant encode try jt update insert into config info tag datum id group id tenant id tag id app name content md5 src ip src user gmt create gmt modify value config info get datum id config info get group tenant tmp tag tmp app name tmp config info get content md5 src ip src user time time catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void update config info final config info config info final string src ip final string src user final timestamp time final map string object config advance info final boolean notify boolean result tjt execute status try config info old config info find config info config info get datum id config info get group config info get tenant string app name tmp old config info get app name if the app name pass by the user be not empty use the persistent user s app name otherwise use db when empty app name you need to pass a empty string if config info get app name null config info set app name app name tmp update config info atomic config info src ip src user time config advance info string config tag config advance info null null string config advance info get config tag if config tag null delete all tag and then recreate remove tag by id atomic old config info get id add config tag relation old config info get id config tag config info get datum id config info get group config info get tenant insert config history atomic old config info get id old config info src ip src user time u catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e return boolean true override public void update config info4 beta config info config info string beta ip string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant string md5 m d5 util md5 hex config info get content constant encode try jt update update config info beta set content md5 src ip src user gmt modify app name where datum id and group id and tenant id config info get content md5 src ip src user time app name tmp config info get datum id config info get group tenant tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void update config info4 tag config info config info string tag string src ip string src user timestamp time boolean notify string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant string tag tmp string util be blank tag string util empty tag trim try string md5 m d5 util md5 hex config info get content constant encode jt update update config info tag set content md5 src ip src user gmt modify app name where datum id and group id and tenant id and tag id config info get content md5 src ip src user time app name tmp config info get datum id config info get group tenant tmp tag tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void insert or update beta final config info config info final string beta ip final string src ip final string src user final timestamp time final boolean notify try add config info4 beta config info beta ip src ip null time notify catch datum integrity violation exception ive unique constraint conflict update config info4 beta config info beta ip src ip null time notify override public void insert or update tag final config info config info final string tag final string src ip final string src user final timestamp time final boolean notify try add config info4 tag config info tag src ip null time notify catch datum integrity violation exception ive unique constraint conflict update config info4 tag config info tag src ip null time notify override public void update md5 string datum id string group string tenant string md5 timestamp last time string tenant tmp string util be blank tenant string util empty tenant try jt update update config info set md5 where datum id and group id and tenant id and gmt modify md5 datum id group tenant tmp last time catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void insert or update string src ip string src user config info config info timestamp time map string object config advance info insert or update src ip src user config info time config advance info true override public void insert or update string src ip string src user config info config info timestamp time map string object config advance info boolean notify try add config info src ip src user config info time config advance info notify catch datum integrity violation exception ive unique constraint conflict update config info config info src ip src user time config advance info notify override public void insert or update sub sub info sub info try add config sub atomic sub info get datum id sub info get group sub info get app name sub info get date catch data integrity violation exception ive unique constraint conflict update config sub atomic sub info get datum id sub info get group sub info get app name sub info get date override public void remove config info final string data id final string group final string tenant final string src ip final string src user tjt execute new transaction callback boolean final timestamp time new timestamp system current time milli override public boolean do in transaction transaction status status try config info config info find config info datum id group tenant if config info null remove config info atomic datum id group tenant src ip src user remove tag by id atomic config info get id insert config history atomic config info get id config info src ip src user time d catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e return boolean true override public list config info remove config info by id final list long id final string src ip final string src user if collection util be empty id return null id remove all collection singleton null list config info result tjt execute new transaction callback list config info final timestamp time new timestamp system current time milli override public list config info do in transaction transaction status status try string id str joiner on join id list config info config info list find config info by id id str if collection util be empty config info list remove config info by id atomic id str for config info config info config info list remove tag by id atomic config info get id insert config history atomic config info get id config info src ip src user time d return config info list catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e return result override public void remove config info4 beta final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant tjt execute status try config info config info find config info4 beta datum id group tenant if config info null jt update delete from config info beta where datum id and group id and tenant id datum id group tenant tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e return boolean true config aggr info table insert update delete override public boolean add aggr config info final string data id final string group string tenant final string datum id string app name final string content string app name tmp string util be blank app name string util empty app name string tenant tmp string util be blank tenant string util empty tenant final timestamp now new timestamp system current time millis string select select content from config info aggr where datum id and group id and tenant id and datum id string insert insert into config info aggr datum id group id tenant id datum id app name content gmt modify value string update update config info aggr set content gmt modify where datum id and group id and tenant id and datum id try try string db content jt query for object select new object datum id group tenant tmp datum id string class if db content null db content equal content return true else return jt update update content now data id group tenant tmp datum id catch empty result datum access exception ex no datum insert return jt update insert datum id group tenant tmp datum id app name tmp content now catch datum access exception e log util fatal log error db error e to string e throw e override public void remove single aggr config info final string data id final string group final string tenant final string datum id final string tenant tmp string util be blank tenant string util empty tenant string sql delete from config info aggr where datum id and group id and tenant id and datum id try this jt update sql new prepared statement setter override public void set value prepared statement ps throw s q l exception int index ps set string index datum id ps set string index group ps set string index tenant tmp ps set string index datum id catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void remove aggr config info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant string sql delete from config info aggr where datum id and group id and tenant id try this jt update sql new prepared statement setter override public void set value prepared statement ps throw s q l exception int index ps set string index datum id ps set string index group ps set string index tenant tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public boolean batch remove aggr final string data id final string group final string tenant final list string datum list final string tenant tmp string util be blank tenant string util empty tenant final string builder datum string new string builder for string datum datum list datum string append append datum append datum string delete char at datum string length final string sql delete from config info aggr where datum id and group id and tenant id and datum id in datum string to string try jt update sql datum id group tenant tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e return false return true override public void remove config history final timestamp start time final int limit size string sql delete from he config info where gmt modify limit pagination helper config info helper create pagination helper try helper update limit sql new object start time limit size catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public int find config history count by time final timestamp start time string sql select count from he config info where gmt modify integer result jt query for object sql integer class new object start time if result null throw new illegal argument exception config info beta count error return result int value override public long find config max id string sql select max id from config info try return jt query for object sql long class catch null pointer exception e return override public boolean batch publish aggr final string data id final string group final string tenant final map string string datum map final string app name try boolean be publish ok tjt execute new transaction callback boolean override public boolean do in transaction transaction status status for map entry string string entry datum map entry set try if add aggr config info datum id group tenant entry get key app name entry get value throw new transaction system exception error in add aggr config info catch throwable e throw new transaction system exception error in add aggr config info return boolean true if be publish ok null return false return be publish ok catch transaction exception e log util fatal log error db error e to string e return false override public boolean replace aggr final string data id final string group final string tenant final map string string datum map final string app name try boolean be replace ok tjt execute new transaction callback boolean override public boolean do in transaction transaction status status try string app name tmp app name null app name remove aggr config info datum id group tenant string tenant tmp string util be blank tenant string util empty tenant string sql insert into config info aggr datum id group id tenant id datum id app name content gmt modify value for map entry string string datum entry datum map entry set jt update sql datum id group tenant tmp datum entry get key app name tmp datum entry get value new timestamp system current time milli catch throwable e throw new transaction system exception error in add aggr config info return boolean true if be replace ok null return false return be replace ok catch transaction exception e log util fatal log error db error e to string e return false deprecate override public list config info find all datum id and group string sql select distinct datum id group id from config info try return jt query sql new object config info row mapper catch empty result datum access exception e return collection empty list catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e catch exception e log util fatal log error db other error e get message e throw new runtime exception e override public config info4 beta find config info4 beta final string data id final string group final string tenant string tenant tmp string util be blank tenant string util empty tenant try return this jt query for object select id datum id group id tenant id app name content beta ip from config info beta where datum id and group id and tenant id new object datum id group tenant tmp config i n f o4 b e t a row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config info4 tag find config info4 tag final string data id final string group final string tenant final string tag string tenant tmp string util be blank tenant string util empty tenant string tag tmp string util be blank tag string util empty tag trim try return this jt query for object select id datum id group id tenant id tag id app name content from config info tag where datum id and group id and tenant id and tag id new object datum id group tenant tmp tag tmp config i n f o4 t a g row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config info find config info app final string data id final string group final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant try return this jt query for object select id datum id group id tenant id app name content from config info where datum id and group id and tenant id and app name new object datum id group tenant tmp app name config info row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config info find config info advance info final string data id final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag list string param list new array list string param list add datum id param list add group param list add tenant tmp string builder sql new string builder select id datum id group id tenant id app name content from config info where datum id and group id and tenant id if string util be not blank config tag sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a data id and a group id and a tenant id sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql append sql append param list add tag arr i sql append if string util be not blank app name sql append and a app name param list add app name else if string util be not blank app name sql append and app name param list add app name try return this jt query for object sql to string param list to array config info row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config info base find config info base final string data id final string group try return this jt query for object select id datum id group id content from config info where datum id and group id and tenant id new object datum id group string util empty config info base row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config info find config info long id try return this jt query for object select id datum id group id tenant id app name content from config info where id new object id config info row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config info find config info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant try return this jt query for object select id datum id group id tenant id app name content md5 type from config info where datum id and group id and tenant id new object datum id group tenant tmp config info row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by datum id final int page no final int page size final string data id final string tenant string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper try return helper fetch page select count from config info where datum id and tenant id select id datum id group id tenant id app name content from config info where datum id and tenant id new object datum id tenant tmp page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by datum id and app final int page no final int page size final string data id final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper try return helper fetch page select count from config info where datum id and tenant id and app name select id datum id group id tenant id app name content from config info where datum id and tenant id and app name new object datum id tenant tmp app name page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by datum id and advance final int page no final int page size final string data id final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string builder sql count new string builder select count from config info where datum id and tenant id string builder sql new string builder select id datum id group id tenant id app name content from config info where datum id and tenant id list string param list new array list string param list add datum id param list add tenant tmp if string util be not blank config tag sql count new string builder select count from config info a left join config tag relation b on a id b id where a data id and a tenant id sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a data id and a tenant id sql count append and b tag name in sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql count append sql append sql count append sql append param list add tag arr i sql count append sql append if string util be not blank app name sql count append and a app name sql append and a app name param list add app name else if string util be not blank app name sql count append and app name sql append and app name param list add app name try return helper fetch page sql count to string sql to string param list to array page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info4 page final int page no final int page size final string data id final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string sql count select count from config info string sql select id datum id group id tenant id app name content type from config info string builder where new string builder where list string param list new array list string param list add tenant tmp if string util be not blank config tag sql count select count from config info a left join config tag relation b on a id b id sql select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where append a tenant id if string util be not blank datum id where append and a data id param list add datum id if string util be not blank group where append and a group id param list add group if string util be not blank app name where append and a app name param list add app name where append and b tag name in string tag arr config tag split for int i i tag arr length i if i where append where append param list add tag arr i where append else where append tenant id if string util be not blank datum id where append and datum id param list add datum id if string util be not blank group where append and group id param list add group if string util be not blank app name where append and app name param list add app name try return helper fetch page sql count where sql where param list to array page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info base find config info base by datum id final int page no final int page size final string datum id pagination helper config info base helper create pagination helper try return helper fetch page select count from config info where datum id and tenant id select id datum id group id content from config info where datum id and tenant id new object datum id string util empty page no page size config info base row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by group final int page no final int page size final string group final string tenant string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper try return helper fetch page select count from config info where group id and tenant id select id datum id group id tenant id app name content from config info where group id and tenant id new object group tenant tmp page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by group and app final int page no final int page size final string group final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper try return helper fetch page select count from config info where group id and tenant id and app name select id datum id group id tenant id app name content from config info where group id and tenant id and app name new object group tenant tmp app name page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by group and advance final int page no final int page size final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string builder sql count new string builder select count from config info where group id and tenant id string builder sql new string builder select id datum id group id tenant id app name content from config info where group id and tenant id list string param list new array list string param list add group param list add tenant tmp if string util be not blank config tag sql count new string builder select count from config info a left join config tag relation b on a id b id where a group id and a tenant id sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a group id and a tenant id sql count append and b tag name in sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql count append sql append sql count append sql append param list add tag arr i sql count append sql append if string util be not blank app name sql count append and a app name sql append and a app name param list add app name else if string util be not blank app name sql count append and app name sql append and app name param list add app name try return helper fetch page sql count to string sql to string param list to array page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by app final int page no final int page size final string tenant final string app name string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper try return helper fetch page select count from config info where tenant id like and app name select id datum id group id tenant id app name content from config info where tenant id like and app name new object generate like argument tenant tmp app name page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info by advance final int page no final int page size final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant pagination helper config info helper create pagination helper final string app name config advance info null null string config advance info get app name final string config tag config advance info null null string config advance info get config tag string builder sql count new string builder select count from config info where tenant id like string builder sql new string builder select id datum id group id tenant id app name content from config info where tenant id like list string param list new array list string param list add tenant tmp if string util be not blank config tag sql count new string builder select count from config info a left join config tag relation b on a id b id where a tenant id sql new string builder select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where a tenant id sql count append and b tag name in sql append and b tag name in string tag arr config tag split for int i i tag arr length i if i sql count append sql append sql count append sql append param list add tag arr i sql count append sql append if string util be not blank app name sql count append and a app name sql append and a app name param list add app name else if string util be not blank app name sql count append and app name sql append and app name param list add app name try return helper fetch page sql count to string sql to string param list to array page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info base find config info base by group final int page no final int page size final string group pagination helper config info base helper create pagination helper try return helper fetch page select count from config info where group id and tenant id select id datum id group id content from config info where group id and tenant id new object group string util empty page no page size config info base row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public int config info count string sql select count id from config info integer result jt query for object sql integer class if result null throw new illegal argument exception config info count error return result int value override public int config info count string tenant string sql select count id from config info where tenant id like tenant integer result jt query for object sql integer class if result null throw new illegal argument exception config info count error return result int value override public int config info beta count string sql select count id from config info beta integer result jt query for object sql integer class if result null throw new illegal argument exception config info beta count error return result int value override public int config info tag count string sql select count id from config info tag integer result jt query for object sql integer class if result null throw new illegal argument exception config info beta count error return result int value override public list string get tenant id list int page int page size string sql select tenant id from config info where tenant id group by tenant id limit int from page page size return jt query for list sql string class from page size override public list string get group id list int page int page size string sql select group id from config info where tenant id group by group id limit int from page page size return jt query for list sql string class from page size override public int aggr config info count string datum id string group string tenant string tenant tmp string util be blank tenant string util empty tenant string sql select count id from config info aggr where datum id and group id and tenant id integer result jt query for object sql integer class new object datum id group tenant tmp if result null throw new illegal argument exception aggr config info count error return result int value override public int aggr config info count string datum id string group string tenant list string datum id boolean be in if datum id null datum id be empty return final string tenant tmp string util be blank tenant string util empty tenant string builder sql new string builder select count from config info aggr where datum id and group id and tenant id and datum id if be in sql append in else sql append not in for int i size datum id size i size i if i sql append sql append sql append list object object list list object new array list datum id group tenant tmp object list add all datum id integer result jt query for object sql to string integer class object list to array if result null throw new illegal argument exception aggr config info count error return result int value override public int aggr config info count in string datum id string group string tenant list string datum id return aggr config info count datum id group tenant datum id true override public int aggr config info count not in string datum id string group string tenant list string datum id return aggr config info count datum id group tenant datum id false override public page config info find all config info final int page no final int page size final string tenant string tenant tmp string util be blank tenant string util empty tenant string sql count row select count from config info string sql fetch row select t id datum id group id tenant id app name content md5 from select id from config info where tenant id like order by id limit g config info t where g id t id pagination helper config info helper create pagination helper try return helper fetch page limit sql count row sql fetch row new object generate like argument tenant tmp page no page size page size page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config key find all config key final int page no final int page size final string tenant string tenant tmp string util be blank tenant string util empty tenant string select select datum id group id app name from select id from config info where tenant id like order by id limit g config info t where g id t id final int total count config info count tenant int page count total count page size if total count page size page count page count if page no page count return null final page config key page new page config key page set page number page no page set page available page count page set total count total count try list config key result jt query select new object generate like argument tenant tmp page no page size page size new object config key row mapper for config key item result page get page item add item return page catch empty result datum access exception e return page catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override deprecate public page config info base find all config info base final int page no final int page size string sql count row select count from config info string sql fetch row select t id datum id group id content md5 from select id from config info order by id limit g config info t where g id t id pagination helper config info base helper create pagination helper try return helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info base row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info wrapper find all config info for dump all final int page no final int page size string sql count row select count from config info string sql fetch row select t id type datum id group id tenant id app name content md5 gmt modify from select id from config info order by id limit g config info t where g id t id pagination helper config info wrapper helper create pagination helper list string param new array list string try return helper fetch page limit sql count row sql fetch row param to array page no page size config info wrapper row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info wrapper find all config info fragment final long last max id final int page size string select select id datum id group id tenant id app name content md5 gmt modify type from config info where id order by id asc limit pagination helper config info wrapper helper create pagination helper try return helper fetch page limit select new object last max id page size page size config info wrapper row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info beta wrapper find all config info beta for dump all final int page no final int page size string sql count row select count from config info beta string sql fetch row select t id datum id group id tenant id app name content md5 gmt modify beta ip from select id from config info beta order by id limit g config info beta t where g id t id pagination helper config info beta wrapper helper create pagination helper try return helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info beta wrapper row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info tag wrapper find all config info tag for dump all final int page no final int page size string sql count row select count from config info tag string sql fetch row select t id datum id group id tenant id tag id app name content md5 gmt modify from select id from config info tag order by id limit g config info tag t where g id t id pagination helper config info tag wrapper helper create pagination helper try return helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info tag wrapper row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list config info find config info by batch final list string data id final string group final string tenant int sub query limit assert dataid group not null string tenant tmp string util be blank tenant string util empty tenant if dataid empty return empty list if collection util be empty datum id return collection empty list batch query limit the number of in be control within the shorter the length of the sql statement the better if sub query limit query limit size sub query limit list config info result new array list config info datum id size string sql start select datum id group id tenant id app name content from config info where group id and tenant id and data id in string sql end string builder sub query sql new string builder for int i i datum id size i sub query limit dataid list string param new array list string datum id sub list i i sub query limit datum id size i sub query limit datum id size for int j j param size j sub query sql append if j param size sub query sql append group param add group param add tenant tmp list config info be this jt query sql start sub query sql to string sql end param to array config info row mapper assert not null if r null r size result add all r return result override public page config info find config info like final int page no final int page size final string data id final string group final string tenant final string app name final string content string tenant tmp string util be blank tenant string util empty tenant if string util be blank datum id string util be blank group if string util be blank app name return this find all config info page no page size tenant tmp else return this find config info by app page no page size tenant tmp app name pagination helper config info helper create pagination helper string sql count row select count from config info where string sql fetch row select id datum id group id tenant id app name content from config info where string where 1 = 1 list string param new array list string if string util be blank datum id where and datum id like param add generate like argument datum id if string util be blank group where and group id like param add generate like argument group where and tenant id like param add generate like argument tenant tmp if string util be blank app name where and app name param add app name if string util be blank content where and content like param add generate like argument content try return helper fetch page sql count row where sql fetch row where param to array page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info like final int page no final int page size final config key config key final boolean blacklist string sql count row select count from config info where string sql fetch row select id datum id group id tenant id app name content from config info where string builder where new string builder 1 = 1 whitelist please leave the synchronization condition empty there be no configuration that meet the condition if config key length blacklist false page config info page new page config info page set total count return page pagination helper config info helper create pagination helper list string param new array list string boolean be first true for config key config info config key string data id config info get datum id string group config info get group string app name config info get app name if string util be blank datum id string util be blank group string util be blank app name break if blacklist if be first be first false where append and else where append and where append boolean be first sub true if string util be blank datum id where append datum id not like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append or where append group id not like param add generate like argument group be first sub false if string util be blank app name if be first sub where append or where append app name param add app name be first sub false where append else if be first be first false where append and else where append or where append boolean be first sub true if string util be blank datum id where append datum id like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append and where append group id like param add generate like argument group be first sub false if string util be blank app name if be first sub where append and where append app name param add app name be first sub false where append try return helper fetch page sql count row where to string sql fetch row where to string param to array page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info find config info like4 page final int page no final int page size final string data id final string group final string tenant final map string object config advance info string tenant tmp string util be blank tenant string util empty tenant final string app name config advance info null null string config advance info get app name final string content config advance info null null string config advance info get content final string config tag config advance info null null string config advance info get config tag pagination helper config info helper create pagination helper string sql count row select count from config info string sql fetch row select id datum id group id tenant id app name content from config info string builder where new string builder where list string param new array list string param add generate like argument tenant tmp if string util be not blank config tag sql count row select count from config info a left join config tag relation b on a id b id sql fetch row select a id a data id a group id a tenant id a app name a content from config info a left join config tag relation b on a id b id where append a tenant id like if string util be blank datum id where append and a data id like param add generate like argument datum id if string util be blank group where append and a group id like param add generate like argument group if string util be blank app name where append and a app name param add app name if string util be blank content where append and a content like param add generate like argument content where append and b tag name in string tag arr config tag split for int i i tag arr length i if i where append where append param add tag arr i where append else where append tenant id like if string util be blank datum id where append and datum id like param add generate like argument datum id if string util be blank group where append and group id like param add generate like argument group if string util be blank app name where append and app name param add app name if string util be blank content where append and content like param add generate like argument content try return helper fetch page sql count row where sql fetch row where param to array page no page size config info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info base find config info base like final int page no final int page size final string data id final string group final string content throw i o exception if string util be blank datum id string util be blank group throw new i o exception invalid param pagination helper config info base helper create pagination helper string sql count row select count from config info where string sql fetch row select id datum id group id tenant id content from config info where string where 1 = 1 and tenant id list string param new array list string if string util be blank datum id where and datum id like param add generate like argument datum id if string util be blank group where and group id like param add generate like argument group if string util be blank content where and content like param add generate like argument content try return helper fetch page sql count row where sql fetch row where param to array page no page size config info base row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config info aggr find single config info aggr string datum id string group string tenant string datum id string tenant tmp string util be blank tenant string util empty tenant string sql select id datum id group id tenant id datum id app name content from config info aggr where datum id and group id and tenant id and datum id try return this jt query for object sql new object datum id group tenant tmp datum id config info aggr row mapper catch empty result datum access exception e empty result datum access exception indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e catch exception e log util fatal log error db other error e get message e throw new runtime exception e override public list config info aggr find config info aggr string datum id string group string tenant string tenant tmp string util be blank tenant string util empty tenant string sql select datum id group id tenant id datum id app name content from config info aggr where datum id and group id and tenant id order by datum id try return this jt query sql new object datum id group tenant tmp config info aggr row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e catch empty result datum access exception e return collection empty list catch exception e log util fatal log error db other error e get message e throw new runtime exception e override public page config info aggr find config info aggr by page string datum id string group string tenant final int page no final int page size string tenant tmp string util be blank tenant string util empty tenant string sql count row select count from config info aggr where datum id and group id and tenant id string sql fetch row select datum id group id tenant id datum id app name content from config info aggr where datum id and group id and tenant id order by datum id limit pagination helper config info aggr helper create pagination helper try return helper fetch page limit sql count row new object datum id group tenant tmp sql fetch row new object datum id group tenant tmp page no page size page size page no page size config info aggr row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public page config info aggr find config info aggr like final int page no final int page size config key config key boolean blacklist string sql count row select count from config info aggr where string sql fetch row select datum id group id tenant id datum id app name content from config info aggr where string builder where new string builder 1 = 1 whitelist please leave the synchronization condition empty there be no configuration that meet the condition if config key length blacklist false page config info aggr page new page config info aggr page set total count return page pagination helper config info aggr helper create pagination helper list string param new array list string boolean be first true for config key config info aggr config key string data id config info aggr get datum id string group config info aggr get group string app name config info aggr get app name if string util be blank datum id string util be blank group string util be blank app name break if blacklist if be first be first false where append and else where append and where append boolean be first sub true if string util be blank datum id where append datum id not like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append or where append group id not like param add generate like argument group be first sub false if string util be blank app name if be first sub where append or where append app name param add app name be first sub false where append else if be first be first false where append and else where append or where append boolean be first sub true if string util be blank datum id where append datum id like param add generate like argument datum id be first sub false if string util be blank group if be first sub where append and where append group id like param add generate like argument group be first sub false if string util be blank app name if be first sub where append and where append app name param add app name be first sub false where append try page config info aggr result helper fetch page sql count row where to string sql fetch row where to string param to array page no page size config info aggr row mapper return result catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list config info change find all aggr group string sql select distinct datum id group id tenant id from config info aggr try return jt query sql new object config info change row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e catch empty result datum access exception e return null catch exception e log util fatal log error db other error e get message e throw new runtime exception e override public list string find datum id by content string datum id string group id string content string sql select datum id from config info aggr where datum id and group id and content try return this jt query for list sql new object datum id group id content string class catch empty result datum access exception e return null catch incorrect result size datum access exception e return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list config info wrapper find change config final timestamp start time final timestamp end time try list map string object list jt query for list select datum id group id tenant id app name content gmt modify from config info where gmt modify and gmt modify new object start time end time return convert change config list catch data access exception e log util fatal log error db error e to string e throw e override public page config info wrapper find change config final string data id final string group final string tenant final string app name final timestamp start time final timestamp end time final int page no final int page size final long last max id string tenant tmp string util be blank tenant string util empty tenant string sql count row select count from config info where string sql fetch row select id datum id group id tenant id app name content type md5 gmt modify from config info where string where 1 = 1 list object param new array list object if string util be blank datum id where and datum id like param add generate like argument datum id if string util be blank group where and group id like param add generate like argument group if string util be blank tenant tmp where and tenant id param add tenant tmp if string util be blank app name where and app name param add app name if start time null where and gmt modify param add start time if end time null where and gmt modify param add end time pagination helper config info wrapper helper create pagination helper try return helper fetch page sql count row where sql fetch row where param to array page no page size last max id config info wrapper row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list config info find delete config final timestamp start time final timestamp end time try list map string object list jt query for list select distinct datum id group id tenant id from he config info where op type d and gmt modify and gmt modify new object start time end time return convert delete config list catch data access exception e log util fatal log error db error e to string e throw e override public long add config info atomic final long config id final string src ip final string src user final config info config info final timestamp time map string object config advance info final string app name tmp string util be blank config info get app name string util empty config info get app name final string tenant tmp string util be blank config info get tenant string util empty config info get tenant final string desc config advance info null null string config advance info get desc final string use config advance info null null string config advance info get use final string effect config advance info null null string config advance info get effect final string type config advance info null null string config advance info get type final string schema config advance info null null string config advance info get schema final string md5 tmp m d5 util md5 hex config info get content constant encode key holder key holder new generate key holder final string sql insert into config info datum id group id tenant id app name content md5 src ip src user gmt create gmt modify c desc c use effect type c schema value try jt update new prepared statement creator override public prepared statement create prepared statement connection connection throw s q l exception prepared statement ps connection prepare statement sql statement return generate key ps set string config info get datum id ps set string config info get group ps set string tenant tmp ps set string app name tmp ps set string config info get content ps set string md5 tmp ps set string src ip ps set string src user ps set timestamp time ps set timestamp time ps set string desc ps set string use ps set string effect ps set string type ps set string schema return ps key holder number nu key holder get key if nu null throw new illegal argument exception insert config info fail return nu long value catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void add config tag relation long config id string config tag string data id string group string tenant if string util be not blank config tag string tag arr config tag split for int i i tag arr length i add config tag relation atomic config id tag arr i datum id group tenant override public void add config tag relation atomic long config id string tag name string datum id string group string tenant try jt update insert into config tag relation id tag name tag type datum id group id tenant id value config id tag name null datum id group tenant catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void remove tag by id atomic long id try jt update delete from config tag relation where id id catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list string get config tag by tenant string tenant string sql select tag name from config tag relation where tenant id try return jt query for list sql new object tenant string class catch empty result datum access exception e return null catch incorrect result size datum access exception e return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list string select tag by config string datum id string group string tenant string sql select tag name from config tag relation where datum id and group id and tenant id try return jt query for list sql new object datum id group tenant string class catch empty result datum access exception e return null catch incorrect result size datum access exception e return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void remove config info atomic final string data id final string group final string tenant final string src ip final string src user string tenant tmp string util be blank tenant string util empty tenant try jt update delete from config info where datum id and group id and tenant id datum id group tenant tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void remove config info by id atomic final string id if string util be blank id return string builder sql new string builder sql delete config info by id sql append id in list long param list new array list string tag arr id split for int i i tag arr length i if i sql append sql append param list add long parse long tag arr i sql append try jt update sql to string param list to array catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void remove config info tag final string data id final string group final string tenant final string tag final string src ip final string src user string tenant tmp string util be blank tenant string util empty tenant string tag tmp string util be blank tag string util empty tag try jt update delete from config info tag where datum id and group id and tenant id and tag id datum id group tenant tmp tag tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void update config info atomic final config info config info final string src ip final string src user final timestamp time map string object config advance info string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant final string md5 tmp m d5 util md5 hex config info get content constant encode string desc config advance info null null string config advance info get desc string use config advance info null null string config advance info get use string effect config advance info null null string config advance info get effect string type config advance info null null string config advance info get type string schema config advance info null null string config advance info get schema try jt update update config info set content md5 src ip src user gmt modify app name c desc c use effect type c schema where datum id and group id and tenant id config info get content md5 tmp src ip src user time app name tmp desc use effect type schema config info get datum id config info get group tenant tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list config info find config info by id final string id if string util be blank id return null string builder sql new string builder sql find config info by id sql append id in list long param list new array list string tag arr id split for int i i tag arr length i if i sql append sql append param list add long parse long tag arr i sql append try return this jt query sql to string param list to array config info row mapper catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config advance info find config advance info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant try list string config tag list this select tag by config datum id group tenant config advance info config advance this jt query for object select gmt create gmt modify src user src ip c desc c use effect type c schema from config info where datum id and group id and tenant id new object datum id group tenant tmp config advance info row mapper if config tag list null config tag list be empty string builder config tag tmp new string builder for string config tag config tag list if config tag tmp length config tag tmp append config tag else config tag tmp append append config tag config advance set config tag config tag tmp to string return config advance catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config all info find config all info final string data id final string group final string tenant final string tenant tmp string util be blank tenant string util empty tenant try list string config tag list this select tag by config datum id group tenant config all info config advance this jt query for object select id datum id group id tenant id app name content md5 gmt create gmt modify src user src ip c desc c use effect type c schema from config info where datum id and group id and tenant id new object datum id group tenant tmp config all info row mapper if config tag list null config tag list be empty string builder config tag tmp new string builder for string config tag config tag list if config tag tmp length config tag tmp append config tag else config tag tmp append append config tag config advance set config tag config tag tmp to string return config advance catch empty result datum access exception e indicate that the datum do not exist return null return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void insert config history atomic long id config info config info string src ip string src user final timestamp time string op string app name tmp string util be blank config info get app name string util empty config info get app name string tenant tmp string util be blank config info get tenant string util empty config info get tenant final string md5 tmp m d5 util md5 hex config info get content constant encode try jt update insert into he config info id datum id group id tenant id app name content md5 src ip src user gmt modify op type value id config info get datum id config info get group tenant tmp app name tmp config info get content md5 tmp src ip src user time op catch data access exception e log util fatal log error db error e to string e throw e override public page config history info find config history string datum id string group string tenant int page no int page size pagination helper config history info helper create pagination helper string tenant tmp string util be blank tenant string util empty tenant string sql count row select count from he config info where datum id and group id and tenant id string sql fetch row select nid datum id group id tenant id app name src ip op type gmt create gmt modify from he config info where datum id and group id and tenant id order by nid desc page config history info page null try page helper fetch page sql count row sql fetch row new object datum id group tenant tmp page no page size history list row mapper catch data access exception e log util fatal log error list config history error datum id group new object datum id group e throw e return page override public void add config sub atomic final string data id final string group final string app name final timestamp date final string app name tmp app name null app name try jt update insert into app configdata relation sub datum id group id app name gmt modify value datum id group app name tmp date catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public void update config sub atomic final string data id final string group final string app name final timestamp time final string app name tmp app name null app name try jt update update app configdata relation sub set gmt modify where datum id and group id and app name time datum id group app name tmp catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public config history info detail config history long nid string sql fetch row select nid datum id group id tenant id app name content md5 src user src ip op type gmt create gmt modify from he config info where nid try config history info history info jt query for object sql fetch row new object nid history detail row mapper return history info catch data access exception e log util fatal log error list config history error nid new object nid e throw e override public void insert tenant info atomic string kp string tenant id string tenant name string tenant desc string create resoure final long time try jt update insert into tenant info kp tenant id tenant name tenant desc create source gmt create gmt modify value kp tenant id tenant name tenant desc create resoure time time catch data access exception e log util fatal log error db error e to string e throw e override public void update tenant name atomic string kp string tenant id string tenant name string tenant desc try jt update update tenant info set tenant name tenant desc gmt modify where kp and tenant id tenant name tenant desc system current time millis kp tenant id catch data access exception e log util fatal log error db error e to string e throw e override public list tenant info find tenant by kp string kp string sql select tenant id tenant name tenant desc from tenant info where kp try return this jt query sql new object kp tenant info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e catch empty result datum access exception e return collection empty list catch exception e log util fatal log error db other error e get message e throw new runtime exception e override public tenant info find tenant by kp string kp string tenant id string sql select tenant id tenant name tenant desc from tenant info where kp and tenant id try return jt query for object sql new object kp tenant id tenant info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e catch empty result datum access exception e return null catch exception e log util fatal log error db other error e get message e throw new runtime exception e override public void remove tenant info atomic final string kp final string tenant id try jt update delete from tenant info where kp and tenant id kp tenant id catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public list config info convert delete config list map string object list list config info config new array list config info for map string object map list string datum id string map get datum id string group string map get group id string tenant string map get tenant id config info config new config info config set datum id data id config set group group config set tenant tenant config add config return config override public list config info wrapper convert change config list map string object list list config info wrapper config new array list config info wrapper for map string object map list string datum id string map get datum id string group string map get group id string tenant string map get tenant id string content string map get content long m time timestamp map get gmt modify get time config info wrapper config new config info wrapper config set datum id data id config set group group config set tenant tenant config set content content config set last modify m time config add config return config override public list config info wrapper list all group key md5 final int page size int total count config info count int page count int math ceil total count 1.0 page size list config info wrapper all config info new array list config info wrapper for int page no page no page count page no list config info wrapper config info list list group key md5 by page page no page size all config info add all config info list return all config info override public list config info wrapper list group key md5 by page int page no int page size string sql count row select count from config info string sql fetch row select t id datum id group id tenant id app name md5 type gmt modify from select id from config info order by id limit g config info t where g id t id pagination helper config info wrapper helper create pagination helper try page config info wrapper page helper fetch page limit sql count row sql fetch row new object page no page size page size page no page size config info wrapper row mapper return page get page item catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public string generate like argument string s string fuzzy search sign string sql like percent sign if s contain pattern str return s replace all fuzzy search sign sql like percent sign else return s override public config info wrapper query config info final string data id final string group final string tenant string tenant tmp string util be blank tenant string util empty tenant try return this jt query for object select id datum id group id tenant id app name content type gmt modify md5 from config info where datum id and group id and tenant id new object datum id group tenant tmp config info wrapper row mapper catch empty result datum access exception e return null catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public boolean be exist table string table name string sql string format select from s limit table name try jt query for object sql integer class return true catch throwable e return false override public boolean complete md5 log util default log info start complete md5 int per page size int row count config info count int page count int math ceil row count 1.0 per page size int actual row count for int page no page no page count page no page config info wrapper page find all config info for dump all page no per page size if page null for config info wrapper cf page get page item string md5 in db cf get md5 final string content cf get content final string tenant cf get tenant final string md5 m d5 util md5 hex content constant encode if string util be blank md5 in db try update md5 cf get datum id cf get group tenant md5 new timestamp cf get last modify catch exception e log util default log error complete md5 error dat id group last modify new object cf get datum id cf get group new timestamp cf get last modify else if md5 in db equal md5 try update md5 cf get datum id cf get group tenant md5 new timestamp cf get last modify catch exception e log util default log error complete md5 error dat id group last modify new object cf get datum id cf get group new timestamp cf get last modify actual row count page get page item size log util default log info complete md5 actual row count row count return true override public list config all info find all config info4 export final string data id final string group final string tenant final string app name final list long id string tenant tmp string util be blank tenant string util empty tenant string builder where new string builder where list object param list new array list if collection util be empty id where append id in for int i i id size i if i where append where append param list add id get i where append else where append tenant id param list add tenant tmp if string util be blank datum id where append and datum id like param list add generate like argument datum id if string util be not blank group where append and group id param list add group if string util be not blank app name where append and app name param list add app name try return this jt query sql find all config info where param list to array config all info row mapper catch can not get jdbc connection exception e log util fatal log error db error e to string e throw e override public map string object batch insert or update list config all info config info list string src user string src ip map string object config advance info timestamp time boolean notify same config policy policy throw naco exception int succ count int skip count list map string string fail datum null list map string string skip datum null for int i i config info list size i config all info config info config info list get i try param util check param config info get datum id config info get group datum id config info get content catch nacos exception e log util default log error datum verification fail e throw e config info config info2 save new config info config info get datum id config info get group config info get tenant config info get app name config info get content string type config info get type if string util be blank type simple judgment of file type base on suffix if config info get datum id contain spot string ext name config info get datum id substr config info get datum id last index of spot to upper case try type file type enum value of ext name to upper case get file type catch exception ex type file type enum text get file type if config advance info null config advance info new hash map config advance info put type type try add config info src ip src user config info2 save time config advance info notify succ count catch data integrity violation exception ive uniqueness constraint conflict if same config policy abort equal policy fail datum new array list skip datum new array list map string string faileditem new hash map faileditem put datum id config info2 save get datum id faileditem put group config info2 save get group fail datum add faileditem for int j i j config info list size j config info skip config info config info list get j map string string skipitem new hash map skipitem put datum id skip config info get datum id skipitem put group skip config info get group skip datum add skipitem break else if same config policy skip equal policy skip count if skip datum null skip datum new array list map string string skipitem new hash map skipitem put datum id config info2 save get datum id skipitem put group config info2 save get group skip datum add skipitem else if same config policy overwrite equal policy succ count update config info config info2 save src ip src user time config advance info notify map string object result new hash map result put succ count succ count result put skip count skip count if fail datum null fail datum be empty result put fail datum fail datum if skip datum null skip datum be empty result put skip datum skip datum return result override public int tenant info count by tenant id string tenant id assert have text tenant id tenant id can not be null integer result this jt query for object sql tenant info count by tenant id new string tenant id integer class if result null return return result int value 
console config component enable scheduling property source application property public class console config autowire private controller method cache method cache init post construct public void init method cache init class method com alibaba naco name controller method cache init class method com alibaba naco console controller method cache init class method com alibaba naco config server controller bean public cor filter cor filter cor configuration config new cor configuration config set allow credentials true config add allow origin config add allow header config set max age l config add allow method url base cor configuration source source new url base cor configuration source source register cor configuration config return new cor filter source 
custom authentication provider component public class custom authentication provider implement authentication provider autowire private naco user detail service impl user detail service override public authentication authenticate authentication authentication throw authentication exception string username string authentication get principal string password string authentication get credentials user detail user detail user detail service load user by username username if password equal user detail get password return new username password authentication token username null null return null override public boolean support class a class return a class equal username password authentication token class 
jwt authentication entry point component public class jwt authentication entry point implement authentication entry point private static final logger logger logger factory get logger jwt authentication entry point class override public void commence http servlet request request http servlet response response authentication exception e throw i o exception servlet exception logger error respond with unauthorized error message url e get message request get request u be i response send error http servlet response sc unauthorized unauthorized 
jwt token manager component public class jwt token manager private static final string authority key auth autowired private auth configs auth configs create token param authentication auth info return token public string create token authentication authentication return create token authentication get name create token param user name auth info return token public string create token string user name long now system current time millis date validity validity new date now auth config get token validity in seconds l claim claim jwt claim set subject user name return jwt builder set claim claim set expiration validity sign with signature algorithm h s256 auth config get secret key compact get auth info param token token return auth info public authentication get authentication string token claim claim jwt parser set signing key auth config get secret key parse claim jws token get body list grant authority authority authority util comma separate string to authority list string claim get authority key user principal new user claim get subject authority return new username password authentication token principal authority validate token param token token public void validate token string token jwt parser set signing key auth config get secret key parse claim jws token 
naco auth manager component public class naco auth manager implement auth manager private static final string token prefix bearer autowire private jwt token manager token manager autowire private authentication manager authentication manager autowire private naco role service impl role service override public user login object request throw access exception http servlet request req http servlet request request string token resolve token req if string util be blank token throw new access exception user not find try token manager validate token token catch expire jwt exception e throw new access exception token expire catch exception e throw new access exception token invalid authentication authentication token manager get authentication token security context holder get context set authentication authentication string username authentication get name naco user user new naco user user set user name username user set token token list role info role info list role service get role username if role info list null for role info role info role info list if role info get role equal naco role service impl global admin role user set global admin true break return user override public void auth permission permission user user throw access exception if logger auth be debug enable logger auth debug auth permission user permission user if role service have permission user get user name permission throw new access exception authorization fail get token from header private string resolve token http servlet request request throw access exception string bearer token request get header naco auth config authorization header if string util be not blank bearer token bearer token start with token prefix return bearer token substring bearer token request get parameter constant access token if string util be blank bearer token string user name request get parameter username string password request get parameter password bearer token resolve token from user user name password return bearer token private string resolve token from user string user name string raw password throw access exception try username password authentication token authentication token new username password authentication token user name raw password authentication manager authenticate authentication token catch authentication exception e throw new access exception unknown user return token manager create token user name 
jwt token util component public class jwt token util private final logger log logger factory get logger jwt token util class private static final string authority key auth minimum sha secret key string length private static final int sha secret char size default sha secret key flag private static final string default secret flag default custom sha secret key from config property value naco security token secret key default private string custom secret key str secret key private secret key secret key token validity time m private long token validity in millisecond init post construct public void init use default secret key for sha if custom secret key str null default secret flag equal custom secret key str this secret key key secret key for signature algorithm h s256 else use custom secret key int size custom secret key str length int left sha secret char size size if leave character for padding string builder string builder new string builder custom secret key str for int i i leave i string builder append i this secret key key hmac sha key for string builder to string get byte else this secret key key hmac sha key for custom secret key str get byte this token validity in millisecond 30 l create token param authentication auth info return token public string create token authentication authentication long now system current time millis date validity new date now this token validity in millisecond return jwt builder set subject authentication get name claim authority key set expiration validity sign with secret key signature algorithm h s256 compact get auth info param token token return auth info public authentication get authentication string token claim claim jwt parser set signing key secret key parse claim jws token get body list grant authority authority authority util comma separate string to authority list string claim get authority key user principal new user claim get subject authority return new username password authentication token principal authority validate token param token token return whether valid public boolean validate token string token try jwt parser set signing key secret key parse claim jws token return true catch signature exception e log info invalid jwt signature log trace invalid jwt signature trace e catch malformed jwt exception e log info invalid jwt token log trace invalid jwt token trace e catch expire jwt exception e log info expire jwt token log trace expire jwt token trace e catch unsupported jwt exception e log info unsupported jwt token log trace unsupported jwt token trace e catch illegal argument exception e log info jwt token compact of handler be invalid log trace jwt token compact of handler be invalid trace e return false 
auth config component configuration public class auth config just for test private static boolean caching enable null autowired private reloadable config reloadable config secret key value naco core auth default token secret key private string secret key token validity time seconds value naco core auth default token expire seconds private long token validity in seconds which auth system be in use value naco core auth system type private string naco auth system type public string get secret key return secret key public long get token validity in seconds return token validity in seconds public string get naco auth system type return naco auth system type auth function be open return auth function be open public boolean be auth enable runtime d parameter have higher priority string enable system get property naco core auth enable if string util be not blank enable return boolean util to boolean enable return boolean util to boolean reloadable config get property get property naco core auth enable false whether permission information can be cache return bool public boolean be cache enable if object non null auth configs caching enable return cache enable return boolean util to boolean reloadable config get property get property naco core auth caching enable true just for test public static void set caching enable boolean caching enable auth config cache enable cache enable bean public filter registration bean auth filter registration filter registration bean auth filter registration new filter registration bean registration set filter auth filter registration add url pattern registration set name auth filter registration set order return registration bean public auth filter auth filter return new auth filter 
server member manager component value server member manager public class server member manager implement application listener web server initialize event private final n async http client async http client http client manager get async http client cluster node list private volatile concurrent skip list map string member server list be this node in the cluster list private volatile boolean be in ip list true port private int port address information for the local node private string local address address pattern instance private member lookup lookup self member obj private volatile member self here be always the node information of the up state private volatile set string member address info new concurrent hash set broadcast this node element information task private final member info report task info report task new member info report task public server member manager servlet context servlet context throw exception this server list new concurrent skip list map application util set context path servlet context get context path member util set manager this init protect void init throw naco exception logger core info naco relate cluster resource initialization this port application util get property server port integer class this local address inet util get self ip port this self member util single parse this local address this self set extend val member meta datum constant version version util version server list put self get address self register node change event publisher to notify manager register cluster event initialize the lookup mode init and start lookup if server list be empty throw new naco exception naco exception server error can not get serverlist so exit logger core info the cluster resource be initialize private void init and start lookup throw naco exception this lookup lookup factory create look up this this lookup start public void switch lookup string name throw naco exception this lookup lookup factory switch lookup name this this lookup start private void register cluster event register node change event notify center register to publisher member change event class application util get property naco member change event queue size integer class the address information of this node need to be dynamically modify when register the ip change of this node notify center register subscriber new subscriber inet util i p change event override public void on event inet util i p change event event string new address event get new ip port server member manager this local address new address application util set local address local address member self server member manager this self self set ip event get new ip string old address event get old ip port server member manager this server list remove old address server member manager this server list put new address self server member manager this member address info remove old address server member manager this member address info add new address override public class extend event subscribe type return inet util i p change event class member information update param new member link member return update be success public boolean update member new member logger cluster debug member information update new member string address new member get address if server list contain key address return false server list compute if present address s member if node state down equal new member get state member address info remove new member get address if member util full equal new member member new member set extend val member meta datum constant last refresh time system current time millis member util copy new member member member datum change and all listener need to be notify notify center publish event member change event builder member all member build return member return true whether the node exist within the cluster param address ip port return be exist public boolean have member string address boolean result server list contain key address if result if only ip information be pass in a fuzzy match be require for map entry string member entry server list entry set if string util contain entry get key address result true break return result public member get self return this self public member find string address return server list get address return this cluster all member return link collection all member public collection member all member we need to do a copy to avoid affect the real data hash set member set new hash set server list value set add self return set return this cluster all member without self return link collection all member without self public list member all member without self list member member new array list server list value member remove self return member synchronize boolean member change collection member member if member null member be empty return false boolean be contain self ip member stream any match ip port tmp object equal local address ip port tmp get address if be contain self ip be in ip list true else be in ip list false member add this self logger cluster warn serverlist self ip not in serverlist self member if the number of old and new cluster be different the cluster information must have change if the number of cluster be the same then compare whether there be a difference if there be a difference then the cluster node change be involved and all recipient need to be notify of the node change event boolean have change member size server list size concurrent skip list map string member tmp map new concurrent skip list map set string tmp address info new concurrent hash set for member member member final string address member get address if server list contain key address have change true ensure that the node be create only once tmp map put address member tmp address info add address server list tmp map member address info tmp address info collection member final member all member logger cluster warn serverlist update to final member persist the current cluster node information to cluster conf important need to put the event publication into a synchronize block to ensure that the event publication be sequential if have change member util sync to file final member set member health member member util select target member member member return node state down equal member get state event event member change event builder member final member build notify center publish event event return have change member join this cluster param member link collection new member return be success public synchronize boolean member join collection member member set member set new hash set member set add all all member return member change set member leave this cluster param member link collection wait leave member return be success public synchronize boolean member leave collection member member set member set new hash set all member set remove all member return member change set this member link member get state be health param address ip port return be health public boolean be un health string address member member server list get address if member null return false return node state up equal member get state public boolean be first ip return object equal server list first key this local address override public void on application event web server initialize event event get self set state node state up if application util get standalone mode global executor schedule by common this info report task l application util set port event get web server get port application util set local address this local address logger cluster info this node be ready to provide external service server member manager shutdown throw naco exception naco exception pre destroy public void shutdown throw naco exception server list clear member address info clear info report task shutdown lookup factory destroy public set string get member address info return member address info just for test public void update member member member server list put member get address member just for test public void set member address info set string member address info this member address info member address info just for test public member info report task get info report task return info report task public map string member get server list return collection unmodifiable map server list public boolean be in ip list return be in ip list synchronize the metadata information of a node a health check of the target node be also attach class member info report task extend task private final generic type rest result string reference new generic type rest result string private int cursor override protect void execute body list member member server member manager this all member without self if member be empty return this cursor this cursor member size member target member get cursor logger cluster debug report the metadata to the node target get address final string url http util build url false target get address application util get context path common naco core context cluster report try async http client post url header new instance add param constant naco server header version util version query empty get self reference get type new callback string override public void on receive rest result string result if result get code http status not implement value result get code http status not find value logger cluster warn version be too low it be recommend to upgrade the version target version util version return if result ok member util on success target else logger cluster warn fail to report new info to target node result target get address result member util on fail target override public void on error throwable throwable logger cluster error fail to report new info to target node error target get address exception util get all exception msg throwable member util on fail target throwable catch throwable ex logger cluster error fail to report new info to target node error target get address exception util get all exception msg ex override protect void after global executor schedule by common this l 
controller method cache component public class controller method cache value server servlet context path naco private string context path private concurrent map string method method new concurrent hash map public concurrent map string method get method return method public method get method string http method string path string key http method path replace context path return method get key find target method from this package param package name package name public void init class method string package name reflection reflection new reflection package name set class class list reflection get type annotate with request mapping class for class clazz class list init class method clazz find target method from class list param class list class list public void init class method set class class list for class clazz class list init class method clazz find target method from target class param clazz link class public void init class method class clazz request mapping request mapping clazz get annotation request mapping class for string class path request mapping value for method method clazz get method if method be annotation present request mapping class parse sub annotation method class path continue request mapping method get annotation request mapping class request method request method request mapping method if request method length request method new request method request method request method get for string method path request mapping value method put request method name class path method path method private void parse sub annotation method method string class path final get map get mapping method get annotation get map class final post mapping post mapping method get annotation post mapping class final put mapping put mapping method get annotation put mapping class final delete mapping delete mapping method get annotation delete mapping class final patch mapping patch mapping method get annotation patch mapping class if get mapping null put request method get class path get mapping value method if post mapping null put request method post class path post mapping value method if put mapping null put request method put class path put mapping value method if delete mapping null put request method delete class path delete mapping value method if patch mapping null put request method patch class path patch mapping value method private void put request method request method string class path string request path method method if array util be empty request path method put request method name class path method return for string request path request path method put request method name class path request path method 
id generator manager suppress warning pmd undefine magic constant rule component public class id generator manager private final map string id generator generator map new concurrent hash map private final function string id generator supplier public id generator manager this supplier s id generator generator service loader id generator loader service loader load id generator class iterator id generator iterator loader iterator if iterator have next generator iterator next else generator new snow flower id generator generator init return generator public void register string resource generator map compute if absent resource s supplier apply resource register resource that need to use the id generator param resource resource name list public void register string resource for string resource resource generator map compute if absent resource s supplier apply resource request next id by resource name param resource resource name return id public long next id string resource if generator map contain key resource return generator map get resource next id throw new no such element exception the resource be not register with the distribute id resource for the time be public map string id generator get generator map return generator map 
protocol manager suppress warning all component value protocol manager depend on server member manager public class protocol manager extend member change listener implement application listener context start event disposable bean private c p protocol cp protocol private a p protocol ap protocol autowire private server member manager member manager private boolean ap init false private boolean cp init false private set member old member private static set string to a p member info collection member member set string node new hash set member for each member node add member get address return node delay init protocol private static set string to c p member info collection member member set string node new hash set member for each member final string ip member get ip final int raft port member util calculate raft port member node add ip raft port return node post construct public void init this member manager member manager notify center register subscriber this public c p protocol get cp protocol synchronize this if cp init init c p protocol cp init true return cp protocol public a p protocol get ap protocol synchronize this if ap init init a p protocol ap init true return ap protocol public void destroy if object non null ap protocol ap protocol shutdown if object non null cp protocol cp protocol shutdown override public void on application event context start event event private void init a p protocol application util get bean if exist a p protocol class protocol class config type class util resolve generic type protocol get class config config config application util get bean config type inject members4 a p config protocol init config protocol manager this ap protocol protocol private void init c p protocol application util get bean if exist c p protocol class protocol class config type class util resolve generic type protocol get class config config config application util get bean config type inject members4 c p config protocol init config protocol manager this cp protocol protocol private void inject members4 c p config config final member self member member manager get self final string self self member get ip integer parse int string value of self member get extend val member meta datum constant raft port set string other to c p member info member manager all member config set member self other private void inject members4 a p config config final string self member manager get self get address set string other to a p member info member manager all member config set member self other override public void on event member change event event here the sequence of node change event be very important for example node change event a occur at time t1 and node change event b occur at time t2 after a period of time t1 t2 set member copy new hash set event get member if old member null old member new hash set copy else old member remove all copy if old member be empty node change event between different protocol should not block each other and we use a single thread pool to inform the consistency layer of node change to avoid multiple task simultaneously carry out the consistency layer of node change operation if object non null ap protocol protocol executor ap member change ap protocol member change to a p member info copy if object non null cp protocol protocol executor cp member change cp protocol member change to c p member info copy remove old member info old member clear old member add all copy 
raft config component configuration property prefix naco core protocol raft public class raft config implement config log processor4 c p private static final long serial version u i d l private map string string datum collection synchronize map new hash map private string self address private set string member collection synchronize set new hash set override public void set member string self set string member this self address self this member clear this member add all member override public string get self member return self address override public set string get member return member override public void add member set string member this member add all member override public void remove member set string member this member remove all member public map string string get datum return datum public void set datum map string string datum this data collection synchronize map datum override public void set val string key string value datum put key value override public string get val string key return datum get key override public string get val of default string key string default val return datum get or default key default val override public string to string try return jackson util to json datum catch exception e return string value of datum 
reloadable config component public class reloadable config private static final string file prefix file private property property value spring config location private string path periodically load configuration file information throw i o exception i o exception schedule fix rate public void reload throw i o exception final property property new property input stream input stream null if string util be not blank path path contain file prefix string path path split path path path length substr file prefix length try input stream new file input stream new file path application property catch exception ignore if input stream null input stream get class get resource as stream application property property load input stream input stream close this property property public final property get property return property 
istio config component public class istio config value naco istio mcp server enable false private final boolean mcp server enable false public boolean be mcp server enable return mcp server enable 
server list manager component server list manager public class server list manager extend member change listener private static final string localhost site util and common unknown site private final switch domain switch domain private final server member manager member manager private final synchronizer synchronizer new server status synchronizer private volatile list member server public server list manager final switch domain switch domain final server member manager member manager this switch domain switch domain this member manager member manager notify center register subscriber this this server new array list member manager all member post construct public void init global executor register server status reporter new server status reporter global executor register server info updater new server info updater judge whether contain server in cluster param server address server address return true if contain otherwise false public boolean contain string server address for member server get server if object equal server address server get address return true return false public list member get server return server override public void on event member change event event this server new array list event get member compatible with older version logic in version 1.2 and before param config info site ip last report time weight public synchronize void on receive server status string config info logger srv log info receive config info config info string config config info split be n if config length return for string config config site ip last report time weight string param config split if param length logger srv log warn receive malformed distro map datum config continue member server optional of nullable member manager find param or else member builder ip param split util and common ip port spliter state node state up port integer parse int param split util and common ip port spliter build server set extend val member meta datum constant site key param server set extend val member meta datum constant weight param length integer parse int param member manager update server if contain server get address throw new illegal argument exception server server get address be not in serverlist private class server info updater implement runnable private int cursor override public void run list member member server if member be empty return this cursor this cursor member size member target member get cursor if object equal target get address application util get local address return this metadata information exist from 1.3 onwards version if target get extend val member meta datum constant version null return final string path util and common naco name operator context util and common naco name cluster context state final map string string param map new hash map with expect size final string server target get address try string content name proxy req common path param server false if string util empty equal content raft peer raft peer jackson util to obj content raft peer class if null raft peer string json jackson util to json raft peer map map jackson util to obj json hash map class target set extend val name map member manager update target catch exception ignore private class server status reporter implement runnable override public void run try if application util get port return int weight runtime get runtime available processor if weight weight long cur time system current time millis string status localhost site application util get local address cur time weight be n list member all server get server if contain application util get local address logger srv log error local ip be not in serverlist ip serverlist application util get local address all server return if all server size application util get local address contain util and common local host ip for member server all server if object equal server get address application util get local address continue this metadata information exist from 1.3 onwards version if server get extend val member meta datum constant version null logger srv log debug server status target have extend val use new api report status server get address member meta datum constant version server get extend val member meta datum constant version continue message msg new message msg set datum status synchronizer send server get address msg catch exception e logger srv log error server status exception while send server status e finally global executor register server status reporter this switch domain get server status synchronization period milli 
jackson serializer component public class jackson serializer implement serializer override public t byte serialize t datum return jackson util to json byte datum override public t t deserialize byte datum class t clazz return jackson util to obj datum clazz override public t extend record map string datum t deserialize map byte datum class t clazz map string datum t result map try result map jackson util to obj datum new type reference map string datum t catch exception e map string json node datum map jackson util to obj datum new type reference map string json node result map new hash map datum map size for map entry string json node entry datum map entry set datum t datum new datum datum timestamp set entry get value get timestamp as long datum key entry get value get key as text datum value jackson util to obj entry get value get value to string clazz result map put entry get key datum return result map 
datum store component public class datum store private map string datum datum map new concurrent hash map public void put string key datum value datum map put key value public datum remove string key return datum map remove key public set string key return datum map key set public datum get string key return datum map get key public boolean contain string key return datum map contain key key batch get datum for a list of key param key of datum return list of datum public map string datum batch get list string key map string datum map new hash map for string key key datum datum datum map get key if datum null continue map put key datum return map public int get instance count int count for map entry string datum entry datum map entry set try datum instance datum entry get value if instance datum value instanceof instance count instance instance datum value get instance list size catch exception ignore return count public map string datum get datum map return datum map 
datum syncer component depend on protocol manager public class datum syncer private final datum store data store private final global config partition config private final serializer serializer private final distro mapper distro mapper private final server member manager member manager private map string string task map new concurrent hash map public datum syncer datum store data store global config partition config serializer serializer distro mapper distro mapper server member manager member manager this data store data store this partition config partition config this serializer serializer this distro mapper distro mapper this member manager member manager post construct public void init start time sync submit a link sync task with a delay to execute param task synchronize datum task param delay delay to execute public void submit sync task task long delay if it be a new task if task get retry count iterator string iterator task get key iterator while iterator have next string key iterator next if string util be not blank task map put if absent build key key task get target server key associate key already exist if logger distro be debug enable logger distro debug sync already in process key key iterator remove if task get key be empty all key be remove return global executor submit datum sync check the server if get server null get server be empty logger srv log warn try to sync datum but server list be empty return list string key task get key if logger srv log be debug enable logger srv log debug try to sync datum for this key key get the datum by key and check the datum be empty or not map string datum datum map datum store batch get key if datum map null datum map be empty clear all flag of this task for string key key task map remove build key key task get target server return byte datum serializer serialize datum map long timestamp system current time millis boolean success name proxy sync datum datum task get target server if success sync task sync task new sync task sync task set key task get key sync task set retry count task get retry count sync task set last execute time timestamp sync task set target server task get target server retry sync sync task else clear all flag of this task for string key task get key task map remove build key key task get target server delay private void retry sync sync task sync task member member new member member set ip sync task get target server split member set port integer parse int sync task get target server split if get server contain member if server be no longer in healthy server list ignore this task fix remove exist task if sync task get key null for string key sync task get key task map remove build key key sync task get target server return todo may choose other retry policy submit sync task partition config get sync retry delay public void start time sync global executor schedule partition datum time sync new time sync public class time sync implement runnable override public void run try if logger distro be debug enable logger distro debug server list be get server send local timestamp to other server map string string key checksum new hash map for string key datum store key if distro mapper responsible key builder get service name key continue datum datum datum store get key if datum null continue key checksum put key datum value get checksum if key checksum be empty return if logger distro be debug enable logger distro debug sync checksum key checksum for member member get server if net util local server equal member get address continue name proxy sync check sum key checksum member get address catch exception e logger distro error time sync task fail e public collection member get server return member manager all member public string build key string key string target server return key util and common cache key spliter target server 
task dispatcher component public class task dispatcher autowire private global config partition config autowire private datum syncer datum syncer private list task scheduler task scheduler list new array list private final int cpu core count runtime get runtime available processor init task dispatcher post construct public void init for int i i cpu core count i task scheduler task scheduler new task scheduler i task scheduler list add task scheduler global executor submit task dispatch task scheduler public void add task string key task scheduler list get util and common shake up key cpu core count add task key public class task scheduler implement runnable private int index private int datum size private long last dispatch time 0 l private blocking queue string queue new link block queue public task scheduler int index this index index public void add task string key queue offer key public int get index return index override public void run list string key new array list while true try string key queue poll partition config get task dispatch period time unit millisecond if logger distro be debug enable string util be not blank key logger distro debug get key key if datum syncer get server null datum syncer get server be empty continue if string util be blank key continue if datum size key new array list key add key datum size if datum size partition config get batch sync key count system current time millis last dispatch time partition config get task dispatch period for member member datum syncer get server if net util local server equal member get address continue sync task sync task new sync task sync task set key key sync task set target server member get address if logger distro be debug enable string util be not blank key logger distro debug add sync task jackson util to json sync task datum syncer submit sync task last dispatch time system current time millis datum size catch exception e logger distro error dispatch sync task fail e 
raft core depend on protocol manager component public class raft core public static final string api vote util and common naco name context raft vote public static final string api beat util and common naco name context raft beat public static final string api pub util and common naco name context raft datum public static final string api del util and common naco name context raft datum public static final string api get util and common naco name context raft datum public static final string api on pub util and common naco name context raft datum commit public static final string api on del util and common naco name context raft datum commit public static final string api get peer util and common naco name context raft peer private final schedule executor service executor executor factory manage new single schedule executor service class util get canonical name name app class new name thread factory com alibaba naco name raft notifier public static final lock operate lock new reentrant lock public static final int publish term increase count private volatile concurrent map string list record listener listener new concurrent hash map private volatile concurrent map string datum datum new concurrent hash map autowire private raft peer set peer autowire private switch domain switch domain autowire private global config global config autowire private raft proxy raft proxy autowire private raft store raft store public volatile notifier notifier new notifier private boolean initialized false init raft core throw exception any exception during init post construct public void init throw exception logger raft info initialize raft sub system executor submit notifier final long start system current time millis raft store load datum notifier datum set term number util to long raft store load meta get property term 0 l logger raft info cache load datum count current term datum size peer get term while true if notifier task size break thread sleep l initialize true logger raft info finish to load datum from disk cost ms system current time millis start global executor register master election new master election global executor register heartbeat new heart beat logger raft info timer start leader timeout ms heart beat timeout ms global executor leader timeout ms global executor heartbeat interval ms public map string list record listener get listener return listener signal publish new record if not leader signal to leader if leader try to commit publish param key key param value value throw exception any exception during publish public void signal publish string key record value throw exception if be leader object node param jackson util create empty json node param put key key param replace value jackson util transfer to json node value map string string parameter new hash map parameter put key key final raft peer leader get leader raft proxy proxy post large leader ip api pub param to string parameter return try operate lock lock final long start system current time millis final datum datum new datum datum key key datum value value if get datum key null datum timestamp set 1 l else datum timestamp set get datum key timestamp increment and get object node json jackson util create empty json node json replace datum jackson util transfer to json node datum json replace source jackson util transfer to json node peer local on publish datum peer local final string content json to string final count down latch latch new count down latch peer majority count for final string server peer all server include myself if be leader server latch count down continue final string url build url server api on pub http client async http post large url array as list key key content new async completion handler integer override public integer on complete response response throw exception if response get status code http u r l connection http ok logger raft warn raft fail to publish datum to peer datum id peer http code datum key server response get status code return latch count down return override public state on content write complete return state continue if latch await util and common raft publish timeout time unit millisecond only majority server return success can we consider this update success logger raft error datum publish fail cause fail to notify majority key key throw new illegal state exception datum publish fail cause fail to notify majority key key long end system current time millis logger raft info signal publish cost m key end start key finally operate lock unlock signal delete record if not leader signal leader delete if leader try to commit delete param key key throw exception any exception during delete public void signal delete final string key throw exception operate lock lock try if be leader map string string param new hash map param put key u be l encoder encode key utf raft proxy proxy get leader ip api del params http method delete return construct datum datum datum new datum datum key key object node json jackson util create empty json node json replace datum jackson util transfer to json node datum json replace source jackson util transfer to json node peer local on delete datum key peer local for final string server peer all server without my self string url build url server api on del http client async http delete large url null json to string new async completion handler integer override public integer on complete response response throw exception if response get status code http u r l connection http ok logger raft warn raft fail to delete datum from peer datum id peer http code key server response get status code return raft peer local peer local local reset leader due return finally operate lock unlock do publish if leader commit publish to store if not leader stop publish because should signal to leader param datum datum param source source raft peer throw exception any exception during publish public void on publish datum datum raft peer source throw exception raft peer local peer local if datum value null logger raft warn receive empty datum throw new illegal state exception receive empty datum if peer be leader source ip logger raft warn peer try to publish datum but wasn t leader leader jackson util to json source jackson util to json get leader throw new illegal state exception peer source ip try to publish datum but wasn t leader if source term get local term get logger raft warn out of date publish pub term cur term jackson util to json source jackson util to json local throw new illegal state exception out of date publish pub term source term get cur term local term get local reset leader due if datum should be persist usually this be true if key builder match persistent key datum key raft store write datum datum put datum key datum if be leader local term add and get publish term increase count else if local term get publish term increase count source term get set leader term get leader term set source term get local term set get leader term get else local term add and get publish term increase count raft store update term local term get notifier add task datum key apply action change logger raft info datum add update key term datum key local term do delete if leader commit delete to store if not leader stop delete because should signal to leader param datum key datum key param source source raft peer throw exception any exception during delete public void on delete string datum key raft peer source throw exception raft peer local peer local if peer be leader source ip logger raft warn peer try to publish datum but wasn t leader leader jackson util to json source jackson util to json get leader throw new illegal state exception peer source ip try to publish datum but wasn t leader if source term get local term get logger raft warn out of date publish pub term cur term jackson util to json source jackson util to json local throw new illegal state exception out of date publish pub term source term cur term local term local reset leader due do apply string key datum key delete datum key if key builder match service meta key key if local term get publish term increase count source term get set leader term get leader term set source term get local term set get leader term get else local term add and get publish term increase count raft store update term local term get logger raft info datum remove key term datum key local term public class master election implement runnable override public void run try if peer be ready return raft peer local peer local local leader due ms global executor tick period ms if local leader due ms return reset timeout local reset leader due local reset heartbeat due send vote catch exception e logger raft warn raft error while master election e private void send vote raft peer local peer get net util local server logger raft info leader timeout start vote leader term jackson util to json get leader local term peer reset local term increment and get local vote for local ip local state raft peer state candidate map string string param new hash map param put vote jackson util to json local for final string server peer all server without my self final string url build url server api vote try http client async http post url null param new async completion handler integer override public integer on complete response response throw exception if response get status code http u r l connection http ok logger raft error naco raft vote fail url response get response body url return raft peer peer jackson util to obj response get response body raft peer class logger raft info receive approve from peer jackson util to json peer peer decide leader peer return catch exception e logger raft warn error while send vote to server server receive vote param remote remote raft peer of vote information return self peer information public synchronize raft peer receive vote raft peer remote if peer contain remote throw new illegal state exception can not find peer remote ip raft peer local peer get net util local server if remote term get local term get string msg receive illegitimate vote voter term remote term votee term local term logger raft info msg if string util be empty local vote for local vote for local ip return local local reset leader due local state raft peer state follower local vote for remote ip local term set remote term get logger raft info vote as leader term remote ip remote term return local public class heart beat implement runnable override public void run try if peer be ready return raft peer local peer local local heartbeat due ms global executor tick period ms if local heartbeat due ms return local reset heartbeat due send beat catch exception e logger raft warn raft error while send beat e private void send beat throw i o exception interrupt exception raft peer local peer local if application util get standalone mode local state raft peer state leader return if logger raft be debug enable logger raft debug raft send beat with key datum size local reset leader due build datum object node packet jackson util create empty json node packet replace peer jackson util transfer to json node local array node array jackson util create empty array node if switch domain be send beat only logger raft info send beat only string value of switch domain be send beat only if switch domain be send beat only for datum datum datums value object node element jackson util create empty json node if key builder match service meta key datum key element put key key builder brief service meta key datum key else if key builder match instance list key datum key element put key key builder brief instance listkey datum key element put timestamp datum timestamp get array add element packet replace datum array broadcast map string string param new hash map string string param put beat jackson util to json packet string content jackson util to json param byte array output stream out new byte array output stream g z i p output stream gzip new g z i p output stream out gzip write content get byte standard charset utf gzip close byte compress byte out to byte array string compress content new string compress byte standard charset utf if logger raft be debug enable logger raft debug raw beat datum size size of compressed datum content length compress content length for final string server peer all server without my self try final string url build url server api beat if logger raft be debug enable logger raft debug send beat to server server http client async http post large url null compressed byte new async completion handler integer override public integer on complete response response throw exception if response get status code http u r l connection http ok logger raft error naco raft beat fail peer response get response body server metric monitor get leader send beat fail exception increment return peer update jackson util to obj response get response body raft peer class if logger raft be debug enable logger raft debug receive beat response from url return override public void on throwable throwable t logger raft error naco raft error while send heart beat to peer server t metric monitor get leader send beat fail exception increment catch exception e logger raft error error while send heart beat to peer server e metric monitor get leader send beat fail exception increment receive beat from leader todo split method to multiple smaller method param beat beat information from leader return self peer information throw exception any exception during handle public raft peer receive beat json node beat throw exception final raft peer local peer local final raft peer remote new raft peer json node peer beat get peer remote ip peer get ip as text remote state raft peer state value of peer get state as text remote term set peer get term as long remote heartbeat due ms peer get heartbeat due ms as long remote leader due ms peer get leader due ms as long remote vote for peer get vote for as text if remote state raft peer state leader logger raft info raft invalid state from master state remote peer remote state jackson util to json remote throw new illegal argument exception invalid state from master state remote state if local term get remote term get logger raft info raft out of date beat beat from term beat to term remote peer and leader due ms remote term get local term get jackson util to json remote local leader due ms throw new illegal argument exception out of date beat beat from term remote term get beat to term local term get if local state raft peer state follower logger raft info raft make remote as leader remote peer jackson util to json remote mk follower local state raft peer state follower local vote for remote ip final json node beat datum beat get datum local reset leader due local reset heartbeat due peer make leader remote if switch domain be send beat only map string integer receive key map new hash map datum size for map entry string datum entry datum entry set receive key map put entry get key now check datum list string batch new array list int process count if logger raft be debug enable logger raft debug raft receive beat with key raft core datum size be remote server term local term beat datum size datum size remote ip remote term local term for object object beat datum process count process count json node entry json node object string key entry get key as text final string datum key if key builder match service meta key key datum key key builder detail service meta key key else if key builder match instance list key key datum key key builder detail instance listkey key else ignore corrupted key continue long timestamp entry get timestamp as long receive key map put datum key try if datum contain key datum key datum get datum key timestamp get timestamp process count beat datum size continue if datum contain key datum key datum get datum key timestamp get timestamp batch add datum key if batch size process count beat datum size continue string key string util join batch if batch size continue logger raft info get datum from leader batch size be process count be datums size be raft core datum size be get leader ip batch size process count beat datum size datum size update datum entry string url build url remote ip api get key u be l encoder encode key utf http client async http get url null null new async completion handler integer override public integer on complete response response throw exception if response get status code http u r l connection http ok return list json node datum list jackson util to obj response get response body new type reference list json node for json node datum json datum list datum new datum null operate lock lock try datum old datum get datum datum json get key as text if old datum null datum json get timestamp as long old datum timestamp get logger raft info naco raft timestamp be smaller than that of mine key remote local datum json get key as text datum json get timestamp as long old datum timestamp continue if key builder match service meta key datum json get key as text datum service service datum new datum service datum key datum json get key as text service datum timestamp set datum json get timestamp as long service datum value jackson util to obj datum json get value to string service class new datum service datum if key builder match instance list key datum json get key as text datum instance instance datum new datum instance datum key datum json get key as text instance datum timestamp set datum json get timestamp as long instance datum value jackson util to obj datum json get value to string instance class new datum instance datum if new datum null new datum value null logger raft error receive null datum datum json continue raft store write new datum datum put new datum key new datum notifier add task new datum key apply action change local reset leader due if local term get remote term get get leader term set remote term get local term set get leader term get else local term add and get raft store update term local term get logger raft info datum update key timestamp from local term new datum key new datum timestamp jackson util to json remote local term catch throwable e logger raft error raft beat fail to sync datum from leader datum new datum e finally operate lock unlock time unit millisecond sleep return batch clear catch exception e logger raft error naco raft fail to handle beat entry key datum key list string dead key new array list for map entry string integer entry receive key map entry set if entry get value dead key add entry get key for string dead key dead key try delete datum dead key catch exception e logger raft error naco raft fail to remove entry key dead key e return local add listener for target key param key key param listener new listener public void listen string key record listener listener list record listener listener list listener get key if listener list null listener list contain listener return if listener list null listener list new copy on write array list listener put key listener list logger raft info add listener key listener list add listener if datum present notify immediately for datum datum datums value if listener interest datum key continue try listener on change datum key datum value catch exception e logger raft error naco raft fail to notify listener e remove listener for key param key key param listener listener public void un listen string key record listener listener if listener contain key key return for record listener dl listener get key todo maybe use equal if dl listener listener get key remove listener break public void unlisten all string key listener remove key public void set term long term peer set term term public boolean be leader string ip return peer be leader ip public boolean be leader return peer be leader net util local server build api url param ip ip of api param api api path return api url public static string build url string ip string api if ip contain util and common ip port spliter ip ip util and common ip port spliter application util get port return http ip application util get context path api public datum get datum string key return datum get key public raft peer get leader return peer get leader public list raft peer get peer return new array list peer all peer public raft peer set get peer set return peer public void set peer set raft peer set peer set peer peer set public int datum size return datum size public void add datum datum datum datum put datum key datum notifier add task datum key apply action change load datum param key datum key public void load datum string key try datum datum raft store load key if datum null return datum put key datum catch exception e logger raft error load datum fail key e private void delete datum string key datum delete try delete datum remove u r l decoder decode key utf if delete null raft store delete delete logger raft info datum delete key key notifier add task u be l decoder decode key utf apply action delete catch unsupported encode exception e logger raft warn datum key decode fail key public boolean be initialize return initialize global config be datum warmup public int get notify task count return notifier get task size public class notifier implement runnable private concurrent hash map string string service new concurrent hash map private blocking queue pair task new link block queue add notify task param datum key datum key param action action of datum public void add task string datum key apply action action if service contain key datum key action apply action change return if action apply action change service put datum key string util empty logger raft info add task datum key task add pair with datum key action public int get task size return task size override public void run logger raft info raft notifier start while true try pair pair task take if pair null continue string datum key string pair get value0 apply action action apply action pair get value1 service remove datum key logger raft info remove task datum key int count if listener contain key key builder service meta key prefix if key builder match service meta key datum key key builder match switch key datum key for record listener listener listener get key builder service meta key prefix try if action apply action change listener on change datum key get datum datum key value if action apply action delete listener on delete datum key catch throwable e logger raft error naco raft error while notify listener of key datum key e if listener contain key datum key continue for record listener listener listener get datum key count try if action apply action change listener on change datum key get datum datum key value continue if action apply action delete listener on delete datum key continue catch throwable e logger raft error naco raft error while notify listener of key datum key e if logger raft be debug enable logger raft debug naco raft datum change notify key listener count datum key count catch throwable e logger raft error naco raft error while handle notify task e 
raft listener component public class raft listener implement smart application listener private static final string group name autowired private server member manager member manager override public boolean support event type class extend application event event type boolean a base raft event class be assignable from event type return a override public void on application event application event event if event instanceof base raft event base raft event raft event base raft event event raft peer local raft event get local string json jackson util to json local map map jackson util to obj json hash map class member self member manager get self self set extend val group map member manager update self 
raft peer set component depend on protocol manager public class raft peer set extend member change listener private final server member manager member manager private atomic long local term new atomic long 0 l private raft peer leader null private volatile map string raft peer peer new hash map private set string site new hash set private volatile boolean ready false private set member old member public raft peer set server member manager member manager this member manager member manager post construct public void init notify center register subscriber this change peer member manager all member public raft peer get leader if application util get standalone mode return local return leader public set string all site return site public boolean be ready return ready remove raft node param server node address need to be remove public void remove list string server for string server server peer remove server update raft peer param peer new peer return new peer public raft peer update raft peer peer peer put peer ip peer return peer judge whether input address be leader param ip peer address return true if be leader or stand alone otherwise false public boolean be leader string ip if application util get standalone mode return true if leader null logger raft warn be leader no leader be available now return false return string util equal leader ip ip public set string all server include myself return peer key set get all server exclude current peer return all server exclude current peer public set string all server without my self set string server new hash set string peer key set exclude myself server remove local ip return server public collection raft peer all peer return peer value public int size return peer size calculate and decide which peer be leader if have new peer have more than half vote change leader to new peer param candidate new candidate return new leader if new candidate have more than half vote otherwise old leader public raft peer decide leader raft peer candidate peer put candidate ip candidate sort bag ip new tree bag int max approve count string max approve peer null for raft peer peer peer value if string util be empty peer vote for continue ip add peer vote for if ip get count peer vote for max approve count max approve count ip get count peer vote for max approve peer peer vote for if max approve count majority count raft peer peer peer get max approve peer peer state raft peer state leader if object equal leader peer leader peer application util publish event new leader elect finish event this leader local logger raft info have become the leader leader ip return leader set leader as new candidate param candidate new candidate return new leader public raft peer make leader raft peer candidate if object equal leader candidate leader candidate application util publish event new make leader event this leader local logger raft info have become the leader local leader leader ip jackson util to json local jackson util to json leader for final raft peer peer peer value map string string param new hash map if object equal peer candidate peer state raft peer state leader try string url raft core build url peer ip raft core api get peer http client async http get url null param new async completion handler integer override public integer on complete response response throw exception if response get status code http u r l connection http ok logger raft error naco raft get peer fail peer response get response body peer ip peer state raft peer state follower return update jackson util to obj response get response body raft peer class return catch exception e peer state raft peer state follower logger raft error naco raft error while get peer from peer peer ip return update candidate get local raft peer return local raft peer public raft peer local raft peer peer peer get application util get local address if peer null application util get standalone mode raft peer local peer new raft peer local peer ip net util local server local peer term set local term get peer put local peer ip local peer return local peer if peer null throw new illegal state exception unable to find local peer net util local server all peer array to string peer key set to array return peer public raft peer get string server return peer get server public int majority count return peer size reset set public void reset leader null for raft peer peer peer value peer vote for null public void set term long term local term set term public long get term return local term get public boolean contain raft peer remote return peer contain key remote ip override public void on event member change event event collection member member event get member if old member null old member new hash set member else old member remove all member if old member be empty change peer member old member clear old member add all member private void change peer collection member member map string raft peer tmp peer new hash map member size for member member member final string address member get address if peer contain key address tmp peer put address peer get address continue raft peer raft peer new raft peer raft peer ip address first time meet the local server if application util get local address equal address raft peer term set local term get tmp peer put address raft peer replace raft peer set peer tmp peer ready true logger raft info raft peer change member override public string to string return raft peer set local term local term leader leader peer peer site site 
raft proxy component public class raft proxy proxy get method param server target server param api api path param param parameter throw exception any exception during request public void proxy get string server string api map string string param throw exception do proxy if server contain util and common ip port spliter server server util and common ip port spliter application util get port string url http server application util get context path api http client http result result http client http get url null param if result code http u r l connection http ok throw new illegal state exception leader fail cause by result content proxy specify method param server target server param api api path param param parameter param method http method throw exception any exception during request public void proxy string server string api map string string param http method method throw exception do proxy if server contain util and common ip port spliter server server util and common ip port spliter application util get port string url http server application util get context path api http client http result result switch method case get result http client http get url null param break case post result http client http post url null param break case delete result http client http delete url null param break default throw new runtime exception unsupported method method if result code http u r l connection http ok throw new illegal state exception leader fail cause by result content proxy post method with large body param server target server param api api path param content body param header header throw exception any exception during request public void proxy post large string server string api string content map string string header throw exception do proxy if server contain util and common ip port spliter server server util and common ip port spliter application util get port string url http server application util get context path api http client http result result http client http post large url header content if result code http u r l connection http ok throw new illegal state exception leader fail cause by result content 
raft store component public class raft store private final property meta new property private static final string meta file name data base dir file separator meta property private static final string cache dir data base dir file separator datum load datum from cache file param notifier raft notifier param datum cache datum map throw exception any exception during load public synchronize void load datum raft core notifier notifier concurrent map string datum datum throw exception datum datum long start system current time millis for file cache list cache if cache be directory cache list file null for file datum file cache list file datum read datum datum file cache get name if datum null datum put datum key datum notifier add task datum key apply action change continue datum read datum cache string util empty if datum null datum put datum key datum logger raft info finish loading all datum size cost ms datum size system current time millis start load metadata from cache file return metadata throw exception any exception during load public synchronize property load meta throw exception file meta file new file meta file name if meta file exist meta file get parent file mkdir meta file create new file throw new illegal state exception fail to create meta file meta file get absolute path try file input stream in stream new file input stream meta file meta load in stream return meta load datum from cache file by key param key datum key return datum throw exception any exception during load public synchronize datum load string key throw exception long start system current time millis load datum for file cache list cache if cache be file logger raft warn warning encounter directory in cache dir cache get absolute path if string util equal cache get name encode datum key key string util equal cache get name encode datum key key raft cache file suffix continue logger raft info finish loading datum key cost m key system current time millis start return read datum cache string util empty return null private boolean be datum cache file string file name return file name end with raft cache file suffix file name start with raft cache file prefix private synchronize datum read datum file file string namespace id throw i o exception if be datum cache file file get name return null byte buffer buffer try file channel fc new file input stream file get channel buffer byte buffer allocate int file length fc read buffer string json new string buffer array standard charset utf if string util be blank json return null final string file name file get name if key builder match switch key file name return jackson util to obj json new type reference datum switch domain if key builder match service meta key file name datum service service datum try service datum jackson util to obj json replace new type reference datum service catch exception e json node json object jackson util to obj json service datum new datum service datum timestamp set json object get timestamp as long service datum key json object get key as text service datum value jackson util to obj json object get value to string service class if string util be blank service datum value get group name service datum value set group name constant default group if service datum value get name contain constant service info spliter service datum value set name constant default group constant service info spliter service datum value get name return service datum if key builder match instance list key file name datum instance instance datum try instance datum jackson util to obj json new type reference datum instance catch exception e json node json object jackson util to obj json instance datum new datum instance datum timestamp set json object get timestamp as long string key json object get key as text string service name key builder get service name key key key substring key index of service name constant default group constant service info spliter service name instance datum key key instance datum value new instance instance datum value set instance list jackson util to obj json object get value to string new type reference list instance if instance datum value get instance list be empty for instance instance instance datum value get instance list instance set ephemeral false return instance datum return jackson util to obj json datum class catch exception e logger raft warn wane fail to deserialize key file get name throw e private string cache file name string namespace id datum datum string file name if string util be not blank namespace id file name cache dir file separator namespace id file separator encode datum key datum key else file name cache dir file separator encode datum key datum key return file name private file cache file string cache file name file cache file new file cache file name if cache file exist return cache file return new file cache file name raft cache file suffix write datum to cache file param datum datum throw exception any exception during write public synchronize void write final datum datum throw exception string namespace id key builder get namespace datum key file cache file cache file cache file name namespace id datum if cache file exist cache file get parent file mkdir cache file create new file metric monitor get disk exception increment throw new illegal state exception can not make cache file cache file get name file channel fc null byte buffer datum datum byte buffer wrap jackson util to json datum get byte standard charset utf try fc new file output stream cache file false get channel fc write datum datum position fc force true catch exception e metric monitor get disk exception increment throw e finally if fc null fc close remove old format file if string util be none blank namespace id if datum key contain constant default group constant service info spliter string old format key datum key replace constant default group constant service info spliter string util empty cache file cache file cache file name namespace id datum if cache file exist cache file delete logger raft error raft delete fail to delete old format datum value datum key datum value throw new illegal state exception fail to delete old format datum datum key private file list cache throw exception file cache dir new file cache dir if cache dir exist cache dir mkdir throw new illegal state exception cloud not make out directory cache dir get name return cache dir list file delete datum from cache file param datum datum public void delete datum datum datum key contain namespace info string namespace id key builder get namespace datum key if string util be not blank namespace id file cache file new file cache file name namespace id datum if cache file exist cache file delete logger raft error raft delete fail to delete datum value datum key datum value throw new illegal state exception fail to delete datum datum key update term metadata param term term throw exception any exception during update public void update term long term throw exception file file new file meta file name if file exist file get parent file mkdir file create new file throw new illegal state exception fail to create meta file try file output stream out stream new file output stream file write meta meta set property term string value of term meta store out stream null private static string encode datum key string datum key return datum key replace private static string decode datum key string datum key return datum key replace 
distro mapper component distro mapper public class distro mapper extend member change listener list of service node you must ensure that the order of healthy list be the same for all node private volatile list string healthy list new array list private final switch domain switch domain private final server member manager member manager public distro mapper server member manager member manager switch domain switch domain this member manager member manager this switch domain switch domain public list string get healthy list return healthy list init server list post construct public void init notify center register subscriber this this healthy list member util simple member member manager all member public boolean responsible cluster cluster instance instance return switch domain be health check enable cluster get service name cluster get health check task be cancel responsible cluster get service name cluster contain instance judge whether current server be responsible for input service param service name service name return true if input service be response otherwise false public boolean responsible string service name final list string server healthy list if switch domain be distro enable application util get standalone mode return true if collection util be empty server mean distro config be not ready yet return false int index server index of application util get local address int last index server last index of application util get local address if last index index return true int target distro hash service name server size return target index target last index calculate which other server response input service param service name service name return server which response input service public string map srv string service name final list string server healthy list if collection util be empty server switch domain be distro enable return application util get local address try int index distro hash service name server size return server get index catch throwable e logger srv log warn naco distro distro mapper fail return localhost application util get local address e return application util get local address private int distro hash string service name return math abs service name hash code integer max value override public void on event member change event event here the node list must be sort to ensure that all naco server s node list be in the same order list string list member util simple member member util select target member event get member member node state down equal member get state collection sort list collection string old healthy list healthy list collection unmodifiable list list logger srv log info naco distro healthy server list change old new old healthy list override public boolean ignore expire event return true 
service manager component public class service manager implement record listener service map namespace map group service name service private final map string map string service service map new concurrent hash map private final link blocking deque service key to be update service queue new link blocking deque private final synchronizer synchronizer new service status synchronizer private final lock lock new reentrant lock resource name consistency delegate private consistency service consistency service private final switch domain switch domain private final distro mapper distro mapper private final server member manager member manager private final push service push service private final raft peer set raft peer set private int max finalize count private final object put service lock new object value naco name empty service auto clean false private boolean empty service auto clean value naco name empty service clean initial delay m private int clean empty service delay value naco name empty service clean period time ms private int clean empty service period public service manager switch domain switch domain distro mapper distro mapper server member manager member manager push service push service raft peer set raft peer set this switch domain switch domain this distro mapper distro mapper this member manager member manager this push service push service this raft peer set raft peer set init service maneger post construct public void init global executor schedule service reporter new service reporter time unit millisecond global executor submit service update manager new updated service processor if empty service auto clean logger srv log info open empty service auto clean job initial delay ms period ms clean empty service delay clean empty service period delay 60 period 20 this task be not recommend to be perform frequently in order to avoid the possibility that the service cache information may just be delete and then create due to the heartbeat mechanism global executor schedule service auto clean new empty service auto clean clean empty service delay clean empty service period try logger srv log info listen for service meta change consistency service listen key builder service meta key prefix this catch nacos exception e logger srv log error listen for service meta change fail public map string service choose service map string namespace id return service map get namespace id add a service into queue to update param namespace id namespace param service name service name param server i p target server ip param checksum checksum of service public void add updated service to queue string namespace id string service name string server i p string checksum lock lock try to be update service queue offer new service key namespace id service name server i p checksum time unit millisecond catch exception e to be update service queue poll to be update service queue add new service key namespace id service name server i p checksum logger srv log error domain status fail to add service to be updatd to queue e finally lock unlock override public boolean interest string key return key builder match service meta key key key builder match switch key key override public boolean match unlisten key string key return key builder match service meta key key key builder match switch key key override public void on change string key service service throw exception try if service null logger srv log warn receive empty push from raft key key return if string util be blank service get namespace id service set namespace id constant default namespace id logger raft info raft notifier datum be change key value key service service old dom get service service get namespace id service get name if old dom null old dom update service re listen to handle the situation when the underlie listener be remove consistency service listen key builder build instance list key service get namespace id service get name true old dom consistency service listen key builder build instance list key service get namespace id service get name false old dom else put service and init service catch throwable e logger srv log error naco service error while processing service update e override public void on delete string key throw exception string namespace key builder get namespace key string name key builder get service name key service service choose service map namespace get name logger raft info raft notifier datum be delete key key if service null service destroy consistency service remove key builder build instance list key namespace name true consistency service remove key builder build instance list key namespace name false consistency service un listen key builder build service meta key namespace name service logger srv log info dead service service to json choose service map namespace remove name private class update service processor implement runnable get changed service from other server asynchronously override public void run service key service key null try while true try service key to be update service queue take catch exception e logger evt log error update domain exception while take item from link blocking deque if service key null continue global executor submit service update new service updater service key catch exception e logger evt log error update domain exception while update service service key e private class service updater implement runnable string namespace id string service name string server i p public service updater service key service key this namespace id service key get namespace id this service name service key get service name this server i p service key get server i p override public void run try update health status namespace id service name server i p catch exception e logger srv log warn domain updater exception while update service from error service name server i p e public raft peer get my self cluster state return raft peer set local update health status of instance in service param namespace id namespace param service name service name param server i p source server ip public void update health status string namespace id string service name string server i p message msg synchronizer get server i p util and common assemble full service name namespace id service name json node service json jackson util to obj msg get datum array node ip list array node service json get ip map string string ip map new hash map ip list size for int i i ip list size i string ip ip list get i as text string string ip split ip map put string string service service get service namespace id service name if service null return boolean change false list instance instance service all i ps for instance instance instance boolean valid boolean parse boolean ip map get instance to ip addr if valid instance be healthy change true instance set healthy valid logger evt log info sync ip service name instance be healthy enable disabled instance get ip instance get port instance get cluster name if change push service service change service if logger evt log be debug enable string builder string builder new string builder list instance all ip service all i ps for instance instance all ip string builder append instance to ip addr append append instance be healthy append logger evt log debug health status update namespace service ip service get namespace id service get name string builder to string public set string get all service name string namespace id return service map get namespace id key set public map string set string get all service name map string set string name map new hash map for string namespace id service map key set name map put namespace id service map get namespace id key set return name map public set string get all namespace return service map key set public list string get all service name list string namespace id if choose service map namespace id null return new array list return new array list choose service map namespace id key set public map string set service get responsible service map string set service result new hash map for string namespace id service map key set result put namespace id new hash set for map entry string service entry service map get namespace id entry set service service entry get value if distro mapper responsible entry get key result get namespace id add service return result public int get responsible service count int service count for string namespace id service map key set for map entry string service entry service map get namespace id entry set if distro mapper responsible entry get key service count return service count public int get responsible instance count map string set service responsible service get responsible service int count for string namespace id responsible service key set for service service responsible service get namespace id count service all i ps size return count fast remove service p remove service bu async param namespace id namespace param service name service name throw exception exception public void easy remove service string namespace id string service name throw exception service service get service namespace id service name if service null throw new illegal argument exception specify service not exist service name service name consistency service remove key builder build service meta key namespace id service name public void add or replace service service service throw naco exception consistency service put key builder build service meta key service get namespace id service get name service public void create empty service string namespace id string service name boolean local throw naco exception create service if absent namespace id service name local null create service if not exist param namespace id namespace param service name service name param local whether create service by local param cluster cluster throw naco exception naco exception public void create service if absent string namespace id string service name boolean local cluster cluster throw naco exception service service get service namespace id service name if service null logger srv log info create empty service namespace id service name service new service service set name service name service set namespace id namespace id service set group name name util get group name service name now validate the service if fail exception will be throw service set last modify millis system current time millis service recalculate checksum if cluster null cluster set service service service get cluster map put cluster get name cluster service validate put service and init service if local add or replace service service register a instance to a service in ap mode p this method create service or cluster silently if they don t exist param namespace id id of namespace param service name service name param instance instance to register throw exception any error occur in the process public void register instance string namespace id string service name instance instance throw naco exception create empty service namespace id service name instance be ephemeral service service get service namespace id service name if service null throw new naco exception naco exception invalid param service not find namespace namespace id service service name add instance namespace id service name instance be ephemeral instance update instance to service param namespace id namespace param service name service name param instance instance throw naco exception naco exception public void update instance string namespace id string service name instance instance throw naco exception service service get service namespace id service name if service null throw new naco exception naco exception invalid param service not find namespace namespace id service service name if service all i ps contain instance throw new naco exception naco exception invalid param instance not exist instance add instance namespace id service name instance be ephemeral instance add instance to service param namespace id namespace param service name service name param ephemeral whether instance be ephemeral param ip instance throw naco exception naco exception public void add instance string namespace id string service name boolean ephemeral instance ip throw naco exception string key key builder build instance list key namespace id service name ephemeral service service get service namespace id service name synchronize service list instance instance list add ip address service ephemeral ip instance instance new instance instance set instance list instance list consistency service put key instance remove instance from service param namespace id namespace param service name service name param ephemeral whether instance be ephemeral param ip instance throw naco exception naco exception public void remove instance string namespace id string service name boolean ephemeral instance ip throw naco exception service service get service namespace id service name synchronize service remove instance namespace id service name ephemeral service ip private void remove instance string namespace id string service name boolean ephemeral service service instance ip throw naco exception string key key builder build instance list key namespace id service name ephemeral list instance instance list substract ip address service ephemeral ip instance instance new instance instance set instance list instance list consistency service put key instance public instance get instance string namespace id string service name string cluster string ip int port service service get service namespace id service name if service null return null list string cluster new array list cluster add cluster list instance ip service all i ps cluster if ips null ip be empty return null for instance instance ip if instance get ip equal ip instance get port port return instance return null compare and get new instance list param service service param action link util and common update instance action remove or link util and common update instance action add param ephemeral whether instance be ephemeral param ip instance return instance list after operation throw naco exception naco exception public list instance update ip address service service string action boolean ephemeral instance ip throw naco exception datum datum consistency service get key builder build instance list key service get namespace id service get name ephemeral list instance current i ps service all i ps ephemeral map string instance current instance new hash map current i ps size set string current instance id set new hash set for instance instance current i ps current instance put instance to ip addr instance current instance id add instance get instance id map string instance instance map if datum null instance map set valid instance datum value get instance list current instance else instance map new hash map ip length for instance instance ip if service get cluster map contain key instance get cluster name cluster cluster new cluster instance get cluster name service cluster init service get cluster map put instance get cluster name cluster logger srv log warn cluster not find ip will create new cluster with default configuration instance get cluster name instance to json if util and common update instance action remove equal action instance map remove instance get datum key else instance set instance id instance generate instance id current instance id instance map put instance get datum key instance if instance map size util and common update instance action add equal action throw new illegal argument exception ip list can not be empty service service get name ip list jackson util to json instance map value return new array list instance map value private list instance substract ip address service service boolean ephemeral instance ip throw naco exception return update ip address service util and common update instance action remove ephemeral ip private list instance add ip address service service boolean ephemeral instance ip throw naco exception return update ip address service util and common update instance action add ephemeral ip private map string instance set valid list instance old instance map string instance map map string instance instance map new hash map old instance size for instance instance old instance instance instance1 map get instance to ip addr if instance1 null instance set healthy instance1 be healthy instance set last beat instance1 get last beat instance map put instance get datum key instance return instance map public service get service string namespace id string service name if service map get namespace id null return null return choose service map namespace id get service name public boolean contain service string namespace id string service name return get service namespace id service name null put service into manager param service service public void put service service service if service map contain key service get namespace id synchronize put service lock if service map contain key service get namespace id service map put service get namespace id new concurrent hash map service map get service get namespace id put service get name service private void put service and init service service throw naco exception put service service service init consistency service listen key builder build instance list key service get namespace id service get name true service consistency service listen key builder build instance list key service get namespace id service get name false service logger srv log info new service service to json search service param namespace id namespace param regex search regex return list of service which search public list service search service string namespace id string regex list service result new array list for map entry string service entry choose service map namespace id entry set service service entry get value string key service get name array util to string service get owner if key match regex result add service return result public int get service count int service count for string namespace id service map key set service count service map get namespace id size return service count public int get instance count int total for string namespace id service map key set for service service service map get namespace id value total service all i ps size return total public map string service get service map string namespace id return service map get namespace id public int get page service string namespace id int start page int page size string param string contain instance list service service list boolean have ip count list service match list if choose service map namespace id null return if string util be not blank param string joiner regex new string joiner constant service info spliter for string s param split constant service info spliter regex add string util be blank s constant any pattern constant any pattern s constant any pattern match list search service namespace id regex to string else match list new array list choose service map namespace id value if collection util be empty match list have ip count match list match list stream filter s collection util be empty s all i ps collect collector to list if string util be not blank contain instance boolean contain for int i i match list size i service service match list get i contain false list instance instance service all i ps for instance instance instance if contain instance contain if string util equal instance get ip instance get port contain instance contain true break else if string util equal instance get ip contain instance contain true break if contain match list remove i i if page size match list size service list add all match list return match list size for int i i match list size i if i start page page size continue service list add match list get i if service list size page size break return match list size public static class service checksum public string namespace id public map string string service name2 checksum new hash map string string public service checksum this namespace id constant default namespace id public service checksum string namespace id this namespace id namespace id add service checksum param service name service name param checksum checksum of service public void add item string service name string checksum if string util be empty service name string util be empty checksum logger srv log warn domain checksum service name or checksum be empty service name checksum service name checksum return service name2 checksum put service name checksum private class empty service auto clean implement runnable override public void run parallel flow opening threshold int parallel size service map for each namespace string service map stream map entry string service stream null if string service map size parallel size stream string service map entry set parallel stream else stream string service map entry set stream stream filter entry final string service name entry get key return distro mapper responsible service name for each entry string service map compute if present entry get key service name service if service be empty to avoid violent service removal the number of time the service experience empty be determine by finalize cnt and if the specify value be reach it be remove if service get finalize count max finalize count logger srv log warn namespace service be automatically clean namespace service name try easy remove service namespace service name catch exception e logger srv log error namespace service be automatically clean have error namespace service name e service set finalize count service get finalize count logger srv log debug namespace the number of time the current service experience a empty instance be namespace service name service get finalize count else service set finalize count return service private class service reporter implement runnable override public void run try map string set string all service name get all service name if all service name size ignore return for string namespace id all service name key set service checksum checksum new service checksum namespace id for string service name all service name get namespace id if distro mapper responsible service name continue service service get service namespace id service name if service null service be empty continue service recalculate checksum checksum add item service name service get checksum message msg new message msg set datum jackson util to json checksum collection member same site server member manager all member if same site server null same site server size return for member server same site server if server get address equal net util local server continue synchronizer send server get address msg catch exception e logger srv log error domain status exception while send service status e finally global executor schedule service reporter this switch domain get service status synchronization period millis time unit millisecond private static class service key private string namespace id private string service name private string server i p private string checksum public string get checksum return checksum public string get server i p return server i p public string get service name return service name public string get namespace id return namespace id public service key string namespace id string service name string server i p string checksum this namespace id namespace id this service name service name this server i p server i p this checksum checksum override public string to string return jackson util to json this 
health check extend provider component public class health check extend provider implement bean factory aware private static final logger logger logger factory get logger health check extend provider class private service loader health check processor processor loader service loader load health check processor class private service loader abstract health checker checker loader service loader load abstract health checker class private singleton bean registry registry public void init load extend private void load extend iterator health check processor processor it processor loader iterator iterator abstract health checker health checker it checker loader iterator set string origin new hash set for health check type type health check type value origin add type name set string processor type new hash set origin set string health checker type new hash set origin while processor it have next health check processor processor processor it next string type processor get type if processor type contain type throw new runtime exception more than one processor of the same type be find type type processor type add type registry register singleton lower first char processor get class get simple name processor while health checker it have next abstract health checker checker health checker it next string type checker get type if health checker type contain type throw new runtime exception more than one health checker of the same type be find type type health checker type add type health check type register health checker checker get type checker get class if processor type equal health checker type throw new runtime exception a unmatched processor and health checker be detect in the extension package if processor type size origin size processor type remove all origin logger debug init health plugin type processor type private string lower first char string simple name if string util be blank simple name throw new illegal argument exception can t find extend processor class name return string value of simple name char at to lower case simple name substr override public void set bean factory bean factory bean factory throw bean exception if bean factory instanceof singleton bean registry this registry singleton bean registry bean factory 
health check common component suppress warning pmd thread pool creation rule public class health check common autowired private distro mapper distro mapper autowire private switch domain switch domain autowire private server member manager member manager autowire private push service push service private static link block deque health check result health check result new link blocking deque init health check public void init global executor schedule name health check list list array as list health check result to array health check result clear collection member same site server member manager all member if same site server null same site server size return for member server same site server if server get address equal net util local server continue map string string param new hash map param put result jackson util to json list if logger srv log be debug enable logger srv log debug health sync server health check result server jackson util to json list http client http result http result http client http post http server get address application util get context path util and common naco name context api health check result null param if http result code http u r l connection http ok logger evt log warn health check sync fail to send result to result server jackson util to json list time unit millisecond be evaluate check responsce time param check r t check response time param task health check task param param health param public void re evaluate check r t long check r t health check task task switch domain health param param task set check rt last check r t if check r t task get check rt worst task set check rt worst check r t if check r t task get check rt best task set check rt best check r t check r t long param get factor task get check rt normalize param get factor check r t if check r t param get max check r t param get max if check r t param get min check r t param get min task set check rt normalize check r t health check pass param ip instance param task health check task param msg message public void check o k instance ip health check task task string msg cluster cluster task get cluster try if ip be healthy ip be mock valid if ip get ok count increment and get switch domain get check time if distro mapper responsible cluster ip ip set healthy true ip set mock valid true service service cluster get service service set last modify millis system current time milli push service service change service add result new health check result service get name ip logger evt log info service name pos ip enable valid region msg cluster get service get name ip get ip ip get port cluster get name util and common localhost site msg else if ip be mock valid ip set mock valid true logger evt log info service name probe ip enable valid region msg cluster get service get name ip get ip ip get port cluster get name util and common localhost site msg else logger evt log info service name other ip enable pre valid in msg cluster get service get name ip get ip ip get port cluster get name ip get ok count msg catch throwable t logger srv log error check ok error when close check task t ip get fail count set ip set be check false health check fail when instance check fail count more than max fail time set unhealthy param ip instance param task health check task param msg message public void check fail instance ip health check task task string msg cluster cluster task get cluster try if ip be healthy ip be mock valid if ip get fail count increment and get switch domain get check time if distro mapper responsible cluster ip ip set healthy false ip set mock valid false service service cluster get service service set last modify millis system current time millis add result new health check result service get name ip push service service change service logger evt log info service name po ip disabled invalid region msg cluster get service get name ip get ip ip get port cluster get name util and common localhost site msg else logger evt log info service name probe ip disabled invalid region msg cluster get service get name ip get ip ip get port cluster get name util and common localhost site msg else logger evt log info service name other ip disabled pre invalid in msg cluster get service get name ip get ip ip get port cluster get name ip get fail count msg catch throwable t logger srv log error check fail error when close check task t ip get ok count set ip set be check false health check fail set instance unhealthy directly param ip instance param task health check task param msg message public void check fail now instance ip health check task task string msg cluster cluster task get cluster try if ip be healthy ip be mock valid if distro mapper responsible cluster ip ip set healthy false ip set mock valid false service service cluster get service service set last modify millis system current time milli push service service change service add result new health check result service get name ip logger evt log info service name po ip disabled invalid now region msg cluster get service get name ip get ip ip get port cluster get name util and common localhost site msg else if ip be mock valid ip set mock valid false logger evt log info service name probe ip disabled invalid now region msg cluster get service get name ip get ip ip get port cluster get name util and common localhost site msg catch throwable t logger srv log error check fail now error when close check task t ip get ok count set ip set be check false private void add result health check result result if switch domain get incremental list contain result get service name return if health check result offer result logger evt log warn health check sync fail to add check result to queue queue size health check result size static class health check result private string service name private instance instance public health check result string service name instance instance this service name service name this instance instance public string get service name return service name public void set service name string service name this service name service name public instance get instance return instance public void set instance instance instance this instance instance 
health check processor delegate component health check delegate public class health check processor delegate implement health check processor private map string health check processor health check processor map new hash map public health check processor delegate health check extend provider provider provider init autowire public void add processor collection health check processor processor health check processor map put all processor stream filter processor processor get type null collect collector to map health check processor get type processor processor override public void process health check task task string type task get cluster get health checker get type health check processor processor health check processor map get type if processor null processor health check processor map get none health check processor type processor process task override public string get type return null 
http health check processor component public class http health check processor implement health check processor public static final string type http autowire private switch domain switch domain autowire private health check common health check common private static async http client async http client private static final int connect timeout ms static try async http client config builder builder new async http client config builder builder set maximum connection total builder set maximum connection per host builder set allow pool connection false builder set follow redirect false builder set idle connection timeout in m connect timeout ms builder set connection timeout in m connect timeout ms builder set compression enable false builder set i o thread multiplier builder set max request retry builder set user agent v i p server async http client new async http client builder build catch throwable e srv log error health check error while construct http asynchronous client e override public string get type return type override public void process health check task task list instance ip task get cluster all i ps false if collection util be empty ips return if switch domain be health check enable return cluster cluster task get cluster for instance ip ip try if ip be mark if srv log be debug enable srv log debug http check ip be mark as to skip health check ip ip get ip continue if ip mark check srv log warn http check start before last one finished service task get cluster get service get name task get cluster get name ip get ip health check common re evaluate check r t task get check rt normalize task switch domain get http health param continue http health checker http cluster get health checker int ck port cluster be use i p port4 check ip get port cluster get def ckport url host new url http ip get ip ck port url target new url host health checker get path async http client bind request builder builder async http client prepare get target to string map string string custom header health checker get custom header for map entry string string entry custom header entry set if host equal entry get key builder set virtual host entry get value continue builder set header entry get key entry get value builder execute new http health check callback ip task metric monitor get http health check monitor increment and get catch throwable e ip set check rt switch domain get http health param get max health check common check fail ip task http error e get message health check common re evaluate check r t switch domain get http health param get max task switch domain get http health param private class http health check callback extend async completion handler integer private instance ip private health check task task private long start time system current time millis public http health check callback instance ip health check task task this ip ip this task task override public integer on complete response response throw exception ip set check rt system current time millis start time int http code response get status code if http u r l connection http ok http code health check common check o k ip task http http code health check common re evaluate check r t system current time millis start time task switch domain get http health param else if http u r l connection http unavailable http code http u r l connection http move temp http code server be busy need verification later health check common check fail ip task http http code health check common re evaluate check r t task get check rt normalize task switch domain get http health param else probably mean the state file have be remove by administrator health check common check fail now ip task http http code health check common re evaluate check r t switch domain get http health param get max task switch domain get http health param return http code override public void on throwable throwable t ip set check rt system current time millis start time throwable cause t int max stack depth for int deepth deepth max stack depth cause null deepth if cause instanceof socket timeout exception cause instanceof connect timeout exception cause instanceof org jboss netty channel connect timeout exception cause instanceof timeout exception cause get cause instanceof timeout exception health check common check fail ip task http timeout cause get message health check common re evaluate check r t task get check rt normalize task switch domain get http health param return cause cause get cause connection error probably not reachable if t instanceof connect exception health check common check fail now ip task http unable2connect t get message health check common re evaluate check r t switch domain get http health param get max task switch domain get http health param else health check common check fail ip task http error t get message health check common re evaluate check r t switch domain get http health param get max task switch domain get http health param 
mysql health check processor component suppress warning pmd thread pool creation rule public class mysql health check processor implement health check processor public static final string type mysql autowire private health check common health check common autowired private switch domain switch domain public static final int connect timeout m private static final string check mysql master sql show global variable where variable name read only private static final string mysql slave readonly on private static final concurrent map string connection connection pool new concurrent hash map string connection public mysql health check processor override public string get type return type override public void process health check task task list instance ip task get cluster all i ps false srv log debug mysql check ip ips if collection util be empty ips return for instance ip ip try if ip be mark if srv log be debug enable srv log debug mysql check ip be mark as to skip health check ip ip get ip continue if ip mark check srv log warn mysql check start before last one finished service task get cluster get service get name task get cluster get name ip get ip health check common re evaluate check r t task get check rt normalize task switch domain get mysql health param continue global executor execute mysql check task new mysql check task ip task metric monitor get mysql health check monitor increment and get catch exception e ip set check rt switch domain get mysql health param get max health check common check fail ip task mysql error e get message health check common re evaluate check r t switch domain get mysql health param get max task switch domain get mysql health param private class mysql check task implement runnable private instance ip private health check task task private long start time system current time millis public mysql check task instance ip health check task task this ip ip this task task override public void run statement statement null result set result set null try cluster cluster task get cluster string key cluster get service get name cluster get name ip get ip ip get port connection connection connection pool get key mysql config mysql cluster get health checker if connection null connection be closed string url jdbc mysql ip get ip ip get port connect timeout connect timeout ms socket timeout connect timeout ms login timeout connection driver manager get connection url config get user config get pwd connection pool put key connection statement connection create statement statement set query timeout result set statement execute query config get cmd int result column index if check mysql master sql equal config get cmd result set next if mysql slave readonly equal result set get string result column index throw new illegal state exception current node be slave health check common check o k ip task mysql ok health check common re evaluate check r t system current time millis start time task switch domain get mysql health param catch s q l exception e fail immediately health check common check fail now ip task mysql e get message health check common re evaluate check r t switch domain get http health param get max task switch domain get mysql health param catch throwable t throwable cause t int max stack depth for int deepth deepth max stack depth cause null deepth if cause instanceof socket timeout exception cause instanceof connect timeout exception cause instanceof timeout exception cause get cause instanceof timeout exception health check common check fail ip task mysql timeout cause get message health check common re evaluate check r t task get check rt normalize task switch domain get mysql health param return cause cause get cause connection error probably not reachable health check common check fail ip task mysql error t get message health check common re evaluate check r t switch domain get mysql health param get max task switch domain get mysql health param finally ip set check rt system current time millis start time if statement null try statement close catch s q l exception e logger srv log error mysql check fail to close statement statement e if result set null try result set close catch s q l exception e logger srv log error mysql check fail to close result set result set e 
none health check processor component public class none health check processor implement health check processor public static final string type none override public void process health check task task override public string get type return type 
tcp super sense processor component suppress warning pmd thread pool creation rule public class tcp super sense processor implement health check processor runnable public static final string type tcp autowire private health check common health check common autowired private switch domain switch domain public static final int connect timeout m private map string beat key key map new concurrent hash map private blocking queue beat task queue new link blocking queue beat this value have be carefully tune do not modify unless you be confident private static final int nio thread count runtime get runtime available processor runtime get runtime available processor because some host doesn t support keep alive connection disabled temporarily private static final long tcp keep alive milli private selector selector tcp super sense processor construct throw illegal state exception when construct fail public tcp super sense processor try selector selector open global executor submit tcp check this catch exception e throw new illegal state exception error while initialize super sense tm override public void process health check task task list instance ip task get cluster all i ps false if collection util be empty ips return for instance ip ip if ip be mark if srv log be debug enable srv log debug tcp check ip be mark as to skip health check ip ip get ip continue if ip mark check srv log warn tcp check start before last one finished service task get cluster get service get name task get cluster get name ip get ip ip get port health check common re evaluate check r t task get check rt normalize task switch domain get tcp health param continue beat beat new beat ip task task queue add beat metric monitor get tcp health check monitor increment and get private void process task throw exception collection callable void task new link list do beat beat task queue poll connect timeout ms time unit millisecond if beat null return task add new task processor beat while task queue size task size nio thread count for future f global executor invoke all tcp super sense task task f get override public void run while true try process task int ready count selector select now if ready count continue iterator selection key iter selector select key iterator while iter have next selection key key iter next iter remove global executor execute tcp super sense new post processor key catch throwable e srv log error health check error while process nio task e public class post processor implement runnable selection key key public post processor selection key key this key key override public void run beat beat beat key attachment socket channel channel socket channel key channel try if beat be healthy invalid beat mean this server be no longer responsible for the current service key cancel key channel close beat finish check return if key be valid key be connectable connected channel finish connect beat finish check true false system current time millis beat get task get start time tcp ok if key be valid key be readable disconnected byte buffer buffer byte buffer allocate if channel read buffer key cancel key channel close else not terminate request ignore catch connect exception e unable to connect possibly port not open beat finish check false true switch domain get tcp health param get max tcp unable2connect e get message catch exception e beat finish check false false switch domain get tcp health param get max tcp error e get message try key cancel key channel close catch exception ignore private class beat instance ip health check task task long start time system current time millis beat instance ip health check task task this ip ip this task task public void set start time long time start time time public long get start time return start time public instance get ip return ip public health check task get task return task public boolean be healthy return system current time millis start time time unit seconds to millis 30 l finish check only no ip state will be change public void finish check ip set be check false public void finish check boolean success boolean now long rt string msg ip set check rt system current time millis start time if success health check common check o k ip task msg else if now health check common check fail now ip task msg else health check common check fail ip task msg key map remove task to string health check common re evaluate check r t rt task switch domain get tcp health param override public string to string return task get cluster get service get name task get cluster get name ip get ip ip get port override public int hash code return object hash ip to json override public boolean equal object obj if obj null obj instanceof beat return false return this to string equal obj to string private static class beat key public selection key key public long birth time public beat key selection key key this key key this birth time system current time milli private static class time out task implement runnable selection key key public time out task selection key key this key key override public void run if key null key be valid socket channel channel socket channel key channel beat beat beat key attachment if channel be connected return try channel finish connect catch exception ignore try beat finish check false false beat get task get check rt normalize tcp timeout key cancel key channel close catch exception ignore private class task processor implement callable void private static final int max wait time millisecond beat beat public task processor beat beat this beat beat override public void call long wait system current time millis beat get start time if wait max wait time millisecond logger srv log warn beat task wait too long wait ms socket channel channel null try instance instance beat get ip beat key beat key key map get beat to string if beat key null beat key key be valid if system current time millis beat key birth time tcp keep alive milli instance set be check false return null beat key key cancel beat key key channel close channel socket channel open channel configure block false only by set this can we make the socket close event asynchronous channel socket set so linger false channel socket set reuse address true channel socket set keep alive true channel socket set tcp no delay true cluster cluster beat get task get cluster int port cluster be use i p port4 check instance get port cluster get def ckport channel connect new inet socket address instance get ip port selection key key channel register selector selection key op connect selection key op read key attach beat key map put beat to string new beat key key beat set start time system current time millis global executor schedule tcp super sense task new time out task key connect timeout ms time unit millisecond catch exception e beat finish check false false switch domain get tcp health param get max tcp error e get message if channel null try channel close catch exception ignore return null override public string get type return type 
global config component public class global config value naco name distro task dispatch period private int task dispatch period value naco name distro batch sync key count private int batch sync key count value naco name distro sync retry delay private long sync retry delay l value naco name datum warmup false private boolean datum warmup false value naco name expire instance true private boolean expire instance true value naco name distro load datum retry delay milli private long load datum retry delay milli public int get task dispatch period return task dispatch period public int get batch sync key count return batch sync key count public long get sync retry delay return sync retry delay public boolean be datum warmup return datum warmup public boolean be expire instance return expire instance public long get load datum retry delay millis return load datum retry delay milli 
switch domain component public class switch domain implement record cloneable private list string master private map string integer ad weight map new hash map private long default push cache millis time unit seconds to millis private long client beat interval time unit seconds to millis private long default cache millis time unit seconds to millis private float distro threshold 0.7 f private boolean health check enable true private boolean auto change health check enable true private boolean distro enable true private boolean enable standalone true private boolean push enable true private int check time private http health param http health param new http health param private tcp health param tcp health param new tcp health param private mysql health param mysql health param new mysql health param private list string incremental list new array list private long server status synchronization period millis time unit seconds to millis private long service status synchronization period millis time unit seconds to millis private boolean disable add i p false private boolean send beat only false private boolean light beat enable true private map string integer limit url map new hash map the server be regard as expire if its two reporting interval be lagger than this variable private long distro server expire millis time unit seconds to millis since which version push can be enable private string push go version 0.1 private string push java version 0.1 private string push python version 0.4 private string push c version 1.0 private boolean enable authentication false private string overridden server status null private boolean default instance ephemeral true public boolean be enable authentication return enable authentication public void set enable authentication boolean enable authentication this enable authentication enable authentication public set string get health check white list return health check white list public void set health check white list set string health check white list this health check white list health check white list private set string health check white list new hash set public long get client beat interval return client beat interval public void set client beat interval long client beat interval this client beat interval client beat interval public boolean be enable standalone return enable standalone public void set enable standalone boolean enable standalone this enable standalone enable standalone public switch domain public boolean be send beat only return send beat only public void set send beat only boolean send beat only this send beat only send beat only the following be not implement public string get name return util and common switch domain name public void update switch domain domain public list string get incremental list return incremental list public void set incremental list list string incremental list this incremental list incremental list public list string get master return master public void set master list string master this masters master public map string integer get ad weight map return ad weight map public void set ad weight map map string integer ad weight map this ad weight map ad weight map public integer get ad weight string key return get ad weight map get key public long get default push cache millis return default push cache milli public void set default push cache milli long default push cache milli this default push cache millis default push cache milli public long get default cache millis return default cache milli public void set default cache milli long default cache milli this default cache millis default cache milli public float get distro threshold return distro threshold public void set distro threshold float distro threshold this distro threshold distro threshold public long get push cache millis string service name return default push cache milli public boolean be health check enable return health check enable public boolean be health check enable string service name return health check enable get health check white list contain service name public void set health check enable boolean health check enable this health check enable health check enable public boolean be auto change health check enable return auto change health check enable public void set auto change health check enable boolean auto change health check enable this auto change health check enable auto change health check enable public boolean be distro enable return distro enable public void set distro enable boolean distro enable this distro enable distro enable public boolean be push enable return push enable public void set push enable boolean push enable this push enable push enable public int get check time return check time public void set check time int check time this check time check time public http health param get http health param return http health param public void set http health param http health param http health param this http health param http health param public tcp health param get tcp health param return tcp health param public void set tcp health param tcp health param tcp health param this tcp health param tcp health param public mysql health param get mysql health param return mysql health param public void set mysql health param mysql health param mysql health param this mysql health param mysql health param public long get server status synchronization period millis return server status synchronization period milli public void set server status synchronization period milli long server status synchronization period milli this server status synchronization period millis server status synchronization period milli public long get service status synchronization period millis return service status synchronization period milli public void set service status synchronization period milli long service status synchronization period milli this service status synchronization period millis service status synchronization period milli public boolean be disable add i p return disable add i p public void set disable add i p boolean disable add i p this disable add i p disable add i p public map string integer get limited url map return limit url map public void set limited url map map string integer limit url map this limited url map limit url map public long get distro server expire millis return distro server expire millis public void set distro server expire milli long distro server expire milli this distro server expire millis distro server expire millis public string get push go version return push go version public void set push go version string push go version this push go version push go version public string get push java version return push java version public void set push java version string push java version this push java version push java version public string get push python version return push python version public void set push python version string push python version this push python version push python version public string get push c version return push c version public void set push c version string push c version this push c version push c version public string get override server status return override server status public void set overridden server status string overridden server status this override server status override server status public boolean be default instance ephemeral return default instance ephemeral public void set default instance ephemeral boolean default instance ephemeral this default instance ephemeral default instance ephemeral public boolean be light beat enable return light beat enable public void set light beat enable boolean light beat enable this light beat enable light beat enable override public string to string return jackson util to json this override protect switch domain clone throw clone not support exception return switch domain super clone override public string get checksum return null public interface health param maximum rt return max rt int get max minimum rt return minimum rt int get min get factor to reevaluate rt return reevaluate factor float get factor public static class http health param implement health param public static final int min max public static final int min min private int max private int min private float factor 0.85 f override public int get max return max override public int get min return min override public float get factor return factor public void set factor float factor this factor factor public void set max int max this max max public void set min int min this min min public static class mysql health param implement health param private int max private int min private float factor 0.65 f override public int get max return max override public int get min return min override public float get factor return factor public void set factor float factor this factor factor public void set max int max this max max public void set min int min this min min public static class tcp health param implement health param private int max private int min private float factor 0.75 f override public int get max return max override public int get min return min override public float get factor return factor public void set factor float factor this factor factor public void set max int max this max max public void set min int min this min min 
switch manager component public class switch manager implement record listener switch domain autowire private switch domain switch domain resource name consistency delegate private consistency service consistency service reentrant lock lock new reentrant lock init switch manager post construct public void init try consistency service listen key builder get switch domain key this catch nacos exception e logger srv log error listen switch service fail e update switch information param entry item entry of switch link switch entry param value switch value param debug whether debug throw exception exception public void update string entry string value boolean debug throw exception lock lock try datum datum consistency service get key builder get switch domain key switch domain switch domain if datum null datum value null switch domain switch domain datum value else switch domain this switch domain clone if switch entry batch equal entry batch update switch domain dom jackson util to obj value switch domain class dom set enable standalone switch domain be enable standalone if dom get http health param get min switch domain http health param min min dom get tcp health param get min switch domain http health param min min throw new illegal argument exception min check time for http or tcp be too small if dom get http health param get max switch domain http health param min max dom get tcp health param get max switch domain http health param min max throw new illegal argument exception max check time for http or tcp be too small if dom get http health param get factor dom get http health param get factor dom get tcp health param get factor dom get tcp health param get factor throw new illegal argument exception malformed factor switch domain dom if entry equal switch entry distro threshold float threshold float parse float value if threshold throw new illegal argument exception distro threshold can not be zero or negative threshold switch domain set distro threshold threshold if entry equal switch entry client beat interval long client beat interval long parse long value switch domain set client beat interval client beat interval if entry equal switch entry push version string type value split string version value split if version match util and common version string syntax throw new illegal argument exception illegal version must match util and common version string syntax if string util equal switch entry client java type switch domain set push java version version else if string util equal switch entry client python type switch domain set push python version version else if string util equal switch entry client c type switch domain set push c version version else if string util equal switch entry client go type switch domain set push go version version else throw new illegal argument exception unsupported client type type if entry equal switch entry push cache milli long cache milli long parse long value if cache milli switch entry min push cache time miili throw new illegal argument exception min cache time for http or tcp be too small switch domain set default push cache millis cache millis extremely careful while modify this cause it will affect all client without push enable if entry equal switch entry default cache milli long cache milli long parse long value if cache milli switch entry min cache time miili throw new illegal argument exception min default cache time be too small switch domain set default cache millis cache millis if entry equal switch entry master list string master array as list value split switch domain set master master if entry equal switch entry distro boolean enable boolean parse boolean value switch domain set distro enable enable if entry equal switch entry check boolean enable boolean parse boolean value switch domain set health check enable enable if entry equal switch entry push enable boolean enable boolean parse boolean value switch domain set push enable enable if entry equal switch entry service status sync period long millis long parse long value if milli switch entry min service sync time miili throw new illegal argument exception service status synchronization period millis be too small switch domain set service status synchronization period millis millis if entry equal switch entry server status sync period long millis long parse long value if milli switch entry min server sync time miili throw new illegal argument exception server status synchronization period millis be too small switch domain set server status synchronization period millis millis if entry equal switch entry health check time int time integer parse int value switch domain set check time time if entry equal switch entry disable add ip boolean disable add ip boolean parse boolean value switch domain set disable add i p disable add ip if entry equal switch entry send beat only boolean send beat only boolean parse boolean value switch domain set send beat only send beat only if entry equal switch entry limit url map map string integer limit url map new hash map if string util be empty value string entry value split for string each entry string part each split if part length throw new illegal argument exception invalid input for limited url string limited url part if string util be empty limited url throw new illegal argument exception url can not be empty url limit url int status code integer parse int part if status code throw new illegal argument exception illegal normal status code status code limit url map put limited url status code switch domain set limited url map limit url map if entry equal switch entry enable standalone if string util be not empty value switch domain set enable standalone boolean parse boolean value if entry equal switch entry override server status string status value if constant null string equal status status string util empty switch domain set overridden server status status if entry equal switch entry default instance ephemeral switch domain set default instance ephemeral boolean parse boolean value if entry equal switch entry distro server expire milli switch domain set distro server expire milli long parse long value if entry equal switch entry light beat enable switch domain set light beat enable boolean util to boolean value if entry equal switch entry auto change health check enable switch domain set auto change health check enable boolean util to boolean value if debug update switch domain else consistency service put key builder get switch domain key switch domain finally lock unlock update switch information from new switch domain param new switch domain new switch domain public void update switch domain new switch domain switch domain set master new switch domain get master switch domain set ad weight map new switch domain get ad weight map switch domain set default push cache milli new switch domain get default push cache milli switch domain set client beat interval new switch domain get client beat interval switch domain set default cache milli new switch domain get default cache milli switch domain set distro threshold new switch domain get distro threshold switch domain set health check enable new switch domain be health check enable switch domain set auto change health check enable new switch domain be auto change health check enable switch domain set distro enable new switch domain be distro enable switch domain set push enable new switch domain be push enable switch domain set enable standalone new switch domain be enable standalone switch domain set check time new switch domain get check time switch domain set http health param new switch domain get http health param switch domain set tcp health param new switch domain get tcp health param switch domain set mysql health param new switch domain get mysql health param switch domain set incremental list new switch domain get incremental list switch domain set server status synchronization period milli new switch domain get server status synchronization period milli switch domain set service status synchronization period milli new switch domain get service status synchronization period milli switch domain set disable add i p new switch domain be disable add i p switch domain set send beat only new switch domain be send beat only switch domain set limited url map new switch domain get limited url map switch domain set distro server expire milli new switch domain get distro server expire milli switch domain set push go version new switch domain get push go version switch domain set push java version new switch domain get push java version switch domain set push python version new switch domain get push python version switch domain set push c version new switch domain get push c version switch domain set enable authentication new switch domain be enable authentication switch domain set overridden server status new switch domain get override server status switch domain set default instance ephemeral new switch domain be default instance ephemeral switch domain set light beat enable new switch domain be light beat enable public switch domain get switch domain return switch domain override public boolean interest string key return key builder match switch key key override public boolean match unlisten key string key return key builder match switch key key override public void on change string key switch domain domain throw exception update domain override public void on delete string key throw exception 
performance logger thread component public class performance logger thread autowire private service manager service manager autowire private push service push service autowire private raft core raft core private static final long period post construct public void init start private void start performance log task task new performance log task global executor schedule performance logger task period time unit seconds refresh metric schedule cron 0 0 public void refresh metric push service set fail push push service set total push metric monitor get http health check monitor set metric monitor get mysql health check monitor set metric monitor get tcp health check monitor set collect metric schedule cron 0/15 public void collect metric int service count service manager get service count metric monitor get dom count monitor set service count int ip count service manager get instance count metric monitor get ip count monitor set ip count long max push cost get max push cost metric monitor get max push cost monitor set max push cost long avg push cost get avg push cost metric monitor get avg push cost monitor set avg push cost metric monitor get total push monitor set push service get total push metric monitor get fail push monitor set push service get fail push count if raft core be leader metric monitor get leader status monitor set else if raft core get peer set local state raft peer state follower metric monitor get leader status monitor set else metric monitor get leader status monitor set class performance log task implement runnable override public void run try int service count service manager get service count int ip count service manager get instance count long max push cost get max push cost long avg push cost get avg push cost logger performance log info performance service count ip count max push cost avg push cost catch exception e logger srv log warn performance exception while print performance log e private long get max push cost long max for map entry string long entry push service push cost map entry set if entry get value max max entry get value return max private long get avg push cost int size long total cost long avg cost for map entry string long entry push service push cost map entry set size total cost entry get value push service push cost map clear if size total cost avg cost total cost size return avg cost 
push service component suppress warning pmd thread pool creation rule public class push service implement application context aware application listener service change event autowire private switch domain switch domain private application context application context private static final long ack timeout nanos time unit seconds to nanos 10 l private static final int max retry time private static volatile concurrent map string receiver ack entry ack map new concurrent hash map private static concurrent map string concurrent map string push client client map new concurrent hash map private static volatile concurrent map string long udp send time map new concurrent hash map public static volatile concurrent map string long push cost map new concurrent hash map private static int total push private static int fail push private static datagram socket udp socket private static concurrent map string future future map new concurrent hash map static try udp socket new datagram socket receiver receiver new receiver thread in thread new thread receiver in thread set daemon true in thread set name com alibaba naco name push receiver in thread start global executor schedule retransmitter try remove client if zombie catch throwable e logger push warn naco push fail to remove client zombie time unit seconds catch socket exception e logger srv log error naco push fail to init push service override public void set application context application context application context throw bean exception this application context application context override public void on application event service change event event service service event get service string service name service get name string namespace id service get namespace id future future global executor schedule udp sender try logger push info service name be change add it to push queue concurrent map string push client client client map get util and common assemble full service name namespace id service name if map util be empty client return map string object cache new hash map long last ref time system nano time for push client client client value if client zombie logger push debug client be zombie client to string client remove client to string logger push debug client be zombie client to string continue receiver ack entry ack entry logger push debug push service name to client service name client to string string key get push cache key service name client get ip client get agent byte compress datum null map string object datum null if switch domain get default push cache millis cache contain key key org javatuple pair pair org javatuple pair cache get key compress datum byte pair get value0 datum map string object pair get value1 logger push debug push cache cache hit service name client get addr str if compress datum null ack entry prepare ack entry client compress datum datum last ref time else ack entry prepare ack entry client prepare host datum client last ref time if ack entry null cache put key new org javatuple pair ack entry origin get datum ack entry datum logger push info service name change schedule push for agent key client get service name client get addr str client get agent ack entry null null ack entry key udp push ack entry catch exception e logger push error naco push fail to push service name to client error service name e finally future map remove util and common assemble full service name namespace id service name time unit millisecond future map put util and common assemble full service name namespace id service name future public int get total push return total push public void set total push int total push push service total push total push add push target client param namespace id namespace id param service name service name param cluster cluster param agent agent information param socket addr client address param datum source datasource of push datum param tenant tenant param app app public void add client string namespace id string service name string cluster string agent inet socket address socket addr datum source datum source string tenant string app push client client new push client namespace id service name cluster agent socket addr datum source tenant app add client client add push target client param client push target client public void add client push client client client be store by key service name because notify event be drive by service name change string service key util and common assemble full service name client get namespace id client get service name concurrent map string push client client client map get service key if client null client map put if absent service key new concurrent hash map client client map get service key push client old client client get client to string if old client null old client refresh else push client re client put if absent client to string client if res null logger push warn client already associate with key re get addr str re to string logger push debug client add for service name client get addr str client get service name get push target client subscriber param service name service name param namespace id namespace id return list of subsriber public list subscriber get client string service name string namespace id string service key util and common assemble full service name namespace id service name concurrent map string push client client concurrent map client map get service key if object be null client concurrent map return null list subscriber client new array list client concurrent map for each key client client add new subscriber client get addr str client get agent client get app client get ip namespace id service name return client fuzzy search subscriber param service name service name param namespace id namespace id return list of subscriber public list subscriber get client fuzzy string service name string namespace id list subscriber client new array list client map for each out key client concurrent map get group name from key string service full name out key split util and common namespace service connector get group name string group name name util get group name service full name get service name string name name util get service name service full name fuzzy match if out key start with namespace id name index of name util get service name service name group name index of name util get group name service name client concurrent map for each key client client add new subscriber client get addr str client get agent client get app client get ip namespace id service full name return client private static void remove client if zombie int size for map entry string concurrent map string push client entry client map entry set concurrent map string push client client concurrent map entry get value for map entry string push client entry1 client concurrent map entry set push client client entry1 get value if client zombie client concurrent map remove entry1 get key size client concurrent map size if logger push be debug enable logger push debug naco push client map size size private static receiver ack entry prepare ack entry push client client map string object datum long last ref time if map util be empty datum logger push error naco push push empty datum for client be not allow client return null datum put last ref time last ref time we apply last ref time as sequence num for further ack string key get ack key client get socket addr get address get host address client get socket addr get port last ref time string datum str jackson util to json datum try byte datum byte datum str get byte standard charset utf datum byte compress if necessary datum byte datagram packet packet new datagram packet datum byte datum byte length client socket addr we must store the key be fore send otherwise there will be a chance the ack return before we put in receiver ack entry ack entry new receiver ack entry key packet ack entry datum datum return ack entry catch exception e logger push error naco push fail to prepare datum to client error datum client get socket addr e return null private static receiver ack entry prepare ack entry push client client byte datum byte map string object datum long last ref time string key get ack key client get socket addr get address get host address client get socket addr get port last ref time datagram packet packet null try packet new datagram packet datum byte datum byte length client socket addr receiver ack entry ack entry new receiver ack entry key packet we must store the key be fore send otherwise there will be a chance the ack return before we put in ack entry datum datum return ack entry catch exception e logger push error naco push fail to prepare datum to client error datum client get socket addr e return null public static string get push cache key string service name string client i p string agent return service name util and common cache key spliter agent service change param service service public void service change service service merge some change event to reduce the push frequency if future map contain key util and common assemble full service name service get namespace id service get name return this application context publish event new service change event this service judge whether this agent be support to push param agent agent information return true if agent can be push otherwise false public boolean can enable push string agent if switch domain be push enable return false client info client info new client info agent if client info client type java client info type client info version compare to version util parse version switch domain get push java version return true else if client info client type dn client info type client info version compare to version util parse version switch domain get push python version return true else if client info client type c client info type client info version compare to version util parse version switch domain get push c version return true else if client info client type go client info type client info version compare to version util parse version switch domain get push go version return true return false public static list receiver ack entry get fail push return new array list receiver ack entry ack map value public int get fail push count return ack map size fail push public void set fail push int fail push push service fail push fail push public static void reset push state ack map clear public class push client private string namespace id private string service name private string cluster private string agent private string tenant private string app private inet socket address socket addr private datum source datum source private map string string param public map string string get param return param public void set param map string string param this param param public long last ref time system current time millis public push client string namespace id string service name string cluster string agent inet socket address socket addr datum source datum source string tenant string app this namespace id namespace id this service name service name this cluster cluster this agent agent this socket addr socket addr this data source datum source this tenant tenant this app app public datum source get datum source return datum source public boolean zombie return system current time millis last ref time switch domain get push cache millis service name override public string to string string builder sb new string builder sb append service name append service name append cluster append cluster append address append socket addr append agent append agent return sb to string public string get agent return agent public string get addr str return socket addr get address get host address socket addr get port public string get ip return socket addr get address get host address override public int hash code return object hash service name cluster socket addr override public boolean equal object obj if obj instanceof push client return false push client other push client obj return service name equal other service name cluster equal other cluster socket addr equal other socket addr public string get cluster return cluster public void set cluster string cluster this cluster cluster public string get namespace id return namespace id public void set namespace id string namespace id this namespace id namespace id public string get service name return service name public void set service name string service name this service name service name public string get tenant return tenant public void set tenant string tenant this tenant tenant public string get app return app public void set app string app this app app public inet socket address get socket addr return socket addr public void refresh last ref time system current time milli private static byte compress if necessary byte datum byte throw i o exception enable compression when datum be larger than 1 k b int max datum size uncompress if datum byte length max datum size uncompress return datum byte byte array output stream out new byte array output stream g z i p output stream gzip new g z i p output stream out gzip write datum byte gzip close return out to byte array private static map string object prepare host datum push client client throw exception map string object cmd new hash map string object cmd put type dom cmd put datum client get datum source get datum client return cmd private static receiver ack entry udp push receiver ack entry ack entry if ack entry null logger push error naco push ack entry be null return null if ack entry get retry time max retry time logger push warn max re push time reach retry time key ack entry retry time ack entry key ack map remove ack entry key udp send time map remove ack entry key fail push return ack entry try if ack map contain key ack entry key total push ack map put ack entry key ack entry udp send time map put ack entry key system current time millis logger push info send udp packet ack entry key udp socket send ack entry origin ack entry increase retry time global executor schedule retransmitter new retransmitter ack entry time unit nanosecond to milli ack timeout nanos time unit millisecond return ack entry catch exception e logger push error naco push fail to push datum to client error ack entry datum ack entry origin get address get host address e ack map remove ack entry key udp send time map remove ack entry key fail push return null private static string get ack key string host int port long last ref time return string util strip host port last ref time public static class retransmitter implement runnable receiver ack entry ack entry public retransmitter receiver ack entry ack entry this ack entry ack entry override public void run if ack map contain key ack entry key logger push info retry to push datum key ack entry key udp push ack entry public static class receiver implement runnable override public void run while true byte buffer new byte datagram packet packet new datagram packet buffer buffer length try udp socket receive packet string json new string packet get datum packet get length standard charset utf trim ack packet ack packet jackson util to obj json ack packet class inet socket address socket address inet socket address packet get socket address string ip socket address get address get host address int port socket address get port if system nano time ack packet last ref time ack timeout nano logger push warn ack take too long from ack json packet get socket address json string ack key get ack key ip port ack packet last ref time ack entry ack entry ack map remove ack key if ack entry null throw new illegal state exception unable to find ack entry for key ack key ack json json long push cost system current time millis udp send time map get ack key logger push info receive ack from cost m unacked total push json ip port push cost ack map size total push push cost map put ack key push cost udp send time map remove ack key catch throwable e logger push error naco push error while receive ack data e public static class ack entry public ack entry string key datagram packet packet this key key this origin packet public void increase retry time retry time increment and get public int get retry time return retry time get public string key public datagram packet origin private atomic integer retry time new atomic integer public map string object datum public static class ack packet public string type public long last ref time public string datum 
test resource path test component public class test resource executor service executor executor new fix thread pool path hello get produce media type application json public string say hello return hello path async hello get produce media type application json public void async say hello suspend final async response async response executor submit new runnable override public void run try time unit millisecond sleep catch interrupted exception e e print stack trace async response resume hello path hello name get produce media type application json public string say hello with name path param value name string name return hello name path ex get produce media type application json public string exception throw new runtime exception test exception mapper path get produce media type application json public string bad request throw new web application exception response status response status bad request entity test return build path delay seconds get produce media type application json public string delay path param value seconds long seconds throw interrupted exception time unit seconds sleep seconds return finish 
authorization interceptor component public class authorization interceptor implement handler interceptor autowire private auth service http servlet request auth service override public boolean pre handle http servlet request request http servlet response response object handler throw exception if handler get class be assignable from handler method class method method handler method handler get method auth action auth action method get annotation auth action class if auth action null auth service auth user auth user auth service get auth user request if auth user null response no privilege msg response auth action message return false string target request get parameter auth action target name if auth user auth target target auth action value response no privilege msg response auth action message return false return true private void response no privilege msg http servlet response response string message throw i o exception result result result of fail message response add header content type application json charset utf response get output stream write json to j s o n byte result 
fake auth service impl component public class fake auth service impl implement auth service http servlet request override public auth user get auth user http servlet request request return new auth user impl static final class auth user impl implement auth user override public boolean auth target string target privilege type privilege type fake implementation always return true return true override public boolean be super user fake implementation always return true return true override public string get nick name return fake nick name override public string get login name return fake login name override public string get id return fake emp id 
login authentication filter component public class login authentication filter implement filter private static final string url suffix dot some url which needn t auth such as auth login registry machine and so on value auth filter exclude url split private list string auth filter exclude url some url with suffix which needn t auth such as htm html j and so on value auth filter exclude url suffix split private list string auth filter exclude url suffix authentication use auth service interface autowire private auth service http servlet request auth service override public void init filter config filter config throw servlet exception override public void do filter servlet request request servlet response response filter chain chain throw i o exception servlet exception http servlet request http request http servlet request request string servlet path http request get servlet path exclude the url which needn t auth if auth filter exclude url contain servlet path chain do filter request response return exclude the url with suffix which needn t auth for string auth filter exclude url suffix auth filter exclude url suffix if string util be blank auth filter exclude url suffix continue add for url suffix so that we needn t add in property file if auth filter exclude url suffix start with url suffix dot auth filter exclude url suffix url suffix dot auth filter exclude url suffix if servlet path end with auth filter exclude url suffix chain do filter request response return auth service auth user auth user auth service get auth user http request http servlet response http response http servlet response response if auth user null if auth fail set response status code to http response set status http status unauthorized value else chain do filter request response override public void destroy 
simple web auth service impl component primary conditional on property name auth enable match if missing true public class simple web auth service impl implement auth service http servlet request public static final string web session key session sentinel admin override public auth user get auth user http servlet request request http session session request get session object sentinel user obj session get attribute simple web auth service impl web session key if sentinel user obj null sentinel user obj instanceof auth user return auth user sentinel user obj return null public static final class simple web auth user impl implement auth user private string username public simple web auth user impl string username this username username override public boolean auth target string target privilege type privilege type return true override public boolean be super user return true override public string get nick name return username override public string get login name return username override public string get id return username 
sentinel api client component public class sentinel api client private static logger logger logger factory get logger sentinel api client class private static final charset default charset charset for name sentinel config charset private static final string http header content type content type private static final string http header content type urlencoded content type create u r l encode util content type to string private static final string resource url path json tree private static final string cluster node path cluster node private static final string get rule path get rule private static final string set rule path set rule private static final string get param rule path get param flow rule private static final string set param rule path set param flow rule private static final string fetch cluster mode path get cluster mode private static final string modify cluster mode path set cluster mode private static final string fetch cluster client config path cluster client fetch config private static final string modify cluster client config path cluster client modify config private static final string fetch cluster server basic info path cluster server info private static final string modify cluster server transport config path cluster server modify transport config private static final string modify cluster server flow config path cluster server modify flow config private static final string modify cluster server namespace set path cluster server modify namespace set private static final string fetch gateway api path gateway get api definition private static final string modify gateway api path gateway update api definition private static final string fetch gateway flow rule path gateway get rule private static final string modify gateway flow rule path gateway update rule private static final string flow rule type flow private static final string degrade rule type degrade private static final string system rule type system private static final string authority type authority private closeable http async client http client private static final sentinel version version160 new sentinel version private static final sentinel version version171 new sentinel version autowire private app management app management public sentinel api client i o reactor config io config i o reactor config custom set connect timeout set so timeout set io thread count runtime get runtime available processor build http client http async client custom set redirect strategy new default redirect strategy override protect boolean be redirectable final string method return false set max conn total set max conn per route set default i o reactor config io config build http client start private boolean be success int status code return status code status code private boolean be command not find int status code string body return status code string util be not empty body body contain command constant msg unknown command prefix protect boolean be support post string app string ip int port return string util be not empty app optional of nullable app management get detail app app flat map e e get machine ip port flat map m version util parse version m get version map v v greater or equal version160 or else false check wheter target instance identify by tuple of app ip port support the form of xxxxx xx xx in content type header param app target app name param ip target node s address param port target node s port protect boolean be support enhance content type string app string ip int port return string util be not empty app optional of nullable app management get detail app app flat map e e get machine ip port flat map m version util parse version m get version map v v greater or equal version171 or else false private string builder query string map string string param string builder query string builder new string builder for entry string string entry param entry set if string util be empty entry get value continue string name url encode entry get key string value url encode entry get value if name null value null if query string builder length query string builder append query string builder append name append append value return query string builder build a http uri request in post way param url param param param support enhance content type see link be support enhance content type string string int return protect static http uri request post request string url map string string param boolean support enhance content type http post http post new http post url if param null param size list name value pair list new array list param size for entry string string entry param entry set list add new basic name value pair entry get key entry get value http post set entity new url encode form entity list const utf if support enhance content type http post set header http header content type http header content type urlencoded return http post private string url encode string str try return u be l encoder encode str default charset name catch unsupported encode exception e logger info encode string error str e return null private string get body http response response throw exception charset charset null try string content type str response get first header http header content type get value if string util be not empty content type str content type content type content type parse content type str charset content type get charset catch exception ignore return entity util to string response get entity charset null charset default charset with no param param ip param port param api return private completable future string execute command string ip int port string api boolean use http post return execute command ip port api null use http post no app specify force to get param ip param port param api param param return private completable future string execute command string ip int port string api map string string param boolean use http post return execute command null ip port api param use http post prefer to execute request use post param app param ip param port param api param param return private completable future string execute command string app string ip int port string api map string string param boolean use http post completable future string future new completable future if string util be blank ip string util be blank api future complete exceptionally new illegal argument exception bad url or command name return future string builder url builder new string builder url builder append http url builder append ip append append port append append api if param null param collection empty map if use http post be support post app ip port use get in older version append parameter after url if param be empty if url builder index of url builder append else url builder append url builder append query string param return execute command new http get url builder to string else use post return execute command post request url builder to string param be support enhance content type app ip port private completable future string execute command http uri request request completable future string future new completable future http client execute request new future callback http response override public void complete final http response response int status code response get status line get status code try string value get body response if be success status code future complete value else if be command not find status code value future complete exceptionally new command not find exception request get u r i get path else future complete exceptionally new command fail exception value catch exception ex future complete exceptionally ex logger error http request fail request get u be i to string ex override public void fail final exception ex future complete exceptionally ex logger error http request fail request get u be i to string ex override public void cancel future complete null return future public void close throw exception http client close nullable private t completable future list t fetch item async string ip int port string api string type class t rule type assert util not empty ip bad machine ip assert util be true port bad machine port map string string params null if string util be not empty type param new hash map param put type type return execute command ip port api param false then apply json json parse array json rule type nullable private t list t fetch item string ip int port string api string type class t rule type try assert util not empty ip bad machine ip assert util be true port bad machine port map string string params null if string util be not empty type param new hash map param put type type return fetch item async ip port api type rule type get catch interrupted exception execution exception e logger error error when fetch item from api api type e return null catch exception e logger error error when fetch item api type e return null private t extend rule list t fetch rule string ip int port string type class t rule type return fetch item ip port get rule path type rule type private boolean set rule string app string ip int port string type list extend rule entity entity if entity null return true try assert util not empty app bad app name assert util not empty ip bad machine ip assert util be true port bad machine port string datum json to j s o n string entity stream map r r to rule collect collector to list map string string param new hash map param put type type param put datum datum string result execute command app ip port set rule path param true get logger info set rule result type result type return true catch interrupt exception e logger warn set rule api fail type e return false catch execution exception e logger warn set rule api fail type e get cause return false catch exception e logger error set rule api fail type type e return false private completable future void set rule async string app string ip int port string type list extend rule entity entity try assert util not null entity rule can not be null assert util not empty app bad app name assert util not empty ip bad machine ip assert util be true port bad machine port string datum json to j s o n string entity stream map r r to rule collect collector to list map string string param new hash map param put type type param put datum datum return execute command app ip port set rule path param true then compose r if success equal ignore case be trim return completable future complete future null return async util new fail future new command fail exception r catch exception e logger error set rule async api fail type type e return async util new fail future e public list node vo fetch resource of machine string ip int port string type return fetch item ip port resource url path type node vo class fetch cluster node param ip ip to fetch param port port of the ip param include zero whether zero value should in the result list return public list node vo fetch cluster node of machine string ip int port boolean include zero string type not zero if include zero type zero return fetch item ip port cluster node path type node vo class public list flow rule entity fetch flow rule of machine string app string ip int port list flow rule rule fetch rule ip port flow rule type flow rule class if rule null return rule stream map rule flow rule entity from flow rule app ip port rule collect collector to list else return null public list degrade rule entity fetch degrade rule of machine string app string ip int port list degrade rule rule fetch rule ip port degrade rule type degrade rule class if rule null return rule stream map rule degrade rule entity from degrade rule app ip port rule collect collector to list else return null public list system rule entity fetch system rule of machine string app string ip int port list system rule rule fetch rule ip port system rule type system rule class if rule null return rule stream map rule system rule entity from system rule app ip port rule collect collector to list else return null fetch all parameter flow rule from provide machine param app application name param ip machine client ip param port machine client port return all retrieve parameter flow rule since 0.2 public completable future list param flow rule entity fetch param flow rule of machine string app string ip int port try assert util not empty app bad app name assert util not empty ip bad machine ip assert util be true port bad machine port return fetch item async ip port get param rule path null param flow rule class then apply rule rule stream map e param flow rule entity from authority rule app ip port e collect collector to list catch exception e logger error error when fetch parameter flow rule e return async util new fail future e fetch all authority rule from provide machine param app application name param ip machine client ip param port machine client port return all retrieve authority rule since 0.2 public list authority rule entity fetch authority rule of machine string app string ip int port assert util not empty app bad app name assert util not empty ip bad machine ip assert util be true port bad machine port map string string param new hash map param put type authority type list authority rule rule fetch rule ip port authority type authority rule class return optional of nullable rule map r r stream map e authority rule entity from authority rule app ip port e collect collector to list or else null set rule of the machine rule null will return immediately rule be empty means set the rule to empty param app param ip param port param rule return whether successfully set the rule public boolean set flow rule of machine string app string ip int port list flow rule entity rule return set rule app ip port flow rule type rule public completable future void set flow rule of machine async string app string ip int port list flow rule entity rule return set rule async app ip port flow rule type rule set rule of the machine rule null will return immediately rule be empty means set the rule to empty param app param ip param port param rule return whether successfully set the rule public boolean set degrade rule of machine string app string ip int port list degrade rule entity rule return set rule app ip port degrade rule type rule set rule of the machine rule null will return immediately rule be empty means set the rule to empty param app param ip param port param rule return whether successfully set the rule public boolean set system rule of machine string app string ip int port list system rule entity rule return set rule app ip port system rule type rule public boolean set authority rule of machine string app string ip int port list authority rule entity rule return set rule app ip port authority type rule public completable future void set param flow rule of machine string app string ip int port list param flow rule entity rule if rule null return completable future complete future null if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try string datum json to j s o n string rule stream map param flow rule entity get rule collect collector to list map string string param new hash map param put datum datum return execute command app ip port set param rule path param true then compose e if command constant msg success equal e return completable future complete future null else logger warn push parameter flow rule to client fail e return async util new fail future new runtime exception e catch exception ex logger warn error when set parameter flow rule ex return async util new fail future ex cluster relate public completable future cluster state simple entity fetch cluster mode string ip int port if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try return execute command ip port fetch cluster mode path false then apply r json parse object r cluster state simple entity class catch exception ex logger warn error when fetch cluster mode ex return async util new fail future ex public completable future void modify cluster mode string ip int port int mode if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try map string string param new hash map param put mode string value of mode return execute command ip port modify cluster mode path param false then compose e if command constant msg success equal e return completable future complete future null else logger warn error when modify cluster mode e return async util new fail future new runtime exception e catch exception ex logger warn error when modify cluster mode ex return async util new fail future ex public completable future cluster client info v o fetch cluster client info and config string ip int port if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try return execute command ip port fetch cluster client config path false then apply r json parse object r cluster client info v o class catch exception ex logger warn error when fetch cluster client config ex return async util new fail future ex public completable future void modify cluster client config string app string ip int port cluster client config config if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try map string string param new hash map param put datum json to j s o n string config return execute command app ip port modify cluster client config path param true then compose e if command constant msg success equal e return completable future complete future null else logger warn error when modify cluster client config e return async util new fail future new runtime exception e catch exception ex logger warn error when modify cluster client config ex return async util new fail future ex public completable future void modify cluster server flow config string app string ip int port server flow config config if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try map string string param new hash map param put datum json to j s o n string config return execute command app ip port modify cluster server flow config path param true then compose e if command constant msg success equal e return completable future complete future null else logger warn error when modify cluster server flow config e return async util new fail future new runtime exception e catch exception ex logger warn error when modify cluster server flow config ex return async util new fail future ex public completable future void modify cluster server transport config string app string ip int port server transport config config if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try map string string param new hash map param put port config get port to string param put idle seconds config get idle seconds to string return execute command app ip port modify cluster server transport config path param false then compose e if command constant msg success equal e return completable future complete future null else logger warn error when modify cluster server transport config e return async util new fail future new runtime exception e catch exception ex logger warn error when modify cluster server transport config ex return async util new fail future ex public completable future void modify cluster server namespace set string app string ip int port set string set if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try map string string param new hash map param put datum json to j s o n string set return execute command app ip port modify cluster server namespace set path param true then compose e if command constant msg success equal e return completable future complete future null else logger warn error when modify cluster server namespace set e return async util new fail future new runtime exception e catch exception ex logger warn error when modify cluster server namespace set ex return async util new fail future ex public completable future cluster server state v o fetch cluster server basic info string ip int port if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try return execute command ip port fetch cluster server basic info path false then apply r json parse object r cluster server state v o class catch exception ex logger warn error when fetch cluster sever all config and basic info ex return async util new fail future ex public completable future list api definition entity fetch apis string app string ip int port if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try return execute command ip port fetch gateway api path false then apply r list api definition entity entity json parse array r api definition entity class if entity null for api definition entity entity entity entity set app app entity set ip ip entity set port port return entity catch exception ex logger warn error when fetch gateway apis ex return async util new fail future ex public boolean modify apis string app string ip int port list api definition entity apis if apis null return true try assert util not empty app bad app name assert util not empty ip bad machine ip assert util be true port bad machine port string datum json to j s o n string apis stream map r r to api definition collect collector to list map string string param new hash map param put datum datum string result execute command app ip port modify gateway api path param true get logger info modify gateway apis result return true catch exception e logger warn error when modify gateway apis e return false public completable future list gateway flow rule entity fetch gateway flow rule string app string ip int port if string util be blank ip port return async util new fail future new illegal argument exception invalid parameter try return execute command ip port fetch gateway flow rule path false then apply r list gateway flow rule gateway flow rule json parse array r gateway flow rule class list gateway flow rule entity entity gateway flow rule stream map rule gateway flow rule entity from gateway flow rule app ip port rule collect collector to list return entity catch exception ex logger warn error when fetch gateway flow rule ex return async util new fail future ex public boolean modify gateway flow rule string app string ip int port list gateway flow rule entity rule if rule null return true try assert util not empty app bad app name assert util not empty ip bad machine ip assert util be true port bad machine port string datum json to j s o n string rule stream map be r to gateway flow rule collect collector to list map string string param new hash map param put datum datum string result execute command app ip port modify gateway flow rule path param true get logger info modify gateway flow rule result return true catch exception e logger warn error when modify gateway apis e return false 
app management component public class app management implement machine discovery autowire private application context context private machine discovery machine discovery post construct public void init machine discovery context get bean simple machine discovery class override public set app info get brief app return machine discovery get brief app override public long add machine machine info machine info return machine discovery add machine machine info override public boolean remove machine string app string ip int port return machine discovery remove machine app ip port override public list string get app name return machine discovery get app name override public app info get detail app string app return machine discovery get detail app app override public void remove app string app machine discovery remove app app 
simple machine discovery component public class simple machine discovery implement machine discovery private final concurrent map string app info app new concurrent hash map override public long add machine machine info machine info assert util not null machine info machine info can not be null app info app info app compute if absent machine info get app o new app info machine info get app machine info get app type app info add machine machine info return override public boolean remove machine string app string ip int port assert util assert not blank app app name can not be blank app info app info app get app if app info null return app info remove machine ip port return false override public list string get app name return new array list app key set override public app info get detail app string app assert util assert not blank app app name can not be blank return app get app override public set app info get brief app return new hash set app value override public void remove app string app assert util assert not blank app app name can not be blank app remove app 
metric fetcher component public class metric fetcher public static final string no metric no metric private static final int http ok private static final long max last fetch interval m private static final long fetch interval second private static final charset default charset charset for name sentinel config charset private final static string metric url path metric private static logger logger logger factory get logger metric fetcher class private final long interval second private map string atomic long app last fetch time new concurrent hash map autowire private metric repository metric entity metric store autowire private app management app management private closeable http async client httpclient suppress warning pmd thread pool creation rule private schedule executor service fetch schedule service executor new schedule thread pool new name thread factory sentinel dashboard metric fetch task private executor service fetch service private executor service fetch worker public metric fetcher int core runtime get runtime available processor long keep alive time int queue size reject execution handler handler new discard policy fetch service new thread pool executor core core keep alive time time unit millisecond new array block queue queue size new name thread factory sentinel dashboard metric fetch service handler fetch worker new thread pool executor core core keep alive time time unit millisecond new array block queue queue size new name thread factory sentinel dashboard metric fetch worker handler i o reactor config io config i o reactor config custom set connect timeout set so timeout set io thread count runtime get runtime available processor build httpclient http async client custom set redirect strategy new default redirect strategy override protect boolean be redirectable final string method return false set max conn total set max conn per route set default i o reactor config io config build httpclient start start private void start fetch schedule service schedule at fix rate try fetch all app catch exception e logger info fetch all app error e interval second time unit seconds private void write metric map string metric entity map if map be empty return date date new date for metric entity entity map value entity set gmt create date entity set gmt modify date metric store save all map value traverse each app and then pull the metric of all machine for that app private void fetch all app list string app app management get app name if app null return for final string app app fetch service submit try do fetch app metric app catch exception e logger error fetch app metric error e fetch metric between start time end time both side inclusive private void fetch once string app long start time long end time int max wait seconds if max wait seconds throw new illegal argument exception max wait seconds must but max wait seconds app info app info app management get detail app app auto remove for app if app info be dead logger info dead app remove app app management remove app app return set machine info machine app info get machine logger debug enter fetch once app machine size machine size time interval ms start time end time if machine be empty return final string msg fetch atomic long unhealthy new atomic long final atomic long success new atomic long final atomic long fail new atomic long long start system current time millis app resource time second metric final map string metric entity metric map new concurrent hash map final count down latch latch new count down latch machine size for final machine info machine machine auto remove if machine be dead latch count down app management get detail app app remove machine machine get ip machine get port logger info dead machine remove of machine get ip machine get port app continue if machine be healthy latch count down unhealthy increment and get continue final string url http machine get ip machine get port metric url path start time start time end time end time refetch false final http get http get new http get url http get set header http conn directive http conn close httpclient execute http get new future callback http response override public void complete final http response response try handle response response machine metric map success increment and get catch exception e logger error msg metric url error e finally latch count down override public void fail final exception ex latch count down fail increment and get http get abort if ex instanceof socket timeout exception logger error fail to fetch metric from socket timeout url else if ex instanceof connect exception logger error fail to fetch metric from connection exception url ex get message else logger error msg metric url error ex override public void cancel latch count down fail increment and get http get abort try latch await max wait seconds time unit seconds catch exception e logger info msg metric wait http client error e long cost system current time millis start logger info finish msg metric for app time interval ms start time end time total machine machine size dead dead fetch success success fetch fail fail time cost cost m write metric metric map private void do fetch app metric final string app long now system current time millis long last fetch ms now max last fetch interval ms if app last fetch time contain key app last fetch ms math max last fetch ms app last fetch time get app get trim millisecond last fetch ms last fetch ms long end time last fetch m fetch interval second if end time now to near return update last fetch in advance app last fetch time compute if absent app a new atomic long set end time final long final last fetch ms last fetch ms final long final end time end time try do real fetch async fetch worker submit try fetch once app final last fetch ms final end time catch exception e logger info fetch once app error e catch exception e logger info submit fetch once app fail interval m last fetch ms end time e private void handle response final http response response machine info machine map string metric entity metric map throw exception int code response get status line get status code if code http ok return charset charset null try string content type str response get first header content type get value if string util be not empty content type str content type content type content type parse content type str charset content type get charset catch exception ignore string body entity util to string response get entity charset null charset default charset if string util be empty body body start with no metric logger info machine get app machine get ip machine get port body str be empty return string line body split n logger info machine get app machine get ip machine get port body str length body length line line length handle body line machine metric map private void handle body string line machine info machine map string metric entity map logger info handle body line line length machine machine if line length return for string line line try metric node node metric node from thin string line if should filter out node get resource continue aggregation metric by app resource time second ignore ip and port string key build metric key machine get app node get resource node get timestamp metric entity entity map get key if entity null entity add pass qp node get pass qp entity add block qps node get block qp entity add rt and success qp node get rt node get success qp entity add exception qps node get exception qp entity add count else entity new metric entity entity set app machine get app entity set timestamp new date node get timestamp entity set pass qp node get pass qp entity set block qp node get block qp entity set rt and success qp node get rt node get success qp entity set exception qp node get exception qps entity set count entity set resource node get resource map put key entity catch exception e logger warn handle body line exception machine line machine to log string line private string build metric key string app string resource long timestamp return app resource timestamp private boolean should filter out string resource return re exclusion set contain resource private static final set string re exclusion set new hash set string add constant total in resource name add constant system load resource name add constant cpu usage resource name 
in mem api definition store component public class in mem api definition store extend in memory rule repository adapter api definition entity private static atomic long id new atomic long override protect long next id return id increment and get 
in mem gateway flow rule store component public class in mem gateway flow rule store extend in memory rule repository adapter gateway flow rule entity private static atomic long id new atomic long override protect long next id return id increment and get 
in memory metric repository component public class in memory metric repository implement metric repository metric entity private static final long max metric live time ms code app resource timestamp metric private map string map string link hash map long metric entity all metric new concurrent hash map private final reentrant read write lock read write lock new reentrant read write lock override public void save metric entity entity if entity null string util be blank entity get app return read write lock write lock lock try all metric compute if absent entity get app e new hash map compute if absent entity get resource e new link hash map long metric entity override protect boolean remove eldest entry entry long metric entity eldest metric older than link max metric live time ms will be remove return eldest get key time util current time millis max metric live time ms put entity get timestamp get time entity finally read write lock write lock unlock override public void save all iterable metric entity metric if metric null return read write lock write lock lock try metric for each this save finally read write lock write lock unlock override public list metric entity query by app and resource between string app string resource long start time long end time list metric entity result new array list if string util be blank app return result map string link hash map long metric entity resource map all metric get app if resource map null return result link hash map long metric entity metric map resource map get resource if metric map null return result read write lock read lock lock try for entry long metric entity entry metric map entry set if entry get key start time entry get key end time result add entry get value return result finally read write lock read lock unlock override public list string list resource of app string app list string result new array list if string util be blank app return result resource timestamp metric map string link hash map long metric entity resource map all metric get app if resource map null return result final long min time ms system current time millis map string metric entity resource count new concurrent hash map read write lock read lock lock try for entry string link hash map long metric entity resource metric resource map entry set for entry long metric entity metric resource metric get value entry set if metric get key min time ms continue metric entity new entity metric get value if resource count contain key resource metric get key metric entity old entity resource count get resource metric get key old entity add pass qp new entity get pass qp old entity add rt and success qp new entity get rt new entity get success qp old entity add block qps new entity get block qp old entity add exception qps new entity get exception qps old entity add count else resource count put resource metric get key metric entity copy of new entity order by last minute b qp desc return resource count entry set stream sort o1 o2 metric entity e1 o1 get value metric entity e2 o2 get value int t e2 get block qp compare to e1 get block qp if t return t return e2 get pass qp compare to e1 get pass qp map entry get key collect collector to list finally read write lock read lock unlock 
in mem authority rule store component public class in mem authority rule store extend in memory rule repository adapter authority rule entity private static atomic long id new atomic long override protect long next id return id increment and get 
in mem degrade rule store component public class in mem degrade rule store extend in memory rule repository adapter degrade rule entity private static atomic long id new atomic long override protect long next id return id increment and get 
in mem flow rule store component public class in mem flow rule store extend in memory rule repository adapter flow rule entity private static atomic long id new atomic long override protect long next id return id increment and get override protect flow rule entity pre process flow rule entity entity if entity null entity be cluster mode cluster flow config config entity get cluster config if config null config new cluster flow config entity set cluster config config set cluster rule id config set flow id entity get id return entity 
in mem param flow rule store component public class in mem param flow rule store extend in memory rule repository adapter param flow rule entity private static atomic long id new atomic long override protect long next id return id increment and get override protect param flow rule entity pre process param flow rule entity entity if entity null entity be cluster mode param flow cluster config config entity get cluster config if config null config new param flow cluster config set cluster rule id config set flow id entity get id return entity 
in mem system rule store component public class in mem system rule store extend in memory rule repository adapter system rule entity private static atomic long id new atomic long override protect long next id return id increment and get 
flow rule api provider component flow rule default provider public class flow rule api provider implement dynamic rule provider list flow rule entity autowire private sentinel api client sentinel api client autowire private app management app management override public list flow rule entity get rule string app name throw exception if string util be blank app name return new array list list machine info list app management get detail app app name get machine stream filter machine info be healthy sort e1 e2 long compare e2 get last heartbeat e1 get last heartbeat collect collector to list if list be empty return new array list else machine info machine list get return sentinel api client fetch flow rule of machine machine get app machine get ip machine get port 
flow rule api publisher component flow rule default publisher public class flow rule api publisher implement dynamic rule publisher list flow rule entity autowire private sentinel api client sentinel api client autowire private app management app management override public void publish string app list flow rule entity rule throw exception if string util be blank app return if rule null return set machine info set app management get detail app app get machine for machine info machine set if machine be healthy continue todo parse the result sentinel api client set flow rule of machine app machine get ip machine get port rule 
flow rule apollo provider component flow rule apollo provider public class flow rule apollo provider implement dynamic rule provider list flow rule entity autowire private apollo open api client apollo open api client autowire private converter string list flow rule entity converter override public list flow rule entity get rule string app name throw exception string app id app id string flow datum id apollo config util get flow datum id app name open namespace d t o open namespace d t o apollo open api client get namespace app id dev default application string rule open namespace d t o get item stream filter p p get key equal flow datum id map open item d t o get value find first or else if string util be empty rule return new array list return converter convert rule 
flow rule apollo publisher component flow rule apollo publisher public class flow rule apollo publisher implement dynamic rule publisher list flow rule entity autowire private apollo open api client apollo open api client autowire private converter list flow rule entity string converter override public void publish string app list flow rule entity rule throw exception assert util not empty app app name can not be empty if rule null return increase the configuration string app id app id string flow datum id apollo config util get flow datum id app open item d t o open item d t o new open item d t o open item d t o set key flow data id open item d t o set value converter convert rule open item d t o set comment program auto join open item d t o set datum change create by some operator apollo open api client create or update item app id dev default application open item d t o release configuration namespace release d t o namespace release d t o new namespace release d t o namespace release d t o set emergency publish true namespace release d t o set release comment modify or add configuration namespace release d t o set release by some operator namespace release d t o set release title modify or add configuration apollo open api client publish namespace app id dev default application namespace release d t o 
flow rule naco provider component flow rule naco provider public class flow rule naco provider implement dynamic rule provider list flow rule entity autowire private config service config service autowire private converter string list flow rule entity converter override public list flow rule entity get rule string app name throw exception string rule config service get config app name naco config util flow datum id postfix naco config util group id if string util be empty rule return new array list return converter convert rule 
flow rule naco publisher component flow rule naco publisher public class flow rule naco publisher implement dynamic rule publisher list flow rule entity autowire private config service config service autowire private converter list flow rule entity string converter override public void publish string app list flow rule entity rule throw exception assert util not empty app app name can not be empty if rule null return config service publish config app naco config util flow datum id postfix naco config util group id converter convert rule 
flow rule zookeeper provider component flow rule zookeeper provider public class flow rule zookeeper provider implement dynamic rule provider list flow rule entity autowire private curator framework zk client autowire private converter string list flow rule entity converter override public list flow rule entity get rule string app name throw exception string zk path zookeeper config util get path app name stat stat zk client check exist for path zk path if stat null return new array list byte byte zk client get datum for path zk path if null byte byte length return new array list string s new string byte return converter convert s 
flow rule zookeeper publisher component flow rule zookeeper publisher public class flow rule zookeeper publisher implement dynamic rule publisher list flow rule entity autowire private curator framework zk client autowire private converter list flow rule entity string converter override public void publish string app list flow rule entity rule throw exception assert util not empty app app name can not be empty string path zookeeper config util get path app stat stat zk client check exist for path path if stat null zk client create create parent container if need with mode create mode persistent for path path null byte datum collection util be empty rule get byte converter convert rule get byte zk client set datum for path path datum 
custom exception mapper component provider priority javax w rs priority user public class custom exception mapper implement exception mapper throwable override public response to response throwable exception return response status response status internal server error entity unknown server error build 
hello resource path hello produce media type application json component public class hello resource get public hello entity say hello return new hello entity hello get path id public hello entity get path param value id long id return new hello entity id hello get path list public list hello entity get all return int stream range close map to obj i new hello entity long i hello collect collector to list path ex get produce media type application json public string exception throw new runtime exception test exception mapper 
