wikipedia edit source test test retry on failure time public void test wikipedia edit source throw exception if can connect time unit seconds final time test timeout time seconds final wikipedia edit source wikipedia edit source new wikipedia edit source executor service executor service null try executor service executor new single thread executor block queue object collect event new array block queue atomic reference exception async error new atomic reference execute the source in a different thread and collect event into the queue we do this in a separate thread in order to not block the main test thread indefinitely in case that something bad happen like not receive any event executor service execute try wikipedia edit source run new collect source context collect event catch exception e boolean interrupted e instanceof interrupt exception if interrupted log warn failure in wikipedia edit source e async error compare and set null e long deadline deadline nano test timeout object event null exception error null check event or error while event null error null system nano time deadline event collect event poll time unit seconds error async error get if error null we don t use assert null because we want to include the error message fail failure in wikipedia edit source error get message assert not null do not receive a wikipedia edit event within the desire timeout event assert true receive unexpected event event event instanceof wikipedia edit event finally wikipedia edit source cancel if executor service null executor service shutdown now executor service await termination time unit seconds else log info skip test because not able to connect to irc server 
random sampler test test retry on failure time public void test bernoullus sampler fraction verify sampler fraction 0.01 false verify sampler fraction 0.05 false verify sampler fraction 0.1 false verify sampler fraction 0.3 false verify sampler fraction 0.5 false verify sampler fraction 0.854 false verify sampler fraction 0.99 false 
random sampler test test retry on failure time public void test bernoullus sampler duplicate element verify random sampler duplicate element new bernoullus sampler double 0.01 verify random sampler duplicate element new bernoullus sampler double 0.1 verify random sampler duplicate element new bernoullus sampler double 0.5 
random sampler test test retry on failure time public void test poisson sampler fraction verify sampler fraction 0.01 true verify sampler fraction 0.05 true verify sampler fraction 0.1 true verify sampler fraction 0.5 true verify sampler fraction 0.854 true verify sampler fraction 0.99 true verify sampler fraction 1.5 true 
random sampler test test retry on failure time public void test bernoullus sampler distribution verify bernoulli sampler 0.01 d verify bernoullus sampler 0.05 d verify bernoullus sampler 0.1 d verify bernoullus sampler 0.5 d 
random sampler test test retry on failure time public void test poisson sampler distribution verify poisson sampler 0.01 d verify poisson sampler 0.05 d verify poisson sampler 0.1 d verify poisson sampler 0.5 d 
random sampler test test retry on failure time public void test reservoir sampler sample size verify sampler fix sample size true verify sampler fix sample size true verify sampler fix sample size true verify sampler fix sample size true verify sampler fix sample size true verify sampler fix sample size true verify sampler fix sample size false verify sampler fix sample size false verify sampler fix sample size false verify sampler fix sample size false verify sampler fix sample size false 
random sampler test test retry on failure time public void test reservoir sampler sample size2 random sampler double sampler new reservoir sampler without replacement double iterator double sample sampler sample source iterator assert true reservoir sampler without replacement sample output size should not beyond the source size get size sample source size 
random sampler test test retry on failure time public void test reservoir sampler duplicate element verify random sampler duplicate element new reservoir sampler without replacement double verify random sampler duplicate element new reservoir sampler without replacement double verify random sampler duplicate element new reservoir sampler without replacement double 
random sampler test test retry on failure time public void test reservoir sampler without replacement verify reservoir sampler without replacement false verify reservoir sampler without replacement false verify reservoir sampler without replacement false verify reservoir sampler without replacement false 
random sampler test test retry on failure time public void test reservoir sampler with replacement verify reservoir sampler with replacement false verify reservoir sampler with replacement false verify reservoir sampler with replacement false verify reservoir sampler with replacement false 
random sampler test test retry on failure time public void test reservoir sampler with multi source partitions1 init source partition verify reservoir sampler without replacement true verify reservoir sampler without replacement true verify reservoir sampler without replacement true verify reservoir sampler without replacement true 
random sampler test test retry on failure time public void test reservoir sampler with multi source partitions2 init source partition verify reservoir sampler with replacement true verify reservoir sampler with replacement true verify reservoir sampler with replacement true verify reservoir sampler with replacement true 
rock d b list state performance test test timeout retry on failure time public void test rock db list state a p be throw exception final file rock dir tmp new folder ensure the rock d b library be load to a distinct location each retry native library loader get instance load library rock dir get absolute path final string key1 key1 final string key2 key2 final string value abcdefghijklmnopqrstuvwxyz0123456789 a b c d e f g h i j k l m n o p q r s t u v w x y z7890654321 final byte key bytes1 key1 get byte standard charset utf final byte key bytes2 key2 get byte standard charset utf final byte value byte value get byte standard charset utf the number of value add to list state can be change for benchmark final int num try final option option new option set compaction style compaction style level set level compaction dynamic level byte true set increase parallelism set use fsync false set max open file set create if missing true set merge operator name rock d b keyed state backend merge operator name final write option write option new write option set sync false set disable w a l true final rock d b rock d b rock d b open option rock dir get absolute path add api log info begin add final long begin insert1 system nano time for int i i num i rock d b merge write option key bytes1 value byte final long end insert1 system nano time log info end add duration n end insert1 begin insert1 update api list byte list new array list num for int i i num i list add value byte byte premerged merge list log info begin update final long begin insert2 system nano time rock d b merge write option key bytes2 premerge final long end insert2 system nano time log info end update duration n end insert2 begin insert2 
rock d b performance test test timeout retry on failure time public void test rock db merge performance throw exception final int num try rock d b rock d b rock d b open option rock dir get absolute path insert log info begin insert final long begin insert system nano time for int i i num i rock d b merge write option key byte value byte final long end insert system nano time log info end insert duration ms end insert begin insert read attempt final byte result holder new byte num value byte length final long begin get1 system nano time rock d b get key byte result holder final long end get1 system nano time log info end get duration ms end get1 begin get1 read attempt final long begin get2 system nano time rock d b get key byte result holder final long end get2 system nano time log info end get duration ms end get2 begin get2 compact log info compact final long begin compact system nano time rock d b compact range final long end compact system nano time log info end compaction duration ms end compact begin compact read attempt final long begin get3 system nano time rock d b get key byte result holder final long end get3 system nano time log info end get duration ms end get3 begin get3 
rock d b performance test test timeout retry on failure time public void test rock db range get performance throw exception final int num try rock d b rock d b rock d b open option rock dir get absolute path final byte key template array copy of key byte key byte length final unsafe unsafe memory util unsafe final long offset unsafe array base offset byte class key template length log info begin insert final long begin insert system nano time for int i i num i unsafe put int key template offset i rock d b put write option key template value byte final long end insert system nano time log info end insert duration ms end insert begin insert suppress warning mismatch read and write of array final byte result holder new byte num value byte length final long begin get system nano time int po try final rock iterator wrapper iterator new rock iterator wrapper rock d b new iterator seek to start unsafe put int key template offset iterator seek key template iterate while iterator be valid same prefix key byte iterator key byte curr value iterator value system arraycopy curr value result holder po curr value length po curr value length iterator next final long end get system nano time log info end get duration ms end get begin get 
rock d b write batch performance test test timeout retry on failure time public void bench mark throw exception int num list tuple2 byte byte datum new array list num for int i i num i datum add new tuple2 key prefix i get byte value get byte log info put vs write batch with disable w a l false long t1 bench mark helper datum false writetype put long t2 bench mark helper datum false writetype write batch log info single put with disable w a l be false for record cost num t1 log info write batch with disable w a l be false for record cost num t2 log info put vs write batch with disable w a l true t1 bench mark helper datum true writetype put t2 bench mark helper datum true writetype write batch log info single put with disable w a l be true for record cost num t1 log info write batch with disable w a l be true for record cost num t2 
retry on failure test test retry on failure time number of run public void test retry on failure throw exception all but the expect last run should be successful if number of fail run number of run number of fail run throw new runtime exception expect test exception else number of successful run 
retry on failure test test retry on failure time number of run public void test retry once on failure throw exception if first run number of fail run first run false throw new runtime exception expect test exception else number of successful run 
retry on failure test test retry on failure time number of run public void test do nt retry on success throw exception number of successful run 
yarn file stage test s3 i t case test retry on failure time public void test recursive upload for yarn s3n throw exception skip test on hadoop https issue apache org jira browse hadoop assume assume true this test be skip for hadoop version above version util compare version system get property hadoop version 3.0 try class for name org apache hadoop f s3native native s3 file system catch class not find exception e not in the classpath can not run this test string msg skip test because native s3 file system be not in the class path log info msg assume no exception msg e test recursive upload for yarn s3n test yarn s3n 
yarn file stage test s3 i t case test retry on failure time public void test recursive upload for yarn s3a throw exception try class for name org apache hadoop f s3a s3 a file system catch class not find exception e not in the classpath can not run this test string msg skip test because s3 a file system be not in the class path log info msg assume no exception msg e test recursive upload for yarn s3a test yarn s3a 
