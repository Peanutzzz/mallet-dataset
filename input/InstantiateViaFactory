datadog http reporter instantiate via factory factory class name org apache flink metric datadog datadog http reporter factory public class datadog http reporter implement metric reporter schedule private static final logger logger logger factory get logger datadog http reporter class private static final string host variable host both flink s gauge and meter value be take as gauge in datadog private final map gauge d gauge gauge new concurrent hash map private final map counter d counter counter new concurrent hash map private final map meter d meter meter new concurrent hash map private datadog http client client private list string config tag private int max metric per request value private final clock clock system current time millis l public static final string api key apikey public static final string proxy host proxy host public static final string proxy port proxy port public static final string datum center datum center public static final string tag tag public static final string max metric per request max metric per request override public void notify of add metric metric metric string metric name metric group group final string name group get metric identifier metric name list string tag new array list config tag tag add all get tag from metric group group string host get host from metric group group if metric instanceof counter counter c counter metric counter put c new d counter c name host tag clock else if metric instanceof gauge gauge g gauge metric gauge put g new d gauge g name host tag clock else if metric instanceof meter meter m meter metric only consider rate meter put m new d meter m name host tag clock else if metric instanceof histogram logger warn can not add because datadog http api doesn t support histogram metric name else logger warn can not add unknown metric type this indicate that the reporter do not support this metric type metric get class get name override public void notify of remove metric metric metric string metric name metric group group if metric instanceof counter counter remove metric else if metric instanceof gauge gauge remove metric else if metric instanceof meter meter remove metric else if metric instanceof histogram no histogram be register else logger warn can not remove unknown metric type this indicate that the reporter do not support this metric type metric get class get name override public void open metric config config string api key config get string api key null string proxy host config get string proxy host null integer proxy port config get integer proxy port string raw datum center config get string datum center we max metric per request value config get integer max metric per request datum center datum center datum center value of raw datum center string tag config get string tag client new datadog http client api key proxy host proxy port datum center true config tag get tag from config tag logger info configure datadog http reporter with tag proxy host proxy port datum center max metric per request tag proxy host proxy port datum center max metric per request value override public void close client close logger info shut down datadog http reporter override public void report d series request new d series add gauge and unregister on exception request counter value for each request add counter meter value for each request add meter int total metric request get series size int from index while from index total metric int to index math min from index max metric per request value total metric try d series chunk new d series request get series sub list from index to index client send chunk chunk get series for each d metric ack report logger debug report series with size chunk get series size catch socket timeout exception e logger warn fail report metric to datadog because of socket timeout e get message catch exception e logger warn fail report metric to datadog e from index to index private void add gauge and unregister on exception d series request list gauge gauge to remove new array list for map entry gauge d gauge entry gauge entry set d gauge g entry get value try will throw exception if the gauge be not of number type flink use gauge to store many type other than number g get metric value request add gauge g catch class cast exception e logger info the metric will not be report because only number type be support by this reporter g get metric gauge to remove add entry get key catch exception e if logger be debug enable logger debug the metric will not be report because it throw a exception g get metric e else logger info the metric will not be report because it throw a exception g get metric gauge to remove add entry get key gauge to remove for each gauge remove get config tag from config metric reporter dghttp tag private list string get tag from config string str return array as list str split get tag from metric group get all variable exclude host private list string get tag from metric group metric group metric group list string tag new array list for map entry string string entry metric group get all variable entry set if entry get key equal host variable tag add get variable name entry get key entry get value return tag private string get host from metric group metric group metric group return metric group get all variable get host variable remove lead and trail angle bracket private string get variable name string str return str substring str length 
graphite reporter public evolve instantiate via factory factory class name org apache flink metric graphite graphite reporter factory public class graphite reporter extend schedule dropwizard reporter public static final string arg protocol protocol private enum protocol tcp udp override public schedule reporter get reporter metric config config string host config get string arg host null int port config get integer arg port if host null host length port throw new illegal argument exception invalid host port configuration host host port port string prefix config get string arg prefix null string conversion rate config get string arg conversion rate null string conversion duration config get string arg conversion duration null string protocol config get string arg protocol tcp com codahale metric graphite graphite reporter builder builder com codahale metric graphite graphite reporter for registry registry if prefix null builder prefix with prefix if conversion rate null builder convert rate to time unit value of conversion rate if conversion duration null builder convert duration to time unit value of conversion duration protocol prot try prot protocol value of protocol catch illegal argument exception iae log warn invalid protocol configuration protocol expect tcp or udp default to tcp prot protocol tcp log info configure graphite reporter with host port protocol host port prot switch prot case udp return builder build new graphite u d p host port case tcp default return builder build new graphite host port 
influxdb reporter instantiate via factory factory class name org apache flink metric influxdb influxdb reporter factory public class influxdb reporter extend abstract reporter measurement info implement schedule private string database private string retention policy private influx d b consistency level consistency private influx d b influx d b public influxdb reporter super new measurement info provider override public void open metric config config string host get string config host int port get integer config port if be valid host host net util be valid client port port throw new illegal argument exception invalid host port configuration host host port port string database get string config db if database null throw new illegal argument exception db key configuration option be not set string url string format http s d host port string username get string config username string password get string config password this database database this retention policy get string config retention policy this consistency get consistency level config consistency int connect timeout get integer config connect timeout int write timeout get integer config write timeout ok http client builder client new ok http client builder connect timeout connect timeout time unit millisecond write timeout write timeout time unit millisecond if username null password null influx d b influx d b factory connect url username password client else influx d b influx d b factory connect url client log info configure influx d b reporter with host port db retention policy and consistency host port database retention policy consistency name override public void close if influx d b null influx d b close influx d b null override public void report batch point report build report if report null influx d b write report nullable private batch point build report instant timestamp instant now batch point builder report batch point database database report retention policy retention policy report consistency consistency try for map entry gauge measurement info entry gauge entry set report point metric mapper map entry get value timestamp entry get key for map entry counter measurement info entry counter entry set report point metric mapper map entry get value timestamp entry get key for map entry histogram measurement info entry histogram entry set report point metric mapper map entry get value timestamp entry get key for map entry meter measurement info entry meter entry set report point metric mapper map entry get value timestamp entry get key catch concurrent modification exception no such element exception e ignore may happen when metric be concurrently add or remove report next time return null return report build private static boolean be valid host string host return host null host be empty 
j m x reporter instantiate via factory factory class name org apache flink metric jmx j m x reporter factory public class j m x reporter implement metric reporter static final string jmx domain prefix org apache flink private static final logger log logger factory get logger j m x reporter class private static final character filter character filter new character filter override public string filter character string input return replace invalid char input the server where the management bean be register and deregister private final m bean server m bean server the name under which the register metric have be add to the m bean server private final map metric object name register metric the server to which jmx client connect to allow for better control over port usage nullable private final j m x server jmx server j m x reporter nullable final string port config this m bean server management factory get platform m bean server this register metric new hash map if port config null iterator integer port net util get port range from string port config j m x server successfully start server null while port have next successfully start server null j m x server server new j m x server int port port next try server start port log info start jmx server on port port successfully start server server catch i o exception ioe assume port conflict log debug could not start jmx server on port port ioe try server stop catch exception e log debug could not stop jmx server e if successfully start server null throw new runtime exception could not start jmx server on any configure port port port config this jmx server successfully start server else this jmx server null log info configure j m x reporter with port port config life cycle override public void open metric config config override public void close if jmx server null try jmx server stop catch i o exception e log error fail to stop jmx server e public optional integer get port if jmx server null return optional empty else return optional of jmx server port add remove metric override public void notify of add metric metric metric string metric name metric group group final string domain generate jmx domain metric name group final hashtable string string table generate jmx table group get all variable abstract bean jmx metric object name jmx name try jmx name new object name domain table catch malformed object name exception e there be a implementation error on we side if this occur either the domain be modify and no longer conform to the jmx domain rule or the table wasn t properly generate log debug implementation error the domain or table do not conform to jmx rule e return if metric instanceof gauge jmx metric new jmx gauge gauge metric else if metric instanceof counter jmx metric new jmx counter counter metric else if metric instanceof histogram jmx metric new jmx histogram histogram metric else if metric instanceof meter jmx metric new jmx meter meter metric else log error can not add unknown metric type this indicate that the metric type be not support by this reporter metric get class get name return try synchronize this m bean server register m bean jmx metric jmx name register metric put metric jmx name catch not compliant m bean exception e implementation error on we side log debug metric do not comply with jmx m bean rule e catch instance already exist exception e log warn a metric with the name jmx name be already register e catch throwable t log warn fail to register metric t override public void notify of remove metric metric metric string metric name metric group group try synchronize this final object name jmx name register metric remove metric remove the metric if it be know if it be not know ignore the request if jmx name null m bean server unregister m bean jmx name catch instance not find exception e alright then catch throwable t never propagate exception the metric reporter should not affect the stability of the run system log error un register metric failed t utility static hashtable string string generate jmx table map string string variable hashtable string string ht new hashtable variable size for map entry string string variable variable entry set ht put replace invalid char variable get key replace invalid char variable get value return ht static string generate jmx domain string metric name metric group group return jmx domain prefix front metric group abstract metric group group get logical scope character filter metric name lightweight method to replace unsupported character if the string do not contain any unsupported character this method create no new string and in fact no new object at all p replacement ul li code be remove li li code space be replace by code underscore li li code be replace by code hyphen li ul static string replace invalid char string str char char null final int str len str length int po for int i i str len i final char c str char at i switch c case case case remove character by not move cursor if char null char str to char array break case if char null char str to char array char po break case case case case case case case if char null char str to char array char po break default if char null char pos c pos return char null str new string char pos interface and base class for jmx bean the common m bean interface for all metric public interface metric m bean private abstract static class abstract bean implement metric m bean the m bean interface for a expose counter public interface jmx counter m bean extend metric m bean long get count private static class jmx counter extend abstract bean implement jmx counter m bean private counter counter jmx counter counter counter this counter counter override public long get count return counter get count the m bean interface for a exposed gauge public interface jmx gauge m bean extend metric m bean object get value private static class jmx gauge extend abstract bean implement jmx gauge m bean private final gauge gauge jmx gauge gauge gauge this gauge gauge override public object get value return gauge get value the m bean interface for a expose histogram public interface jmx histogram m bean extend metric m bean long get count double get mean double get std dev long get max long get min double get median double get75th percentile double get95th percentile double get98th percentile double get99th percentile double get999th percentile private static class jmx histogram extend abstract bean implement jmx histogram m bean private final histogram histogram jmx histogram histogram histogram this histogram histogram override public long get count return histogram get count override public double get mean return histogram get statistics get mean override public double get std dev return histogram get statistics get std dev override public long get max return histogram get statistics get max override public long get min return histogram get statistics get min override public double get median return histogram get statistics get quantile 0.5 override public double get75th percentile return histogram get statistics get quantile 0.75 override public double get95th percentile return histogram get statistics get quantile 0.95 override public double get98th percentile return histogram get statistics get quantile 0.98 override public double get99th percentile return histogram get statistics get quantile 0.99 override public double get999th percentile return histogram get statistics get quantile 0.999 the m bean interface for a expose meter public interface jmx meter m bean extend metric m bean double get rate long get count private static class jmx meter extend abstract bean implement jmx meter m bean private final meter meter public jmx meter meter meter this meter meter override public double get rate return meter get rate override public long get count return meter get count jmx server implementation that jmx client can connect to p originally base on j256 simplejmx project p http github com j256 simplejmx blob master src main java com j256 simplejmx server jmx server java private static class j m x server private registry rmi registry private j m x connector server connector private int port private final atomic reference remote rmi server reference new atomic reference public void start int port throw i o exception if rmi registry null connector null log debug j m x server be already run return internal start port this port port private void internal start int port throw i o exception rmi server reference set null this allow client to lookup the jmx service rmi registry new jmx registry port jmxrmi rmi server reference string service url service jmx rmi localhost port jndi rmi localhost port jmxrmi j m x service u r l url try url new j m x service u r l service url catch malformed u r l exception e throw new illegal argument exception malformed service url create service url e final r m i j r m p server impl rmi server new r m i j r m p server impl port null null null connector new r m i connector server url null rmi server management factory get platform m bean server connector start we can t pass the create stub directly to the registry since this would form a cyclic dependency you can only start the connector after the registry be start you can only create the stub after the connector be start you can only start the registry after the stub be create rmi server reference set rmi server to stub public void stop throw i o exception rmi server reference set null if connector null try connector stop finally connector null if rmi registry null try unicast remote object unexport object rmi registry true catch no such object exception e throw new i o exception could not un export we rmi registry e finally rmi registry null a registry that only expose a single remote object suppress warning restriction private static class jmx registry extend sun rmi registry registry impl private final string lookup name private final atomic reference remote remote server stub jmx registry final int port final string lookup name final atomic reference remote remote server stub throw remote exception super port this lookup name lookup name this remote server stub remote server stub override public remote lookup string s throw not bind exception if lookup name equal s final remote remote remote server stub get if remote null return remote throw new not bind exception not bind override public void bind string s remote remote this be call from r m i connector server start don t throw a general access exception override public void unbind string s this be call from r m i connector server stop don t throw a general access exception override public void rebind string s remote remote might as well not throw a exception here give that the other don t override public string list return new string lookup name 
prometheus push gateway reporter public evolve instantiate via factory factory class name org apache flink metric prometheus prometheus push gateway reporter factory public class prometheus push gateway reporter extend abstract prometheus reporter implement schedule private push gateway push gateway private string job name private boolean delete on shutdown private map string string grouping key override public void open metric config config super open config string host config get string host key host default value int port config get integer port key port default value string configure job name config get string job name key job name default value boolean random suffix config get boolean random job name suffix key random job name suffix default value delete on shutdown config get boolean delete on shutdown key delete on shutdown default value grouping key parse grouping key config get string grouping key key grouping key default value if host null host be empty port throw new illegal argument exception invalid host port configuration host host port port if random suffix this job name configure job name new abstract i d else this job name configure job name push gateway new push gateway host port log info configure prometheus push gateway reporter with host port job name random job name suffix delete on shutdown grouping key host port job name random suffix delete on shutdown grouping key map string string parse grouping key final string grouping key config if grouping key config be empty map string string grouping key new hash map string kvs grouping key config split for string kv kvs int idx kv index of if idx log warn invalid prometheus push gateway grouping key will be ignore kv continue string label key kv substr idx string label value kv substr idx if string util be null or whitespace only label key string util be null or whitespace only label value log warn invalid grouping key label key label value must not be empty label key label value continue grouping key put label key label value return grouping key return collection empty map override public void report try push gateway push collector registry default registry job name grouping key catch exception e log warn fail to push metric to push gateway with job name grouping key job name grouping key e override public void close if delete on shutdown push gateway null try push gateway delete job name grouping key catch i o exception e log warn fail to delete metric from push gateway with job name grouping key job name grouping key e super close 
prometheus reporter public evolve instantiate via factory factory class name org apache flink metric prometheus prometheus reporter factory public class prometheus reporter extend abstract prometheus reporter static final string arg port port private static final string default port private h t t p server http server private int port visible for test int get port precondition check state http server null server have not be initialize return port override public void open metric config config super open config string port config config get string arg port default port iterator integer port net util get port range from string port config while port have next int port port next try internally access collector registry default registry http server new h t t p server port this port port log info start prometheus reporter http server on port port break catch i o exception ioe assume port conflict log debug could not start prometheus reporter http server on port port ioe if http server null throw new runtime exception could not start prometheus reporter http server on any configure port port port config override public void close if http server null http server stop super close 
slf4j reporter instantiate via factory factory class name org apache flink metric slf4j slf4j reporter factory public class slf4j reporter extend abstract reporter implement schedule private static final logger log logger factory get logger slf4j reporter class private static final string line separator system line separator the initial size roughly fit metric with default scope setting private int previous size visible for test map gauge string get gauge return gauge visible for test map counter string get counter return counter visible for test map histogram string get histogram return histograms visible for test map meter string get meter return meter override public void open metric config metric config override public void close override public void report try try report catch concurrent modification exception ignore at try report we don t synchronize while iterate over the various map which might cause a concurrent modification exception to be throw if concurrently a metric be be add or remove private void try report initialize with previous size to avoid repeat resizing of back array pad the size to allow deviation in the final string for example due to different double value representation string builder builder new string builder int previous size 1.1 builder append line separator append start metric report append line separator builder append line separator append counter append line separator for map entry counter string metric counter entry set builder append metric get value append append metric get key get count append line separator builder append line separator append gauge append line separator for map entry gauge string metric gauge entry set builder append metric get value append append metric get key get value append line separator builder append line separator append meter append line separator for map entry meter string metric meter entry set builder append metric get value append append metric get key get rate append line separator builder append line separator append histogram append line separator for map entry histogram string metric histogram entry set histogram statistics stats metric get key get statistics builder append metric get value append count append stats size append min append stats get min append max append stats get max append mean append stats get mean append stddev append stats get std dev append p50 append stats get quantile 0.50 append p75 append stats get quantile 0.75 append p95 append stats get quantile 0.95 append p98 append stats get quantile 0.98 append p99 append stats get quantile 0.99 append p999 append stats get quantile 0.999 append line separator builder append line separator append finished metric report append line separator log info builder to string previous size builder length override public string filter character string input return input 
stats d reporter public evolve instantiate via factory factory class name org apache flink metric statsd stats d reporter factory public class stats d reporter extend abstract reporter implement schedule private static final logger log logger factory get logger stats d reporter class public static final string arg host host public static final string arg port port private boolean closed false private datagram socket socket private inet socket address address override public void open metric config config string host config get string arg host null int port config get integer arg port if host null host length port throw new illegal argument exception invalid host port configuration host host port port this address new inet socket address host port try this socket new datagram socket catch socket exception e throw new runtime exception could not create datagram socket e log info configure stats d reporter with host port host port override public void close close true if socket null socket be closed socket close override public void report instead of lock here we tolerate exception we do this to prevent hold the lock for very long and block operator creation and shutdown try for map entry gauge string entry gauge entry set if closed return report gauge entry get value entry get key for map entry counter string entry counter entry set if closed return report counter entry get value entry get key for map entry histogram string entry histogram entry set report histogram entry get value entry get key for map entry meter string entry meter entry set report meter entry get value entry get key catch concurrent modification exception no such element exception e ignore may happen when metric be concurrently add or remove report next time private void report counter final string name final counter counter send name counter get count private void report gauge final string name final gauge gauge object value gauge get value if value null return if value instanceof number send number be negative number value name value to string send name value to string private void report histogram final string name final histogram histogram if histogram null histogram statistics statistics histogram get statistics if statistics null send prefix name count histogram get count send prefix name max statistics get max send prefix name min statistics get min send prefix name mean statistics get mean send prefix name stddev statistics get std dev send prefix name p50 statistics get quantile 0.5 send prefix name p75 statistics get quantile 0.75 send prefix name p95 statistics get quantile 0.95 send prefix name p98 statistics get quantile 0.98 send prefix name p99 statistics get quantile 0.99 send prefix name p999 statistics get quantile 0.999 private void report meter final string name final meter meter if meter null send prefix name rate meter get rate send prefix name count meter get count private string prefix string name if name length string builder string builder new string builder name for int i i name length i string builder append append name i return string builder to string else return private void send string name double value send number be negative value name string value of value private void send string name long value send value name string value of value private void send boolean reset to zero string name string value if reset to zero negative value be interpret as reduction instead of absolute value reset value to before apply reduction as a workaround send name send name value private void send final string name final string value try string format string format s s g name value byte datum format get byte standard charset utf socket send new datagram packet datum datum length this address catch i o exception e log error unable to send packet to statsd at address get host name address get port override public string filter character string input char char null final int str len input length int po for int i i str len i final char c input char at i switch c case if char null char input to char array char po break default if char null char pos c pos return char null input new string char pos private boolean number be negative number input return double compare input double value 
reporter setup test instantiate via factory factory class name org apache flink runtime metric reporter setup test instantiation type track test reporter factory protect static class instantiation type track test reporter2 extend instantiation type track test reporter 
