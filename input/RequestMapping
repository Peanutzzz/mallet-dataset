sys generator controller rest controller api tag request map generator public class sys generator controller autowire private sy generator service sy generator service response body get mapping list public page result get table list request param map string object param return sy generator service query list param file util get map code public void make code string table http servlet response response throw i o exception byte datum sy generator service generator code table split response reset response set header content disposition attachment filename generator zip response add header content length datum length response set content type application octet stream charset utf i o util write datum response get output stream 
index controller slf4j rest controller api tag api request mapping admin public class index controller autowire private i index service index service autowire private index property index property post map index public result create index request body index dto index dto throw i o exception if index dto get number of shard null index dto set number of shard if index dto get number of replica null index dto set number of replica index service create index dto return result succeed get map index public page result map string string list request param require false string query str throw i o exception return index service list query str index property get show get map index public result map string object show index string index name throw i o exception map string object result index service show index name return result succeed result delete mapping index public result delete index string index name throw i o exception index service delete index name return result succeed 
aggregation controller slf4j rest controller api tag api request mapping agg public class aggregation controller private final i aggregation service aggregation service public aggregation controller i aggregation service aggregation service this aggregation service aggregation service param index name param routing e get map request stat index name route public map string object request stat agg path variable string index name path variable string routing throw i o exception return aggregation service request stat agg index name routing 
search controller slf4j rest controller api tag api request mapping search public class search controller private final i search service search service public search controller i search service search service this search service search service param index name param search dto dto post mapping index name public page result j s o n object str query path variable string index name request body require false search dto search dto throw i o exception if search dto null search dto new search dto return search service str query index name search dto 
sy menu controller rest controller api tag api slf4j request mapping menu public class sy menu controller autowire private i sy menu service menu service param sy menu return public static list sy menu tree builder list sy menu sy menu list sy menu menu new array list for sy menu sy menu sys menu if object util equal 1 l sy menu get parent id menu add sy menu for sy menu menu sy menu if menu get parent id equal sy menu get id if sy menu get sub menu null sy menu set sub menu new array list sy menu get sub menu add menu return menu param id api operation value delete mapping id public result delete path variable long id try menu service remove by id id return result succeed catch exception ex log error memu delete error ex return result fail api operation value role id get map role id menu public list map string object find menu by role id path variable long role id set long role id new hash set role id add role id list sy menu role menu menu service find by role role id list sy menu all menu menu service find all list map string object auth tree new array list map long sy menu role menu map role menu stream collect collector to map sy menu get id sy menu sy menu for sy menu sy menu all menu map string object auth tree new hash map auth tree put id sy menu get id auth tree put name sy menu get name auth tree put p id sy menu get parent id auth tree put open true auth tree put check false if role menu map get sy menu get id null auth tree put check true auth tree add auth tree return auth tree api operation value role code suppress warning unchecked cacheable value menu key role code get map role code public list sy menu find menu by role path variable string role code list sy menu result null if string util be not empty role code set string role set set string convert to collection hash set class string class role code result menu service find by role code role set common constant permission return result api operation value post mapping grant public result set menu to role request body sy menu sy menu menu service set menu to role sy menu get role id sy menu get menu id return result succeed api operation value get map find all public page result sy menu find all list sy menu list menu service find all return page result sy menu builder datum list code count long list size build api operation value get mapping find one public page result sy menu find one list sy menu list menu service find one return page result sy menu builder datum list code count long list size build param menu return api operation value post mapping save or update public result save or update request body sy menu menu try menu service save or update menu return result succeed catch exception ex log error memu save or update error ex return result fail return get map current api operation value public list sy menu find my menu login user sy user user list sy role role user get role if collection util be empty role return collection empty list list sy menu menu menu service find by role code role parallel stream map sy role get code collect collector to set common constant menu return tree builder menu 
business controller request mapping path place order public boolean place order business service place order u001 return true 
business controller request mapping path place order fall back public boolean place order fall back business service place order u002 return true 
order controller rest controller request mapping order public class order controller resource private order service order service param user id id param commodity code param count request mapping create public boolean create string user id string commodity code integer count order service create user id commodity code count return true 
order controller request mapping create public boolean create string user id string commodity code integer count order service create user id commodity code count return true 
storage controller rest controller request mapping storage public class storage controller resource private storage service storage service param commodity code param count request mapping path deduct public boolean deduct string commodity code integer count storage service deduct commodity code count return true 
storage controller request mapping path deduct public boolean deduct string commodity code integer count storage service deduct commodity code count return true 
demo controller request map txlcn public string execute request param value string value request param value ex require false string ex flag request param value f require false string flag return demo service execute value ex flag flag 
swagger handler rest controller request mapping swagger resource public class swagger handler private final swagger resource provider swagger resource autowire required false private security configuration security configuration autowire required false private ui configuration ui configuration autowire public swagger handler swagger resource provider swagger resource this swagger resource swagger resource get map configuration security public mono response entity security configuration security configuration return mono just new response entity optional of nullable security configuration or else security configuration builder builder build http status ok get map configuration ui public mono response entity ui configuration ui configuration return mono just new response entity optional of nullable ui configuration or else ui configuration builder builder build http status ok get map public mono response entity swagger resource return mono just new response entity swagger resource get http status ok 
index controller request map public string index model model map string object dashboard map xxl job service dashboard info model add all attribute dashboard map return index 
index controller request mapping chart info response body public return t map string object chart info date start date date end date return t map string object chart info xxl job service chart info start date end date return chart info 
index controller request mapping to login permession limit limit false public string to login model model http servlet request request if permission interceptor if login request return redirect return login 
index controller request mapping value login method request method post response body permession limit limit false public return t string login do http servlet request request http servlet response response string user name string password string if remember valid if permission interceptor if login request return return t success param if string util be blank user name string util be blank password return new return t string i18n util get string login param empty boolean if rem string util be not blank if remember on equal if remember true false do login boolean login ret permission interceptor login response user name password if rem if login ret return new return t string i18n util get string login param unvalid return return t success 
index controller request mapping value logout method request method post response body permession limit limit false public return t string logout http servlet request request http servlet response response if permission interceptor if login request permission interceptor logout request response return return t success 
index controller request mapping help public string help if permission interceptor if login request return redirect to login return help 
job api controller request mapping admin biz mapping permession limit limit false public void api http servlet request request http servlet response response throw i o exception servlet exception xxl job dynamic scheduler invoke admin service request response 
job code controller controller request mapping jobcode public class job code controller resource private xxl job info dao xxl job info dao resource private xxl job log glue dao xxl job log glue dao request map public string index model model int job id xxl job info job info xxl job info dao load by id job id list xxl job log glue job log glue xxl job log glue dao find by job id job id if job info null throw new runtime exception i18n util get string jobinfo glue jobid unvalid if glue type enum bean glue type enum match job info get glue type throw new runtime exception i18n util get string jobinfo glue gluetype unvalid glue model add attribute glue type enum glue type enum value model add attribute job info job info model add attribute job log glue job log glue return jobcode jobcode index request mapping save response body public return t string save model model int id string glue source string glue remark valid if glue remark null return new return t string i18n util get string system please input i18n util get string jobinfo glue remark if glue remark length glue remark length return new return t string i18n util get string jobinfo glue remark limit xxl job info exist job info xxl job info dao load by id id if exist job info null return new return t string i18n util get string jobinfo glue jobid unvalid update new code exist job info set glue source glue source exist job info set glue remark glue remark exist job info set glue updatetime new date xxl job info dao update exist job info log old code xxl job log glue xxl job log glue new xxl job log glue xxl job log glue set job id exist job info get id xxl job log glue set glue type exist job info get glue type xxl job log glue set glue source glue source xxl job log glue set glue remark glue remark xxl job log glue dao save xxl job log glue remove code backup more than xxl job log glue dao remove old exist job info get id return return t success 
job code controller request map public string index model model int job id xxl job info job info xxl job info dao load by id job id list xxl job log glue job log glue xxl job log glue dao find by job id job id if job info null throw new runtime exception i18n util get string jobinfo glue jobid unvalid if glue type enum bean glue type enum match job info get glue type throw new runtime exception i18n util get string jobinfo glue gluetype unvalid glue model add attribute glue type enum glue type enum value model add attribute job info job info model add attribute job log glue job log glue return jobcode jobcode index 
job code controller request mapping save response body public return t string save model model int id string glue source string glue remark valid if glue remark null return new return t string i18n util get string system please input i18n util get string jobinfo glue remark if glue remark length glue remark length return new return t string i18n util get string jobinfo glue remark limit xxl job info exist job info xxl job info dao load by id id if exist job info null return new return t string i18n util get string jobinfo glue jobid unvalid update new code exist job info set glue source glue source exist job info set glue remark glue remark exist job info set glue updatetime new date xxl job info dao update exist job info log old code xxl job log glue xxl job log glue new xxl job log glue xxl job log glue set job id exist job info get id xxl job log glue set glue type exist job info get glue type xxl job log glue set glue source glue source xxl job log glue set glue remark glue remark xxl job log glue dao save xxl job log glue remove code backup more than xxl job log glue dao remove old exist job info get id return return t success 
job group controller controller request mapping jobgroup public class job group controller resource public xxl job info dao xxl job info dao resource public xxl job group dao xxl job group dao request map public string index model model job group executor list xxl job group list xxl job group dao find all model add attribute list list return jobgroup jobgroup index request mapping save response body public return t string save xxl job group xxl job group valid if xxl job group get app name null string util be blank xxl job group get app name return new return t string i18n util get string system please input app name if xxl job group get app name length xxl job group get app name length return new return t string i18n util get string jobgroup field app name length if xxl job group get title null string util be blank xxl job group get title return new return t string i18n util get string system please input i18n util get string jobgroup field title if xxl job group get address type if string util be blank xxl job group get address list return new return t string i18n util get string jobgroup field address type limit string addresss xxl job group get address list split for string item addresss if string util be blank item return new return t string i18n util get string jobgroup field registry list unvalid int ret xxl job group dao save xxl job group return ret return t success return t fail request mapping update response body public return t string update xxl job group xxl job group valid if xxl job group get app name null string util be blank xxl job group get app name return new return t string i18n util get string system please input app name if xxl job group get app name length xxl job group get app name length return new return t string i18n util get string jobgroup field app name length if xxl job group get title null string util be blank xxl job group get title return new return t string i18n util get string system please input i18n util get string jobgroup field title if xxl job group get address type list string registry list find registry by app name xxl job group get app name string address list str null if registry list null registry list be empty collection sort registry list address list str string util join registry list xxl job group set address list address list str else if string util be blank xxl job group get address list return new return t string i18n util get string jobgroup field address type limit string addresss xxl job group get address list split for string item addresss if string util be blank item return new return t string i18n util get string jobgroup field registry list unvalid int ret xxl job group dao update xxl job group return ret return t success return t fail private list string find registry by app name string app name param hash map string list string app address map new hash map string list string list xxl job registry list xxl job admin config get admin config get xxl job registry dao find all registry config dead timeout if list null for xxl job registry item list if registry config regist type executor name equal item get registry group string app name item get registry key list string registry list app address map get app name if registry list null registry list new array list string if registry list contain item get registry value registry list add item get registry value app address map put app name registry list return app address map get app name param request mapping remove response body public return t string remove int id valid int count xxl job info dao page list count id null null if count return new return t string i18n util get string jobgroup del limit list xxl job group all list xxl job group dao find all if all list size return new return t string i18n util get string jobgroup del limit int ret xxl job group dao remove id return ret return t success return t fail 
job group controller request map public string index model model job group executor list xxl job group list xxl job group dao find all model add attribute list list return jobgroup jobgroup index 
job group controller request mapping save response body public return t string save xxl job group xxl job group valid if xxl job group get app name null string util be blank xxl job group get app name return new return t string i18n util get string system please input app name if xxl job group get app name length xxl job group get app name length return new return t string i18n util get string jobgroup field app name length if xxl job group get title null string util be blank xxl job group get title return new return t string i18n util get string system please input i18n util get string jobgroup field title if xxl job group get address type if string util be blank xxl job group get address list return new return t string i18n util get string jobgroup field address type limit string addresss xxl job group get address list split for string item addresss if string util be blank item return new return t string i18n util get string jobgroup field registry list unvalid int ret xxl job group dao save xxl job group return ret return t success return t fail 
job group controller request mapping update response body public return t string update xxl job group xxl job group valid if xxl job group get app name null string util be blank xxl job group get app name return new return t string i18n util get string system please input app name if xxl job group get app name length xxl job group get app name length return new return t string i18n util get string jobgroup field app name length if xxl job group get title null string util be blank xxl job group get title return new return t string i18n util get string system please input i18n util get string jobgroup field title if xxl job group get address type list string registry list find registry by app name xxl job group get app name string address list str null if registry list null registry list be empty collection sort registry list address list str string util join registry list xxl job group set address list address list str else if string util be blank xxl job group get address list return new return t string i18n util get string jobgroup field address type limit string addresss xxl job group get address list split for string item addresss if string util be blank item return new return t string i18n util get string jobgroup field registry list unvalid int ret xxl job group dao update xxl job group return ret return t success return t fail 
job group controller request mapping remove response body public return t string remove int id valid int count xxl job info dao page list count id null null if count return new return t string i18n util get string jobgroup del limit list xxl job group all list xxl job group dao find all if all list size return new return t string i18n util get string jobgroup del limit int ret xxl job group dao remove id return ret return t success return t fail 
job info controller controller request map jobinfo public class job info controller resource private xxl job group dao xxl job group dao resource private xxl job service xxl job service request map public string index model model request param require false default value int job group model add attribute executor route strategy enum executor route strategy enum value model add attribute glue type enum glue type enum value glue model add attribute executor block strategy enum executor block strategy enum value list xxl job group job group list xxl job group dao find all model add attribute job group list job group list model add attribute job group job group return jobinfo jobinfo index request mapping page list response body public map string object page list request param require false default value int start request param require false default value int length int job group string job desc string executor handler string filter time return xxl job service page list start length job group job desc executor handler filter time request mapping add response body public return t string add xxl job info job info return xxl job service add job info request mapping update response body public return t string update xxl job info job info return xxl job service update job info request mapping remove response body public return t string remove int id return xxl job service remove id request map stop todo pause stop response body public return t string pause int id return xxl job service stop id request mapping start todo resume start response body public return t string start int id return xxl job service start id request mapping trigger response body permession limit limit false public return t string trigger job int id string executor param force cover job param if executor param null executor param job trigger pool helper trigger id trigger type enum manual null executor param return return t success 
job info controller request map public string index model model request param require false default value int job group model add attribute executor route strategy enum executor route strategy enum value model add attribute glue type enum glue type enum value glue model add attribute executor block strategy enum executor block strategy enum value list xxl job group job group list xxl job group dao find all model add attribute job group list job group list model add attribute job group job group return jobinfo jobinfo index 
job info controller request mapping page list response body public map string object page list request param require false default value int start request param require false default value int length int job group string job desc string executor handler string filter time return xxl job service page list start length job group job desc executor handler filter time 
job info controller request mapping add response body public return t string add xxl job info job info return xxl job service add job info 
job info controller request mapping update response body public return t string update xxl job info job info return xxl job service update job info 
job info controller request mapping remove response body public return t string remove int id return xxl job service remove id 
job info controller request map stop todo pause stop response body public return t string pause int id return xxl job service stop id 
job info controller request mapping start todo resume start response body public return t string start int id return xxl job service start id 
job info controller request mapping trigger response body permession limit limit false public return t string trigger job int id string executor param force cover job param if executor param null executor param job trigger pool helper trigger id trigger type enum manual null executor param return return t success 
job log controller controller request mapping joblog public class job log controller private static logger logger logger factory get logger job log controller class resource private xxl job group dao xxl job group dao resource public xxl job info dao xxl job info dao resource public xxl job log dao xxl job log dao request map public string index model model request param require false default value integer job id list xxl job group job group list xxl job group dao find all model add attribute job group list job group list if job id xxl job info job info xxl job info dao load by id job id model add attribute job info job info return joblog joblog index request mapping get job by group response body public return t list xxl job info get job by group int job group list xxl job info list xxl job info dao get job by group job group return new return t list xxl job info list request mapping page list response body public map string object page list request param require false default value int start request param require false default value int length int job group int job id int log status string filter time parse param date trigger time start null date trigger time end null if string util be not blank filter time string temp filter time split if temp null temp length try trigger time start date util parse date temp new string yyyy mm dd hh mm ss trigger time end date util parse date temp new string yyyy mm dd hh mm ss catch parse exception e page query list xxl job log list xxl job log dao page list start length job group job id trigger time start trigger time end log status int list count xxl job log dao page list count start length job group job id trigger time start trigger time end log status package result map string object map new hash map string object map put record total list count map put record filter list count map put datum list return map request mapping log detail page public string log detail page int id model model base check return t string log statue return t success xxl job log job log xxl job log dao load id if job log null throw new runtime exception i18n util get string joblog logid unvalid model add attribute trigger code job log get trigger code model add attribute handle code job log get handle code model add attribute executor address job log get executor address model add attribute trigger time job log get trigger time get time model add attribute log id job log get id return joblog joblog detail request mapping log detail cat response body public return t log result log detail cat string executor address long trigger time int log id int from line num try executor biz executor biz xxl job dynamic scheduler get executor biz executor address return t log result log result executor biz log trigger time log id from line num be end if log result get content null log result get content get from line num log result get content get to line num xxl job log job log xxl job log dao load log id if job log get handle code log result get content set end true return log result catch exception e logger error e get message e return new return t log result return t fail code e get message request mapping log kill response body public return t string log kill int id base check xxl job log log xxl job log dao load id xxl job info job info xxl job info dao load by id log get job id if job info null return new return t string i18n util get string jobinfo glue jobid unvalid if return t success code log get trigger code return new return t string i18n util get string joblog kill log limit request of kill return t string run result null try executor biz executor biz xxl job dynamic scheduler get executor biz log get executor address run result executor biz kill job info get id catch exception e logger error e get message e run result new return t string e get message if return t success code run result get code log set handle code return t fail code log set handle msg i18n util get string joblog kill log byman run result get msg null run result get msg log set handle time new date xxl job log dao update handle info log return new return t string run result get msg else return new return t string run result get msg request map clear log response body public return t string clear log int job group int job id int type date clear before time null int clear before num if type clear before time date util add month new date else if type clear before time date util add month new date else if type clear before time date util add month new date else if type clear before time date util add year new date else if type clear before num else if type clear before num else if type clear before num else if type clear before num else if type clear before num else return new return t string return t fail code i18n util get string joblog clean type unvalid xxl job log dao clear log job group job id clear before time clear before num return return t success 
job log controller request map public string index model model request param require false default value integer job id list xxl job group job group list xxl job group dao find all model add attribute job group list job group list if job id xxl job info job info xxl job info dao load by id job id model add attribute job info job info return joblog joblog index 
job log controller request mapping get job by group response body public return t list xxl job info get job by group int job group list xxl job info list xxl job info dao get job by group job group return new return t list xxl job info list 
job log controller request mapping page list response body public map string object page list request param require false default value int start request param require false default value int length int job group int job id int log status string filter time parse param date trigger time start null date trigger time end null if string util be not blank filter time string temp filter time split if temp null temp length try trigger time start date util parse date temp new string yyyy mm dd hh mm ss trigger time end date util parse date temp new string yyyy mm dd hh mm ss catch parse exception e page query list xxl job log list xxl job log dao page list start length job group job id trigger time start trigger time end log status int list count xxl job log dao page list count start length job group job id trigger time start trigger time end log status package result map string object map new hash map string object map put record total list count map put record filter list count map put datum list return map 
job log controller request mapping log detail page public string log detail page int id model model base check return t string log statue return t success xxl job log job log xxl job log dao load id if job log null throw new runtime exception i18n util get string joblog logid unvalid model add attribute trigger code job log get trigger code model add attribute handle code job log get handle code model add attribute executor address job log get executor address model add attribute trigger time job log get trigger time get time model add attribute log id job log get id return joblog joblog detail 
job log controller request mapping log detail cat response body public return t log result log detail cat string executor address long trigger time int log id int from line num try executor biz executor biz xxl job dynamic scheduler get executor biz executor address return t log result log result executor biz log trigger time log id from line num be end if log result get content null log result get content get from line num log result get content get to line num xxl job log job log xxl job log dao load log id if job log get handle code log result get content set end true return log result catch exception e logger error e get message e return new return t log result return t fail code e get message 
job log controller request mapping log kill response body public return t string log kill int id base check xxl job log log xxl job log dao load id xxl job info job info xxl job info dao load by id log get job id if job info null return new return t string i18n util get string jobinfo glue jobid unvalid if return t success code log get trigger code return new return t string i18n util get string joblog kill log limit request of kill return t string run result null try executor biz executor biz xxl job dynamic scheduler get executor biz log get executor address run result executor biz kill job info get id catch exception e logger error e get message e run result new return t string e get message if return t success code run result get code log set handle code return t fail code log set handle msg i18n util get string joblog kill log byman run result get msg null run result get msg log set handle time new date xxl job log dao update handle info log return new return t string run result get msg else return new return t string run result get msg 
job log controller request map clear log response body public return t string clear log int job group int job id int type date clear before time null int clear before num if type clear before time date util add month new date else if type clear before time date util add month new date else if type clear before time date util add month new date else if type clear before time date util add year new date else if type clear before num else if type clear before num else if type clear before num else if type clear before num else if type clear before num else return new return t string return t fail code i18n util get string joblog clean type unvalid xxl job log dao clear log job group job id clear before time clear before num return return t success 
client controller api tag rest controller request mapping client public class client controller autowire private i client service client service get mapping list api operation value public page result client list request param map string object param return client service list client param true get map id api operation value id public client get path variable long id return client service get by id id get map all api operation value public result list client all client page result client page client service list client map new hash map false return result succeed page get datum delete mapping id api operation value public void delete path variable long id client service del client id post mapping save or update api operation value public result save or update request body client dto client dto throw exception return client service save client client dto 
token controller api tag token rest controller request mapping token public class token controller autowire private i token service token service get map api operation value token public page result token vo list request param map string object param string tenant id return token service list token param tenant id 
index controller rest controller request mapping path public class index controller get map public string index return apollo adminservice 
instance config controller rest controller request mapping instance public class instance config controller private static final splitter release splitter splitter on omit empty string trim result private final release service release service private final instance service instance service public instance config controller final release service release service final instance service instance service this release service release service this instance service instance service get mapping by release public page d t o instance d t o get by release request param release id long release id pageable pageable release release release service find one release id if release null throw new not find exception string format release not find for s release id page instance config instance config page instance service find active instance config by release key release get release key pageable list instance d t o instance d t os collection empty list if instance config page have content multimap long instance config instance config map hash multimap create set string other release key set new hash set for instance config instance config instance config page get content instance config map put instance config get instance id instance config other release key add instance config get release key set long instance id instance config map key set list instance instance instance service find instance by id instance id if collection util be empty instance instance d t os bean util batch transform instance d t o class instance for instance d t o instance d t o instance d t os collection instance config config instance config map get instance d t o get id list instance config d t o config d t os config stream map instance config instance config d t o instance config d t o new instance config d t o to save some space instance config d t o set release null instance config d t o set release delivery time instance config get release delivery time instance config d t o set datum change last modify time instance config get datum change last modify time return instance config d t o collect collector to list instance d t o set config config d t os return new page d t o instance d t os pageable instance config page get total element get map by namespace and release not in public list instance d t o get by release not in request param app id string app id request param cluster name string cluster name request param namespace name string namespace name request param release id string release id set long release id set release splitter split to list release id stream map long parse long collect collector to set list release release release service find by release id release id set if collection util be empty release throw new not find exception string format release not find for s release id set string release key release stream map release get release key collect collector to set list instance config instance config instance service find instance config by namespace with release key not in app id cluster name namespace name release key multimap long instance config instance config map hash multimap create set string other release key set new hash set for instance config instance config instance config instance config map put instance config get instance id instance config other release key add instance config get release key list instance instance instance service find instance by id instance config map key set if collection util be empty instance return collection empty list list instance d t o instance d t os bean util batch transform instance d t o class instance list release other release release service find by release key other release key map string release d t o release map map new hash map for release release other release unset configuration to save space release set configuration null release d t o release d t o bean util transform release d t o class release release map put release get release key release d t o for instance d t o instance d t o instance d t os collection instance config config instance config map get instance d t o get id list instance config d t o config d t os config stream map instance config instance config d t o instance config d t o new instance config d t o instance config d t o set release release map get instance config get release key instance config d t o set release delivery time instance config get release delivery time instance config d t o set datum change last modify time instance config get datum change last modify time return instance config d t o collect collector to list instance d t o set config config d t os return instance d t os get mapping by namespace public page d t o instance d t o get instance by namespace request param app id string app id request param cluster name string cluster name request param namespace name string namespace name request param value instance app id require false string instance app id pageable pageable page instance instance if string be null or empty instance app id instance instance service find instance by namespace app id cluster name namespace name pageable else instance instance service find instance by namespace and instance app id instance app id app id cluster name namespace name pageable list instance d t o instance d t os bean util batch transform instance d t o class instance get content return new page d t o instance d t os pageable instance get total element get map by namespace count public long get instance count by namespace request param app id string app id request param cluster name string cluster name request param namespace name string namespace name page instance instance instance service find instance by namespace app id cluster name namespace name page request of return instance get total element 
apollo info controller rest controller request mapping path apollo public class apollo info controller request mapping app public string get app return foundation app to string request mapping net public string get net return foundation net to string request mapping server public string get server return foundation server to string request map version public string get version return apollo version 
apollo info controller request mapping app public string get app return foundation app to string 
apollo info controller request mapping net public string get net return foundation net to string 
apollo info controller request mapping server public string get server return foundation server to string 
apollo info controller request map version public string get version return apollo version 
config controller rest controller request mapping config public class config controller private static final splitter x forward for splitter splitter on omit empty string trim result private final config service config service private final app namespace service with cache app namespace service private final namespace util namespace util private final instance config audit util instance config audit util private final gson gson private static final type configuration type reference new type token map string string get type public config controller final config service config service final app namespace service with cache app namespace service final namespace util namespace util final instance config audit util instance config audit util final gson gson this config service config service this app namespace service app namespace service this namespace util namespace util this instance config audit util instance config audit util this gson gson get mapping value app id cluster name namespace public apollo config query config path variable string app id path variable string cluster name path variable string namespace request param value datum center require false string datum center request param value release key default value string client side release key request param value ip require false string client ip request param value message require false string message as string http servlet request request http servlet response response throw i o exception string original namespace namespace strip out property suffix namespace namespace util filter namespace name namespace fix the character case issue such as fx apollo fx apollo namespace namespace util normalize namespace app id namespace if string be null or empty client ip client ip try to get client ip request apollo notification message client message transform message message as string list release release list new link list string app cluster name load cluster name if config const no appid placeholder equal ignore case app id release current app release config service load config app id client ip app id cluster name namespace datum center client message if current app release null release add current app release we have cluster search process so the cluster name might be override app cluster name load current app release get cluster name if namespace do not belong to this app id should check if there be a public configuration if namespace belong to app id app id namespace release public release this find public config app id client ip cluster name namespace datum center client message if object be null public release release add public release if release be empty response send error http servlet response sc not find string format could not load configuration with app id s cluster name s namespace s app id cluster name original namespace tracer log event apollo config not find assemble key app id cluster name original namespace datum center return null audit release app id cluster name datum center client ip release string merge release key release stream map release get release key collect collector join config const cluster namespace separator if merge release key equal client side release key client side configuration be the same with server side return response set status http servlet response sc not modify tracer log event apollo config not modify assemble key app id app cluster name load original namespace datum center return null apollo config apollo config new apollo config app id app cluster name load original namespace merge release key apollo config set configuration merge release configuration release tracer log event apollo config find assemble key app id app cluster name load original namespace datum center return apollo config private boolean namespace belong to app id string app id string namespace name every app have a application namespace if object equal config const namespace application namespace name return true if no app id be present then no other namespace belong to it if config const no appid placeholder equal ignore case app id return false app namespace app namespace app namespace service find by app id and namespace app id namespace name return app namespace null param client app id the application which use public config param namespace the namespace param datum center the datacenter private release find public config string client app id string client ip string cluster name string namespace string datum center apollo notification message client message app namespace app namespace app namespace service find public namespace by name namespace check whether the namespace s app id equal to current one if object be null app namespace object equal client app id app namespace get app id return null string public config app id app namespace get app id return config service load config client app id client ip public config app id cluster name namespace datum center client message merge configuration of release release in lower index override those in higher index map string string merge release configuration list release release map string string result map new link hash map for release release list reverse release result put all gson from json release get configuration configuration type reference return result private string assemble key string app id string cluster string namespace string datum center list string key part list new array list app id cluster namespace if string be null or empty datum center key part add datum center return key part stream collect collector join config const cluster namespace separator private void audit release string app id string cluster string datum center string client ip list release release if string be null or empty client ip no need to audit instance config when there be no ip return for release release release instance config audit util audit app id cluster datum center client ip release get app id release get cluster name release get namespace name release get release key private string try to get client ip http servlet request request string forward for request get header x forward for if string be null or empty forward for return x forward for splitter split to list forward for get return request get remote addr apollo notification message transform message string message as string apollo notification message notification message null if string be null or empty message as string try notification message gson from json message as string apollo notification message class catch throwable ex tracer log error ex return notification message 
config file controller rest controller request mapping configfile public class config file controller implement release message listener private static final logger logger logger factory get logger config file controller class private static final joiner string joiner joiner on config const cluster namespace separator private static final splitter x forward for splitter splitter on omit empty string trim result private static final long max cache size 50 m b private static final long expire after write private final http header property response header private final http header json response header private final response entity string not find response private cache string string local cache private final multimap string string watch keys2 cache key multimap synchronize set multimap hash multimap create private final multimap string string cache key2 watch key multimap synchronize set multimap hash multimap create private static final gson gson new gson private final config controller config controller private final namespace util namespace util private final watch key util watch key util private final gray release rule holder gray release rule holder public config file controller final config controller config controller final namespace util namespace util final watch key util watch key util final gray release rule holder gray release rule holder local cache cache builder new builder expire after write expire after write time unit minute weigher weigher string string key value value null value length maximum weight max cache size removal listener notification string cache key notification get key logger debug remove cache key cache key if cache key2 watch key contain key cache key return create a new list to avoid concurrent modification exception list string watch key new array list cache key2 watch key get cache key for string watch key watch key watch keys2 cache key remove watch key cache key cache key2 watch key remove all cache key logger debug remove cache key cache key build property response header new http header property response header add content type text plain charset utf json response header new http header json response header add content type application json charset utf not find response new response entity http status not find this config controller config controller this namespace util namespace util this watch key util watch key util this gray release rule holder gray release rule holder get mapping value app id cluster name namespace public response entity string query config as property path variable string app id path variable string cluster name path variable string namespace request param value datum center require false string datum center request param value ip require false string client ip http servlet request request http servlet response response throw i o exception string result query config config file output format property app id cluster name namespace datum center client ip request response if result null return not find response return new response entity result property response header http status ok get mapping value json app id cluster name namespace public response entity string query config as json path variable string app id path variable string cluster name path variable string namespace request param value datum center require false string datum center request param value ip require false string client ip http servlet request request http servlet response response throw i o exception string result query config config file output format json app id cluster name namespace datum center client ip request response if result null return not find response return new response entity result json response header http status ok string query config config file output format output format string app id string cluster name string namespace string datum center string client ip http servlet request request http servlet response response throw i o exception strip out property suffix namespace namespace util filter namespace name namespace fix the character case issue such as fx apollo fx apollo namespace namespace util normalize namespace app id namespace if string be null or empty client ip client ip try to get client ip request check whether this client have gray release rule boolean have gray release rule gray release rule holder have gray release rule app id client ip namespace string cache key assemble cache key output format app id cluster name namespace datum center try to load gray release and return if have gray release rule tracer log event config file cache gray release cache key return load config output format app id cluster name namespace datum center client ip request response if not gray release check weather cache exist if exist return string result local cache get if present cache key if not exist load from config controller if string be null or empty result tracer log event config file cache miss cache key result load config output format app id cluster name namespace datum center client ip request response if result null return null double check if this client need to load gray release if yes load from db again this step be mainly to avoid cache pollution if gray release rule holder have gray release rule app id client ip namespace tracer log event config file cache gray release conflict cache key return load config output format app id cluster name namespace datum center client ip request response local cache put cache key result logger debug add cache for key cache key set string watch key watch key util assemble all watch key app id cluster name namespace datum center for string watch key watch key watch keys2 cache key put watch key cache key cache key2 watch key put all cache key watch key logger debug add cache for key cache key else tracer log event config file cache hit cache key return result private string load config config file output format output format string app id string cluster name string namespace string datum center string client ip http servlet request request http servlet response response throw i o exception apollo config apollo config config controller query config app id cluster name namespace datum center client ip null request response if apollo config null apollo config get configuration null return null string result null switch output format case property property property new property property put all apollo config get configuration result property util to string property break case json result gson to json apollo config get configuration break return result string assemble cache key config file output format output format string app id string cluster name string namespace string datum center list string key part list new array list output format get value app id cluster name namespace if string be null or empty datum center key part add datum center return string joiner join key part override public void handle message release message message string channel logger info message receive channel message channel message string content message get message if topic apollo release topic equal channel string be null or empty content return if watch keys2 cache key contain key content return create a new list to avoid concurrent modification exception list string cache key new array list watch keys2 cache key get content for string cache key cache key logger debug invalidate cache key cache key local cache invalidate cache key enum config file output format property property json json private string value config file output format string value this value value public string get value return value private string try to get client ip http servlet request request string forward for request get header x forward for if string be null or empty forward for return x forward for splitter split to list forward for get return request get remote addr 
notification controller deprecate rest controller request mapping notification public class notification controller implement release message listener private static final logger logger logger factory get logger notification controller class private static final long timeout seconds private final multimap string defer result response entity apollo config notification defer result multimap synchronize set multimap hash multimap create private static final response entity apollo config notification not modify response new response entity http status not modify private static final splitter string splitter splitter on config const cluster namespace separator omit empty string private final watch key util watch key util private final release message service with cache release message service private final entity manager util entity manager util private final namespace util namespace util public notification controller final watch key util watch key util final release message service with cache release message service final entity manager util entity manager util final namespace util namespace util this watch key util watch key util this release message service release message service this entity manager util entity manager util this namespace util namespace util for single namespace notification reserve for older version of apollo client param app id the app id param cluster the cluster param namespace the namespace name param datum center the datacenter param notification id the notification id for the namespace param client ip the client side ip return a deferred result get map public defer result response entity apollo config notification poll notification request param value app id string app id request param value cluster string cluster request param value namespace default value config const namespace application string namespace request param value datum center require false string datum center request param value notification id default value long notification id request param value ip require false string client ip strip out property suffix namespace namespace util filter namespace name namespace set string watch key watch key util assemble all watch key app id cluster namespace datum center defer result response entity apollo config notification defer result new defer result timeout not modify response check whether client be out date release message latest release message service find latest release message for message watch key manually close the entity manager since for async request spring win t do so until the request be finish which be unacceptable since we be do long polling mean the db connection would be hold for a very long time entity manager util close entity manager if latest null latest get id notification id defer result set result new response entity new apollo config notification namespace latest get id http status ok else register all key for string key watch key this defer result put key deferred result defer result on timeout log watch key watch key apollo long poll time out key defer result on completion unregister all key for string key watch key defer result remove key deferred result log watch key watch key apollo long poll complete key log watch key watch key apollo long poll register key logger debug listen from app id cluster namespace datacenter watch key app id cluster namespace datum center return defer result override public void handle message release message message string channel logger info message receive channel message channel message string content message get message tracer log event apollo long poll message content if topic apollo release topic equal channel string be null or empty content return list string key string splitter split to list content message should be app id cluster namespace if key size logger error message format invalid content return response entity apollo config notification notification new response entity new apollo config notification key get message get id http status ok if defer result contain key content return create a new list to avoid concurrent modification exception list defer result response entity apollo config notification result list new array list defer result get content logger debug notify client for key result size content for deferred result response entity apollo config notification result result result set result notification logger debug notification complete private void log watch key set string watch key string event name for string watch key watch key tracer log event event name watch key 
notification controller v2 rest controller request mapping notification v2 public class notification controller v2 implement release message listener private static final logger logger logger factory get logger notification controller v2 class private final multimap string defer result wrapper defer result multimap synchronize set multimap tree multimap create string case insensitive order order natural private static final splitter string splitter splitter on config const cluster namespace separator omit empty string private static final type notification type reference new type token list apollo config notification get type private final executor service large notification batch executor service private final watch key util watch key util private final release message service with cache release message service private final entity manager util entity manager util private final namespace util namespace util private final gson gson private final biz config biz config autowire public notification controller v2 final watch key util watch key util final release message service with cache release message service final entity manager util entity manager util final namespace util namespace util final gson gson final biz config biz config large notification batch executor service executor new single thread executor apollo thread factory create notification controller v2 true this watch key util watch key util this release message service release message service this entity manager util entity manager util this namespace util namespace util this gson gson this biz config biz config get map public defer result response entity list apollo config notification poll notification request param value app id string app id request param value cluster string cluster request param value notification string notification as string request param value datum center require false string datum center request param value ip require false string client ip list apollo config notification notification null try notification gson from json notification as string notification type reference catch throwable ex tracer log error ex if collection util be empty notification throw new bad request exception invalid format of notification notification as string defer result wrapper defer result wrapper new deferred result wrapper biz config long polling timeout in milli set string namespace set new hash set map string long client side notification map new hash map map string apollo config notification filter notification filter notification app id notification for map entry string apollo config notification notification entry filter notification entry set string normalize namespace notification entry get key apollo config notification notification notification entry get value namespace add normalize namespace client side notification put normalize namespace notification get notification id if object equal notification get namespace name normalize namespace defer result wrapper record namespace name normalize result notification get namespace name normalize namespace if collection util be empty namespace throw new bad request exception invalid format of notification notification as string multimap string string watch key map watch key util assemble all watch key app id cluster namespace datum center set string watch key set new hash set watch key map value set deferred result before the check for avoid more wait if the check before set deferred result it may receive a notification the next time when method handle message be execute between check and set deferred result defer result wrapper on timeout log watch key watch key apollo long poll time out key defer result wrapper on completion unregister all key for string key watch key defer result remove key deferred result wrapper log watch key watch key apollo long poll complete key register all key for string key watch key this defer result put key deferred result wrapper log watch key watch key apollo long poll register key logger debug listen from app id cluster namespace datacenter watch key app id cluster namespace datum center check new release list release message latest release message release message service find latest release message group by message watch key manually close the entity manager since for async request spring win t do so until the request be finish which be unacceptable since we be do long polling mean the db connection would be hold for a very long time entity manager util close entity manager list apollo config notification new notification get apollo config notification namespace client side notification watch key map latest release message if collection util be empty new notification defer result wrapper set result new notification return defer result wrapper get result private map string apollo config notification filter notification string app id list apollo config notification notification map string apollo config notification filter notification map new hash map for apollo config notification notification notification if string be null or empty notification get namespace name continue strip out property suffix string original namespace namespace util filter namespace name notification get namespace name notification set namespace name original namespace fix the character case issue such as fx apollo fx apollo string normalize namespace namespace util normalize namespace app id original namespace in case client side namespace name have character case issue and have difference notification id such as fx apollo but fx apollo we should let fx apollo have the chance to update its notification id which mean we should record fx apollo here and ignore fx apollo if filter notification contain key normalize namespace filter notification get normalize namespace get notification id notification get notification id continue filter notification put normalize namespace notification return filter notification private list apollo config notification get apollo config notification set string namespace map string long client side notification multimap string string watch key map list release message latest release message list apollo config notification new notification list new array list if collection util be empty latest release message map string long latest notification map new hash map for release message release message latest release message latest notification put release message get message release message get id for string namespace namespace long client side id client side notification get namespace long latest id config const notification id placeholder collection string namespace watch key watch key map get namespace for string namespace watch key namespace watch key long namespace notification id latest notification get or default namespace watch key config const notification id placeholder if namespace notification id latest id latest id namespace notification id if latest id client side id apollo config notification notification new apollo config notification namespace latest id namespace watch key stream filter latest notification contain key for each namespace watch key notification add message namespace watch key latest notification get namespace watch key new notification add notification return new notification override public void handle message release message message string channel logger info message receive channel message channel message string content message get message tracer log event apollo long poll message content if topic apollo release topic equal channel string be null or empty content return string change namespace retrieve namespace from release message apply content if string be null or empty changed namespace logger error message format invalid content return if defer result contain key content return create a new list to avoid concurrent modification exception list defer result wrapper result list new array list defer result get content apollo config notification config notification new apollo config notification change namespace message get id config notification add message content message get id do async notification if too many client if result size biz config release message notification batch large notification batch executor service submit logger debug async notify client for key with batch result size content biz config release message notification batch for int i i result size i if i i biz config release message notification batch try time unit millisecond sleep biz config release message notification batch interval in milli catch interrupted exception e ignore logger debug async notify result get i result get i set result config notification return logger debug notify client for key result size content for deferred result wrapper result result result set result config notification logger debug notification complete private static final function string string retrieve namespace from release message release message if string be null or empty release message return null list string key string splitter split to list release message message should be app id cluster namespace if key size logger error message format invalid release message return null return key get private void log watch key set string watch key string event name for string watch key watch key tracer log event event name watch key 
service controller rest controller request mapping service public class service controller private final discovery service discovery service private static function instance info service d t o instance info to service d t o func instance service d t o service new service d t o service set app name instance get app name service set instance id instance get instance id service set homepage url instance get home page url return service public service controller final discovery service discovery service this discovery service discovery service request mapping meta public list service d t o get meta service list instance info instance discovery service get meta service instance list service d t o result instance stream map instance info to service d t o func collect collector to list return result request mapping config public list service d t o get config service request param value app id default value string app id request param value ip require false string client ip list instance info instance discovery service get config service instance list service d t o result instance stream map instance info to service d t o func collect collector to list return result request mapping admin public list service d t o get admin service list instance info instance discovery service get admin service instance list service d t o result instance stream map instance info to service d t o func collect collector to list return result 
service controller request mapping meta public list service d t o get meta service list instance info instance discovery service get meta service instance list service d t o result instance stream map instance info to service d t o func collect collector to list return result 
service controller request mapping config public list service d t o get config service request param value app id default value string app id request param value ip require false string client ip list instance info instance discovery service get config service instance list service d t o result instance stream map instance info to service d t o func collect collector to list return result 
service controller request mapping admin public list service d t o get admin service list instance info instance discovery service get admin service instance list service d t o result instance stream map instance info to service d t o func collect collector to list return result 
app controller rest controller openapi app controller request mapping openapi v1 public class app controller private final portal setting portal setting private final cluster service cluster service private final app service app service public app controller final portal setting portal setting final cluster service cluster service final app service app service this portal setting portal setting this cluster service cluster service this app service app service get map value app app id envcluster public list open env cluster d t o load env cluster info path variable string app id list open env cluster d t o env cluster new link list list env envs portal setting get active env for env env envs open env cluster d t o env cluster new open env cluster d t o env cluster set env env name list cluster d t o cluster d t os cluster service find cluster env app id env cluster set cluster bean util to property set name cluster d t os env cluster add env cluster return env cluster get map app public list open app d t o find app request param value app id require false string app id final list app app new array list if string util be empty app id app add all app service find all else app add all app service find by app id set new hash set app id split return open api bean util transform from app app 
cluster controller rest controller openapi cluster controller request mapping openapi v1 env env public class cluster controller private final cluster service cluster service private final user service user service public cluster controller final cluster service cluster service final user service user service this cluster service cluster service this user service user service get map value app app id cluster cluster name public open cluster d t o load cluster path variable app id string app id path variable string env path variable cluster name string cluster name cluster d t o cluster d t o cluster service load cluster app id env from string env cluster name return cluster d t o null null open api bean util transform from cluster d t o cluster d t o pre authorize value consumer permission validator have create cluster permission request app id post mapping value app app id cluster public open cluster d t o create cluster path variable string app id path variable string env valid request body open cluster d t o cluster http servlet request request if object equal app id cluster get app id throw new bad request exception string format app id not equal app id in path s app id in payload s app id cluster get app id string cluster name cluster get name string operator cluster get datum change create by request precondition check argument string util be contain empty cluster name operator name and datum change create by should not be null or empty if input validator be valid cluster namespace cluster name throw new bad request exception string format invalid cluster name format s input validator invalid cluster namespace message if user service find by user id operator null throw new bad request exception user operator doesn t exist cluster d t o to create open api bean util transform to cluster d t o cluster cluster d t o create cluster d t o cluster service create cluster env from string env to create return open api bean util transform from cluster d t o create cluster d t o 
item controller rest controller openapi item controller request mapping openapi v1 env env public class item controller private final item service item service private final user service user service public item controller final item service item service final user service user service this item service item service this user service user service get map value app app id cluster cluster name namespace namespace name item key public open item d t o get item path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string key item d t o item d t o item service load item env from string env app id cluster name namespace name key return item d t o null null open api bean util transform from item d t o item d t o pre authorize value consumer permission validator have modify namespace permission request app id namespace name env post mapping value app app id cluster cluster name namespace namespace name item public open item d t o create item path variable string app id path variable string env path variable string cluster name path variable string namespace name request body open item d t o item http servlet request request request precondition check argument string util be contain empty item get key item get datum change create by key and datum change create by should not be null or empty if user service find by user id item get datum change create by null throw new bad request exception user item get datum change create by doesn t exist if string util be empty item get comment item get comment length throw new bad request exception comment length should not exceed character item d t o to create open api bean util transform to item d t o item protect to create set line num to create set id to create set datum change last modify by to create get datum change create by to create set datum change last modify time null to create set datum change create time null item d t o create item item service create item app id env from string env cluster name namespace name to create return open api bean util transform from item d t o create item pre authorize value consumer permission validator have modify namespace permission request app id namespace name env put map value app app id cluster cluster name namespace namespace name item key public void update item path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string key request body open item d t o item request param default value false boolean create if not exist http servlet request request request precondition check argument item null item payload can not be empty request precondition check argument string util be contain empty item get key item get datum change last modify by key and datum change last modify by can not be empty request precondition check argument item get key equal key key in path and payload be not consistent if user service find by user id item get datum change last modify by null throw new bad request exception user datum change last modify by not exist if string util be empty item get comment item get comment length throw new bad request exception comment length should not exceed character try item d t o to update item item service load item env from string env app id cluster name namespace name item get key protect only value comment last modify by can be modify to update item set comment item get comment to update item set value item get value to update item set datum change last modify by item get datum change last modify by item service update item app id env from string env cluster name namespace name to update item catch throwable ex if ex instanceof http status code exception check create if not exist if http status code exception ex get status code equal http status not find create if not exist create item app id env cluster name namespace name item request return throw ex pre authorize value consumer permission validator have modify namespace permission request app id namespace name env delete mapping value app app id cluster cluster name namespace namespace name item key public void delete item path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string key request param string operator http servlet request request if user service find by user id operator null throw new bad request exception user operator not exist item d t o to delete item item service load item env from string env app id cluster name namespace name key if to delete item null throw new bad request exception item not exist item service delete item env from string env to delete item get id operator 
namespace branch controller rest controller openapi namespace branch controller request mapping openapi v1 env env public class namespace branch controller private final consumer permission validator consumer permission validator private final release service release service private final namespace branch service namespace branch service private final user service user service public namespace branch controller final consumer permission validator consumer permission validator final release service release service final namespace branch service namespace branch service final user service user service this consumer permission validator consumer permission validator this release service release service this namespace branch service namespace branch service this user service user service get map value app app id cluster cluster name namespace namespace name branch public open namespace d t o find branch path variable string app id path variable string env path variable string cluster name path variable string namespace name namespace b o namespace b o namespace branch service find branch app id env value of env to upper case cluster name namespace name if namespace b o null return null return open api bean util transform from namespace b o namespace b o pre authorize value consumer permission validator have create namespace permission request app id post mapping value app app id cluster cluster name namespace namespace name branch public open namespace d t o create branch path variable string app id path variable string env path variable string cluster name path variable string namespace name request param operator string operator http servlet request request request precondition check argument string util be contain empty operator operator can not be empty if user service find by user id operator null throw new bad request exception operator operator not exist namespace d t o namespace d t o namespace branch service create branch app id env value of env to upper case cluster name namespace name operator if namespace d t o null return null return bean util transform open namespace d t o class namespace d t o pre authorize value consumer permission validator have modify namespace permission request app id namespace name env delete mapping value app app id cluster cluster name namespace namespace name branch branch name public void delete branch path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string branch name request param operator string operator http servlet request request request precondition check argument string util be contain empty operator operator can not be empty if user service find by user id operator null throw new bad request exception operator operator not exist boolean can delete consumer permission validator have release namespace permission request app id namespace name env consumer permission validator have modify namespace permission request app id namespace name env release service load latest release app id env value of env branch name namespace name null if can delete throw new access deny exception forbidden operation cause by you don t have release permission or you don t have modification permission or you have modification permission but branch have be release namespace branch service delete branch app id env value of env to upper case cluster name namespace name branch name operator get map value app app id cluster cluster name namespace namespace name branch branch name rule public open gray release rule d t o get branch gray rule path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string branch name gray release rule d t o gray release rule d t o namespace branch service find branch gray rule app id env value of env to upper case cluster name namespace name branch name if gray release rule d t o null return null return open api bean util transform from gray release rule d t o gray release rule d t o pre authorize value consumer permission validator have modify namespace permission request app id namespace name env put map value app app id cluster cluster name namespace namespace name branch branch name rule public void update branch rule path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string branch name request body open gray release rule d t o rule request param operator string operator http servlet request request request precondition check argument string util be contain empty operator operator can not be empty if user service find by user id operator null throw new bad request exception operator operator not exist rule set app id app id rule set cluster name cluster name rule set namespace name namespace name rule set branch name branch name gray release rule d t o gray release rule d t o open api bean util transform to gray release rule d t o rule namespace branch service update branch gray rule app id env value of env to upper case cluster name namespace name branch name gray release rule d t o operator 
release controller rest controller openapi release controller request mapping openapi v1 env env public class release controller private final release service release service private final user service user service private final namespace branch service namespace branch service private final consumer permission validator consumer permission validator public release controller final release service release service final user service user service final namespace branch service namespace branch service final consumer permission validator consumer permission validator this release service release service this user service user service this namespace branch service namespace branch service this consumer permission validator consumer permission validator pre authorize value consumer permission validator have release namespace permission request app id namespace name env post mapping value app app id cluster cluster name namespace namespace name release public open release d t o create release path variable string app id path variable string env path variable string cluster name path variable string namespace name request body namespace release d t o model http servlet request request request precondition check argument string util be contain empty model get release by model get release title param release title and release by can not be empty if user service find by user id model get release by null throw new bad request exception user release by not exist namespace release model release model bean util transform namespace release model class model release model set app id app id release model set env env from string env to string release model set cluster name cluster name release model set namespace name namespace name return open api bean util transform from release d t o release service publish release model get map value app app id cluster cluster name namespace namespace name release latest public open release d t o load latest active release path variable string app id path variable string env path variable string cluster name path variable string namespace name release d t o release d t o release service load latest release app id env from string env cluster name namespace name if release d t o null return null return open api bean util transform from release d t o release d t o pre authorize value consumer permission validator have release namespace permission request app id namespace name env post mapping value app app id cluster cluster name namespace namespace name branch branch name merge public open release d t o merge path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string branch name request param value delete branch default value true boolean delete branch request body namespace release d t o model http servlet request request request precondition check argument string util be contain empty model get release by model get release title param release title and release by can not be empty if user service find by user id model get release by null throw new bad request exception user release by not exist release d t o merged release namespace branch service merge app id env value of env to upper case cluster name namespace name branch name model get release title model get release comment model be emergency publish delete branch model get release by return open api bean util transform from release d t o merged release pre authorize value consumer permission validator have release namespace permission request app id namespace name env post mapping value app app id cluster cluster name namespace namespace name branch branch name release public open release d t o create gray release path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string branch name request body namespace release d t o model http servlet request request request precondition check argument string util be contain empty model get release by model get release title param release title and release by can not be empty if user service find by user id model get release by null throw new bad request exception user release by not exist namespace release model release model bean util transform namespace release model class model release model set app id app id release model set env env from string env to string release model set cluster name branch name release model set namespace name namespace name return open api bean util transform from release d t o release service publish release model pre authorize value consumer permission validator have release namespace permission request app id namespace name env post mapping value app app id cluster cluster name namespace namespace name branch branch name gray del release public open release d t o create gray del release path variable string app id path variable string env path variable string cluster name path variable string namespace name path variable string branch name request body namespace gray del release d t o model http servlet request request request precondition check argument string util be contain empty model get release by model get release title param release title and release by can not be empty request precondition check argument model get gray del key null param gray del key can not be null if user service find by user id model get release by null throw new bad request exception user release by not exist namespace gray del release model release model bean util transform namespace gray del release model class model release model set app id app id release model set env env to upper case release model set cluster name branch name release model set namespace name namespace name return open api bean util transform from release d t o release service publish release model release model get release by put mapping path release release id rollback public void rollback path variable string env path variable long release id request param string operator http servlet request request request precondition check argument string util be contain empty operator param operator can not be empty if user service find by user id operator null throw new bad request exception user operator not exist release d t o release release service find release by id env from string env release id if release null throw new bad request exception release not find if consumer permission validator have release namespace permission request release get app id release get namespace name env throw new access deny exception forbidden operation you don t have release permission release service rollback env from string env release id operator 
app controller rest controller request map app public class app controller private final user info holder user info holder private final app service app service private final portal setting portal setting private final application event publisher publisher private final role permission service role permission service private final role initialization service role initialization service public app controller final user info holder user info holder final app service app service final portal setting portal setting final application event publisher publisher final role permission service role permission service final role initialization service role initialization service this user info holder user info holder this app service app service this portal setting portal setting this publisher publisher this role permission service role permission service this role initialization service role initialization service get map public list app find app request param value app id require false string app id if string util be empty app id return app service find all return app service find by app id set new hash set app id split get map search by appid or name public page d t o app search by app id or app name request param value query require false string query pageable pageable if string util be empty query return app service find all pageable return app service search by app id or app name query pageable get mapping by owner public list app find app by owner request param owner string owner pageable page set string app id set new hash set list role user role role permission service find user role owner for role role user role string app id role util extract app id from role name role get role name if app id null app id add app id return app service find by app id app id page pre authorize value permission validator have create application permission post map public app create valid request body app model app model app app transform to app app model app create app app service create app in local app publisher publish event new app creation event create app set string admin app model get admin if collection util be empty admin role permission service assign role to user role util build app master role name create app get app id admin user info holder get user get user id return create app pre authorize value permission validator be app admin app id put mapping app id public void update path variable string app id valid request body app model app model if object equal app id app model get app id throw new bad request exception the app id of path variable and request body be different app app transform to app app model app update app app service update app in local app publisher publish event new app info change event update app get map app id navtree public multi response entity env cluster info nav path variable string app id multi response entity env cluster info response multi response entity ok list env envs portal setting get active env for env env envs try response add response entity rich response entity ok app service create env nav node env app id catch exception e response add response entity rich response entity error http status internal server error load env env name cluster error e get message return response post mapping value env env consume application json public response entity void create path variable string env valid request body app app app service create app in remote env value of env app role initialization service init namespace specific env role app get app id config const namespace application env user info holder get user get user id return response entity ok build get map app id public app load path variable string app id return app service load app id pre authorize value permission validator be super admin delete mapping app id public void delete app path variable string app id app app app service delete app in local app id publisher publish event new app deletion event app get map app id miss env public multi response entity string find miss env path variable string app id multi response entity string response multi response entity ok for env env portal setting get active env try app service load env app id catch exception e if e instanceof http client error exception http client error exception e get status code http status not find response add response entity rich response entity ok env to string else response add response entity rich response entity error http status internal server error string format load app id s from env s error app id env e get message return response private app transform to app app model app model string app id app model get app id string app name app model get name string owner name app model get owner name string org id app model get org id string org name app model get org name return app builder app id app id name app name owner name owner name org id org id org name org name build 
env controller rest controller request mapping env public class env controller private final portal setting portal setting public env controller final portal setting portal setting this portal setting portal setting get map public list string envs list string environment new array list for env env portal setting get active env environment add env to string return environment 
organization controller rest controller request mapping organization public class organization controller private final portal config portal config public organization controller final portal config portal config this portal config portal config request map public list organization load organization return portal config organization 
organization controller request map public list organization load organization return portal config organization 
sso heartbeat controller controller request mapping sso heartbeat public class sso heartbeat controller private final sso heartbeat handler handler public sso heartbeat controller final sso heartbeat handler handler this handler handler get map public void heartbeat http servlet request request http servlet response response handler do heartbeat request response 
system info controller rest controller request mapping system info public class system info controller private static final logger logger logger factory get logger system info controller class private static final string config service url path service config private static final string admin service url path service admin private rest template rest template private final portal setting portal setting private final rest template factory rest template factory private final portal meta domain service portal meta domain service public system info controller final portal setting portal setting final rest template factory rest template factory final portal meta domain service portal meta domain service this portal setting portal setting this rest template factory rest template factory this portal meta domain service portal meta domain service post construct private void init rest template rest template factory get object pre authorize value permission validator be super admin get map public system info get system info system info system info new system info string version apollo version if be valid version version system info set version version list env all env list portal setting get all env for env env all env list environment info environment info adapt env2 environment info env system info add environment environment info return system info pre authorize value permission validator be super admin get mapping value health public health check health request param string instance id list env all env portal setting get all env service d t o service null for final env env all envs environment info env info adapt env2 environment info env if env info get admin service null for final service d t o s env info get admin service if instance id equal s get instance id service s break if env info get config service null for final service d t o s env info get config service if instance id equal s get instance id service s break if service null throw new illegal argument exception no such instance of instance id instance id return rest template get for object service get homepage url health health class private environment info adapt env2 environment info final env env environment info environment info new environment info string meta server address portal meta domain service get meta server address env environment info set env env environment info set active portal setting be env active env environment info set meta server address meta server address string select meta server address portal meta domain service get domain env try environment info set config service get server address select meta server address config service url path environment info set admin service get server address select meta server address admin service url path catch throwable ex string error message loading config admin service from meta server select meta server address fail logger error error message ex environment info set error message error message exception ex get message return environment info private service d t o get server address string meta server address string path string url meta server address path return rest template get for object url service d t o class private boolean be valid version string version return version equal java null 
address server cluster controller rest controller request mapping address server constant address server request url node public class address server cluster controller autowire private service manager service manager autowire private address server manager address server manager autowire private address server generator manager address server generator manager create new cluster param product ip list of product to be associate param cluster ip list of product cluster to be associate param ip will post ip list return result of create new cluster request mapping value method request method post public response entity post cluster request param require false string product request param require false string cluster request param name ip string ip prepare the storage name for product and cluster string product name address server generator manager generate product name product string cluster name address server manager get default cluster name if empty cluster prepare the response name for product and cluster to client string raw product name address server manager get raw product name product string raw cluster name address server manager get raw cluster name cluster logger address logger info put cluster node the cluster name be cluster the product name product the ip list ip response entity response entity try string service name address server generator manager generate naco service name product name cluster cluster obj new cluster cluster obj set name cluster name cluster obj set health checker new abstract health checker none service manager create service if absent constant default namespace id service name false cluster obj string ip array address server manager split ip ip string check result address server param check util check ip ip array if address server param check util check ok equal check result list instance instance list address server generator manager generate instance by ips service name raw product name cluster name ip array for instance instance instance list service manager register instance constant default namespace id service name instance response entity response entity ok product raw product name cluster raw cluster name put success with size instance list size else response entity response entity status http status bad request body check result catch exception e response entity response entity status http status internal server error body e get message return response entity delete cluster param product ip list of product to be associate param cluster ip list of product cluster to be associate param ip will delete ip return delete result request mapping value method request method delete public response entity delete cluster request param require false string product request param require false string cluster request param string ip prepare the storage name for product and cluster string product name address server generator manager generate product name product string cluster name address server manager get default cluster name if empty cluster prepare the response name for product and cluster to client string raw product name address server manager get raw product name product string raw cluster name address server manager get raw cluster name cluster response entity response entity response entity status http status ok body product raw product name cluster raw cluster name delete success try string service name address server generator manager generate naco service name product name service service service manager get service constant default namespace id service name if service null response entity response entity status http status not find body product raw product name not find else if string util be blank ip delete all ip from the cluster response entity response entity status http status bad request body ip must not be empty else delete specify ip list string ip array address server manager split ip ip string check result address server param check util check ip ip array if address server param check util check ok equal check result list instance instance list address server generator manager generate instance by ips service name raw product name cluster name ip array service manager remove instance constant default namespace id service name false instance list to array new instance instance list size else response entity response entity status http status bad request body check result catch exception e response entity response entity status http status internal server error body e get cause return response entity 
address server cluster controller request mapping value method request method post public response entity post cluster request param require false string product request param require false string cluster request param name ip string ip prepare the storage name for product and cluster string product name address server generator manager generate product name product string cluster name address server manager get default cluster name if empty cluster prepare the response name for product and cluster to client string raw product name address server manager get raw product name product string raw cluster name address server manager get raw cluster name cluster logger address logger info put cluster node the cluster name be cluster the product name product the ip list ip response entity response entity try string service name address server generator manager generate naco service name product name cluster cluster obj new cluster cluster obj set name cluster name cluster obj set health checker new abstract health checker none service manager create service if absent constant default namespace id service name false cluster obj string ip array address server manager split ip ip string check result address server param check util check ip ip array if address server param check util check ok equal check result list instance instance list address server generator manager generate instance by ips service name raw product name cluster name ip array for instance instance instance list service manager register instance constant default namespace id service name instance response entity response entity ok product raw product name cluster raw cluster name put success with size instance list size else response entity response entity status http status bad request body check result catch exception e response entity response entity status http status internal server error body e get message return response entity 
address server cluster controller request mapping value method request method delete public response entity delete cluster request param require false string product request param require false string cluster request param string ip prepare the storage name for product and cluster string product name address server generator manager generate product name product string cluster name address server manager get default cluster name if empty cluster prepare the response name for product and cluster to client string raw product name address server manager get raw product name product string raw cluster name address server manager get raw cluster name cluster response entity response entity response entity status http status ok body product raw product name cluster raw cluster name delete success try string service name address server generator manager generate naco service name product name service service service manager get service constant default namespace id service name if service null response entity response entity status http status not find body product raw product name not find else if string util be blank ip delete all ip from the cluster response entity response entity status http status bad request body ip must not be empty else delete specify ip list string ip array address server manager split ip ip string check result address server param check util check ip ip array if address server param check util check ok equal check result list instance instance list address server generator manager generate instance by ips service name raw product name cluster name ip array service manager remove instance constant default namespace id service name false instance list to array new instance instance list size else response entity response entity status http status bad request body check result catch exception e response entity response entity status http status internal server error body e get cause return response entity 
server list controller request mapping value product cluster method request method get public response entity get cluster path variable string product path variable string cluster string product name address server builder manager generate product name product string service name address server builder manager generate naco service name product name service service service manager get service constant default namespace id service name if service null return response entity status http status not find body product product not find if service get cluster map contain key cluster return response entity status http status not find body product product cluster cluster not find cluster cluster obj service get cluster map get cluster return response entity status http status ok body address server builder manager generate response ip cluster obj all i ps false 
operation controller rest controller request map util and common naco cmdb context op public class operation controller autowire private cmdb provider cmdb provider query label param request http request return query result throw exception exception request mapping value label method request method get public string query label http servlet request request throw exception string entry web util require request entry string label web util require request label return cmdb provider query label entry ip label 
operation controller request mapping value label method request method get public string query label http servlet request request throw exception string entry web util require request entry string label web util require request label return cmdb provider query label entry ip label 
capacity controller rest controller request mapping constant capacity controller path public class capacity controller private static final logger logger logger factory get logger capacity controller class private final capacity service capacity service autowire public capacity controller capacity service capacity service this capacity service capacity service get map public rest result capacity get capacity http servlet response response request param require false string group request param require false string tenant if group null tenant null rest result capacity rest result new rest result capacity response set status rest result set code rest result set message group tenant return rest result if group null string util be blank tenant rest result capacity rest result new rest result capacity response set status rest result set code rest result set message tenant return rest result rest result capacity rest result new rest result capacity try response set status rest result set code capacity capacity capacity service get capacity with default group tenant if capacity null logger warn get capacity capacity group tenant group tenant capacity service init capacity group tenant capacity capacity service get capacity with default group tenant if capacity null rest result set data capacity catch exception e logger error get capacity e response set status rest result set code rest result set message e get message return rest result modify group or capacity of tenant and init record when capacity information be still initial post map public rest result boolean update capacity http servlet response response request param require false string group request param require false string tenant request param require false integer quota request param require false integer max size request param require false integer max aggr count request param require false integer max aggr size if string util be blank group string util be blank tenant capacity service init all capacity rest result boolean rest result new rest result boolean set fail result response rest result rest result set message group tenant return rest result if quota null max size null max aggr count null max aggr size null rest result boolean rest result new rest result boolean set fail result response rest result rest result set message quota max size max aggr count max aggr size return rest result string target field name string target field value if tenant null target field name group target field value group else target field name tenant target field value tenant rest result boolean rest result new rest result boolean if string util be blank target field value set fail result response rest result rest result set message string format s target field name return rest result try boolean insert or update result capacity service insert or update capacity group tenant quota max size max aggr count max aggr size if insert or update result set success result response rest result rest result set message string format s s target field name target field value return rest result set fail result response rest result rest result set message string format s s target field name target field value return rest result catch exception e logger error update capacity e set fail result response rest result rest result set message e get message return rest result private void set fail result http servlet response response rest result boolean rest result int status code response set status status code rest result set code status code rest result set datum false private void set success result http servlet response response rest result boolean rest result response set status rest result set code rest result set datum true 
communication controller rest controller request mapping constant communication controller path public class communication controller private final dump service dump service private final long polling service long polling service private string true str true autowired public communication controller dump service dump service long polling service long polling service this dump service dump service this long polling service long polling service notify the change of config information get mapping datum change public boolean notify config info http servlet request request request param datum id string data id request param group string group request param value tenant require false default value string util empty string tenant request param value tag require false string tag datum id data id trim group group trim string last modify request get header notify service notify header last modify long last modify t string util be empty last modify long parse long last modify string handle ip request get header notify service notify header op handle ip string be beta str request get header be beta if string util be not blank be beta str true str equal be beta str dump service dump datum id group tenant last modify t handle ip true else dump service dump datum id group tenant tag last modify t handle ip return true get client config information of subscriber in local machine get map config watcher public sample result get sub client config request param datum id string data id request param group string group request param value tenant require false string tenant model map model map group string util be blank group constant default group group return long polling service get collect subscrible info datum id group tenant get client config listener list of subscriber in local machine get map watcher configs public sample result get sub client config by ip http servlet request request http servlet response response request param ip string ip model map model map return long polling service get collect subscrible info by ip ip 
config controller rest controller request mapping constant config controller path public class config controller private static final logger logger logger factory get logger config controller class private static final string namespace public key public private static final string export config file name naco config export private static final string export config file name ext zip private static final string export config file name date format yyyy m mdd h hmmss private final config servlet inner inner private final persist service persist service private final config sub service config sub service autowire public config controller config servlet inner config servlet inner persist service persist service config sub service config sub service this inner config servlet inner this persist service persist service this config sub service config sub service add or update non aggregate datum throw naco exception naco exception post mapping secure action action type write parser config resource parser class public boolean publish config http servlet request request http servlet response response request param value datum id string data id request param value group string group request param value tenant require false default value string util empty string tenant request param value content string content request param value tag require false string tag request param value app name require false string app name request param value src user require false string src user request param value config tag require false string config tag request param value desc require false string desc request param value use require false string use request param value effect require false string effect request param value type require false string type request param value schema require false string schema throw naco exception final string src ip request util get remote ip request final string request ip app request util get app name request check tenant param util check tenant tenant param util check param datum id group datum id content param util check param tag map string object config advance info new hash map string object map util put if val no null config advance info config tag config tag map util put if val no null config advance info desc desc map util put if val no null config advance info use use map util put if val no null config advance info effect effect map util put if val no null config advance info type type map util put if val no null config advance info schema schema param util check param config advance info if aggr whitelist be aggr datum id datum id logger warn aggr conflict attemp to publish single datum request util get remote ip request datum id group throw new naco exception naco exception no right datum id datum id be aggr final timestamp time time util get current time string beta ip request get header beta ip config info config info new config info datum id group tenant app name content config info set type type if string util be blank beta ip if string util be blank tag persist service insert or update src ip src user config info time config advance info true config change publisher notify config change new config datum change event false datum id group tenant time get time else persist service insert or update tag config info tag src ip src user time true config change publisher notify config change new config datum change event false datum id group tenant tag time get time else beta publish persist service insert or update beta config info beta ip src ip src user time true config change publisher notify config change new config datum change event true datum id group tenant time get time config trace service log persistence event datum id group tenant request ip app time get time inet util get self ip config trace service persistence event pub content return true get configure board infomation fail throw servlet exception servlet exception throw i o exception i o exception throw naco exception naco exception get map secure action action type read parser config resource parser class public void get config http servlet request request http servlet response response request param datum id string data id request param group string group request param value tenant require false default value string util empty string tenant request param value tag require false string tag throw i o exception servlet exception naco exception check tenant param util check tenant tenant tenant process tenant tenant check param param util check param datum id group datum id content param util check param tag final string client ip request util get remote ip request inner do get config request response datum id group tenant tag client ip get the specific configuration information that the console use throw naco exception naco exception get map param show all secure action action type read parser config resource parser class public config all info detail config info http servlet request request http servlet response response request param datum id string data id request param group string group request param value tenant require false default value string util empty string tenant throw naco exception check tenant param util check tenant tenant check param param util check param datum id group datum id content return persist service find config all info data id group tenant synchronously delete all pre aggregation datum under a data id throw naco exception naco exception delete mapping secure action action type write parser config resource parser class public boolean delete config http servlet request request http servlet response response request param datum id string data id request param group string group request param value tenant require false default value string util empty string tenant request param value tag require false string tag throw naco exception check tenant param util check tenant tenant param util check param datum id group datum id rm param util check param tag string client ip request util get remote ip request if string util be blank tag persist service remove config info datum id group tenant client ip null else persist service remove config info tag datum id group tenant tag client ip null final timestamp time time util get current time config trace service log persistence event datum id group tenant null time get time client ip config trace service persistence event remove null config change publisher notify config change new config datum change event false datum id group tenant tag time get time return true execute delete config operation return java lang boolean author klw description delete configuration base on multiple config id date 2019/7 5 10 param request response datum id group tenant tag delete mapping params del type id secure action action type write parser config resource parser class public rest result boolean delete config http servlet request request http servlet response response request param value id list long id string client ip request util get remote ip request final timestamp time time util get current time list config info config info list persist service remove config info by id id client ip null if collection util be empty config info list for config info config info config info list config change publisher notify config change new config datum change event false config info get datum id config info get group config info get tenant time get time config trace service log persistence event config info get datum id config info get group config info get tenant null time get time client ip config trace service persistence event remove null return result builder build success result true get map catalog secure action action type read parser config resource parser class public rest result config advance info get config advance info request param datum id string data id request param group string group request param value tenant require false default value string util empty string tenant rest result config advance info rr new rest result config advance info config advance info config info persist service find config advance info datum id group tenant rr set code rr set datum config info return rr the client listen for configuration change post map listener secure action action type read parser config resource parser class public void listener http servlet request request http servlet response response throw servlet exception i o exception request set attribute org apache catalina async support true string probe modify request get parameter listen config if string util be blank probe modify throw new illegal argument exception invalid probe modify probe modify u r l decoder decode probe modify constant encode map string string client md5 map try client md5 map m d5 util get client md5 map probe modify catch throwable e throw new illegal argument exception invalid probe modify do long polling inner do polling config request response client md5 map probe modify length subscribe to configure client information get map listener secure action action type read parser config resource parser class public groupkey listenser status get listener request param datum id string data id request param group string group request param value tenant require false string tenant request param value sample time require false default value int sample time throw exception group string util be blank group constant default group group sample result collect sample result config sub service get collect sample result datum id group tenant sample time groupkey listenser status gl new groupkey listenser status gl set collect status if collect sample result get lisenter groupkey status null gl set lisenter groupkey status collect sample result get lisenter groupkey status return gl query the configuration information and return it in json format get map param search accurate secured action action type read parser config resource parser class public page config info search config request param datum id string data id request param group string group request param value app name require false string app name request param value tenant require false default value string util empty string tenant request param value config tag require false string config tag request param page no int page no request param page size int page size map string object config advance info new hash map string object if string util be not blank app name config advance info put app name app name if string util be not blank config tag config advance info put config tag config tag try return persist service find config info4 page page no page size datum id group tenant config advance info catch exception e string error msg serialize page error datum id datum id group group logger error error msg e throw new runtime exception error msg e fuzzy query configuration information fuzzy query base only on content be not allow that be both datum id and group be null but content be not null in this case all configuration be return get map param search blur secure action action type read parser config resource parser class public page config info fuzzy search config request param datum id string data id request param group string group request param value app name require false string app name request param value tenant require false default value string util empty string tenant request param value config tag require false string config tag request param page no int page no request param page size int page size map string object config advance info new hash map string object if string util be not blank app name config advance info put app name app name if string util be not blank config tag config advance info put config tag config tag try return persist service find config info like4 page page no page size datum id group tenant config advance info catch exception e string error msg serialize page error datum id datum id group group logger error error msg e throw new runtime exception error msg e execute to remove beta operation param datum id data id string value param group group string value param tenant tenant string value return execute to operate result delete mapping param beta true secured action action type write parser config resource parser class public rest result boolean stop beta request param value datum id string data id request param value group string group request param value tenant require false default value string util empty string tenant rest result boolean rr new rest result boolean try persist service remove config info4 beta datum id group tenant catch exception e logger error remove beta datum error e rr set code rr set datum false rr set message remove beta datum error return rr config change publisher notify config change new config datum change event true datum id group tenant system current time millis rr set code rr set datum true rr set message stop beta ok return rr execute to query beta operation param datum id data id string value param group group string value param tenant tenant string value return rest result for config info4 beta get map param beta true secured action action type read parser config resource parser class public rest result config info4 beta query beta request param value datum id string data id request param value group string group request param value tenant require false default value string util empty string tenant rest result config info4 beta rr new rest result config info4 beta try config info4 beta ci persist service find config info4 beta datum id group tenant rr set code rr set datum ci rr set message stop beta ok return rr catch exception e logger error remove beta datum error e rr set code rr set message remove beta datum error return rr execute export config operation param datum id data id string value param group group string value param app name app name string value param tenant tenant string value param id id list value return response entity get map param export true secured action action type read parser config resource parser class public response entity byte export config request param value datum id require false string datum id request param value group require false string group request param value app name require false string app name request param value tenant require false default value string util empty string tenant request param value id require false list long id id remove all collection singleton null tenant process tenant tenant list config all info datum list persist service find all config info4 export datum id group tenant app name id list zip util zip item zip item list new array list string builder meta datum null for config info ci datum list if string util be not blank ci get app name handle app name if meta datum null meta datum new string builder string meta data id ci get datum id if meta datum id contain meta datum id meta datum id substring meta datum id last index of meta datum id substring meta datum id last index of meta datum append ci get group append append meta datum id append app fix use of r n here append ci get app name append r n string item name ci get group ci get datum id zip item list add new zip util zip item item name ci get content if meta data null zip item list add new zip util zip item meta yml meta datum to string http header header new http header string file name export config file name date format util format new date export config file name date format export config file name ext header add content disposition attachment filename file name return new response entity byte zip util zip zip item list header http status ok execute import and publish config operation param request http servlet request param src user src user string value param namespace namespace string value param policy policy model param file multipart file return rest result map throw naco exception naco exception post mapping param import true secured action action type write parser config resource parser class public rest result map string object import and publish config http servlet request request request param value src user require false string src user request param value namespace require false string namespace request param value policy default value abort same config policy policy multipart file file throw naco exception map string object fail datum new hash map if object be null file return result builder build result result code enum datum empty fail datum if string util be not blank namespace if persist service tenant info count by tenant id namespace fail datum put succ count return result builder build result result code enum namespace not exist fail datum list config all info config info list null try zip util un zip result unziped zip util unzip file get byte zip util zip item meta datum zip item unziped get meta datum item map string string meta datum map new hash map if meta datum zip item null string meta datum str meta datum zip item get item datum string meta datum arr meta datum str split be n for string meta datum item meta datum arr string meta datum item arr meta datum item split if meta datum item arr length fail datum put succ count return result builder build result result code enum metadata illegal fail datum meta datum map put meta datum item arr meta datum item arr list zip util zip item item list unziped get zip item list if item list null item list be empty config info list new array list item list size for zip util zip item item item list string group adn data id item get item name split if item get item name contain group adn datum id length fail datum put succ count return result builder build result result code enum datum validation fail fail datum string group group adn datum id string datum id group adn datum id string temp datum id data id if temp datum id contain temp datum id temp datum id substr temp datum id last index of temp datum id substr temp datum id last index of final string meta datum id group temp datum id app config all info ci new config all info ci set tenant namespace ci set group group ci set datum id data id ci set content item get item datum if meta datum map get meta datum id null ci set app name meta datum map get meta datum id config info list add ci catch i o exception e fail datum put succ count logger error parse datum fail e return result builder build result result code enum parse datum fail fail datum if config info list null config info list be empty fail datum put succ count return result builder build result result code enum datum empty fail datum final string src ip request util get remote ip request string request ip app request util get app name request final timestamp time time util get current time map string object save result persist service batch insert or update config info list src user src ip null time false policy for config info config info config info list config change publisher notify config change new config datum change event false config info get datum id config info get group config info get tenant time get time config trace service log persistence event config info get datum id config info get group config info get tenant request ip app time get time inet util get self ip config trace service persistence event pub config info get content return result builder build success result save result execute clone config operation param request http servlet request param src user src user string value param namespace namespace string value param config bean list config bean list param policy config policy model return rest result for map throw naco exception naco exception post mapping param clone true secured action action type write parser config resource parser class public rest result map string object clone config http servlet request request request param value src user require false string src user request param value tenant require true string namespace request body require true list same namespace clone config bean config bean list request param value policy default value abort same config policy policy throw naco exception map string object fail datum new hash map if collection util be empty config bean list fail datum put succ count return result builder build result result code enum no select config fail datum config bean list remove all collection singleton null if namespace public key equal ignore case namespace namespace else if persist service tenant info count by tenant id namespace fail datum put succ count return result builder build result result code enum namespace not exist fail datum list long id list new array list config bean list size map long same namespace clone config bean config bean map config bean list stream collect collector to map same namespace clone config bean get cfg id cfg id list add cfg get cfg id return cfg k1 k2 k1 list config all info querye datum list persist service find all config info4 export null null null null id list if querye datum list null querye datum list be empty fail datum put succ count return result builder build result result code enum datum empty fail datum list config all info config info list4 clone new array list querye datum list size for config all info ci querye datum list same namespace clone config bean prarm bean config bean map get ci get id config all info ci4save new config all info ci4save set tenant namespace ci4save set type ci get type ci4save set group prarm bean null string util be not blank prarm bean get group prarm bean get group ci get group ci4save set datum id prarm bean null string util be not blank prarm bean get datum id prarm bean get datum id ci get datum id ci4save set content ci get content if string util be not blank ci get app name ci4save set app name ci get app name config info list4 clone add ci4save if config info list4 clone be empty fail datum put succ count return result builder build result result code enum datum empty fail datum final string src ip request util get remote ip request string request ip app request util get app name request final timestamp time time util get current time map string object save result persist service batch insert or update config info list4 clone src user src ip null time false policy for config info config info config info list4 clone config change publisher notify config change new config datum change event false config info get datum id config info get group config info get tenant time get time config trace service log persistence event config info get datum id config info get group config info get tenant request ip app time get time inet util get self ip config trace service persistence event pub config info get content return result builder build success result clone complete successfully save result private string process tenant string tenant if string util be empty tenant namespace public key equal ignore case tenant return return tenant 
config op controller rest controller request map constant op controller path public class config op controller private static final logger logger logger factory get logger config op controller class protect final persist service persist service private final dump service dump service autowire public config op controller persist service persist service dump service dump service this persist service persist service this dump service dump service manually trigger dump of a local configuration file post mapping value local cache public string update local cache from store logger info start to dump all datum from store dump service dump all logger info finish to dump all datum from store return http servlet response sc ok put mapping value log public string set log level request param string log name request param string log level log util set log level log name log level return http servlet response sc ok todo in a future release the front page should appear operable the interface to the derby operation query can only run select statement and be a direct query to the native derby database without any additional logic param sql the query return link rest result get mapping value derby public rest result object derby op request param value sql string sql string select sign select string limit sign row fetch next string limit offset row fetch next row only try if property util be embed storage local datum source service impl datum source service local datum source service impl dynamic datum source get instance get datum source if string util start with ignore case sql select sign if string utils contain ignore case sql limit sign sql limit jdbc template template datum source service get jdbc template list map string object result template query for list sql return rest result util success result return rest result util fail only query statement be allow to be execute return rest result util fail the current storage mode be not derby catch exception e return rest result util fail e get message todo the front page should appear operable the external datum source be import into derby p mysqldump default file xxx host 0.0 0.0 protocol tcp user xxx extend insert false complete insert true skip trigger no create info skip column statistics schema table name param multipart file link multipart file return link defer result post mapping value datum removal secure action action type write resource naco admin public defer result rest result string import derby request param value file multipart file multipart file defer result rest result string response new deferred result if property util be embed storage response set result rest result util fail limit to embed storage mode return response database operate database operate application util get bean database operate class web util on file upload multipart file file notify center publish event new derby import event false database operate datum import file when complete result ex notify center publish event new derby import event true if object non null ex response set result rest result util fail ex get message return response set result result response return response 
health controller rest controller request mapping constant health controller path public class health controller private datum source service datum source service private string heath up str up private string heath down str down private string heath warn str warn autowired private server member manager member manager post construct public void init datum source service dynamic datum source get instance get datum source get map public string get health todo up down warn string builder sb new string builder string db status datum source service get health if db status contain heath up str member manager be in ip list sb append heath up str else if db status contain heath warn str member manager be in ip list sb append warn sb append slave db append db status split append down else sb append down if db status contain heath down str sb append master db append db status split append down if member manager be in ip list sb append server ip append inet util get self ip append be not in the server list of address server return sb to string 
history controller rest controller request mapping constant history controller path public class history controller autowire protect persist service persist service query the list history config param datum id data id string value param group group string value param tenant tenant string value param app name app name string value param page no page no string value param page size page size string value param model map mode map return get map param search accurate public page config history info list config history request param datum id string data id request param group string group request param value tenant require false default value string util empty string tenant request param value app name require false string app name request param value page no required false integer page no request param value page size require false integer page size model map model map page no null page no page no page size null page size page size page size math min page size config info base have no app name field return persist service find config history datum id group tenant page no page size query the detailed configuration history information get map public config history info get config history info http servlet request request http servlet response response request param nid long nid model map model map return persist service detail config history nid 
listener controller rest controller request mapping constant listener controller path public class listener controller private final config sub service config sub service autowire public listener controller config sub service config sub service this config sub service config sub service get subscribe information from client side get map public groupkey listenser status get all sub client config by ip request param ip string ip request param value all require false boolean all request param value tenant require false string tenant request param value sample time require false default value int sample time model map model map throw exception sample result collect sample result config sub service get collect sample result by ip ip sample time groupkey listenser status gl new groupkey listenser status gl set collect status map string string config md5 status new hash map string string if collect sample result get lisenter groupkey status null map string string status collect sample result get lisenter groupkey status for map entry string string config status entry set if string util be blank tenant if config get key contain tenant config md5 status put config get key config get value else get common config default value if want to get all config you need to add all if all config md5 status put config get key config get value else string config key group key2 parse key config get key if string util be blank config key config md5 status put config get key config get value gl set lisenter groupkey status config md5 status return gl 
health controller rest controller console health request mapping v1 console health public class health controller private static final logger logger logger factory get logger health controller class private final persist service persist service private final operator controller api command autowire public health controller persist service persist service operator controller api command this persist service persist service this api command api command whether the naco be in broken state or not and can not recover except by be restart return http code equal to indicate that naco be in right state http code equal to indicate that naco be in broken state get map liveness public response entity liveness return response entity ok body ok ready to receive the request or not return http code equal to indicate that naco be ready http code equal to indicate that naco be not ready get map readiness public response entity readiness http servlet request request boolean be config readiness be config readiness boolean be name readiness be name readiness request if be config readiness be name readiness return response entity ok body ok if be config readiness be name readiness return response entity status body config and naming be not in readiness if be config readiness return response entity status body config be not in readiness return response entity status body naming be not in readiness private boolean be config readiness check db try persist service config info count return true catch exception e logger error config health check fail e return false private boolean be name readiness http servlet request request try api command metric request return true catch exception e logger error name health check fail e return false 
namespace controller rest controller request mapping v1 console namespace public class namespace controller autowire private persist service persist service private final pattern namespace id check pattern pattern compile w private static final int namespace id max length get namespace list param request request param response response return namespace list get map public rest result list namespace get namespace http servlet request request http servlet response response rest result list namespace rr new rest result list namespace rr set code todo kp list tenant info tenant info persist service find tenant by kp namespace namespace0 new namespace public persist service config info count list namespace namespace new array list namespace namespace add namespace0 for tenant info tenant info tenant info int config count persist service config info count tenant info get tenant id namespace namespace tmp new namespace tenant info get tenant id tenant info get tenant name config count namespace add namespace tmp rr set datum namespace return rr get namespace all info by namespace id param request request param response response param namespace id namespace id return namespace all info get map param show all public namespace all info get namespace http servlet request request http servlet response response request param namespace id string namespace id todo kp if string util be blank namespace id return new namespace all info namespace id public persist service config info count public namespace else tenant info tenant info persist service find tenant by kp namespace id int config count persist service config info count namespace id return new namespace all info namespace id tenant info get tenant name config count tenant info get tenant desc create namespace param request request param response response param namespace name namespace name param namespace desc namespace desc return whether create ok post mapping secure resource naco auth config console resource name prefix namespace action action type write public boolean create namespace http servlet request request http servlet response response request param custom namespace id string namespace id request param namespace name string namespace name request param value namespace desc require false string namespace desc todo kp if string util be blank namespace id namespace id uuid random u u i d to string else namespace id namespace id trim if namespace id check pattern matcher namespace id match return false if namespace id length namespace id max length return false if persist service tenant info count by tenant id namespace id return false persist service insert tenant info atomic namespace id namespace name namespace desc naco system current time millis return true check namespace id exist param namespace id namespace id return true if exist otherwise false get mapping param check namespace id exist true public boolean check namespace id exist request param custom namespace id string namespace id if string util be blank namespace id return false return persist service tenant info count by tenant id namespace id edit namespace param namespace namespace param namespace show name namespace show name param namespace desc namespace desc return whether edit ok put mapping secure resource naco auth config console resource name prefix namespace action action type write public boolean edit namespace request param namespace string namespace request param namespace show name string namespace show name request param value namespace desc require false string namespace desc todo kp persist service update tenant name atomic namespace namespace show name namespace desc return true del namespace by id param request request param response response param namespace id namespace id return whether del ok delete mapping secure resource naco auth config console resource name prefix namespace action action type write public boolean delete config http servlet request request http servlet response response request param namespace id string namespace id persist service remove tenant info atomic namespace id return true 
permission controller rest controller request mapping v1 auth permission public class permission controller autowire private naco role service impl naco role service query permission of a role param role the role param page no page index param page size page size return permission of a role get map secure resource naco auth config console resource name prefix permission action action type read public object get permission request param int page no request param int page size request param name role default value string util empty string role return naco role service get permission from database role page no page size add a permission to a role param role the role param resource the related resource param action the related action return ok if succeed post mapping secure resource naco auth config console resource name prefix permission action action type write public object add permission request param string role request param string resource request param string action naco role service add permission role resource action return new rest result add permission ok delete a permission from a role param role the role param resource the related resource param action the related action return ok if succeed delete mapping secure resource naco auth config console resource name prefix permission action action type write public object delete permission request param string role request param string resource request param string action naco role service delete permission role resource action return new rest result delete permission ok 
role controller rest controller request mapping v1 auth role public class role controller autowire private naco role service impl role service get role list param page no number index of page param page size page size param username optional username of user return role list get map secure resource naco auth config console resource name prefix role action action type read public object get role request param int page no request param int page size request param name username default value string username return role service get role from database username page no page size add a role to a user p this method be use for function create a role and bind it to global admin bind a role to a user param role role name param username username return code and message add role ok post mapping secure resource naco auth config console resource name prefix role action action type write public object add role request param string role request param string username role service add role role username return new rest result add role ok delete a role if no username be specify all user under this role be delete param role role param username username return ok if succeed delete mapping secure resource naco auth config console resource name prefix role action action type write public object delete role request param string role request param name username default value string util empty string username if string util be blank username role service delete role role else role service delete role role username return new rest result delete role of user username ok 
server state controller rest controller request mapping v1 console server public class server state controller get server state of current server return state json get map state public response entity server state map string string server state new hash map server state put standalone mode application util get standalone mode application util standalone mode alone application util standalone mode cluster server state put function mode application util get function mode server state put version version util version return response entity ok body server state 
user controller rest controller user request mapping v1 auth v1 auth user public class user controller autowire private jwt token util jwt token util autowire private authentication manager authentication manager autowire private naco user detail service impl user detail service autowire private naco role service impl role service autowire private auth configs auth configs autowired private naco auth manager auth manager create a new user param username username param password password return ok if create succeed throw illegal argument exception if user already exist since 1.2 secure resource naco auth config console resource name prefix user action action type write post map public object create user request param string username request param string password user user user detail service get user from database username if user null throw new illegal argument exception user username already exist user detail service create user username password encoder util encode password return new rest result create user ok delete a exist user param username username of user return ok if delete succeed keep silent if user not exist since 1.2 delete mapping secure resource naco auth config console resource name prefix user action action type write public object delete user request param string username list role info role info list role service get role username if role info list null for role info role info role info list if role info get role equal naco role service impl global admin role throw new illegal argument exception can not delete admin username user detail service delete user username return new rest result delete user ok update a user param username username of user param new password new password of user return ok if update succeed throw illegal argument exception if user not exist or old password be incorrect since 1.2 put mapping secure resource naco auth config console resource name prefix user action action type write public object update user request param string username request param string new password user user user detail service get user from database username if user null throw new illegal argument exception user username not exist user detail service update user password username password encoder util encode new password return new rest result update user ok get page user param page no number index of page param page size size of page return a collection of user empty set if no user be find since 1.2 get map secure resource naco auth config console resource name prefix user action action type read public object get user request param int page no request param int page size return user detail service get user from database page no page size login to naco p this method use username and password to require a new token param username username of user param password password param response http response param request http request return new token of the user throw access exception if user info be incorrect post mapping login public object login request param string username request param string password http servlet response response http servlet request request throw access exception if auth system type naco name equal ignore case auth config get naco auth system type naco user user naco user auth manager login request response add header naco auth config authorization header naco auth config token prefix user get token object node result jackson util create empty json node j s o n object result new j s o n object result put constant access token user get token result put constant token ttl auth config get token validity in seconds result put constant global admin user be global admin return result authentication username password authentication token username password authentication token authentication token new username password authentication token username password rest result string rr new rest result string try authentication manager provider manager authenticate authentication authentication authentication authentication manager authenticate authentication token authentication security context security context holder get context set authentication authentication token string token jwt token util create token authentication token http response add header naco auth config authorization header bearer token rr set code rr set data bearer token return rr catch bad credentials exception authentication rr set code rr set message login fail return rr update password param old password old password param new password new password return code if update successfully code if old password invalid otherwise put mapping password deprecate public rest result string update password request param value old password string old password request param value new password string new password rest result string rr new rest result string object principal security context holder get context get authentication get principal string username user detail principal get username user user user detail service get user from database username string password user get password todo throw out more fine grained exception try if password encoder util match old password password user detail service update user password username password encoder util encode new password rr set code rr set message update password success else rr set code rr set message old password be invalid catch exception e rr set code rr set message update userpassword fail return rr 
core op controller rest controller request map common naco core context op public class core op controller private final protocol manager protocol manager private final id generator manager id generator manager public core op controller protocol manager protocol manager id generator manager id generator manager this protocol manager protocol manager this id generator manager id generator manager temporarily overpass the raft operation interface group id xxx command transfer leader or do snapshot or reset raft cluster or remove peer value ip raft port post mapping value raft public rest result string raft op request body map string string command return protocol manager get cp protocol execute command get the current health of the id generator return link rest result get mapping value id info public rest result map string map object object id info map string map object object info new hash map id generator manager get generator map for each resource id generator info put resource id generator info return rest result util success info 
naco cluster controller rest controller request mapping common naco core context cluster public class naco cluster controller private final server member manager member manager public naco cluster controller server member manager member manager this member manager member manager get mapping value self public rest result member self return rest result util success member manager get self the console display the list of cluster member param ip key word search key word return all member get map value node public rest result collection member list node request param value keyword require false string ip key word collection member member member manager all member collection member result new array list member stream sort for each member if string util be blank ip key word result add member return final string address member get address if string util equal address ip key word string util start with address ip key word result add member return rest result util success result the client can get all the naco node information in the current cluster accord to this interface get map value simple node public rest result collection string list simple node return rest result util success member manager get member address info get map health public rest result string get health return rest result util success member manager get self get state name other node return they own metadata information param node link member return link rest result post mapping value report public rest result string report request body member node if node check return rest result util fail with msg node information be illegal logger util print if debug enable logger cluster node state report receive info node node set state node state up node set fail access cnt boolean result member manager update node return rest result util success boolean to string result address mode switch param type member lookup name return link rest result post mapping value switch lookup public rest result string switch lookup request param name type string type try member manager switch lookup type return rest result util success catch throwable ex return rest result util fail ex get message member leave param param member ip list example ip1 port1 ip2 port2 return link rest result throw exception link exception post mapping server leave public rest result string leave request body collection string param throw exception collection member member list member util multi parse param member manager member leave member list final n async http client async http client http client manager get async http client final generic type rest result string generic type new generic type rest result string final collection member notify list member manager all member without self notify list remove all member list count down latch latch new count down latch notify list size for member member notify list final string url http util build url false member get address application util get context path common naco core context cluster server leave async http client post url header empty query empty param generic type get type new callback string override public void on receive rest result string result try if result ok logger util print if debug enable logger cluster the node success to process the request member member util on success member else logger cluster warn the node fail to process the request response be member result member util on fail member finally latch count down override public void on error throwable throwable try logger cluster error fail to communicate with the node member member util on fail member finally latch count down try latch await time unit millisecond return rest result util success ok catch throwable ex return rest result util fail ex get message 
api controller rest controller deprecate request mapping util and common naco name context api public class api controller extend instance controller autowire private distro mapper distro mapper autowire private service manager service manager get all dom service name param request http request return dom service jackson json object throw exception exception request map all dom name public object node all dom name http servlet request request throw exception boolean responsible only boolean parse boolean web util optional request responsible only false map string set string dom map service manager get all service name object node result jackson util create empty json node for old dn f client string dnsf version 1.0 string agent web util get user agent request client info client info new client info agent if client info type client info client type dn client info version compare to version util parse version dnsf version list string dom new array list string set string dom set null if dom map contain key constant default namespace id dom set dom map get constant default namespace id if collection util be empty dom set result put dom jackson util transfer to json node new hash set result put count return result for string dom dom set if distro mapper responsible dom responsible only dom add name util get service name dom result put dom jackson util transfer to json node dom result put count dom size return result map string set string dom new hash map int count for string namespace id dom map key set dom put namespace id new hash set for string dom dom map get namespace id if distro mapper responsible dom responsible only dom get namespace id add name util get service name dom count dom get namespace id size result put dom jackson util transfer to json node dom result put count count return result get service ip param request http request return service detail infomation throw exception exception request mapping srv i p x t response body public object node srv ipxt http servlet request request throw exception string namespace id web util optional request common param namespace id constant default namespace id string dom web util require request dom string agent web util get user agent request string cluster web util optional request cluster string util empty string client i p web util optional request client i p string util empty integer udp port integer parse int web util optional request udp port string env web util optional request env string util empty boolean be check boolean parse boolean web util optional request be check false string app web util optional request app string util empty string tenant web util optional request tid string util empty boolean healthy only boolean parse boolean web util optional request healthy only false return do srv ipxt namespace id name util get group name dom constant default group agent cluster client i p udp port env be check app tenant healthy only client report beat api param request http request return beat response throw exception exception can distro request mapping client beat public object node client beat http servlet request request throw exception override parameter request wrapper request wrapper override parameter request wrapper build request request request wrapper add parameter common param service name constant default group constant service info spliter web util require request dom return beat request wrapper 
api controller request map all dom name public object node all dom name http servlet request request throw exception boolean responsible only boolean parse boolean web util optional request responsible only false map string set string dom map service manager get all service name object node result jackson util create empty json node for old dn f client string dnsf version 1.0 string agent web util get user agent request client info client info new client info agent if client info type client info client type dn client info version compare to version util parse version dnsf version list string dom new array list string set string dom set null if dom map contain key constant default namespace id dom set dom map get constant default namespace id if collection util be empty dom set result put dom jackson util transfer to json node new hash set result put count return result for string dom dom set if distro mapper responsible dom responsible only dom add name util get service name dom result put dom jackson util transfer to json node dom result put count dom size return result map string set string dom new hash map int count for string namespace id dom map key set dom put namespace id new hash set for string dom dom map get namespace id if distro mapper responsible dom responsible only dom get namespace id add name util get service name dom count dom get namespace id size result put dom jackson util transfer to json node dom result put count count return result 
api controller request mapping srv i p x t response body public object node srv ipxt http servlet request request throw exception string namespace id web util optional request common param namespace id constant default namespace id string dom web util require request dom string agent web util get user agent request string cluster web util optional request cluster string util empty string client i p web util optional request client i p string util empty integer udp port integer parse int web util optional request udp port string env web util optional request env string util empty boolean be check boolean parse boolean web util optional request be check false string app web util optional request app string util empty string tenant web util optional request tid string util empty boolean healthy only boolean parse boolean web util optional request healthy only false return do srv ipxt namespace id name util get group name dom constant default group agent cluster client i p udp port env be check app tenant healthy only 
api controller can distro request mapping client beat public object node client beat http servlet request request throw exception override parameter request wrapper request wrapper override parameter request wrapper build request request request wrapper add parameter common param service name constant default group constant service info spliter web util require request dom return beat request wrapper 
catalog controller rest controller request map util and common naco name context catalog public class catalog controller autowire protected service manager service manager get service detail param namespace id namespace id param service name service name return service detail information throw naco exception naco exception secure parser name resource parser class action action type read get mapping service public object node service detail request param default value constant default namespace id string namespace id string service name throw naco exception service detailed service service manager get service namespace id service name if detailed service null throw new naco exception naco exception not find service service name be not find object node service object jackson util create empty json node service object put name name util get service name service name service object put protect threshold detailed service get protect threshold service object put group name name util get group name service name service object replace selector jackson util transfer to json node detailed service get selector service object replace metadata jackson util transfer to json node detailed service get metadata object node detail view jackson util create empty json node detail view replace service service object list cluster cluster new array list for com alibaba naco name core cluster cluster detailed service get cluster map value cluster cluster view new cluster cluster view set name cluster get name cluster view set health checker cluster get health checker cluster view set metadata cluster get metadata cluster view set use i p port4 check cluster be use i p port4 check cluster view set default port cluster get default port cluster view set default check port cluster get default check port cluster view set service name cluster get service get name cluster add cluster view detail view replace cluster jackson util transfer to json node cluster return detail view list instance of special service param namespace id namespace id param service name service name param cluster name cluster name param page number of page param page size size of each page return instance information throw naco exception naco exception secure parser name resource parser class action action type read request mapping value instance public object node instance list request param default value constant default namespace id string namespace id request param string service name request param string cluster name request param name page no int page request param int page size throw naco exception service service service manager get service namespace id service name if service null throw new naco exception naco exception not find serivce service name be not find if service get cluster map contain key cluster name throw new naco exception naco exception not find cluster cluster name be not find list instance instance service get cluster map get cluster name all i ps int start page page size int end page page size if start start if start instance size start instance size if end instance size end instance size object node result jackson util create empty json node result replace list jackson util transfer to json node instance sub list start end result put count instance size return result list service detail information param with instance whether return instance param namespace id namespace id param page no number of page param page size size of each page param service name service name param group name group name param contain instance instance name pattern which will be contain in detail param have ip count whether filter service with empty instance return list service detail secure parser name resource parser class action action type read get mapping service public object list detail request param require false boolean with instance request param default value constant default namespace id string namespace id request param require false int page no request param require false int page size request param name service name param default value string util empty string service name request param name group name param default value string util empty string group name request param name instance default value string util empty string contain instance request param require false boolean have ip count string param string util be blank service name string util be blank group name string util empty naming util get group name service name group name if with instance list service detail info service detail info list new array list list service service new array list service manager get page service namespace id page no page size param string util empty service false for service service service service detail info service detail info new service detail info service detail info set service name name util get service name service get name service detail info set group name name util get group name service get name service detail info set metadata service get metadata map string cluster info cluster info map get string cluster info map service service detail info set cluster map cluster info map service detail info list add service detail info return service detail info list object node result jackson util create empty json node list service service new array list final int total service manager get page service namespace id page no page size param contain instance service have ip count if collection util be empty service result replace service list jackson util transfer to json node collection empty list result put count return result list service view service view new link list for service service service service view service view new service view service view set name name util get service name service get name service view set group name name util get group name service get name service view set cluster count service get cluster map size service view set ip count service all i ps size service view set healthy instance count service healthy instance count service view set trigger flag service trigger flag true false service view add service view result replace service list jackson util transfer to json node service view result put count total return result get response time of service param request http request return response time information request mapping rt service public object node rt4 service http servlet request request string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name service service service manager get service namespace id service name if service null throw new illegal argument exception request service doesn t exist object node result jackson util create empty json node array node cluster jackson util create empty array node for map entry string com alibaba naco name core cluster entry service get cluster map entry set object node packet jackson util create empty json node health check task task entry get value get health check task packet put name entry get key packet put check r t best task get check rt best packet put check r t worst task get check rt worst packet put check r t normalize task get check rt normalize cluster add packet result replace cluster cluster return result private map string cluster info get string cluster info map service service map string cluster info cluster info map new hash map service get cluster map for each cluster name cluster cluster info cluster info new cluster info list ip address info ip address info get ip address info cluster all i ps cluster info set host ip address info cluster info map put cluster name cluster info return cluster info map private list ip address info get ip address info list instance instance list ip address info ip address info new array list instance for each ip address ip address info ip address info new ip address info ip address info set ip ip address get ip ip address info set port ip address get port ip address info set metadata ip address get metadata ip address info set valid ip address be healthy ip address info set weight ip address get weight ip address info set enable ip address be enable ip address info add ip address info return ip address info 
catalog controller secure parser name resource parser class action action type read request mapping value instance public object node instance list request param default value constant default namespace id string namespace id request param string service name request param string cluster name request param name page no int page request param int page size throw naco exception service service service manager get service namespace id service name if service null throw new naco exception naco exception not find serivce service name be not find if service get cluster map contain key cluster name throw new naco exception naco exception not find cluster cluster name be not find list instance instance service get cluster map get cluster name all i ps int start page page size int end page page size if start start if start instance size start instance size if end instance size end instance size object node result jackson util create empty json node result replace list jackson util transfer to json node instance sub list start end result put count instance size return result 
catalog controller request mapping rt service public object node rt4 service http servlet request request string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name service service service manager get service namespace id service name if service null throw new illegal argument exception request service doesn t exist object node result jackson util create empty json node array node cluster jackson util create empty array node for map entry string com alibaba naco name core cluster entry service get cluster map entry set object node packet jackson util create empty json node health check task task entry get value get health check task packet put name entry get key packet put check r t best task get check rt best packet put check r t worst task get check rt worst packet put check r t normalize task get check rt normalize cluster add packet result replace cluster cluster return result 
cluster controller rest controller request map util and common naco name context cluster public class cluster controller autowire protected service manager service manager update cluster param request http request return ok if success throw exception if fail put mapping secure action action type write public string update http servlet request request throw exception string namespace id web util optional request common param namespace id constant default namespace id string cluster name web util require request common param cluster name string service name web util require request common param service name string check port web util require request check port service service service manager get service namespace id service name if service null throw new naco exception naco exception invalid param service not find service name cluster cluster service get cluster map get cluster name if cluster null logger srv log warn update cluster cluster not exist will create it service cluster name service name cluster new cluster cluster name service cluster set def ckport number util to int check port cluster set use i p port4 check boolean util to boolean web util require request use instance port4 check abstract health checker abstract health checker health checker factory deserialize web util require request health checker cluster set health checker abstract health checker cluster set metadata util and common parse metadata web util optional request metadata string util empty cluster init service get cluster map put cluster name cluster service set last modify millis system current time millis service recalculate checksum service validate service manager add or replace service service return ok 
distro controller rest controller request map util and common naco name context distro public class distro controller autowire private serializer serializer autowire private distro consistency service impl consistency service autowire private datum store data store autowire private service manager service manager autowire private switch domain switch domain synchronize datum param datum map datum map return ok if success throw exception if fail put mapping datum public response entity on sync datum request body map string datum instance datum map throw exception if datum map be empty logger distro error on sync receive empty entity throw new naco exception naco exception invalid param receive empty entity for map entry string datum instance entry datum map entry set if key builder match ephemeral instance list key entry get key string namespace id key builder get namespace entry get key string service name key builder get service name entry get key if service manager contain service namespace id service name switch domain be default instance ephemeral service manager create empty service namespace id service name true consistency service on put entry get key entry get value value return response entity ok ok checksum param source source server param datum map checksum map return ok put mapping checksum public response entity sync checksum request param string source request body map string string datum map consistency service on receive checksum datum map source return response entity ok ok get datum param body key of datum return datum throw exception if fail get map datum public response entity get request body string body throw exception json node body node jackson util to obj body string key body node get key as text string key splitter map string datum datum map new hash map for string key key split key splitter datum datum consistency service get key if datum null continue datum map put key datum byte content serializer serialize datum map return response entity ok content get all datum return all datum get map datum public response entity get all datum byte content serializer serialize datum store get datum map return response entity ok content 
health controller rest controller name health controller request map util and common naco name context health public class health controller autowire private service manager service manager autowire private push service push service just a health check return hello message request mapping server public object node server object node result jackson util create empty json node result put msg hello i be naco name and healthy total service raft service manager get service count local port application util get port return result update health check for instance param request http request return ok if success can distro put mapping value instance secure action action type write public string update http servlet request request string healthy string web util optional request healthy string util empty if string util be blank healthy string healthy string web util optional request valid string util empty if string util be blank healthy string throw new illegal argument exception param healthy be require boolean valid boolean util to boolean healthy string string service name web util require request common param service name string namespace id web util optional request common param namespace id constant default namespace id string cluster name web util optional request common param cluster name util and common default cluster name string ip web util require request ip int port integer parse int web util require request port service service service manager get service namespace id service name only health check none need update health status with api if health check type none name equal service get cluster map get cluster name get health checker get type for instance instance service all i ps list new array list cluster name if instance get ip equal ip instance get port port instance set healthy valid logger evt log info valid ip enable ip disabled ip instance get ip instance get port instance get cluster name service service name msg update think health controller api push service service change service break else throw new illegal argument exception health check be still work service service name return ok get all health checkers return health checkers map get map checkers public response entity checkers list class extend abstract health checker class health check type get load health checker class map string abstract health checker checker map new hash map for class extend abstract health checker clazz class try abstract health checker checker clazz new instance checker map put checker get type checker catch instantiation exception illegal access exception e logger evt log error checker error e return response entity ok checker map 
health controller request mapping server public object node server object node result jackson util create empty json node result put msg hello i be naco name and healthy total service raft service manager get service count local port application util get port return result 
instance controller rest controller request map util and common naco name context instance public class instance controller autowire private switch domain switch domain autowire private push service push service autowire private service manager service manager private datum source push datum source new datum source override public string get datum push service push client client object node result jackson util create empty json node try result do srv ipxt client get namespace id client get service name client get agent client get cluster client get socket addr get address get host address string util empty false string util empty string util empty false catch exception e logger srv log warn push service service be not modify e overdrive the cache milli to push mode result put cache milli switch domain get push cache millis client get service name return result to string register new instance param request http request return ok if success throw exception any error during register can distro post mapping secure parser name resource parser class action action type write public string register http servlet request request throw exception final string service name web util require request common param service name final string namespace id web util optional request common param namespace id constant default namespace id final instance instance parse instance request service manager register instance namespace id service name instance return ok deregister instance param request http request return ok if success throw exception any error during deregister can distro delete mapping secure parser name resource parser class action action type write public string deregister http servlet request request throw exception instance instance get ip address request string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name service service service manager get service namespace id service name if service null logger srv log warn remove instance from non exist service service name return ok service manager remove instance namespace id service name instance be ephemeral instance return ok update instance param request http request return ok if success throw exception any error during update can distro put mapping secure parser name resource parser class action action type write public string update http servlet request request throw exception final string service name web util require request common param service name final string namespace id web util optional request common param namespace id constant default namespace id final instance instance parse instance request string agent web util get user agent request client info client info new client info agent if client info type client info client type java client info version compare to version util parse version 1.0 service manager update instance namespace id service name instance else service manager register instance namespace id service name instance return ok patch instance param request http request return ok if success throw exception any error during patch can distro patch mapping secure parser name resource parser class action action type write public string patch http servlet request request throw exception string service name web util require request common param service name string namespace id web util optional request common param namespace id constant default namespace id string ip web util require request ip string port web util require request port string cluster web util optional request common param cluster name string util empty if string util be blank cluster cluster web util optional request cluster util and common default cluster name instance instance service manager get instance namespace id service name cluster ip integer parse int port if instance null throw new illegal argument exception instance not find string metadata web util optional request metadata string util empty if string util be not blank metadata instance set metadata util and common parse metadata metadata string app web util optional request app string util empty if string util be not blank app instance set app app string weight web util optional request weight string util empty if string util be not blank weight instance set weight double parse double weight string healthy web util optional request healthy string util empty if string util be not blank healthy instance set healthy boolean util to boolean healthy string enable string web util optional request enable string util empty if string util be not blank enable string instance set enable boolean util to boolean enable string instance set last beat system current time millis instance validate service manager update instance namespace id service name instance return ok get all instance of input service param request http request return list of instance throw exception any error during list get mapping list secure parser name resource parser class action action type read public object node list http servlet request request throw exception string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name string agent web util get user agent request string cluster web util optional request cluster string util empty string client i p web util optional request client i p string util empty int udp port integer parse int web util optional request udp port string env web util optional request env string util empty boolean be check boolean parse boolean web util optional request be check false string app web util optional request app string util empty string tenant web util optional request tid string util empty boolean healthy only boolean parse boolean web util optional request healthy only false return do srv ipxt namespace id service name agent cluster client i p udp port env be check app tenant healthy only get detail information of specify instance param request http request return detail information of instance throw exception any error during get get map secure parser name resource parser class action action type read public object node detail http servlet request request throw exception string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name string cluster web util optional request common param cluster name util and common default cluster name string ip web util require request ip int port integer parse int web util require request port service service service manager get service namespace id service name if service null throw new naco exception naco exception not find no service service name find list string cluster new array list cluster add cluster list instance ip service all i ps cluster if ips null ip be empty throw new naco exception naco exception not find no ip find for cluster cluster in service service name for instance instance ip if instance get ip equal ip instance get port port object node result jackson util create empty json node result put service service name result put ip ip result put port port result put cluster name cluster result put weight instance get weight result put healthy instance be healthy result put metadata jackson util transfer to json node instance get metadata result put instance id instance get instance id return result throw new naco exception naco exception not find no match ip find create a beat for instance param request http request return detail information of instance throw exception any error during handle can distro put mapping beat secure parser name resource parser class action action type write public object node beat http servlet request request throw exception object node result jackson util create empty json node result put client beat interval switch domain get client beat interval string beat web util optional request beat string util empty rs info client beat null if string util be not blank beat client beat jackson util to obj beat rs info class string cluster name web util optional request common param cluster name util and common default cluster name string ip web util optional request ip string util empty int port integer parse int web util optional request port if client beat null if string util be not blank client beat get cluster cluster name client beat get cluster else fix client beat set cluster cluster name ip client beat get ip port client beat get port string service name web util require request common param service name string namespace id web util optional request common param namespace id constant default namespace id logger srv log debug client beat full argument beat service name client beat service name instance instance service manager get instance namespace id service name cluster name ip port if instance null if client beat null result put common param code name response code resource not find return result logger srv log warn client beat the instance have be remove for health mechanism perform datum compensation operation beat service name client beat service name instance new instance instance set port client beat get port instance set ip client beat get ip instance set weight client beat get weight instance set metadata client beat get metadata instance set cluster name cluster name instance set service name service name instance set instance id instance get instance id instance set ephemeral client beat be ephemeral service manager register instance namespace id service name instance service service service manager get service namespace id service name if service null throw new naco exception naco exception server error service not find service name namespace id if client beat null client beat new rs info client beat set ip ip client beat set port port client beat set cluster cluster name service process client beat client beat result put common param code name response code ok result put client beat interval instance get instance heart beat interval result put switch entry light beat enable switch domain be light beat enable return result list all instance with health status param key namespace service name return list of instance throw naco exception any error during handle request mapping status public object node list with health status request param string key throw naco exception string service name string namespace id if key contain util and common namespace service connector namespace id key split util and common namespace service connector service name key split util and common namespace service connector else namespace id constant default namespace id service name key service service service manager get service namespace id service name if service null throw new naco exception naco exception not find service service name not find list instance ip service all i ps object node result jackson util create empty json node array node ip array jackson util create empty array node for instance ip ip ip array add ip to ip addr ip be healthy result replace ips ip array return result private instance parse instance http servlet request request throw exception string service name web util require request common param service name string app web util optional request app default instance instance get ip address request instance set app app instance set service name service name generate simple instance id first this value would be update accord to instance id generator instance set instance id instance generate instance id instance set last beat system current time millis string metadata web util optional request metadata string util empty if string util be not empty metadata instance set metadata util and common parse metadata metadata instance validate return instance private instance get ip address http servlet request request final string ip web util require request ip final string port web util require request port string cluster web util optional request common param cluster name string util empty if string util be blank cluster cluster web util optional request cluster util and common default cluster name string enable string web util optional request enable string util empty boolean enable if string util be blank enable string enable boolean util to boolean web util optional request enable true else enable boolean util to boolean enable string boolean ephemeral boolean util to boolean web util optional request ephemeral string value of switch domain be default instance ephemeral string weight web util optional request weight boolean healthy boolean util to boolean web util optional request healthy true instance instance new instance instance set port integer parse int port instance set ip ip instance set weight double parse double weight instance set cluster name cluster instance set healthy healthy instance set enable enable instance set ephemeral ephemeral return instance private void check if disabled service service throw exception if service get enable throw new exception service be disabled now get service full information with instance param namespace id namespace id param service name service name param agent agent infor string param cluster cluster name param client i p client ip param udp port push udp port param env env param be check be check request param app app name param tid tenant param healthy only whether only for healthy check return service full information with instance throw exception any error during handle public object node do srv ipxt string namespace id string service name string agent string cluster string client i p int udp port string env boolean be check string app string tid boolean healthy only throw exception client info client info new client info agent object node result jackson util create empty json node service service service manager get service namespace id service name if service null if logger srv log be debug enable logger srv log debug no instance to serve for service service name result put name service name result put cluster cluster result replace host jackson util create empty array node return result check if disabled service long cache milli switch domain get default cache milli now try to enable the push try if udp port push service can enable push agent push service add client namespace id service name cluster agent new inet socket address client i p udp port push datum source tid app cache milli switch domain get push cache millis service name catch exception e logger srv log error naco api fail to add push client client info client i p udp port e cache milli switch domain get default cache millis list instance srved i ps srved i ps service srv i ps array as list string util split cluster filter ip use selector if service get selector null string util be not blank client i p srved i ps service get selector select client i p srved i ps if collection util be empty srved i ps if logger srv log be debug enable logger srv log debug no instance to serve for service service name if client info type client info client type java client info version compare to version util parse version 1.0 result put dom service name else result put dom name util get service name service name result put host jackson util create empty array node result put name service name result put cache millis cache millis result put last ref time system current time millis result put checksum service get checksum result put use specify u be l false result put cluster cluster result put env env result put metadata jackson util transfer to json node service get metadata return result map boolean list instance ip map new hash map ip map put boolean true new array list ip map put boolean false new array list for instance ip srved i ps ip map get ip be healthy add ip if be check result put reach protect threshold false double threshold service get protect threshold if float ip map get boolean true size srved i ps size threshold logger srv log warn protect threshold reach return all ip service service name if be check result put reach protect threshold true ip map get boolean true add all ip map get boolean false ip map get boolean false clear if be check result put protect threshold service get protect threshold result put reach local site call threshold false return jackson util create empty json node array node host jackson util create empty array node for map entry boolean list instance entry ip map entry set list instance ip entry get value if healthy only entry get key continue for instance instance ip remove disabled instance if instance be enable continue object node ip obj jackson util create empty json node ip obj put ip instance get ip ip obj put port instance get port deprecate since naco 1.0 ip obj put valid entry get key ip obj put healthy entry get key ip obj put marked instance be marked ip obj put instance id instance get instance id ip obj put metadata jackson util transfer to json node instance get metadata ip obj put enable instance be enable ip obj put weight instance get weight ip obj put cluster name instance get cluster name if client info type client info client type java client info version compare to version util parse version 1.0 ip obj put service name instance get service name else ip obj put service name name util get service name instance get service name ip obj put ephemeral instance be ephemeral host add ip obj result replace host host if client info type client info client type java client info version compare to version util parse version 1.0 result put dom service name else result put dom name util get service name service name result put name service name result put cache millis cache millis result put last ref time system current time millis result put checksum service get checksum result put use specify u be l false result put cluster cluster result put env env result replace metadata jackson util transfer to json node service get metadata return result 
instance controller request mapping status public object node list with health status request param string key throw naco exception string service name string namespace id if key contain util and common namespace service connector namespace id key split util and common namespace service connector service name key split util and common namespace service connector else namespace id constant default namespace id service name key service service service manager get service namespace id service name if service null throw new naco exception naco exception not find service service name not find list instance ip service all i ps object node result jackson util create empty json node array node ip array jackson util create empty array node for instance ip ip ip array add ip to ip addr ip be healthy result replace ips ip array return result 
operator controller rest controller request map util and common naco name context operator util and common naco name context op public class operator controller private final push service push service private final switch manager switch manager private final server list manager server list manager private final service manager service manager private final server member manager member manager private final server status manager server status manager private final switch domain switch domain private final distro mapper distro mapper private final raft core raft core public operator controller push service push service switch manager switch manager server list manager server list manager service manager service manager server member manager member manager server status manager server status manager switch domain switch domain distro mapper distro mapper raft core raft core this push service push service this switch manager switch manager this server list manager server list manager this service manager service manager this member manager member manager this server status manager server status manager this switch domain switch domain this distro mapper distro mapper this raft core raft core get push metric status param detail whether return detail information param reset whether reset metric information after return information return push metric status request mapping push state public object node push state request param require false boolean detail request param require false boolean reset object node result jackson util create empty json node list push service receiver ack entry fail push push service get fail push int fail push count push service get fail push count result put succeed push service get total push fail push count result put total push service get total push if push service get total push result put ratio float push service get total push fail push count push service get total push else result put ratio array node datum array jackson util create empty array node if detail for push service receiver ack entry entry fail push try datum array add new string entry origin get datum utf catch unsupported encode exception e datum array add encode failure result replace datum datum array if reset push service reset push state result put reset reset return result get switch information param request no used return switch domain get map switch public switch domain switch http servlet request request return switch domain update switch information param debug whether debug param entry item entry of switch link switch entry param value switch value return ok if success throw exception exception secure resource naming switch action action type write put mapping switch public string update switch request param require false boolean debug request param string entry request param string value throw exception switch manager update entry value debug return ok get metric information param request request return metric information secure resource name metric action action type read get map metric public object node metric http servlet request request object node result jackson util create empty json node int service count service manager get service count int ip count service manager get instance count int responsible dom count service manager get responsible service count int responsible ip count service manager get responsible instance count result put status server status manager get server status name result put service count service count result put instance count ip count result put raft notify task count raft core get notify task count result put responsible service count responsible dom count result put responsible instance count responsible ip count result put cpu application util get c p u result put load application util get load result put mem application util get mem return result get map distro server public object node get responsible server4 service request param default value constant default namespace id string namespace id request param string service name service service service manager get service namespace id service name if service null throw new illegal argument exception service not find object node result jackson util create empty json node result put responsible server distro mapper map srv service name return result get distro metric status param action action return distro metric status get map distro status public object node distro status request param default value view string action object node result jackson util create empty json node if string util equal switch entry action view action result replace status jackson util transfer to json node member manager all member return result return result get map server public object node get healthy server list request param require false boolean healthy object node result jackson util create empty json node if healthy list member healthy member member manager all member stream filter member member get state node state up collect array list new array list add array list add all result replace server jackson util transfer to json node healthy member else result replace server jackson util transfer to json node member manager all member return result this interface will be remove in a future release param server status server status return ok deprecate 1.3 this function will be delete sometime after version 1.3 deprecate request mapping server status public string server status request param string server status server list manager on receive server status server status return ok put mapping log public string set log level request param string log name request param string log level logger set log level log name log level return ok this interface will be remove in a future release return link json node deprecate 1.3 this function will be delete sometime after version 1.3 deprecate request mapping value cluster state method request method get public json node get cluster state return jackson util transfer to json node service manager get my self cluster state 
operator controller request mapping push state public object node push state request param require false boolean detail request param require false boolean reset object node result jackson util create empty json node list push service receiver ack entry fail push push service get fail push int fail push count push service get fail push count result put succeed push service get total push fail push count result put total push service get total push if push service get total push result put ratio float push service get total push fail push count push service get total push else result put ratio array node datum array jackson util create empty array node if detail for push service receiver ack entry entry fail push try datum array add new string entry origin get datum utf catch unsupported encode exception e datum array add encode failure result replace datum datum array if reset push service reset push state result put reset reset return result 
operator controller deprecate request mapping server status public string server status request param string server status server list manager on receive server status server status return ok 
operator controller deprecate request mapping value cluster state method request method get public json node get cluster state return jackson util transfer to json node service manager get my self cluster state 
raft controller rest controller request map util and common naco name context raft util and common naco server context util and common naco name context raft public class raft controller autowire private raft consistency service impl raft consistency service autowire private service manager service manager autowire private raft core raft core raft vote api param request http request param response http response return peer information throw exception exception post mapping vote public json node vote http servlet request request http servlet response response throw exception raft peer peer raft core receive vote jackson util to obj web util require request vote raft peer class return jackson util transfer to json node peer beat api param request http request param response http response return peer information throw exception exception post mapping beat public json node beat http servlet request request http servlet response response throw exception string entity new string io util try decompress request get input stream standard charset utf string value u r l decoder decode entity utf value u r l decoder decode value utf json node json jackson util to obj value raft peer peer raft core receive beat jackson util to obj json get beat as text return jackson util transfer to json node peer get peer information param request http request param response http response return peer information get mapping peer public json node get peer http servlet request request http servlet response response list raft peer peer raft core get peer raft peer peer null for raft peer peer1 peer if string util equal peer1 ip net util local server peer peer1 if peer null peer new raft peer peer ip net util local server return jackson util transfer to json node peer datum reload request param request http request param response http response return ok if success throw exception exception put mapping datum reload public string reload datum http servlet request request http servlet response response throw exception string key web util require request key raft core load datum key return ok publish datum param request http request param response http response return ok if success throw exception exception post mapping datum public string publish http servlet request request http servlet response response throw exception response set header content type application json charset get accept encode request response set header cache control no cache response set header content encode gzip string entity io util to string request get input stream utf string value u r l decoder decode entity utf json node json jackson util to obj value string key json get key as text if key builder match instance list key key raft consistency service put key jackson util to obj json get value to string instance class return ok if key builder match switch key key raft consistency service put key jackson util to obj json get value to string switch domain class return ok if key builder match service meta key key raft consistency service put key jackson util to obj json get value to string service class return ok throw new naco exception naco exception invalid param unknown type publish key key remove datum param request http request param response http response return ok if success throw exception exception delete mapping datum public string delete http servlet request request http servlet response response throw exception response set header content type application json charset get accept encode request response set header cache control no cache response set header content encode gzip raft consistency service remove web util require request key return ok get datum param request http request param response http response return datum throw exception exception get map datum public string get http servlet request request http servlet response response throw exception response set header content type application json charset get accept encode request response set header cache control no cache response set header content encode gzip string key string web util require request key key string u be l decoder decode key string utf string key key string split list datum datum new array list datum for string key key datum datum raft core get datum key datum add datum return jackson util to json datum get state of raft peer param request http request param response http response return datum throw exception exception get map state public json node state http servlet request request http servlet response response throw exception response set header content type application json charset get accept encode request response set header cache control no cache response set header content encode gzip object node result jackson util create empty json node result put service service manager get service count result replace peer jackson util transfer to json node raft core get peer return result commit publish datum param request http request param response http response return ok if success throw exception exception post mapping datum commit public string on publish http servlet request request http servlet response response throw exception response set header content type application json charset get accept encode request response set header cache control no cache response set header content encode gzip string entity io util to string request get input stream utf string value u r l decoder decode entity utf json node json object jackson util to obj value string key key raft peer source jackson util to obj json object get source to string raft peer class json node datum json json object get datum datum datum null if key builder match instance list key datum json get key as text datum jackson util to obj json object get datum to string new type reference datum instance else if key builder match switch key datum json get key as text datum jackson util to obj json object get datum to string new type reference datum switch domain else if key builder match service meta key datum json get key as text datum jackson util to obj json object get datum to string new type reference datum service raft consistency service on put datum source return ok commit delete datum param request http request param response http response return ok if success throw exception exception delete mapping datum commit public string on delete http servlet request request http servlet response response throw exception response set header content type application json charset get accept encode request response set header cache control no cache response set header content encode gzip string entity io util to string request get input stream utf string value u r l decoder decode entity utf value u r l decoder decode value utf json node json object jackson util to obj value datum datum jackson util to obj json object get datum to string datum class raft peer source jackson util to obj json object get source to string raft peer class raft consistency service on remove datum source return ok elect leader api param request http request param response http response return leader peer information get map leader public json node get leader http servlet request request http servlet response response object node result jackson util create empty json node result put leader jackson util to json raft core get leader return result get all listener param request http request param response http response return all listener information get map listener public json node get all listener http servlet request request http servlet response response object node result jackson util create empty json node map string list record listener listener raft core get listener array node listener array jackson util create empty array node for string key listener key set listener array add key result replace listener listener array return result public static string get accept encode http servlet request req string encode string util default if empty req get header accept charset utf encode encode contain encode substring encode index of encode return encode contain encode substring encode index of encode 
service controller rest controller request map util and common naco name context service public class service controller autowire protected service manager service manager autowire private distro mapper distro mapper autowire private server member manager member manager autowire private subscribe manager subscribe manager create a new service param namespace id namespace id param service name service name param protect threshold protect threshold param metadata service metadata param selector selector return ok if success throw exception exception post mapping secure parser name resource parser class action action type write public string create request param default value constant default namespace id string namespace id request param string service name request param require false float protect threshold request param default value string util empty string metadata request param default value string util empty string selector throw exception if service manager get service namespace id service name null throw new illegal argument exception specify service already exist service name service name map string string metadata map new hash map if string util be not blank metadata metadata map util and common parse metadata metadata service service new service service name service set protect threshold protect threshold service set enable true service set metadata metadata map service set selector parse selector selector service set namespace id namespace id now valid the service if fail exception will be throw service set last modify millis system current time millis service recalculate checksum service validate service manager add or replace service service return ok remove service param namespace id namespace param service name service name return ok if success throw exception exception delete mapping secure parser name resource parser class action action type write public string remove request param default value constant default namespace id string namespace id request param string service name throw exception service manager easy remove service namespace id service name return ok get detail of service param namespace id namespace param service name service name return detail information of service throw naco exception naco exception get map secure parser name resource parser class action action type read public object node detail request param default value constant default namespace id string namespace id request param string service name throw naco exception service service service manager get service namespace id service name if service null throw new naco exception naco exception not find service service name be not find object node re jackson util create empty json node re put name name util get service name service name re put namespace id service get namespace id re put protect threshold service get protect threshold re replace metadata jackson util transfer to json node service get metadata re replace selector jackson util transfer to json node service get selector re put group name name util get group name service name array node cluster jackson util create empty array node for cluster cluster service get cluster map value object node cluster json jackson util create empty json node cluster json put name cluster get name cluster json replace health checker jackson util transfer to json node cluster get health checker cluster json replace metadata jackson util transfer to json node cluster get metadata cluster add cluster json re replace cluster cluster return re list all service name param request http request return all service name throw exception exception get mapping list secure parser name resource parser class action action type read public object node list http servlet request request throw exception final int page no number util to int web util require request page no final int page size number util to int web util require request page size string namespace id web util optional request common param namespace id constant default namespace id string group name web util optional request common param group name constant default group string selector string web util optional request selector string util empty list string service name list service manager get all service name list namespace id object node result jackson util create empty json node if service name list null service name list be empty result replace dom jackson util transfer to json node collection empty list result put count return result service name list remove if service name service name start with group name constant service info spliter if string util be not blank selector string json node selector json jackson util to obj selector string selector type selector type selector type value of selector json get type as text string expression selector json get expression as text if selector type label equal selector type string util be not blank expression expression string util delete whitespace expression now we only support the following expression instance metadata xxx yyy or service metadata xxx yyy string term expression split string factor term split switch factor case instance service name list filter instance metadata namespace id service name list factor factor length term replace break case service service name list filter service metadata namespace id service name list factor factor length term replace break default break int start page no page size if start start int end start page size if end service name list size end service name list size for int i start i end i service name list set i service name list get i replace group name constant service info spliter result replace dom jackson util transfer to json node service name list sub list start end result put count service name list size return result update service param request http request return ok if success throw exception exception put mapping secure parser name resource parser class action action type write public string update http servlet request request throw exception string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name float protect threshold number util to float web util require request protect threshold string metadata web util optional request metadata string util empty service service service manager get service namespace id service name if service null throw new naco exception naco exception invalid param service service name not find service set protect threshold protect threshold map string string metadata map util and common parse metadata metadata service set metadata metadata map service set selector parse selector web util optional request selector string util empty service set last modify millis system current time millis service recalculate checksum service validate service manager add or replace service service return ok search service param namespace id namespace param expr search pattern param responsible only whether only search responsible service return search result request mapping name secure parser name resource parser class action action type read public object node search service request param default value string util empty string namespace id request param default value string util empty string expr request param require false boolean responsible only map string list service service new hash map if string util be not blank namespace id service put namespace id service manager search service namespace id constant any pattern expr constant any pattern else for string namespace service manager get all namespace service put namespace service manager search service namespace constant any pattern expr constant any pattern map string set string service name map new hash map for string namespace service key set service name map put namespace new hash set for service service service get namespace if distro mapper responsible service get name responsible only service name map get namespace add name util get service name service get name object node result jackson util create empty json node result replace service jackson util transfer to json node service name map result put count service size return result check service status whether latest param request http request return ok if service status if latest otherwise fail or exception throw exception exception post mapping status public string service status http servlet request request throw exception string entity io util to string request get input stream utf string value u r l decoder decode entity utf json node json jackson util to obj value format service1 checksum service2 checksum string status json get status as text string server ip json get client i p as text if member manager have member server ip throw new naco exception naco exception invalid param ip server ip be not in serverlist try service manager service checksum checksum jackson util to obj status service manager service checksum class if checksum null logger srv log warn domain status receive malformed datum null return fail for map entry string string entry checksum service name2 checksum entry set if entry null string util be empty entry get key string util be empty entry get value continue string service name entry get key string checksum entry get value service service service manager get service checksum namespace id service name if service null continue service recalculate checksum if checksum equal service get checksum if logger srv log be debug enable logger srv log debug checksum of be not consistent remote checksum local service name server ip checksum service get checksum service manager add updated service to queue checksum namespace id service name server ip checksum catch exception e logger srv log warn domain status receive malformed datum status e return ok get checksum of one service param request http request return checksum of one service throw exception exception put mapping checksum public object node checksum http servlet request request throw exception string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name service service service manager get service namespace id service name if service null throw new naco exception naco exception not find service name not find service name service recalculate checksum object node result jackson util create empty json node result put checksum service get checksum return result get subscriber list param request http request return jackson object node get map subscriber secure parser name resource parser class action action type read public object node subscriber http servlet request request int page no number util to int web util require request page no int page size number util to int web util require request page size string namespace id web util optional request common param namespace id constant default namespace id string service name web util require request common param service name boolean aggregation boolean parse boolean web util optional request aggregation string value of boolean true object node result jackson util create empty json node try list subscriber subscriber subscribe manager get subscriber service name namespace id aggregation int start page no page size if start start int end start page size int count subscriber size if end count end count result replace subscriber jackson util transfer to json node subscriber sub list start end result put count count return result catch exception e logger srv log warn query subscriber fail e result replace subscriber jackson util create empty array node result put count return result private list string filter instance metadata string namespace id list string service name string key string value list string filter service name new array list for string service name service name service service service manager get service namespace id service name if service null continue for instance address service all i ps if address get metadata null value equal address get metadata get key filter service name add service name break return filter service name private list string filter service metadata string namespace id list string service name string key string value list string filter service new array list for string service name service name service service service manager get service namespace id service name if service null continue if value equal service get metadatum get key filter service add service name return filter service private selector parse selector string selector json string throw exception if string util be blank selector json string return new none selector json node selector json jackson util to obj u r l decoder decode selector json string utf switch selector type value of selector json get type as text case none return new none selector case label string expression selector json get expression as text set string label label selector parse expression expression label selector label selector new label selector label selector set expression expression label selector set label label return label selector default throw new naco exception naco exception invalid param not match any type of selector 
service controller request mapping name secure parser name resource parser class action action type read public object node search service request param default value string util empty string namespace id request param default value string util empty string expr request param require false boolean responsible only map string list service service new hash map if string util be not blank namespace id service put namespace id service manager search service namespace id constant any pattern expr constant any pattern else for string namespace service manager get all namespace service put namespace service manager search service namespace constant any pattern expr constant any pattern map string set string service name map new hash map for string namespace service key set service name map put namespace new hash set for service service service get namespace if distro mapper responsible service get name responsible only service name map get namespace add name util get service name service get name object node result jackson util create empty json node result replace service jackson util transfer to json node service name map result put count service size return result 
test controller request mapping httpclient back public string back return welcome back 
test controller request mapping httpclient back id public string back path variable string id return welcome back id 
test controller request mapping okhttp back public string back return welcome back 
test controller request mapping okhttp back id public string back path variable string id return welcome back id 
app controller rest controller request mapping value app public class app controller autowire private app management app management get map name json public result list string query app http servlet request request return result of success app management get app name get map briefinfo json public result list app info query app info http servlet request request list app info list new array list app management get brief app collection sort list comparator compare app info get app return result of success list get mapping value app machine json public result list machine info vo get machine by app path variable app string app app info app info app management get detail app app if app info null return result of success null list machine info list new array list app info get machine collection sort list comparator compare machine info get app then compare machine info get ip then compare int machine info get port return result of success machine info vo from machine info list list request mapping value app machine remove json public result string remove machine by id path variable app string app request param name ip string ip request param name port int port app info app info app management get detail app app if app info null return result of success null if app management remove machine app ip port return result of success msg success else return result of fail remove fail 
app controller request mapping value app machine remove json public result string remove machine by id path variable app string app request param name ip string ip request param name port int port app info app info app management get detail app app if app info null return result of success null if app management remove machine app ip port return result of success msg success else return result of fail remove fail 
auth controller rest controller request map auth public class auth controller private static final logger logger logger factory get logger auth controller class value auth username sentinel private string auth username value auth password sentinel private string auth password autowire private auth service http servlet request auth service post mapping login public result auth service auth user login http servlet request request string username string password if string util be not blank dashboard config get auth username auth username dashboard config get auth username if string util be not blank dashboard config get auth password auth password dashboard config get auth password if auth username or auth password be blank set in application property or vm argument auth will pass as the front side validate the input which can t be blank so user can input any username or password both be not blank to login in that case if string util be not blank auth username auth username equal username string util be not blank auth password auth password equal password logger error login fail invalid username or password username username return result of fail invalid username or password auth service auth user auth user new simple web auth service impl simple web auth user impl username request get session set attribute simple web auth service impl web session key auth user return result of success auth user post mapping value logout public result logout http servlet request request request get session invalidate return result of success null post mapping value check public result check http servlet request request auth service auth user auth user auth service get auth user request if auth user null return result of fail not log in return result of success auth user 
authority rule controller rest controller request mapping value authority public class authority rule controller private final logger logger logger factory get logger authority rule controller class autowire private sentinel api client sentinel api client autowire private rule repository authority rule entity long repository get mapping rule auth action privilege type read rule public result list authority rule entity api query all rule for machine request param string app request param string ip request param integer port if string util be empty app return result of fail app can not be null or empty if string util be empty ip return result of fail ip can not be null or empty if port null port return result of fail invalid parameter port try list authority rule entity rule sentinel api client fetch authority rule of machine app ip port rule repository save all rule return result of success rule catch throwable throwable logger error error when query authority rule throwable return result of fail throwable get message private r result r check entity internal authority rule entity entity if entity null return result of fail bad rule body if string util be blank entity get app return result of fail app can t be null or empty if string util be blank entity get ip return result of fail ip can t be null or empty if entity get port null entity get port return result of fail port can t be null if entity get rule null return result of fail rule can t be null if string util be blank entity get resource return result of fail resource name can not be null or empty if string util be blank entity get limit app return result of fail limit app should be valid if entity get strategy rule constant authority white entity get strategy rule constant authority black return result of fail unknown strategy must be blacklist or whitelist return null post mapping rule auth action privilege type write rule public result authority rule entity api add authority rule request body authority rule entity entity result authority rule entity check result check entity internal entity if check result null return check result entity set id null date date new date entity set gmt create date entity set gmt modify date try entity repository save entity catch throwable throwable logger error fail to add authority rule throwable return result of throwable throwable if publish rule entity get app entity get ip entity get port logger info publish authority rule fail after rule add return result of success entity put mapping rule id auth action privilege type write rule public result authority rule entity api update param flow rule path variable id long id request body authority rule entity entity if id null id return result of fail invalid id result authority rule entity check result check entity internal entity if check result null return check result entity set id id date date new date entity set gmt create null entity set gmt modify date try entity repository save entity if entity null return result of fail fail to save authority rule catch throwable throwable logger error fail to save authority rule throwable return result of throwable throwable if publish rule entity get app entity get ip entity get port logger info publish authority rule fail after rule update return result of success entity delete mapping rule id auth action privilege type delete rule public result long api delete rule path variable id long id if id null return result of fail id can not be null authority rule entity old entity repository find by id id if old entity null return result of success null try repository delete id catch exception e return result of fail e get message if publish rule old entity get app old entity get ip old entity get port logger error publish authority rule fail after rule delete return result of success id private boolean publish rule string app string ip integer port list authority rule entity rule repository find all by machine machine info of app ip port return sentinel api client set authority rule of machine app ip port rule 
cluster assign controller rest controller request mapping cluster assign public class cluster assign controller private final logger logger logger factory get logger cluster assign controller class autowire private cluster assign service cluster assign service post map all server app public result cluster app assign result v o api assign all cluster server of app path variable string app request body cluster app full assign request assign request if string util be empty app return result of fail app can not be null or empty if assign request null assign request get cluster map null assign request get remaining list null return result of fail bad request body try return result of success cluster assign service apply assign to app app assign request get cluster map assign request get remaining list catch throwable throwable logger error error when assign full cluster server for app app throwable return result of fail throwable get message post mapping single server app public result cluster app assign result v o api assign single cluster server of app path variable string app request body cluster app single server assign request assign request if string util be empty app return result of fail app can not be null or empty if assign request null assign request get cluster map null return result of fail bad request body try return result of success cluster assign service apply assign to app app collection singleton list assign request get cluster map assign request get remaining list catch throwable throwable logger error error when assign single cluster server for app app throwable return result of fail throwable get message post mapping unbind server app public result cluster app assign result v o api unbind cluster server of app path variable string app request body set string machine id if string util be empty app return result of fail app can not be null or empty if machine id null machine id be empty return result of fail bad request body try return result of success cluster assign service unbind cluster server app machine id catch throwable throwable logger error error when unbind cluster server for app machine id app throwable return result of fail throwable get message 
cluster config controller rest controller request mapping value cluster public class cluster config controller private final logger logger logger factory get logger cluster config controller class private final sentinel version version140 new sentinel version set major version set minor version autowire private app management app management autowire private cluster config service cluster config service post mapping config modify single public result boolean api modify cluster config request body string payload if string util be blank payload return result of fail empty request body try j s o n object body json parse object payload if body contain key key mode int mode body get integer key mode switch mode case cluster state manager cluster client cluster client modify request datum json parse object payload cluster client modify request class result boolean re check valid request datum if res null return re cluster config service modify cluster client config datum get return result of success true case cluster state manager cluster server cluster server modify request d json parse object payload cluster server modify request class result boolean r check valid request d if r null return r todo bad design here should refactor cluster config service modify cluster server config d get return result of success true default return result of fail invalid mode return result of fail invalid parameter catch execution exception ex logger error error when modify cluster config ex get cause return error response ex catch throwable ex logger error error when modify cluster config ex return result of fail ex get message private t result t error response execution exception ex if be not support ex get cause return unsupported version else return result of throwable ex get cause get map state single public result cluster universal state v o api get cluster state request param string app request param string ip request param integer port if string util be empty app return result of fail app can not be null or empty if string util be empty ip return result of fail ip can not be null or empty if port null port return result of fail invalid parameter port if check if support app ip port return unsupported version try return cluster config service get cluster universal state app ip port then apply result of success get catch execution exception ex logger error error when fetch cluster state ex get cause return error response ex catch throwable throwable logger error error when fetch cluster state throwable return result of fail throwable get message get map server state app public result list app cluster server state wrap v o api get cluster server state of app path variable string app if string util be empty app return result of fail app can not be null or empty try return cluster config service get cluster universal state app then apply cluster entity util wrap to app cluster server state then apply result of success get catch execution exception ex logger error error when fetch cluster server state of app app ex get cause return error response ex catch throwable throwable logger error error when fetch cluster server state of app app throwable return result of fail throwable get message get map client state app public result list app cluster client state wrap v o api get cluster client state of app path variable string app if string util be empty app return result of fail app can not be null or empty try return cluster config service get cluster universal state app then apply cluster entity util wrap to app cluster client state then apply result of success get catch execution exception ex logger error error when fetch cluster token client state of app app ex get cause return error response ex catch throwable throwable logger error error when fetch cluster token client state of app app throwable return result of fail throwable get message get map state app public result list cluster universal state pair v o api get cluster state of app path variable string app if string util be empty app return result of fail app can not be null or empty try return cluster config service get cluster universal state app then apply result of success get catch execution exception ex logger error error when fetch cluster state of app app ex get cause return error response ex catch throwable throwable logger error error when fetch cluster state of app app throwable return result of fail throwable get message private boolean be not support throwable ex return ex instanceof command not find exception private boolean check if support string app string ip int port try return optional of nullable app management get detail app app flat map e e get machine ip port flat map m version util parse version m get version map v v greater or equal version140 or else true if error occur or can not retrieve machine info return true catch exception ex return true private result boolean check valid request cluster modify request request if string util be empty request get app return result of fail app can not be empty if string util be empty request get ip return result of fail ip can not be empty if request get port null request get port return result of fail invalid port if request get mode null request get mode return result of fail invalid mode if check if support request get app request get ip request get port return unsupported version return null private r result r unsupported version return result of fail sentinel client not support for cluster flow control unsupported version or dependency absent private static final string key mode mode 
degrade controller controller request mapping value degrade produce media type application json value public class degrade controller private final logger logger logger factory get logger degrade controller class autowire private in mem degrade rule store repository autowire private sentinel api client sentinel api client response body request mapping rule json auth action privilege type read rule public result list degrade rule entity query machine rule string app string ip integer port if string util be empty app return result of fail app can t be null or empty if string util be empty ip return result of fail ip can t be null or empty if port null return result of fail port can t be null try list degrade rule entity rule sentinel api client fetch degrade rule of machine app ip port rule repository save all rule return result of success rule catch throwable throwable logger error query app error throwable return result of throwable throwable response body request map new json auth action privilege type write rule public result degrade rule entity add string app string ip integer port string limit app string resource double count integer time window integer grade if string util be blank app return result of fail app can t be null or empty if string util be blank ip return result of fail ip can t be null or empty if port null return result of fail port can t be null if string util be blank limit app return result of fail limit app can t be null or empty if string util be blank resource return result of fail resource can t be null or empty if count null return result of fail count can t be null if time window null return result of fail time window can t be null if grade null return result of fail grade can t be null if grade rule constant degrade grade rt grade rule constant degrade grade exception count return result of fail invalid grade grade degrade rule entity entity new degrade rule entity entity set app app trim entity set ip ip trim entity set port port entity set limit app limit app trim entity set resource resource trim entity set count count entity set time window time window entity set grade grade date date new date entity set gmt create date entity set gmt modify date try entity repository save entity catch throwable throwable logger error add error throwable return result of throwable throwable if publish rule app ip port logger info publish degrade rule fail after rule add return result of success entity response body request mapping save json auth action privilege type write rule public result degrade rule entity update if not null long id string app string limit app string resource double count integer time window integer grade if id null return result of fail id can t be null if grade null if grade rule constant degrade grade rt grade rule constant degrade grade exception count return result of fail invalid grade grade degrade rule entity entity repository find by id id if entity null return result of fail id id dose not exist if string util be not blank app entity set app app trim if string util be not blank limit app entity set limit app limit app trim if string util be not blank resource entity set resource resource trim if count null entity set count count if time window null entity set time window time window if grade null entity set grade grade date date new date entity set gmt modify date try entity repository save entity catch throwable throwable logger error save error throwable return result of throwable throwable if publish rule entity get app entity get ip entity get port logger info publish degrade rule fail after rule update return result of success entity response body request map delete json auth action privilege type delete rule public result long delete long id if id null return result of fail id can t be null degrade rule entity old entity repository find by id id if old entity null return result of success null try repository delete id catch throwable throwable logger error delete error throwable return result of throwable throwable if publish rule old entity get app old entity get ip old entity get port logger info publish degrade rule fail after rule delete return result of success id private boolean publish rule string app string ip integer port list degrade rule entity rule repository find all by machine machine info of app ip port return sentinel api client set degrade rule of machine app ip port rule 
degrade controller response body request mapping rule json auth action privilege type read rule public result list degrade rule entity query machine rule string app string ip integer port if string util be empty app return result of fail app can t be null or empty if string util be empty ip return result of fail ip can t be null or empty if port null return result of fail port can t be null try list degrade rule entity rule sentinel api client fetch degrade rule of machine app ip port rule repository save all rule return result of success rule catch throwable throwable logger error query app error throwable return result of throwable throwable 
degrade controller response body request map new json auth action privilege type write rule public result degrade rule entity add string app string ip integer port string limit app string resource double count integer time window integer grade if string util be blank app return result of fail app can t be null or empty if string util be blank ip return result of fail ip can t be null or empty if port null return result of fail port can t be null if string util be blank limit app return result of fail limit app can t be null or empty if string util be blank resource return result of fail resource can t be null or empty if count null return result of fail count can t be null if time window null return result of fail time window can t be null if grade null return result of fail grade can t be null if grade rule constant degrade grade rt grade rule constant degrade grade exception count return result of fail invalid grade grade degrade rule entity entity new degrade rule entity entity set app app trim entity set ip ip trim entity set port port entity set limit app limit app trim entity set resource resource trim entity set count count entity set time window time window entity set grade grade date date new date entity set gmt create date entity set gmt modify date try entity repository save entity catch throwable throwable logger error add error throwable return result of throwable throwable if publish rule app ip port logger info publish degrade rule fail after rule add return result of success entity 
degrade controller response body request mapping save json auth action privilege type write rule public result degrade rule entity update if not null long id string app string limit app string resource double count integer time window integer grade if id null return result of fail id can t be null if grade null if grade rule constant degrade grade rt grade rule constant degrade grade exception count return result of fail invalid grade grade degrade rule entity entity repository find by id id if entity null return result of fail id id dose not exist if string util be not blank app entity set app app trim if string util be not blank limit app entity set limit app limit app trim if string util be not blank resource entity set resource resource trim if count null entity set count count if time window null entity set time window time window if grade null entity set grade grade date date new date entity set gmt modify date try entity repository save entity catch throwable throwable logger error save error throwable return result of throwable throwable if publish rule entity get app entity get ip entity get port logger info publish degrade rule fail after rule update return result of success entity 
degrade controller response body request map delete json auth action privilege type delete rule public result long delete long id if id null return result of fail id can t be null degrade rule entity old entity repository find by id id if old entity null return result of success null try repository delete id catch throwable throwable logger error delete error throwable return result of throwable throwable if publish rule old entity get app old entity get ip old entity get port logger info publish degrade rule fail after rule delete return result of success id 
demo controller controller request mapping value demo produce media type application json value public class demo controller logger logger logger factory get logger machine registry controller class request mapping greet public string greet return index request mapping link response body public string link throw block exception entry entry sph u entry head1 entry type in entry entry1 sph u entry head2 entry type in entry entry2 sph u entry head3 entry type in entry entry3 sph u entry head4 entry type in entry3 exit entry2 exit entry1 exit entry exit return successfully create a call link request mapping loop response body public string loop string name int time throw block exception for int i i i thread timer new thread new run task name time false timer set name false timer start return successfully create a loop thread request mapping slow response body public string slow string name int time throw block exception for int i i i thread timer new thread new run task name time true timer set name false timer start return successfully create a loop thread static class run task implement runnable int time boolean stop false string name boolean slow false public run task string name int time boolean slow super this time time this name name this slow slow override public void run long start time system current time millis context util enter string value of start time while stop long now system current time millis if now start time time stop true entry e1 null try e1 sph u entry name if slow true time unit millisecond sleep catch exception e finally if e1 null e1 exit random random2 new random try time unit millisecond sleep random2 next int catch interrupt exception e todo auto generate catch block e print stack trace context util exit 
demo controller request mapping greet public string greet return index 
demo controller request mapping link response body public string link throw block exception entry entry sph u entry head1 entry type in entry entry1 sph u entry head2 entry type in entry entry2 sph u entry head3 entry type in entry entry3 sph u entry head4 entry type in entry3 exit entry2 exit entry1 exit entry exit return successfully create a call link 
demo controller request mapping loop response body public string loop string name int time throw block exception for int i i i thread timer new thread new run task name time false timer set name false timer start return successfully create a loop thread 
demo controller request mapping slow response body public string slow string name int time throw block exception for int i i i thread timer new thread new run task name time true timer set name false timer start return successfully create a loop thread 
flow controller v1 rest controller request mapping value v1 flow public class flow controller v1 private final logger logger logger factory get logger flow controller v1 class autowire private in memory rule repository adapter flow rule entity repository autowire private sentinel api client sentinel api client get mapping rule auth action privilege type read rule public result list flow rule entity api query machine rule request param string app request param string ip request param integer port if string util be empty app return result of fail app can t be null or empty if string util be empty ip return result of fail ip can t be null or empty if port null return result of fail port can t be null try list flow rule entity rule sentinel api client fetch flow rule of machine app ip port rule repository save all rule return result of success rule catch throwable throwable logger error error when query flow rule throwable return result of throwable throwable private r result r check entity internal flow rule entity entity if string util be blank entity get app return result of fail app can t be null or empty if string util be blank entity get ip return result of fail ip can t be null or empty if entity get port null return result of fail port can t be null if string util be blank entity get limit app return result of fail limit app can t be null or empty if string util be blank entity get resource return result of fail resource can t be null or empty if entity get grade null return result of fail grade can t be null if entity get grade entity get grade return result of fail grade must be or but entity get grade get if entity get count null entity get count return result of fail count should be at lease zero if entity get strategy null return result of fail strategy can t be null if entity get strategy string util be blank entity get ref resource return result of fail ref resource can t be null or empty when strategy if entity get control behavior null return result of fail control behavior can t be null int control behavior entity get control behavior if control behavior entity get warm up period sec null return result of fail warm up period sec can t be null when control behavior if control behavior entity get max queueing time ms null return result of fail max queueing time ms can t be null when control behavior if entity be cluster mode entity get cluster config null return result of fail cluster config should be valid return null post mapping rule auth action privilege type write rule public result flow rule entity api add flow rule request body flow rule entity entity result flow rule entity check result check entity internal entity if check result null return check result entity set id null date date new date entity set gmt create date entity set gmt modify date entity set limit app entity get limit app trim entity set resource entity get resource trim try entity repository save entity publish rule entity get app entity get ip entity get port get time unit millisecond return result of success entity catch throwable t throwable e t instanceof execution exception t get cause t logger error fail to add new flow rule app ip entity get app entity get ip e return result of fail e get message put mapping save json auth action privilege type write rule public result flow rule entity api update flow rule long id string app string limit app string resource integer grade double count integer strategy string ref resource integer control behavior integer warm up period sec integer max queueing time ms if id null return result of fail id can t be null flow rule entity entity repository find by id id if entity null return result of fail id id dose not exist if string util be not blank app entity set app app trim if string util be not blank limit app entity set limit app limit app trim if string util be not blank resource entity set resource resource trim if grade null if grade grade return result of fail grade must be or but grade get entity set grade grade if count null entity set count count if strategy null if strategy strategy strategy return result of fail strategy must be in but strategy get entity set strategy strategy if strategy if string util be blank ref resource return result of fail ref resource can t be null or empty when strategy entity set ref resource ref resource trim if control behavior null if control behavior control behavior control behavior return result of fail control behavior must be in but control behavior get if control behavior warm up period sec null return result of fail warm up period sec can t be null when control behavior if control behavior max queueing time ms null return result of fail max queueing time ms can t be null when control behavior entity set control behavior control behavior if warm up period sec null entity set warm up period sec warm up period sec if max queueing time ms null entity set max queueing time ms max queueing time ms date date new date entity set gmt modify date try entity repository save entity if entity null return result of fail save entity fail null publish rule entity get app entity get ip entity get port get time unit millisecond return result of success entity catch throwable t throwable e t instanceof execution exception t get cause t logger error error when update flow rule app ip rule id entity get app entity get ip id e return result of fail e get message delete mapping delete json auth action privilege type write rule public result long api delete flow rule long id if id null return result of fail id can t be null flow rule entity old entity repository find by id id if old entity null return result of success null try repository delete id catch exception e return result of fail e get message try publish rule old entity get app old entity get ip old entity get port get time unit millisecond return result of success id catch throwable t throwable e t instanceof execution exception t get cause t logger error error when delete flow rule app ip id old entity get app old entity get ip id e return result of fail e get message private completable future void publish rule string app string ip integer port list flow rule entity rule repository find all by machine machine info of app ip port return sentinel api client set flow rule of machine async app ip port rule 
gateway api controller rest controller request mapping value gateway api public class gateway api controller private final logger logger logger factory get logger gateway api controller class autowire private in mem api definition store repository autowire private sentinel api client sentinel api client get mapping list json auth action auth service privilege type read rule public result list api definition entity query apis string app string ip integer port if string util be empty app return result of fail app can t be null or empty if string util be empty ip return result of fail ip can t be null or empty if port null return result of fail port can t be null try list api definition entity apis sentinel api client fetch apis app ip port get repository save all apis return result of success api catch throwable throwable logger error query apis error throwable return result of throwable throwable post map new json auth action auth service privilege type write rule public result api definition entity add api http servlet request request request body add api req vo req vo string app req vo get app if string util be blank app return result of fail app can t be null or empty api definition entity entity new api definition entity entity set app app trim string ip req vo get ip if string util be blank ip return result of fail ip can t be null or empty entity set ip ip trim integer port req vo get port if port null return result of fail port can t be null entity set port port api string api name req vo get api name if string util be blank api name return result of fail api name can t be null or empty entity set api name api name trim list api predicate item vo predicate item req vo get predicate item if collection util be empty predicate item return result of fail predicate item can t empty list api predicate item entity predicate item entity new array list for api predicate item vo predicate item predicate item api predicate item entity predicate item entity new api predicate item entity integer match strategy predicate item get match strategy if array as list url match strategy exact url match strategy prefix url match strategy regex contain match strategy return result of fail invalid match strategy match strategy predicate item entity set match strategy match strategy string pattern predicate item get pattern if string util be blank pattern return result of fail pattern can t be null or empty predicate item entity set pattern pattern predicate item entity add predicate item entity entity set predicate item new link hash set predicate item entity api list api definition entity all apis repository find all by machine machine info of app trim ip trim port if all api stream map o o get api name any match o o equal api name trim return result of fail api name exist api name date date new date entity set gmt create date entity set gmt modify date try entity repository save entity catch throwable throwable logger error add gateway api error throwable return result of throwable throwable if publish apis app ip port logger warn publish gateway apis fail after add return result of success entity post mapping save json auth action auth service privilege type write rule public result api definition entity update api request body update api req vo req vo string app req vo get app if string util be blank app return result of fail app can t be null or empty long id req vo get id if id null return result of fail id can t be null api definition entity entity repository find by id id if entity null return result of fail api do not exist id id list api predicate item vo predicate item req vo get predicate item if collection util be empty predicate item return result of fail predicate item can t empty list api predicate item entity predicate item entity new array list for api predicate item vo predicate item predicate item api predicate item entity predicate item entity new api predicate item entity int match strategy predicate item get match strategy if array as list url match strategy exact url match strategy prefix url match strategy regex contain match strategy return result of fail invalid match strategy match strategy predicate item entity set match strategy match strategy string pattern predicate item get pattern if string util be blank pattern return result of fail pattern can t be null or empty predicate item entity set pattern pattern predicate item entity add predicate item entity entity set predicate item new link hash set predicate item entity date date new date entity set gmt modify date try entity repository save entity catch throwable throwable logger error update gateway api error throwable return result of throwable throwable if publish apis app entity get ip entity get port logger warn publish gateway apis fail after update return result of success entity post mapping delete json auth action auth service privilege type delete rule public result long delete api long id if id null return result of fail id can t be null api definition entity old entity repository find by id id if old entity null return result of success null try repository delete id catch throwable throwable logger error delete gateway api error throwable return result of throwable throwable if publish apis old entity get app old entity get ip old entity get port logger warn publish gateway apis fail after delete return result of success id private boolean publish apis string app string ip integer port list api definition entity apis repository find all by machine machine info of app ip port return sentinel api client modify apis app ip port apis 
gateway flow rule controller rest controller request mapping value gateway flow public class gateway flow rule controller private final logger logger logger factory get logger gateway flow rule controller class autowire private in mem gateway flow rule store repository autowire private sentinel api client sentinel api client get mapping list json auth action auth service privilege type read rule public result list gateway flow rule entity query flow rule string app string ip integer port if string util be empty app return result of fail app can t be null or empty if string util be empty ip return result of fail ip can t be null or empty if port null return result of fail port can t be null try list gateway flow rule entity rule sentinel api client fetch gateway flow rule app ip port get repository save all rule return result of success rule catch throwable throwable logger error query gateway flow rule error throwable return result of throwable throwable post map new json auth action auth service privilege type write rule public result gateway flow rule entity add flow rule request body add flow rule req vo req vo string app req vo get app if string util be blank app return result of fail app can t be null or empty gateway flow rule entity entity new gateway flow rule entity entity set app app trim string ip req vo get ip if string util be blank ip return result of fail ip can t be null or empty entity set ip ip trim integer port req vo get port if port null return result of fail port can t be null entity set port port api route id api integer resource mode req vo get resource mode if resource mode null return result of fail resource mode can t be null if array as list resource mode route id resource mode custom api name contain resource mode return result of fail invalid resource mode resource mode entity set resource mode resource mode api string resource req vo get resource if string util be blank resource return result of fail resource can t be null or empty entity set resource resource trim gateway param flow item vo param item req vo get param item if param item null gateway param flow item entity item entity new gateway param flow item entity entity set param item item entity client i p remote host header url cookie integer parse strategy param item get parse strategy if array as list param parse strategy client ip param parse strategy host param parse strategy header param parse strategy url param param parse strategy cookie contain parse strategy return result of fail invalid parse strategy parse strategy item entity set parse strategy param item get parse strategy header url cookie if array as list param parse strategy header param parse strategy url param param parse strategy cookie contain parse strategy string field name param item get field name if string util be blank field name return result of fail field name can t be null or empty item entity set field name param item get field name string pattern param item get pattern if string util be not empty pattern item entity set pattern pattern integer match strategy param item get match strategy if array as list param match strategy exact param match strategy contain param match strategy regex contain match strategy return result of fail invalid match strategy match strategy item entity set match strategy match strategy qp integer grade req vo get grade if grade null return result of fail grade can t be null if array as list flow grade thread flow grade qp contain grade return result of fail invalid grade grade entity set grade grade qp double count req vo get count if count null return result of fail count can t be null if count return result of fail count should be at lease zero entity set count count long interval req vo get interval if interval null return result of fail interval can t be null if interval return result of fail interval should be greater than zero entity set interval interval integer interval unit req vo get interval unit if interval unit null return result of fail interval unit can t be null if array as list interval unit second interval unit minute interval unit hour interval unit day contain interval unit return result of fail invalid interval unit interval unit entity set interval unit interval unit integer control behavior req vo get control behavior if control behavior null return result of fail control behavior can t be null if array as list control behavior default control behavior rate limiter contain control behavior return result of fail invalid control behavior control behavior entity set control behavior control behavior if control behavior default control behavior burst size integer burst req vo get burst if burst null return result of fail burst can t be null if burst return result of fail invalid burst burst entity set burst burst else if control behavior rate limiter control behavior integer max queue timeout ms req vo get max queueing timeout ms if max queue timeout ms null return result of fail max queue timeout ms can t be null if max queue timeout ms return result of fail invalid max queue timeout ms max queue timeout ms entity set max queue timeout ms max queue timeout ms date date new date entity set gmt create date entity set gmt modify date try entity repository save entity catch throwable throwable logger error add gateway flow rule error throwable return result of throwable throwable if publish rule app ip port logger warn publish gateway flow rule fail after add return result of success entity post mapping save json auth action auth service privilege type write rule public result gateway flow rule entity update flow rule request body update flow rule req vo req vo string app req vo get app if string util be blank app return result of fail app can t be null or empty long id req vo get id if id null return result of fail id can t be null gateway flow rule entity entity repository find by id id if entity null return result of fail gateway flow rule do not exist id id gateway param flow item vo param item req vo get param item if param item null gateway param flow item entity item entity new gateway param flow item entity entity set param item item entity client i p remote host header url cookie integer parse strategy param item get parse strategy if array as list param parse strategy client ip param parse strategy host param parse strategy header param parse strategy url param param parse strategy cookie contain parse strategy return result of fail invalid parse strategy parse strategy item entity set parse strategy param item get parse strategy header url cookie if array as list param parse strategy header param parse strategy url param param parse strategy cookie contain parse strategy string field name param item get field name if string util be blank field name return result of fail field name can t be null or empty item entity set field name param item get field name string pattern param item get pattern if string util be not empty pattern item entity set pattern pattern integer match strategy param item get match strategy if array as list param match strategy exact param match strategy contain param match strategy regex contain match strategy return result of fail invalid match strategy match strategy item entity set match strategy match strategy else entity set param item null qp integer grade req vo get grade if grade null return result of fail grade can t be null if array as list flow grade thread flow grade qp contain grade return result of fail invalid grade grade entity set grade grade qp double count req vo get count if count null return result of fail count can t be null if count return result of fail count should be at lease zero entity set count count long interval req vo get interval if interval null return result of fail interval can t be null if interval return result of fail interval should be greater than zero entity set interval interval integer interval unit req vo get interval unit if interval unit null return result of fail interval unit can t be null if array as list interval unit second interval unit minute interval unit hour interval unit day contain interval unit return result of fail invalid interval unit interval unit entity set interval unit interval unit integer control behavior req vo get control behavior if control behavior null return result of fail control behavior can t be null if array as list control behavior default control behavior rate limiter contain control behavior return result of fail invalid control behavior control behavior entity set control behavior control behavior if control behavior default control behavior burst size integer burst req vo get burst if burst null return result of fail burst can t be null if burst return result of fail invalid burst burst entity set burst burst else if control behavior rate limiter control behavior integer max queue timeout ms req vo get max queueing timeout ms if max queue timeout ms null return result of fail max queue timeout ms can t be null if max queue timeout ms return result of fail invalid max queue timeout ms max queue timeout ms entity set max queue timeout ms max queue timeout ms date date new date entity set gmt modify date try entity repository save entity catch throwable throwable logger error update gateway flow rule error throwable return result of throwable throwable if publish rule app entity get ip entity get port logger warn publish gateway flow rule fail after update return result of success entity post mapping delete json auth action auth service privilege type delete rule public result long delete flow rule long id if id null return result of fail id can t be null gateway flow rule entity old entity repository find by id id if old entity null return result of success null try repository delete id catch throwable throwable logger error delete gateway flow rule error throwable return result of throwable throwable if publish rule old entity get app old entity get ip old entity get port logger warn publish gateway flow rule fail after delete return result of success id private boolean publish rule string app string ip integer port list gateway flow rule entity rule repository find all by machine machine info of app ip port return sentinel api client modify gateway flow rule app ip port rule 
machine registry controller controller request mapping value registry produce media type application json value public class machine registry controller private final logger logger logger factory get logger machine registry controller class autowire private app management app management response body request map machine public result receive heart beat string app request param value app type require false default value integer app type long version string v string hostname string ip integer port if app null app machine discovery unknown app name if ip null return result of fail ip can t be null if port null return result of fail port can t be null if port logger info receive heartbeat from ip but port not set yet return result of fail you port not set yet string sentinel version string util be empty v unknown v version version null system current time millis version try machine info machine info new machine info machine info set app app machine info set app type app type machine info set hostname hostname machine info set ip ip machine info set port port machine info set heartbeat version version machine info set last heartbeat system current time millis machine info set version sentinel version app management add machine machine info return result of success msg success catch exception e logger error receive heartbeat error e return result of fail e get message 
machine registry controller response body request map machine public result receive heart beat string app request param value app type require false default value integer app type long version string v string hostname string ip integer port if app null app machine discovery unknown app name if ip null return result of fail ip can t be null if port null return result of fail port can t be null if port logger info receive heartbeat from ip but port not set yet return result of fail you port not set yet string sentinel version string util be empty v unknown v version version null system current time millis version try machine info machine info new machine info machine info set app app machine info set app type app type machine info set hostname hostname machine info set ip ip machine info set port port machine info set heartbeat version version machine info set last heartbeat system current time millis machine info set version sentinel version app management add machine machine info return result of success msg success catch exception e logger error receive heartbeat error e return result of fail e get message 
metric controller controller request mapping value metric produce media type application json value public class metric controller private static logger logger logger factory get logger metric controller class private static final long max query interval ms autowire private metric repository metric entity metric store response body request mapping query top resource metric json public result query top resource metric final string app integer page index integer page size boolean desc long start time long end time string search key if string util be empty app return result of fail app can t be null or empty if page index null page index page index if page size null page size if page size page size if desc null desc true if end time null end time system current time millis if start time null start time end time if end time start time max query interval ms return result of fail time interval ms be too big must 1h list string resource metric store list resource of app app logger debug query top resource metric resource size resource size if resource null resource be empty return result of success null if desc collection reverse resource if string util be not empty search key list string search new array list for string resource resource if resource contain search key search add resource resource search int total page resource size page size page size list string top resource new array list if page index total page top resource resource sub list page index page size math min page index page size resource size final map string iterable metric vo map new concurrent hash map logger debug top resource top resource long time system current time millis for final string resource top resource list metric entity entity metric store query by app and resource between app resource start time end time logger debug resource entity size resource entity null null entity size list metric vo vos metric vo from metric entity entity resource iterable metric vo vos sort sort metric vo and distinct vos map put resource vos sort logger debug query top resource metric total query time ms system current time millis time map string object result map new hash map result map put total count resource size result map put total page total page result map put page index page index result map put page size page size map string iterable metric vo map2 new link hash map order matter for string identity top resource map2 put identity map get identity result map put metric map2 return result of success result map response body request mapping query by app and resource json public result query by app and resource string app string identity long start time long end time if string util be empty app return result of fail app can t be null or empty if string util be empty identity return result of fail identity can t be null or empty if end time null end time system current time millis if start time null start time end time if end time start time max query interval ms return result of fail time interval ms be too big must 1h list metric entity entity metric store query by app and resource between app identity start time end time list metric vo vos metric vo from metric entity entity identity return result of success sort metric vo and distinct vo private iterable metric vo sort metric vo and distinct list metric vo vos if vos null return null map long metric vo map new tree map for metric vo vo vos metric vo old vo map get vo get timestamp if old vo null vo get gmt create old vo get gmt create map put vo get timestamp vo return map value 
metric controller response body request mapping query top resource metric json public result query top resource metric final string app integer page index integer page size boolean desc long start time long end time string search key if string util be empty app return result of fail app can t be null or empty if page index null page index page index if page size null page size if page size page size if desc null desc true if end time null end time system current time millis if start time null start time end time if end time start time max query interval ms return result of fail time interval ms be too big must 1h list string resource metric store list resource of app app logger debug query top resource metric resource size resource size if resource null resource be empty return result of success null if desc collection reverse resource if string util be not empty search key list string search new array list for string resource resource if resource contain search key search add resource resource search int total page resource size page size page size list string top resource new array list if page index total page top resource resource sub list page index page size math min page index page size resource size final map string iterable metric vo map new concurrent hash map logger debug top resource top resource long time system current time millis for final string resource top resource list metric entity entity metric store query by app and resource between app resource start time end time logger debug resource entity size resource entity null null entity size list metric vo vos metric vo from metric entity entity resource iterable metric vo vos sort sort metric vo and distinct vos map put resource vos sort logger debug query top resource metric total query time ms system current time millis time map string object result map new hash map result map put total count resource size result map put total page total page result map put page index page index result map put page size page size map string iterable metric vo map2 new link hash map order matter for string identity top resource map2 put identity map get identity result map put metric map2 return result of success result map 
metric controller response body request mapping query by app and resource json public result query by app and resource string app string identity long start time long end time if string util be empty app return result of fail app can t be null or empty if string util be empty identity return result of fail identity can t be null or empty if end time null end time system current time millis if start time null start time end time if end time start time max query interval ms return result of fail time interval ms be too big must 1h list metric entity entity metric store query by app and resource between app identity start time end time list metric vo vos metric vo from metric entity entity identity return result of success sort metric vo and distinct vo 
param flow rule controller rest controller request mapping value param flow public class param flow rule controller private final logger logger logger factory get logger param flow rule controller class autowire private sentinel api client sentinel api client autowire private app management app management autowire private rule repository param flow rule entity long repository private boolean check if support string app string ip int port try return optional of nullable app management get detail app app flat map e e get machine ip port flat map m version util parse version m get version map v v greater or equal version020 or else true if error occur or can not retrieve machine info return true catch exception ex return true get mapping rule auth action privilege type read rule public result list param flow rule entity api query all rule for machine request param string app request param string ip request param integer port if string util be empty app return result of fail app can not be null or empty if string util be empty ip return result of fail ip can not be null or empty if port null port return result of fail invalid parameter port if check if support app ip port return unsupported version try return sentinel api client fetch param flow rule of machine app ip port then apply repository save all then apply result of success get catch execution exception ex logger error error when query parameter flow rule ex get cause if be not support ex get cause return unsupported version else return result of throwable ex get cause catch throwable throwable logger error error when query parameter flow rule throwable return result of fail throwable get message private boolean be not support throwable ex return ex instanceof command not find exception post mapping rule auth action auth service privilege type write rule public result param flow rule entity api add param flow rule request body param flow rule entity entity result param flow rule entity check result check entity internal entity if check result null return check result if check if support entity get app entity get ip entity get port return unsupported version entity set id null entity get rule set resource entity get resource trim date date new date entity set gmt create date entity set gmt modify date try entity repository save entity publish rule entity get app entity get ip entity get port get return result of success entity catch execution exception ex logger error error when add new parameter flow rule ex get cause if be not support ex get cause return unsupported version else return result of throwable ex get cause catch throwable throwable logger error error when add new parameter flow rule throwable return result of fail throwable get message private r result r check entity internal param flow rule entity entity if entity null return result of fail bad rule body if string util be blank entity get app return result of fail app can t be null or empty if string util be blank entity get ip return result of fail ip can t be null or empty if entity get port null entity get port return result of fail port can t be null if entity get rule null return result of fail rule can t be null if string util be blank entity get resource return result of fail resource name can not be null or empty if entity get count return result of fail count should be valid if entity get grade rule constant flow grade qp return result of fail unknown mode block grade for parameter flow control if entity get param idx null entity get param idx return result of fail param idx should be valid if entity get duration in sec return result of fail duration in sec should be valid if entity get control behavior return result of fail control behavior should be valid return null put mapping rule id auth action auth service privilege type write rule public result param flow rule entity api update param flow rule path variable id long id request body param flow rule entity entity if id null id return result of fail invalid id param flow rule entity old entity repository find by id id if old entity null return result of fail id id do not exist result param flow rule entity check result check entity internal entity if check result null return check result if check if support entity get app entity get ip entity get port return unsupported version entity set id id date date new date entity set gmt create old entity get gmt create entity set gmt modify date try entity repository save entity publish rule entity get app entity get ip entity get port get return result of success entity catch execution exception ex logger error error when update parameter flow rule id id ex get cause if be not support ex get cause return unsupported version else return result of throwable ex get cause catch throwable throwable logger error error when update parameter flow rule id id throwable return result of fail throwable get message delete mapping rule id auth action privilege type delete rule public result long api delete rule path variable id long id if id null return result of fail id can not be null param flow rule entity old entity repository find by id id if old entity null return result of success null try repository delete id publish rule old entity get app old entity get ip old entity get port get return result of success id catch execution exception ex logger error error when delete parameter flow rule ex get cause if be not support ex get cause return unsupported version else return result of throwable ex get cause catch throwable throwable logger error error when delete parameter flow rule throwable return result of fail throwable get message private completable future void publish rule string app string ip integer port list param flow rule entity rule repository find all by machine machine info of app ip port return sentinel api client set param flow rule of machine app ip port rule private r result r unsupported version return result of fail sentinel client not support for parameter flow control unsupported version or dependency absent private final sentinel version version020 new sentinel version set minor version 
resource controller rest controller request mapping value resource public class resource controller private static logger logger logger factory get logger resource controller class autowire private sentinel api client http fetcher fetch real time statistics info of the machine param ip ip to fetch param port port of the ip param type one of root default cluster root mean fetch from tree root node default mean fetch from tree default node cluster mean fetch from cluster node param search key key to search return node statistics info get map machine resource json public result list resource vo fetch resource chain list of machine string ip integer port string type string search key if string util be empty ip port null return result of fail invalid param give ip port final string root root final string default default if string util be empty type type root if root equal ignore case type default equal ignore case type list node vo node vo http fetcher fetch resource of machine ip port type if node vos null return result of success null resource tree node tree node resource tree node from node vo list node vo tree node search ignore case search key return result of success resource vo from resource tree node tree node else normal cluster node list node vo node vo http fetcher fetch cluster node of machine ip port true if node vos null return result of success null if string util be not empty search key node vo node vos stream filter node node get resource to lower case contain search key to lower case collect collector to list return result of success resource vo from node vo list node vo 
system controller rest controller request mapping system public class system controller private final logger logger logger factory get logger system controller class autowire private rule repository system rule entity long repository autowire private sentinel api client sentinel api client private r result r check basic param string app string ip integer port if string util be empty app return result of fail app can t be null or empty if string util be empty ip return result of fail ip can t be null or empty if port null return result of fail port can t be null if port port return result of fail port should be in return null get mapping rule json auth action privilege type read rule public result list system rule entity api query machine rule string app string ip integer port result list system rule entity check result check basic param app ip port if check result null return check result try list system rule entity rule sentinel api client fetch system rule of machine app ip port rule repository save all rule return result of success rule catch throwable throwable logger error query machine system rule error throwable return result of throwable throwable private int count not null and not negative number value int not null count for int i i value length i if value i null value i double value not null count return not null count request map new json auth action privilege type write rule public result system rule entity api add string app string ip integer port double highest system load double highest cpu usage long avg rt long max thread double qp result system rule entity check result check basic param app ip port if check result null return check result int not null count count not null and not negative highest system load avg rt max thread qp highest cpu usage if not null count return result of fail only one of highest system load avg rt max thread qp highest cpu usage value must be set but not null count value get if null highest cpu usage highest cpu usage return result of fail highest cpu usage must between 0.0 1.0 system rule entity entity new system rule entity entity set app app trim entity set ip ip trim entity set port port be a fake value if null highest system load entity set highest system load highest system load else entity set highest system load 1 d if null highest cpu usage entity set highest cpu usage highest cpu usage else entity set highest cpu usage 1 d if avg rt null entity set avg rt avg rt else entity set avg rt 1 l if max thread null entity set max thread max thread else entity set max thread 1 l if qps null entity set qp qp else entity set qp 1 d date date new date entity set gmt create date entity set gmt modify date try entity repository save entity catch throwable throwable logger error add system rule error throwable return result of throwable throwable if publish rule app ip port logger warn publish system rule fail after rule add return result of success entity get map save json auth action privilege type write rule public result system rule entity api update if not null long id string app double highest system load double highest cpu usage long avg rt long max thread double qp if id null return result of fail id can t be null system rule entity entity repository find by id id if entity null return result of fail id id dose not exist if string util be not blank app entity set app app trim if highest system load null if highest system load return result of fail highest system load must entity set highest system load highest system load if highest cpu usage null if highest cpu usage return result of fail highest cpu usage must if highest cpu usage return result of fail highest cpu usage must entity set highest cpu usage highest cpu usage if avg rt null if avg rt return result of fail avg rt must entity set avg rt avg rt if max thread null if max thread return result of fail max thread must entity set max thread max thread if qps null if qp return result of fail qp must entity set qp qps date date new date entity set gmt modify date try entity repository save entity catch throwable throwable logger error save error throwable return result of throwable throwable if publish rule entity get app entity get ip entity get port logger info publish system rule fail after rule update return result of success entity request map delete json auth action privilege type delete rule public result delete long id if id null return result of fail id can t be null system rule entity old entity repository find by id id if old entity null return result of success null try repository delete id catch throwable throwable logger error delete error throwable return result of throwable throwable if publish rule old entity get app old entity get ip old entity get port logger info publish system rule fail after rule delete return result of success id private boolean publish rule string app string ip integer port list system rule entity rule repository find all by machine machine info of app ip port return sentinel api client set system rule of machine app ip port rule 
system controller request map new json auth action privilege type write rule public result system rule entity api add string app string ip integer port double highest system load double highest cpu usage long avg rt long max thread double qp result system rule entity check result check basic param app ip port if check result null return check result int not null count count not null and not negative highest system load avg rt max thread qp highest cpu usage if not null count return result of fail only one of highest system load avg rt max thread qp highest cpu usage value must be set but not null count value get if null highest cpu usage highest cpu usage return result of fail highest cpu usage must between 0.0 1.0 system rule entity entity new system rule entity entity set app app trim entity set ip ip trim entity set port port be a fake value if null highest system load entity set highest system load highest system load else entity set highest system load 1 d if null highest cpu usage entity set highest cpu usage highest cpu usage else entity set highest cpu usage 1 d if avg rt null entity set avg rt avg rt else entity set avg rt 1 l if max thread null entity set max thread max thread else entity set max thread 1 l if qps null entity set qp qp else entity set qp 1 d date date new date entity set gmt create date entity set gmt modify date try entity repository save entity catch throwable throwable logger error add system rule error throwable return result of throwable throwable if publish rule app ip port logger warn publish system rule fail after rule add return result of success entity 
system controller request map delete json auth action privilege type delete rule public result delete long id if id null return result of fail id can t be null system rule entity old entity repository find by id id if old entity null return result of success null try repository delete id catch throwable throwable logger error delete error throwable return result of throwable throwable if publish rule old entity get app old entity get ip old entity get port logger info publish system rule fail after rule delete return result of success id 
flow controller v2 rest controller request mapping value v2 flow public class flow controller v2 private final logger logger logger factory get logger flow controller v2 class autowire private in memory rule repository adapter flow rule entity repository autowire qualifier flow rule default provider private dynamic rule provider list flow rule entity rule provider autowire qualifier flow rule default publisher private dynamic rule publisher list flow rule entity rule publisher get mapping rule auth action privilege type read rule public result list flow rule entity api query machine rule request param string app if string util be empty app return result of fail app can t be null or empty try list flow rule entity rule rule provider get rule app if rule null rule be empty for flow rule entity entity rule entity set app app if entity get cluster config null entity get cluster config get flow id null entity set id entity get cluster config get flow id rule repository save all rule return result of success rule catch throwable throwable logger error error when query flow rule throwable return result of throwable throwable private r result r check entity internal flow rule entity entity if entity null return result of fail invalid body if string util be blank entity get app return result of fail app can t be null or empty if string util be blank entity get limit app return result of fail limit app can t be null or empty if string util be blank entity get resource return result of fail resource can t be null or empty if entity get grade null return result of fail grade can t be null if entity get grade entity get grade return result of fail grade must be or but entity get grade get if entity get count null entity get count return result of fail count should be at lease zero if entity get strategy null return result of fail strategy can t be null if entity get strategy string util be blank entity get ref resource return result of fail ref resource can t be null or empty when strategy if entity get control behavior null return result of fail control behavior can t be null int control behavior entity get control behavior if control behavior entity get warm up period sec null return result of fail warm up period sec can t be null when control behavior if control behavior entity get max queueing time ms null return result of fail max queueing time ms can t be null when control behavior if entity be cluster mode entity get cluster config null return result of fail cluster config should be valid return null post mapping rule auth action value auth service privilege type write rule public result flow rule entity api add flow rule request body flow rule entity entity result flow rule entity check result check entity internal entity if check result null return check result entity set id null date date new date entity set gmt create date entity set gmt modify date entity set limit app entity get limit app trim entity set resource entity get resource trim try entity repository save entity publish rule entity get app catch throwable throwable logger error fail to add flow rule throwable return result of throwable throwable return result of success entity put mapping rule id auth action auth service privilege type write rule public result flow rule entity api update flow rule path variable id long id request body flow rule entity entity if id null id return result of fail invalid id flow rule entity old entity repository find by id id if old entity null return result of fail id id do not exist if entity null return result of fail invalid body entity set app old entity get app entity set ip old entity get ip entity set port old entity get port result flow rule entity check result check entity internal entity if check result null return check result entity set id id date date new date entity set gmt create old entity get gmt create entity set gmt modify date try entity repository save entity if entity null return result of fail save entity fail publish rule old entity get app catch throwable throwable logger error fail to update flow rule throwable return result of throwable throwable return result of success entity delete mapping rule id auth action privilege type delete rule public result long api delete rule path variable id long id if id null id return result of fail invalid id flow rule entity old entity repository find by id id if old entity null return result of success null try repository delete id publish rule old entity get app catch exception e return result of fail e get message return result of success id private void publish rule non null string app throw exception list flow rule entity rule repository find all by app app rule publisher publish app rule 
apache http client test controller request mapping httpclient back public string back system out println back return welcome back 
apache http client test controller request mapping httpclient back id public string back path variable string id system out println back return welcome back id 
apache http client test controller request mapping httpclient sync public string sync throw exception sentinel apache http client config config new sentinel apache http client config config set extractor new apache http client resource extractor override public string extractor http request wrapper request string contain httpclient back string uri request get request line get uri if uri start with contain uri uri substr uri index of contain contain length id return request get method uri closeable http client httpclient new sentinel apache http client builder config build http get http get new http get http localhost port httpclient back return get remote string httpclient http get 
apache http client test controller request mapping httpclient sync id public string sync path variable string id throw exception sentinel apache http client config config new sentinel apache http client config config set extractor new apache http client resource extractor override public string extractor http request wrapper request string contain httpclient back string uri request get request line get uri if uri start with contain uri uri substr uri index of contain contain length id return request get method uri closeable http client httpclient new sentinel apache http client builder config build http get http get new http get http localhost port httpclient back id return get remote string httpclient http get 
ok http test controller request mapping okhttp back public string back return welcome back 
ok http test controller request mapping okhttp back id public string back path variable string id return welcome back id 
ok http test controller request mapping okhttp testcase id public string testcase path variable string id throw exception return get remote string id 
ok http test controller request mapping okhttp testcase public string testcase throw exception return get remote string null 
baz controller rest controller request mapping value baz public class baz controller autowire private baz service baz service get mapping id public mono string api get value path variable id long id return baz service get by id id transform new sentinel reactor transformer baz service get by id post mapping id public mono boolean api set value path variable id long id request body string value return baz service set value id value transform new sentinel reactor transformer baz service set value 
foo controller rest controller request mapping value foo public class foo controller autowire private foo service foo service get map single public mono string api normal single return foo service emit single transform the publisher here transform new sentinel reactor transformer demo foo normal single get map flux public flux integer api normal flux return foo service emit multiple transform new sentinel reactor transformer demo foo normal flux get map slow public mono string api do something slow server http response response return foo service do something slow 
spring could datum source test rest controller request mapping value test datum source public class spring could datum source test autowire private sentinel rule locator locator converter string list flow rule converter new converter string list flow rule override public list flow rule convert string source return json parse array source flow rule class get map get response body public list flow rule get spring cloud config datum source datum source new spring cloud config datum source flow rule converter flow rule manager register2 property datum source get property return flow rule manager get rule web hook refresh config get map refresh response body public list flow rule refresh locator refresh return flow rule manager get rule 
