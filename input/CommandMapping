get gateway api definition group command handler command mapping name gateway get api definition desc fetch all customize gateway api group public class get gateway api definition group command handler implement command handler string override public command response string handle command request request return command response of success json to j s o n string gateway api definition manager get api definition 
get gateway rule command handler command mapping name gateway get rule desc fetch all gateway rule public class get gateway rule command handler implement command handler string override public command response string handle command request request return command response of success json to j s o n string gateway rule manager get rule 
update gateway api definition group command handler command mapping name gateway update api definition desc public class update gateway api definition group command handler implement command handler string private static writable datum source set api definition api definition wd null override public command response string handle command request request string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception bad datum try datum u be l decoder decode datum utf catch exception e record log info decode gateway api definition datum error e return command response of failure e decode gateway api definition datum error record log info api server receive datum change type gateway api definition datum string result success msg set api definition api definition parse json datum gateway api definition manager load api definition api definition if write to datum source api definition wd api definition result write d failure msg return command response of success result private static final string success msg success private static final string write d failure msg partial success write datum source fail parse json datum to set of link api definition since the predicate item of link api definition be set of interface here we parse predicate item to link api path predicate item temporarily private set api definition parse json string datum set api definition api definition new hash set j s o n array array json parse array datum for object obj array j s o n object o j s o n object obj api definition api definition new api definition o get string api name set api predicate item predicate item new hash set j s o n array item array o get j s o n array predicate item if item array null predicate item add all item array to java list api path predicate item class api definition set predicate item predicate item api definition add api definition return api definition write target value to give datum source param datum source writable datum source param value target value to save param t value type return true if write successful or datum source be empty false if error occur private t boolean write to datum source writable datum source t datum source t value if datum source null try datum source write value catch exception e record log warn write datum source fail e return false return true public synchronize static writable datum source set api definition get writable datum source return api definition wds public synchronize static void set writable datum source writable datum source set api definition api definition wd update gateway api definition group command handler api definition wd api definition wd 
update gateway rule command handler command mapping name gateway update rule desc update gateway rule public class update gateway rule command handler implement command handler string private static writable datum source set gateway flow rule gateway flow wds null override public command response string handle command request request string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception bad datum try datum u be l decoder decode datum utf catch exception e record log info decode gateway rule datum error e return command response of failure e decode gateway rule datum error record log info string format api server receive rule change type gateway rule s datum string result success msg set gateway flow rule flow rule json parse object datum new type reference set gateway flow rule gateway rule manager load rule flow rule if write to datum source gateway flow wds flow rule result write d failure msg return command response of success result write target value to give datum source param datum source writable datum source param value target value to save param t value type return true if write successful or datum source be empty false if error occur private t boolean write to datum source writable datum source t datum source t value if datum source null try datum source write value catch exception e record log warn write datum source fail e return false return true public synchronize static writable datum source set gateway flow rule get writable datum source return gateway flow wds public synchronize static void set writable datum source writable datum source set gateway flow rule gateway flow wd update gateway rule command handler gateway flow wd gateway flow wds private static final string success msg success private static final string write d failure msg partial success write datum source fail 
fetch cluster client config handler command mapping name cluster client fetch config desc get cluster client config public class fetch cluster client config handler implement command handler string override public command response string handle command request request cluster client state entity state v o new cluster client state entity set server host cluster client config manager get server host set server port cluster client config manager get server port set request timeout cluster client config manager get request timeout if token client provider be client spi available state v o set client state token client provider get client get state else state v o set client state client constant client status off return command response of success json to j s o n string state v o 
modify cluster client config handler command mapping name cluster client modify config desc modify cluster client config public class modify cluster client config handler implement command handler string override public command response string handle command request request string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception empty datum try datum u be l decoder decode datum utf record log info modify cluster client config handler receive cluster client config datum cluster client state entity entity json parse object datum cluster client state entity class cluster client config manager apply new config entity to client config cluster client config manager apply new assign config entity to assign config return command response of success command constant msg success catch exception e record log warn modify cluster client config handler decode client cluster config error e return command response of failure e decode client cluster config error 
fetch cluster flow rule command handler command mapping name cluster server flow rule desc get cluster flow rule public class fetch cluster flow rule command handler implement command handler string override public command response string handle command request request string namespace request get param namespace if string util be empty namespace return command response of success json to j s o n string cluster flow rule manager get all flow rule else return command response of success json to j s o n string cluster flow rule manager get flow rule namespace 
fetch cluster metric command handler command mapping name cluster server metric list desc get cluster server metric public class fetch cluster metric command handler implement command handler string override public command response string handle command request request string namespace request get param namespace if string util be empty namespace return command response of failure new illegal argument exception fail namespace can not be empty return command response of success json to j s o n string cluster metric node generator generate current node map namespace 
fetch cluster param flow rule command handler command mapping name cluster server param rule desc get cluster server param flow rule public class fetch cluster param flow rule command handler implement command handler string override public command response string handle command request request string namespace request get param namespace if string util be empty namespace return command response of success json to j s o n string cluster param flow rule manager get all param rule else return command response of success json to j s o n string cluster param flow rule manager get param rule namespace 
fetch cluster server config handler command mapping name cluster server fetch config desc get cluster server config public class fetch cluster server config handler implement command handler string override public command response string handle command request request string namespace request get param namespace if string util be empty namespace return global config result return namespace config result namespace private command response string namespace config result non empty string namespace server flow config flow config new server flow config set exceed count cluster server config manager get exceed count namespace set max occupy ratio cluster server config manager get max occupy ratio namespace set interval ms cluster server config manager get interval ms namespace set sample count cluster server config manager get sample count namespace j s o n object config new j s o n object fluent put flow flow config return command response of success config to j s o n string private command response string global config result server transport config transport config new server transport config set port cluster server config manager get port set idle seconds cluster server config manager get idle seconds server flow config flow config new server flow config set exceed count cluster server config manager get exceed count set max occupy ratio cluster server config manager get max occupy ratio set interval ms cluster server config manager get interval m set sample count cluster server config manager get sample count j s o n object config new j s o n object fluent put transport transport config fluent put flow flow config fluent put namespace set cluster server config manager get namespace set return command response of success config to j s o n string 
fetch cluster server info command handler command mapping name cluster server info desc get cluster server info public class fetch cluster server info command handler implement command handler string override public command response string handle command request request j s o n object info new j s o n object j s o n array connection group new j s o n array set string namespace set cluster server config manager get namespace set for string namespace namespace set connection group group connection manager get or create connection group namespace if group null connection group add group server transport config transport config new server transport config set port cluster server config manager get port set idle seconds cluster server config manager get idle seconds server flow config flow config new server flow config set exceed count cluster server config manager get exceed count set max occupy ratio cluster server config manager get max occupy ratio set interval ms cluster server config manager get interval m set sample count cluster server config manager get sample count set max allow qps cluster server config manager get max allow qps j s o n array request limit datum build request limit datum namespace set info fluent put port cluster server config manager get port fluent put connection connection group fluent put request limit datum request limit datum fluent put transport transport config fluent put flow flow config fluent put namespace set namespace set fluent put embed cluster server config manager be embed since 1.5 the app name be carry so that the caller can identify the app name of the token server info put app name app name util get app name return command response of success info to j s o n string private j s o n array build request limit datum set string namespace set j s o n array array new j s o n array for string namespace namespace set array add new j s o n object fluent put namespace namespace fluent put current qp global request limiter get current qps namespace fluent put max allow qps global request limiter get max allow qps namespace return array 
modify cluster flow rule command handler command mapping name cluster server modify flow rule desc modify cluster flow rule public class modify cluster flow rule command handler implement command handler string override public command response string handle command request request string namespace request get param namespace if string util be empty namespace return command response of failure new illegal argument exception empty namespace string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception empty datum try datum u be l decoder decode datum utf record log info modify cluster flow rule command handler receive cluster flow rule for namespace namespace datum list flow rule flow rule j s o n array parse array data flow rule class cluster flow rule manager load rule namespace flow rule return command response of success success catch exception e record log warn modify cluster flow rule command handler decode cluster flow rule error e return command response of failure e decode cluster flow rule error private static final string success success 
modify cluster param flow rule command handler command mapping name cluster server modify param rule desc modify cluster param flow rule public class modify cluster param flow rule command handler implement command handler string override public command response string handle command request request string namespace request get param namespace if string util be empty namespace return command response of failure new illegal argument exception empty namespace string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception empty datum try datum u be l decoder decode datum utf record log info receive cluster param rule for namespace from command handler namespace datum list param flow rule flow rule j s o n array parse array datum param flow rule class cluster param flow rule manager load rule namespace flow rule return command response of success success catch exception e record log warn modify cluster param flow rule command handler decode cluster param rule error e return command response of failure e decode cluster param rule error private static final string success success 
modify cluster server flow config handler command mapping name cluster server modify flow config desc modify cluster server flow config public class modify cluster server flow config handler implement command handler string override public command response string handle command request request string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception empty datum string namespace request get param namespace try datum u be l decoder decode datum utf if string util be empty namespace record log info modify cluster server flow config handler receive cluster server global flow config datum server flow config config json parse object datum server flow config class if cluster server config manager be valid flow config config command response of failure new illegal argument exception bad flow config cluster server config manager load global flow config config else record log info modify cluster server flow config handler receive cluster server flow config for namespace namespace datum server flow config config json parse object datum server flow config class if cluster server config manager be valid flow config config command response of failure new illegal argument exception bad flow config cluster server config manager load flow config namespace config return command response of success success catch exception e record log warn modify cluster server flow config handler decode cluster server flow config error e return command response of failure e decode cluster server flow config error 
modify cluster server transport config handler command mapping name cluster server modify transport config desc modify cluster server transport config public class modify cluster server transport config handler implement command handler string override public command response string handle command request request string port value request get param port if string util be blank port value return command response of failure new illegal argument exception invalid empty port string idle seconds value request get param idle seconds if string util be blank idle seconds value return command response of failure new illegal argument exception invalid empty idle seconds try int port integer value of port value int idle seconds integer value of idle seconds value cluster server config manager load global transport config new server transport config set port port set idle seconds idle seconds return command response of success success catch number format exception e return command response of failure new illegal argument exception invalid parameter catch exception ex return command response of failure new illegal argument exception unexpected error 
modify server namespace set handler command mapping name cluster server modify namespace set desc modify server namespace set public class modify server namespace set handler implement command handler string override public command response string handle command request request string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception empty datum try datum u be l decoder decode datum utf record log info modify server namespace set handler receive cluster server namespace set datum set string set json parse object datum new type reference set string cluster server config manager load server namespace set set return command response of success success catch exception e record log warn modify server namespace set handler decode cluster server namespace set error e return command response of failure e decode client cluster config error 
echo command handler command mapping name echo desc echo command for demo public class echo command handler implement command handler string override public command response string handle command request request string name request get param name if name null name trim length return command response of success tell we what be you name by submit a name parameter return command response of success hello name 
get param flow rule command handler command mapping name get param flow rule desc get all parameter flow rule public class get param flow rule command handler implement command handler string override public command response string handle command request request return command response of success json to j s o n string param flow rule manager get rule 
modify param flow rule command handler command mapping name set param flow rule desc set parameter flow rule while previous rule will be replace public class modify param flow rule command handler implement command handler string private static writable datum source list param flow rule param flow wds null override public command response string handle command request request string datum request get param datum if string util be blank datum return command response of failure new illegal argument exception bad datum try datum u be l decoder decode datum utf catch exception e record log info decode rule datum error e return command response of failure e decode rule datum error record log info string format api server receive rule change type parameter flow rule s datum string result success msg list param flow rule flow rule j s o n array parse array datum param flow rule class param flow rule manager load rule flow rule if write to datum source param flow wds flow rule result write d failure msg return command response of success result write target value to give datum source param datum source writable datum source param value target value to save param t value type return true if write successful or datum source be empty false if error occur private t boolean write to datum source writable datum source t datum source t value if datum source null try datum source write value catch exception e record log warn write datum source fail e return false return true public synchronize static writable datum source list param flow rule get writable datum source return param flow wds public synchronize static void set writable datum source writable datum source list param flow rule hot param wd modify param flow rule command handler param flow wd hot param wds private static final string success msg success private static final string write d failure msg partial success write datum source fail 
api command handler command mapping name api desc get all available command handler public class api command handler implement command handler string override public command response string handle command request request map string command handler handler command handler provider get instance name handler j s o n array array new j s o n array if handler be empty return command response of success array to j s o n string for command handler handler handler value command mapping command mapping handler get class get annotation command mapping class if command mapping null continue string api command mapping name string desc command mapping desc j s o n object obj new j s o n object obj put url api obj put desc desc array add obj return command response of success array to j s o n string 
basic info command handler command mapping name basic info desc get sentinel config info public class basic info command handler implement command handler string override public command response string handle command request request return command response of success host name util get config string 
fetch cluster mode command handler command mapping name get cluster mode desc get cluster mode status public class fetch cluster mode command handler implement command handler string override public command response string handle command request request j s o n object re new j s o n object fluent put mode cluster state manager get mode fluent put last modify cluster state manager get last modify fluent put client available be cluster client spi available fluent put server available be cluster server spi available return command response of success re to j s o n string private boolean be cluster client spi available return token client provider get client null private boolean be cluster server spi available return embed cluster token server provider get server null 
modify cluster mode command handler command mapping name set cluster mode desc set cluster mode accept param mode 0 | 1 client mode server mode public class modify cluster mode command handler implement command handler string override public command response string handle command request request try int mode integer value of request get param mode if mode cluster state manager cluster client token client provider be client spi available return command response of failure new illegal state exception token client mode not available no spi find if mode cluster state manager cluster server be cluster server spi available return command response of failure new illegal state exception token server mode not available no spi find record log info modify cluster mode command handler modify cluster mode to mode cluster state manager apply state mode return command response of success success catch number format exception ex return command response of failure new illegal argument exception invalid parameter catch exception ex return command response of failure ex private boolean be cluster server spi available return embed cluster token server provider be server spi available 
fetch active rule command handler command mapping name get rule desc get all active rule by type request param type rule type public class fetch active rule command handler implement command handler string override public command response string handle command request request string type request get param type if flow equal ignore case type return command response of success json to j s o n string flow rule manager get rule else if degrade equal ignore case type return command response of success json to j s o n string degrade rule manager get rule else if authority equal ignore case type return command response of success json to j s o n string authority rule manager get rule else if system equal ignore case type return command response of success json to j s o n string system rule manager get rule else return command response of failure new illegal argument exception invalid type 
fetch cluster node by id command handler command mapping name cluster node by id desc get cluster node vo by id request param id resource name public class fetch cluster node by id command handler implement command handler string override public command response string handle command request request string id request get param id if string util be empty id return command response of failure new illegal argument exception invalid parameter empty cluster node name cluster node node cluster builder slot get cluster node id if node null return command response of success json to j s o n string node vo from cluster node id node else return command response of success 
fetch cluster node human command handler command mapping name cnode desc get cluster node metric by id request param id resource name public class fetch cluster node human command handler implement command handler string private final static string format 4 80 10 10 10 11 9 6 10 11 9 11 private final static int max len override public command response string handle command request request string name request get param id if string util be empty name return command response of failure new illegal argument exception invalid parameter empty cluster node name string builder sb new string builder int i int name length for entry resource wrapper cluster node e cluster builder slot get cluster node map entry set if e get key get name contain name int l e get key get show name length if l name length name length l if i break name length name length max len max len name length string format format replace all string value of name length sb append string format format idx id thread pass block success total a rt 1m pass 1m block 1m all exception append n for entry resource wrapper cluster node e cluster builder slot get cluster node map entry set if e get key get name contain name cluster node node e get value string id e get key get show name int len num int math ceil double id length name length sb append string format format i len num id id substr name length node cur thread num node pass qp node block qp node success qp node total qp node avg rt node total request node block request node block request node total request node exception qp append n for int j j len num j int start name length j int end j len num id length name length j sb append string format format id substr start end append n if i break return command response of success sb to string 
fetch json tree command handler command mapping name json tree desc get tree node vo start from root node public class fetch json tree command handler implement command handler string override public command response string handle command request request list node vo result new array list node vo visit constant root result null return command response of success json to j s o n string result preorder traversal private void visit default node node list node vo result string parent id node vo vo node vo from default node node parent id result add vo string id vo get id for node n node get child list visit default node n result id 
fetch origin command handler command mapping name origin desc get origin cluster node by id request param id resource name public class fetch origin command handler implement command handler string private final static string format 4 80 10 10 11 9 6 10 11 9 private final static int max len override public command response string handle command request request string builder sb new string builder string name request get param id cluster node c node null boolean exactly false for entry resource wrapper cluster node e cluster builder slot get cluster node map entry set if e get key get name equal name c node e get value sb append id append e get key get show name append n sb append n exactly true break if exactly for entry resource wrapper cluster node e cluster builder slot get cluster node map entry set if e get key get name index of name c node e get value sb append id append e get key get show name append n sb append n break if c node null return command response of success not find c node with id name int i int name length for entry string statistic node e c node get origin count map entry set int l e get key length if l name length name length l if i break name length name length max len max len name length string format format replace all string value of name length i sb append string format format idx origin thread num pass qp block qp total qp a rt 1m pass 1m block 1m total append n for entry string statistic node e c node get origin count map entry set statistic node node e get value string id e get key int len num int math ceil double id length name length sb append string format format i len num id id substr name length node cur thread num node pass qp node block qp node total qp node avg rt node total request node block request node block request node total request append n for int j j len num j int start name length j int end j len num id length name length j sb append string format format id substr start end append n if i break return command response of success sb to string 
fetch simple cluster node command handler command mapping name cluster node desc get all cluster node vo use type not zero to ignore those node with total request public class fetch simple cluster node command handler implement command handler string override public command response string handle command request request type not zero means node whose total request will be ignore string type request get param type list node vo list new array list node vo map resource wrapper cluster node map cluster builder slot get cluster node map if map null return command response of success j s o n array to j s o n string list for map entry resource wrapper cluster node entry map entry set if not zero equal ignore case type if entry get value total request list add node vo from cluster node entry get key entry get value else list add node vo from cluster node entry get key entry get value return command response of success j s o n array to j s o n string list 
fetch system status command handler command mapping name system status desc get system status public class fetch system status command handler implement command handler string override public command response string handle command request request map string object system status new hash map string object system status put rqp constant entry node success qp system status put qp constant entry node pass qp system status put b constant entry node block qp system status put r constant entry node avg rt system status put t constant entry node cur thread num return command response of success j s o n object to j s o n string system status 
fetch tree command handler command mapping name tree desc get metric in tree mode use id to specify detailed tree root public class fetch tree command handler implement command handler string override public command response string handle command request request string id request get param id string builder sb new string builder default node start constant root if id null visit tree start sb else boolean exactly false for node n start get child list default node dn default node n if dn get id get name equal id visit tree dn sb exactly true break if exactly for node n start get child list default node dn default node n if dn get id get name contain id visit tree dn sb sb append r n r n sb append t thread num pq pass qp bq block qp tq total qp rt average rt prq pass request qp 1mp 1m pass 1mb 1m block 1mt 1m total append r n return command response of success sb to string private void visit tree int level default node node non null string builder sb for int i i level i sb append if node instanceof entrance node sb append string format s t s pq s bq s tq s rt s prq s 1mp s 1mb s 1mt s node get id get show name node cur thread num node pass qp node block qp node total qp node avg rt node success qp node total request node block request node block request node total request append n else sb append string format entrance node s t s pq s bq s tq s rt s prq s 1mp s 1mb s 1mt s node get id get show name node cur thread num node pass qp node block qp node total qp node avg rt node success qp node total request node block request node block request node total request append n for node n node get child list default node dn default node n visit tree level dn sb 
modify rule command handler command mapping name set rule desc modify the rule accept param type rule type datum rule json public class modify rule command handler implement command handler string private static final int fastjson minimal ver 0x01020 c00 override public command response string handle command request request xxx from 1.7 force to fail when fastjson be older than 1.2 we may need a better solution on this if version util from version string json version fastjson minimal ver fastjson too old return command response of failure new runtime exception the fastjson json version introduce in application be too old you need fastjson 1.2 at least string type request get param type rule datum in get parameter string datum request get param datum if string util be not empty datum try datum u be l decoder decode datum utf catch exception e record log info decode rule datum error e return command response of failure e decode rule datum error record log info receive rule change type type datum string result success if flow rule type equal ignore case type list flow rule flow rule j s o n array parse array data flow rule class flow rule manager load rule flow rule if write to datum source get flow datum source flow rule result write d failure msg return command response of success result else if authority rule type equal ignore case type list authority rule rule j s o n array parse array datum authority rule class authority rule manager load rule rule if write to datum source get authority datum source rule result write d failure msg return command response of success result else if degrade rule type equal ignore case type list degrade rule rule j s o n array parse array datum degrade rule class degrade rule manager load rule rule if write to datum source get degrade datum source rule result write d failure msg return command response of success result else if system rule type equal ignore case type list system rule rule j s o n array parse array datum system rule class system rule manager load rule rule if write to datum source get system source rule result write d failure msg return command response of success result return command response of failure new illegal argument exception invalid type write target value to give datum source param datum source writable datum source param value target value to save param t value type return true if write successful or datum source be empty false if error occur private t boolean write to datum source writable datum source t datum source t value if datum source null try datum source write value catch exception e record log warn write datum source fail e return false return true private static final string write d failure msg partial success write datum source fail private static final string flow rule type flow private static final string degrade rule type degrade private static final string system rule type system private static final string authority rule type authority 
on off get command handler command mapping name get switch desc get sentinel switch status public class on off get command handler implement command handler string override public command response string handle command request request return command response of success sentinel switch value constant on 
on off set command handler command mapping name set switch desc set sentinel switch accept param value true false public class on off set command handler implement command handler string override public command response string handle command request request string value request get param value try constant on boolean value of value catch exception e record log info bad value when set global switch e string info sentinel set switch value value record log info info return command response of success info 
send metric command handler command mapping name metric desc get and aggregate metric accept param start time start time end time end time max line max line identify resource name public class send metric command handler implement command handler string private volatile metric searcher searcher private final object lock new object override public command response string handle command request request note not thread safe if searcher null synchronize lock string app name sentinel config get app name if app name null app name if searcher null searcher new metric searcher metric writer metric base dir metric writer form metric file name app name pid util get pid string start time str request get param start time string end time str request get param end time string max line str request get param max line string identity request get param identity long start time int max line if string util be not blank start time str start time long parse long start time str else return command response of success list metric node list try find by end time if set if string util be not blank end time str long end time long parse long end time str list searcher find by time and resource start time end time identity else if string util be not blank max line str max line integer parse int max line str max line math min max line list searcher find start time max line catch exception ex return command response of failure new runtime exception error when retrieve metric ex if list null list new array list if string util be blank identity add cpu usage and load list string builder sb new string builder for metric node node list sb append node to thin string append n return command response of success sb to string add current cpu usage and load to the metric list param list metric list should not be null private void add cpu usage and load list metric node list long time time util current time millis double load system rule manager get current system avg load double usage system rule manager get current cpu usage if load metric node load node to node load time constant system load resource name list add load node if usage metric node usage node to node usage time constant cpu usage resource name list add usage node transfer the value to a metric node the value will multiply then truncate to long value and as the link metric node pass qp p this be a eclectic scheme before we have a standard metric format p param value value to save param t timestamp param resource resource name return a metric node represent the value private metric node to node double value long t string resource metric node node new metric node node set pass qp long value node set timestamp t node set resource resource return node 
version command handler command mapping name version desc get sentinel version public class version command handler implement command handler string override public command response string handle command request request return command response of success constant sentinel version 
multiple slash name command test handler command mapping name aa bb cc desc a test handler with multiple in its name public class multiple slash name command test handler implement command handler string override public command response string handle command request request return command response of success multiple slash name command test handler result 
