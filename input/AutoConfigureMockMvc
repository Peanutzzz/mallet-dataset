sentinel spring mvc integration test run with spring runner class spring boot test class test application class auto configure mock mvc public class sentinel spring mvc integration test private static final string hello str hello autowired private mock mvc mvc test public void test base throw exception string url hello this mvc perform get url and expect status be ok and expect content string hello str cluster node cn cluster builder slot get cluster node url assert not null cn assert equal cn pass qp 0.01 test public void test origin parser throw exception string spring mvc path variable url foo id string limit origin user a final string header name s user configure rule for spring mvc path variable url limit origin this will be pass since the caller be different user b this mvc perform get foo accept media type text plain header header name user b and expect status be ok and expect content string foo this will be block since the caller be same user a this mvc perform get foo accept media type application json header header name limit origin and expect status be ok and expect content json result wrapper block to json string this will be pass since the caller be different this mvc perform get foo accept media type application json and expect status be ok and expect content string foo flow rule manager load rule null test public void test total interceptor throw exception string url hello string total target my spring mvc total url request for int i i i this mvc perform get url and expect status be ok and expect content string hello str cluster node cn cluster builder slot get cluster node total target assert not null cn assert equal cn pass qp 0.01 test public void test runtime exception throw exception string url runtime exception configure exception rule for url null int repeat for int i i repeat i this mvc perform get url and expect status be ok and expect content string result wrapper error to json string cluster node cn cluster builder slot get cluster node url assert not null cn assert equal i cn pass qps 0.01 this will be block and response json this mvc perform get url and expect status be ok and expect content string result wrapper block to json string cluster node cn cluster builder slot get cluster node url assert not null cn assert equal repeat cn pass qp 0.01 assert equal cn block request private void configure rule for string resource int count string limit app flow rule rule new flow rule set count count set grade rule constant flow grade qp rule set resource resource if string util be not blank limit app rule set limit app limit app flow rule manager load rule collection singleton list rule private void configure exception rule for string resource int count string limit app flow rule rule new flow rule set count count set grade rule constant degrade grade exception ratio rule set resource resource if string util be not blank limit app rule set limit app limit app flow rule manager load rule collection singleton list rule after public void clean up flow rule manager load rule null cluster builder slot reset cluster node 
common filter test run with spring runner class spring boot test class test application class auto configure mock mvc public class common filter test private static final string hello str hello autowired private mock mvc mvc private void configure rule for string resource int count configure rule for resource count default private void configure rule for string resource int count string limit app flow rule rule new flow rule set count count set grade rule constant flow grade qp rule set resource resource if string util be not blank limit app rule set limit app limit app flow rule manager load rule collection singleton list rule test public void test common filter miscellaneous throw exception constant root remove child list string url hello this mvc perform get url and expect status be ok and expect content string hello str cluster node cn cluster builder slot get cluster node url assert not null cn assert equal cn pass qp 0.01 string context for node n constant root get child list if n instanceof entrance node string id entrance node n get id get name if url equal id context entrance node n get id get name assert equal context test common block and redirect block page url cn test for url cleaner test url cleaner test url exclusion test custom origin parser private void test common block and redirect block page string url cluster node cn throw exception configure rule for url the request will be block and response be default block message web servlet config set block page http status http status ok value this mvc perform get url accept media type text plain and expect status be ok and expect content string filter util default block msg assert equal cn block qp 0.01 web servlet config set block page http status http status too many request value this mvc perform get url accept media type text plain and expect status be too many request and expect content string filter util default block msg test for redirect string redirect url http some location com web servlet config set block page redirect url this mvc perform get url accept media type text plain and expect status is3xx redirection and expect header string location redirect url http referer http localhost hello flow rule manager load rule null web servlet config set block page private void test url cleaner throw exception final string foo prefix foo string url1 foo prefix string url2 foo prefix web callback manager set url cleaner new url cleaner override public string clean string origin url if origin url start with foo prefix return foo return origin url this mvc perform get url1 accept media type text plain and expect status be ok and expect content string hello this mvc perform get url2 accept media type text plain and expect status be ok and expect content string hello cluster node cn cluster builder slot get cluster node foo prefix assert equal cn pass qp 0.01 assert null cluster builder slot get cluster node url1 assert null cluster builder slot get cluster node url2 web callback manager set url cleaner new default url cleaner private void test url exclusion throw exception final string exclude prefix exclude string url exclude prefix web callback manager set url cleaner new url cleaner override public string clean string origin url if origin url start with exclude prefix return return origin url this mvc perform get url accept media type text plain and expect status be ok and expect content string exclude assert null cluster builder slot get cluster node url web callback manager set url cleaner new default url cleaner private void test custom origin parser throw exception string url hello string limit origin user a final string header name s user configure rule for url limit origin web callback manager set request origin parser new request origin parser override public string parse origin http servlet request request string origin request get header header name return origin null origin this mvc perform get url accept media type text plain header header name user b and expect status be ok and expect content string hello str this will be block this mvc perform get url accept media type text plain header header name limit origin and expect status be too many request and expect content string filter util default block msg this mvc perform get url accept media type text plain and expect status be ok and expect content string hello str web callback manager set request origin parser null flow rule manager load rule null after public void clean up flow rule manager load rule null cluster builder slot reset cluster node 
common filter context test run with spring runner class spring boot test class test context application class web environment spring boot test web environment random port auto configure mock mvc public class common filter context test private static final string hello str hello autowired private mock mvc mvc private void configure rule for string resource int count configure rule for resource count default private void configure rule for string resource int count string limit app flow rule rule new flow rule set count count set grade rule constant flow grade qp rule set resource resource if string util be not blank limit app rule set limit app limit app flow rule manager load rule collection singleton list rule test public void test common filter miscellaneous throw exception string url hello this mvc perform get url and expect status be ok and expect content string hello str cluster node cn cluster builder slot get cluster node url assert not null cn assert equal cn pass qp 0.01 string context for node n constant root get child list if n instanceof entrance node string id entrance node n get id get name if url equal id context entrance node n get id get name assert equal url context after public void clean up flow rule manager load rule null cluster builder slot reset cluster node 
common filter method test run with spring runner class spring boot test class test application class web environment spring boot test web environment random port auto configure mock mvc public class common filter method test private static final string hello str hello private static final string hello post str hello post private static final string get get private static final string post post private static final string colon autowire private mock mvc mvc private void configure rule for string resource int count configure rule for resource count default private void configure rule for string resource int count string limit app flow rule rule new flow rule set count count set grade rule constant flow grade qp rule set resource resource if string util be not blank limit app rule set limit app limit app flow rule manager load rule collection singleton list rule test public void test common filter miscellaneous throw exception string url hello this mvc perform get url and expect status be ok and expect content string hello str cluster node cn get cluster builder slot get cluster node get colon url assert not null cn get assert equal cn get pass qp 0.01 cluster node cn post cluster builder slot get cluster node post colon url assert null cn post this mvc perform post url and expect status be ok and expect content string hello post str cn post cluster builder slot get cluster node post colon url assert not null cn post assert equal cn post pass qp 0.01 test common block and redirect block page url cn get cn post private void test common block and redirect block page string url cluster node cn get cluster node cn post throw exception configure rule for get url the request will be block and response be default block message this mvc perform get url accept media type text plain and expect status be too many request and expect content string filter util default block msg assert equal cn get block qps 0.01 test for post pass this mvc perform post url and expect status be ok and expect content string hello post str assert equal cn post pass qp 0.01 flow rule manager load rule null web servlet config set block page after public void clean up flow rule manager load rule null cluster builder slot reset cluster node 
